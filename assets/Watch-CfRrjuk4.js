import{c as T,j as e}from"./index-Cy-imd_x.js";import{f as oe,h as de,d as ue,b as s}from"./vendor-Btvvx3Fo.js";import{H as w}from"./ui-BeglVYDV.js";const we=()=>{var U,F,q,W,J,B,G;const{episodeId:c}=oe(),[K]=de(),E=ue(),v=K.get("animeId"),[u,V]=s.useState(null),[o,Y]=s.useState([]),[P,h]=s.useState(null),[r,Q]=s.useState(null),[X,$]=s.useState(!0),[Z,M]=s.useState(!1),[m,x]=s.useState(!1),[ee,L]=s.useState(!0),[j,N]=s.useState({message:"",type:null}),[te,_]=s.useState(!1),[p,k]=s.useState(!1),[se,re]=s.useState(0),[ae,z]=s.useState(0),[me,fe]=s.useState(1),[xe,he]=s.useState(!1),[A,pe]=s.useState(!0),[le,ie]=s.useState(null),i=s.useRef(null),I=s.useRef(null),D=s.useRef(null),b=s.useRef(null),S=s.useCallback(async(t=!1,a)=>{var l,n;if(c)try{t?M(!0):$(!0),N({message:"",type:null}),x(!1),L(!0);const[f,d,g]=await Promise.allSettled([T.getStream(c,a),T.getServers(c),v?T.getInfo(v):Promise.resolve(null)]);if(g.status==="fulfilled"&&g.value){Q(g.value);const R=JSON.parse(localStorage.getItem("anime_history")||"{}"),y=R[g.value.id]||[];y.includes(c)||(R[g.value.id]=[...y,c],localStorage.setItem("anime_history",JSON.stringify(R)))}d.status==="fulfilled"&&Y(d.value),f.status==="fulfilled"&&((n=(l=f.value)==null?void 0:l.sources)==null?void 0:n.length)>0?(V(f.value),f.value.sources.some(y=>y.url.includes(".m3u8")||y.isM3U8)||(x(!0),d.status==="fulfilled"&&d.value.length>0&&h(d.value[0].name))):f.status==="rejected"?N({message:f.reason.message||"Stream resolution requires a live backend proxy.",type:"environment"}):(x(!0),d.status==="fulfilled"&&d.value.length>0?h(a||d.value[0].name):N({message:"No active stream signals were detected in this sector.",type:"fatal"}))}catch{N({message:"Neural link failed. Environment restricts manifest extraction.",type:"environment"})}finally{$(!1),M(!1)}},[c,v]);s.useEffect(()=>{S()},[S]),s.useEffect(()=>{if(u&&i.current&&!m){const t=u.sources.find(a=>a.url.includes(".m3u8"))||u.sources[0];if(b.current=window.setTimeout(()=>{!p&&!m&&(x(!0),o.length>0&&h(o[0].name))},7e3),w.isSupported()){const a=new w({enableWorker:!0,lowLatencyMode:!0,xhrSetup:l=>{u.headers&&Object.keys(u.headers).forEach(n=>{["referer","user-agent"].includes(n.toLowerCase())||l.setRequestHeader(n,u.headers[n])})}});I.current=a,a.loadSource(t.url),a.attachMedia(i.current),a.on(w.Events.MANIFEST_PARSED,()=>{var l;b.current&&clearTimeout(b.current),(l=i.current)==null||l.play().catch(()=>k(!1))}),a.on(w.Events.ERROR,(l,n)=>{n.fatal&&(n.type===w.ErrorTypes.NETWORK_ERROR?(x(!0),o.length>0&&h(o[0].name),a.destroy()):a.recoverMediaError())})}return()=>{I.current&&I.current.destroy(),b.current&&clearTimeout(b.current)}}},[u,m,o,p]);const O=()=>{i.current&&(p?i.current.pause():i.current.play(),k(!p))},ne=()=>{if(i.current){const t=i.current.currentTime,a=i.current.duration;if(re(t/(a||1)*100),z(a),a>0&&a-t<15&&!le&&(r!=null&&r.episodes)){const l=r.episodes.findIndex(n=>n.id===c);l!==-1&&l<r.episodes.length-1&&ie(15)}}},H=t=>{const a=Math.floor(t/60),l=Math.floor(t%60);return`${a}:${l.toString().padStart(2,"0")}`};if(X||Z)return e.jsxs("div",{className:"bg-black h-screen flex flex-col items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-20 w-20 border-[6px] border-white/5 border-t-primary shadow-[0_0_60px_rgba(168,85,247,0.3)]"}),e.jsx("p",{className:"mt-8 text-[10px] font-black uppercase tracking-[0.4em] text-slate-500 animate-pulse",children:"Syncing Stream Signal..."})]});if(j.message)return e.jsxs("div",{className:"bg-black h-screen flex flex-col items-center justify-center p-8 text-center",children:[e.jsx("div",{className:"size-24 bg-red-500/10 rounded-full flex items-center justify-center mb-8 border border-red-500/20",children:e.jsx("span",{className:"material-symbols-outlined text-red-500 text-5xl",children:j.type==="environment"?"dns":"sensors_off"})}),e.jsx("h2",{className:"text-3xl font-black text-white mb-4 uppercase tracking-tighter",children:j.type==="environment"?"Environment Restricted":"Playback Gated"}),e.jsx("p",{className:"text-slate-500 max-w-sm mx-auto mb-12 text-sm leading-relaxed font-bold uppercase tracking-widest",children:j.message}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>S(!0),className:"bg-primary text-white font-black px-10 py-5 rounded-[2rem] shadow-xl hover:bg-primary/90 transition-all uppercase tracking-[0.2em] text-[10px]",children:"Retry Uplink"}),e.jsx("button",{onClick:()=>E(-1),className:"bg-white/5 text-slate-400 font-black px-10 py-5 rounded-[2rem] border border-white/10 uppercase tracking-[0.2em] text-[10px]",children:"Abort"})]})]});const ce=typeof(r==null?void 0:r.title)=="string"?r.title:((U=r==null?void 0:r.title)==null?void 0:U.english)||((F=r==null?void 0:r.title)==null?void 0:F.romaji)||"Episode",C=(q=r==null?void 0:r.episodes)==null?void 0:q.find(t=>t.id===c);return e.jsxs("div",{ref:D,className:"relative w-full h-screen bg-black flex flex-col group overflow-hidden select-none",children:[e.jsxs("div",{className:`absolute top-0 left-0 right-0 p-10 flex justify-between items-start bg-gradient-to-b from-black via-black/60 to-transparent z-[100] transition-all duration-700 ${A?"opacity-100 translate-y-0":"opacity-0 -translate-y-8"}`,children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("button",{onClick:()=>E(-1),className:"p-4 bg-white/5 hover:bg-primary/20 backdrop-blur-3xl rounded-2xl border border-white/10 transition-all",children:e.jsx("span",{className:"material-symbols-outlined text-white",children:"arrow_back"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:`px-3 py-1 mb-1 w-fit rounded-full text-[8px] font-black uppercase tracking-widest text-white shadow-lg ${m?"bg-amber-600":"bg-primary"}`,children:m?"RELAY":"DIRECT"}),e.jsxs("h1",{className:"text-xl font-black text-white tracking-tighter line-clamp-1",children:[ce," ",e.jsxs("span",{className:"text-primary/60 ml-2",children:["EP ",(C==null?void 0:C.number)||"?"]})]})]})]}),e.jsx("button",{onClick:()=>_(!0),className:"p-4 bg-white/5 hover:bg-white/10 backdrop-blur-3xl rounded-2xl border border-white/10 transition-all",children:e.jsx("span",{className:"material-symbols-outlined text-white",children:"grid_view"})})]}),e.jsxs("main",{className:"flex-1 relative bg-black flex items-center justify-center",children:[m?e.jsxs("div",{className:"w-full h-full relative",children:[ee&&e.jsxs("div",{className:"absolute inset-0 z-10 flex flex-col items-center justify-center bg-black",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-t-2 border-primary mb-4"}),e.jsx("p",{className:"text-[9px] font-black text-slate-600 uppercase tracking-widest",children:"Bridging Relay Server..."})]}),e.jsx("iframe",{src:((W=o.find(t=>t.name===P))==null?void 0:W.url)||((J=o[0])==null?void 0:J.url),className:"w-full h-full border-none",allowFullScreen:!0,referrerPolicy:"no-referrer",onLoad:()=>L(!1),allow:"autoplay; fullscreen"})]}):e.jsx("video",{ref:i,className:"w-full h-full object-contain",onTimeUpdate:ne,onLoadedMetadata:()=>{var t;return z(((t=i.current)==null?void 0:t.duration)||0)},onPlay:()=>k(!0),onPause:()=>k(!1),onClick:O}),!m&&e.jsxs("div",{className:`absolute bottom-0 left-0 right-0 p-8 pt-24 bg-gradient-to-t from-black via-black/70 to-transparent z-[100] transition-all duration-700 ${A?"opacity-100 translate-y-0":"opacity-0 translate-y-8"}`,children:[e.jsx("div",{className:"relative w-full h-1.5 bg-white/10 rounded-full mb-8 group/seek flex items-center",children:e.jsx("div",{className:"absolute h-full bg-primary rounded-full shadow-[0_0_20px_rgba(168,85,247,0.8)]",style:{width:`${se}%`}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-10",children:[e.jsx("button",{onClick:O,className:"text-white hover:text-primary transition-all active:scale-90",children:e.jsx("span",{className:"material-symbols-outlined !text-4xl",children:p?"pause_circle":"play_circle"})}),e.jsxs("div",{className:"text-[10px] font-black text-slate-400 tracking-widest uppercase flex items-center gap-2",children:[e.jsx("span",{className:"text-white",children:H(((B=i.current)==null?void 0:B.currentTime)||0)}),e.jsx("span",{className:"opacity-30",children:"/"}),e.jsx("span",{children:H(ae)})]})]}),e.jsx("button",{onClick:()=>{var t;document.fullscreenElement?document.exitFullscreen():(t=D.current)==null||t.requestFullscreen()},className:"text-white hover:text-primary transition-all",children:e.jsx("span",{className:"material-symbols-outlined !text-3xl",children:"fullscreen"})})]})]})]}),e.jsxs("div",{className:`fixed right-0 top-0 h-full w-[380px] z-[200] bg-background-dark/98 backdrop-blur-3xl border-l border-white/10 transition-transform duration-700 p-10 flex flex-col shadow-[-40px_0_100px_rgba(0,0,0,0.8)] ${te?"translate-x-0":"translate-x-full"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-12",children:[e.jsx("h3",{className:"text-2xl font-black text-white tracking-tighter uppercase",children:"Episodes"}),e.jsx("button",{onClick:()=>_(!1),className:"size-10 flex items-center justify-center bg-white/5 rounded-xl border border-white/10 text-slate-500 hover:text-white transition-all",children:e.jsx("span",{className:"material-symbols-outlined",children:"close"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto hide-scrollbar space-y-3",children:(G=r==null?void 0:r.episodes)==null?void 0:G.map(t=>e.jsxs("button",{onClick:()=>{E(`/watch/${t.id}?animeId=${v}`),_(!1)},className:`w-full flex items-center gap-5 p-5 rounded-2xl transition-all border ${t.id===c?"bg-primary border-primary text-white shadow-xl":"bg-white/5 border-white/5 text-slate-400 hover:bg-white/10 hover:border-white/20"}`,children:[e.jsx("div",{className:`size-8 rounded-lg flex items-center justify-center font-black ${t.id===c?"bg-white/20":"bg-white/10"}`,children:t.number}),e.jsx("p",{className:"font-black text-xs text-left line-clamp-1 flex-1 uppercase tracking-tight",children:t.title||`Episode ${t.number}`})]},t.id))}),e.jsxs("div",{className:"mt-8 pt-8 border-t border-white/5",children:[e.jsx("p",{className:"text-[9px] font-black text-slate-600 uppercase tracking-widest mb-4",children:"Neural Relay Nodes"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:o.map(t=>e.jsx("button",{onClick:()=>{x(!0),h(t.name),S(!0,t.name)},className:`px-4 py-3 rounded-xl text-[8px] font-black uppercase tracking-widest border transition-all ${P===t.name?"bg-primary/20 border-primary text-primary shadow-lg shadow-primary/10":"bg-white/5 border-white/10 text-slate-500 hover:text-white"}`,children:t.name},t.name))})]})]})]})};export{we as default};
