var Nc={};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Fc,Uc;function Oc(){return{geminiUrl:Fc,vertexUrl:Uc}}function Bc(n,e,t,i){var s,r;if(!(n!=null&&n.baseUrl)){const o=Oc();return e?(s=o.vertexUrl)!==null&&s!==void 0?s:t:(r=o.geminiUrl)!==null&&r!==void 0?r:i}return n.baseUrl}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class lt{}function G(n,e){const t=/\{([^}]+)\}/g;return n.replace(t,(i,s)=>{if(Object.prototype.hasOwnProperty.call(e,s)){const r=e[s];return r!=null?String(r):""}else throw new Error(`Key '${s}' not found in valueMap.`)})}function h(n,e,t){for(let r=0;r<e.length-1;r++){const o=e[r];if(o.endsWith("[]")){const a=o.slice(0,-2);if(!(a in n))if(Array.isArray(t))n[a]=Array.from({length:t.length},()=>({}));else throw new Error(`Value must be a list given an array path ${o}`);if(Array.isArray(n[a])){const u=n[a];if(Array.isArray(t))for(let l=0;l<u.length;l++){const c=u[l];h(c,e.slice(r+1),t[l])}else for(const l of u)h(l,e.slice(r+1),t)}return}else if(o.endsWith("[0]")){const a=o.slice(0,-3);a in n||(n[a]=[{}]);const u=n[a];h(u[0],e.slice(r+1),t);return}(!n[o]||typeof n[o]!="object")&&(n[o]={}),n=n[o]}const i=e[e.length-1],s=n[i];if(s!==void 0){if(!t||typeof t=="object"&&Object.keys(t).length===0||t===s)return;if(typeof s=="object"&&typeof t=="object"&&s!==null&&t!==null)Object.assign(s,t);else throw new Error(`Cannot set value for an existing key. Key: ${i}`)}else i==="_self"&&typeof t=="object"&&t!==null&&!Array.isArray(t)?Object.assign(n,t):n[i]=t}function d(n,e,t=void 0){try{if(e.length===1&&e[0]==="_self")return n;for(let i=0;i<e.length;i++){if(typeof n!="object"||n===null)return t;const s=e[i];if(s.endsWith("[]")){const r=s.slice(0,-2);if(r in n){const o=n[r];return Array.isArray(o)?o.map(a=>d(a,e.slice(i+1),t)):t}else return t}else n=n[s]}return n}catch(i){if(i instanceof TypeError)return t;throw i}}function $c(n,e){for(const[t,i]of Object.entries(e)){const s=t.split("."),r=i.split("."),o=new Set;let a=-1;for(let u=0;u<s.length;u++)if(s[u]==="*"){a=u;break}if(a!==-1&&r.length>a)for(let u=a;u<r.length;u++){const l=r[u];l!=="*"&&!l.endsWith("[]")&&!l.endsWith("[0]")&&o.add(l)}zn(n,s,r,0,o)}}function zn(n,e,t,i,s){if(i>=e.length||typeof n!="object"||n===null)return;const r=e[i];if(r.endsWith("[]")){const o=r.slice(0,-2),a=n;if(o in a&&Array.isArray(a[o]))for(const u of a[o])zn(u,e,t,i+1,s)}else if(r==="*"){if(typeof n=="object"&&n!==null&&!Array.isArray(n)){const o=n,a=Object.keys(o).filter(l=>!l.startsWith("_")&&!s.has(l)),u={};for(const l of a)u[l]=o[l];for(const[l,c]of Object.entries(u)){const f=[];for(const p of t.slice(i))p==="*"?f.push(l):f.push(p);h(o,f,c)}for(const l of a)delete o[l]}}else{const o=n;r in o&&zn(o[r],e,t,i+1,s)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Ps(n){if(typeof n!="string")throw new Error("fromImageBytes must be a string");return n}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Gc(n){const e={},t=d(n,["operationName"]);t!=null&&h(e,["operationName"],t);const i=d(n,["resourceName"]);return i!=null&&h(e,["_url","resourceName"],i),e}function Vc(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["response","generateVideoResponse"]);return o!=null&&h(e,["response"],Kc(o)),e}function Hc(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["response"]);return o!=null&&h(e,["response"],qc(o)),e}function Kc(n){const e={},t=d(n,["generatedSamples"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>Yc(o))),h(e,["generatedVideos"],r)}const i=d(n,["raiMediaFilteredCount"]);i!=null&&h(e,["raiMediaFilteredCount"],i);const s=d(n,["raiMediaFilteredReasons"]);return s!=null&&h(e,["raiMediaFilteredReasons"],s),e}function qc(n){const e={},t=d(n,["videos"]);if(t!=null){let r=t;Array.isArray(r)&&(r=r.map(o=>Wc(o))),h(e,["generatedVideos"],r)}const i=d(n,["raiMediaFilteredCount"]);i!=null&&h(e,["raiMediaFilteredCount"],i);const s=d(n,["raiMediaFilteredReasons"]);return s!=null&&h(e,["raiMediaFilteredReasons"],s),e}function Yc(n){const e={},t=d(n,["video"]);return t!=null&&h(e,["video"],jc(t)),e}function Wc(n){const e={},t=d(n,["_self"]);return t!=null&&h(e,["video"],ed(t)),e}function Jc(n){const e={},t=d(n,["operationName"]);return t!=null&&h(e,["_url","operationName"],t),e}function zc(n){const e={},t=d(n,["operationName"]);return t!=null&&h(e,["_url","operationName"],t),e}function Xc(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["response"]);return o!=null&&h(e,["response"],Qc(o)),e}function Qc(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["parent"]);i!=null&&h(e,["parent"],i);const s=d(n,["documentName"]);return s!=null&&h(e,["documentName"],s),e}function cl(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["response"]);return o!=null&&h(e,["response"],Zc(o)),e}function Zc(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["parent"]);i!=null&&h(e,["parent"],i);const s=d(n,["documentName"]);return s!=null&&h(e,["documentName"],s),e}function jc(n){const e={},t=d(n,["uri"]);t!=null&&h(e,["uri"],t);const i=d(n,["encodedVideo"]);i!=null&&h(e,["videoBytes"],Ps(i));const s=d(n,["encoding"]);return s!=null&&h(e,["mimeType"],s),e}function ed(n){const e={},t=d(n,["gcsUri"]);t!=null&&h(e,["uri"],t);const i=d(n,["bytesBase64Encoded"]);i!=null&&h(e,["videoBytes"],Ps(i));const s=d(n,["mimeType"]);return s!=null&&h(e,["mimeType"],s),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var pr;(function(n){n.OUTCOME_UNSPECIFIED="OUTCOME_UNSPECIFIED",n.OUTCOME_OK="OUTCOME_OK",n.OUTCOME_FAILED="OUTCOME_FAILED",n.OUTCOME_DEADLINE_EXCEEDED="OUTCOME_DEADLINE_EXCEEDED"})(pr||(pr={}));var gr;(function(n){n.LANGUAGE_UNSPECIFIED="LANGUAGE_UNSPECIFIED",n.PYTHON="PYTHON"})(gr||(gr={}));var mr;(function(n){n.SCHEDULING_UNSPECIFIED="SCHEDULING_UNSPECIFIED",n.SILENT="SILENT",n.WHEN_IDLE="WHEN_IDLE",n.INTERRUPT="INTERRUPT"})(mr||(mr={}));var pt;(function(n){n.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT",n.NULL="NULL"})(pt||(pt={}));var yr;(function(n){n.API_SPEC_UNSPECIFIED="API_SPEC_UNSPECIFIED",n.SIMPLE_SEARCH="SIMPLE_SEARCH",n.ELASTIC_SEARCH="ELASTIC_SEARCH"})(yr||(yr={}));var Er;(function(n){n.AUTH_TYPE_UNSPECIFIED="AUTH_TYPE_UNSPECIFIED",n.NO_AUTH="NO_AUTH",n.API_KEY_AUTH="API_KEY_AUTH",n.HTTP_BASIC_AUTH="HTTP_BASIC_AUTH",n.GOOGLE_SERVICE_ACCOUNT_AUTH="GOOGLE_SERVICE_ACCOUNT_AUTH",n.OAUTH="OAUTH",n.OIDC_AUTH="OIDC_AUTH"})(Er||(Er={}));var Tr;(function(n){n.HTTP_IN_UNSPECIFIED="HTTP_IN_UNSPECIFIED",n.HTTP_IN_QUERY="HTTP_IN_QUERY",n.HTTP_IN_HEADER="HTTP_IN_HEADER",n.HTTP_IN_PATH="HTTP_IN_PATH",n.HTTP_IN_BODY="HTTP_IN_BODY",n.HTTP_IN_COOKIE="HTTP_IN_COOKIE"})(Tr||(Tr={}));var vr;(function(n){n.PHISH_BLOCK_THRESHOLD_UNSPECIFIED="PHISH_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_HIGH_AND_ABOVE="BLOCK_HIGH_AND_ABOVE",n.BLOCK_HIGHER_AND_ABOVE="BLOCK_HIGHER_AND_ABOVE",n.BLOCK_VERY_HIGH_AND_ABOVE="BLOCK_VERY_HIGH_AND_ABOVE",n.BLOCK_ONLY_EXTREMELY_HIGH="BLOCK_ONLY_EXTREMELY_HIGH"})(vr||(vr={}));var Sr;(function(n){n.UNSPECIFIED="UNSPECIFIED",n.BLOCKING="BLOCKING",n.NON_BLOCKING="NON_BLOCKING"})(Sr||(Sr={}));var Ar;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.MODE_DYNAMIC="MODE_DYNAMIC"})(Ar||(Ar={}));var Ir;(function(n){n.MODE_UNSPECIFIED="MODE_UNSPECIFIED",n.AUTO="AUTO",n.ANY="ANY",n.NONE="NONE",n.VALIDATED="VALIDATED"})(Ir||(Ir={}));var _r;(function(n){n.THINKING_LEVEL_UNSPECIFIED="THINKING_LEVEL_UNSPECIFIED",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH",n.MINIMAL="MINIMAL"})(_r||(_r={}));var Rr;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",n.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",n.HARM_CATEGORY_IMAGE_HATE="HARM_CATEGORY_IMAGE_HATE",n.HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT="HARM_CATEGORY_IMAGE_DANGEROUS_CONTENT",n.HARM_CATEGORY_IMAGE_HARASSMENT="HARM_CATEGORY_IMAGE_HARASSMENT",n.HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT="HARM_CATEGORY_IMAGE_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_JAILBREAK="HARM_CATEGORY_JAILBREAK"})(Rr||(Rr={}));var xr;(function(n){n.HARM_BLOCK_METHOD_UNSPECIFIED="HARM_BLOCK_METHOD_UNSPECIFIED",n.SEVERITY="SEVERITY",n.PROBABILITY="PROBABILITY"})(xr||(xr={}));var Cr;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE",n.OFF="OFF"})(Cr||(Cr={}));var Lr;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.LANGUAGE="LANGUAGE",n.OTHER="OTHER",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.SPII="SPII",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.IMAGE_SAFETY="IMAGE_SAFETY",n.UNEXPECTED_TOOL_CALL="UNEXPECTED_TOOL_CALL",n.IMAGE_PROHIBITED_CONTENT="IMAGE_PROHIBITED_CONTENT",n.NO_IMAGE="NO_IMAGE",n.IMAGE_RECITATION="IMAGE_RECITATION",n.IMAGE_OTHER="IMAGE_OTHER"})(Lr||(Lr={}));var Pr;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(Pr||(Pr={}));var Dr;(function(n){n.HARM_SEVERITY_UNSPECIFIED="HARM_SEVERITY_UNSPECIFIED",n.HARM_SEVERITY_NEGLIGIBLE="HARM_SEVERITY_NEGLIGIBLE",n.HARM_SEVERITY_LOW="HARM_SEVERITY_LOW",n.HARM_SEVERITY_MEDIUM="HARM_SEVERITY_MEDIUM",n.HARM_SEVERITY_HIGH="HARM_SEVERITY_HIGH"})(Dr||(Dr={}));var br;(function(n){n.URL_RETRIEVAL_STATUS_UNSPECIFIED="URL_RETRIEVAL_STATUS_UNSPECIFIED",n.URL_RETRIEVAL_STATUS_SUCCESS="URL_RETRIEVAL_STATUS_SUCCESS",n.URL_RETRIEVAL_STATUS_ERROR="URL_RETRIEVAL_STATUS_ERROR",n.URL_RETRIEVAL_STATUS_PAYWALL="URL_RETRIEVAL_STATUS_PAYWALL",n.URL_RETRIEVAL_STATUS_UNSAFE="URL_RETRIEVAL_STATUS_UNSAFE"})(br||(br={}));var wr;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER",n.BLOCKLIST="BLOCKLIST",n.PROHIBITED_CONTENT="PROHIBITED_CONTENT",n.IMAGE_SAFETY="IMAGE_SAFETY",n.MODEL_ARMOR="MODEL_ARMOR",n.JAILBREAK="JAILBREAK"})(wr||(wr={}));var kr;(function(n){n.TRAFFIC_TYPE_UNSPECIFIED="TRAFFIC_TYPE_UNSPECIFIED",n.ON_DEMAND="ON_DEMAND",n.PROVISIONED_THROUGHPUT="PROVISIONED_THROUGHPUT"})(kr||(kr={}));var Wi;(function(n){n.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",n.TEXT="TEXT",n.IMAGE="IMAGE",n.AUDIO="AUDIO"})(Wi||(Wi={}));var Mr;(function(n){n.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",n.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",n.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",n.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH"})(Mr||(Mr={}));var Nr;(function(n){n.TUNING_MODE_UNSPECIFIED="TUNING_MODE_UNSPECIFIED",n.TUNING_MODE_FULL="TUNING_MODE_FULL",n.TUNING_MODE_PEFT_ADAPTER="TUNING_MODE_PEFT_ADAPTER"})(Nr||(Nr={}));var Fr;(function(n){n.ADAPTER_SIZE_UNSPECIFIED="ADAPTER_SIZE_UNSPECIFIED",n.ADAPTER_SIZE_ONE="ADAPTER_SIZE_ONE",n.ADAPTER_SIZE_TWO="ADAPTER_SIZE_TWO",n.ADAPTER_SIZE_FOUR="ADAPTER_SIZE_FOUR",n.ADAPTER_SIZE_EIGHT="ADAPTER_SIZE_EIGHT",n.ADAPTER_SIZE_SIXTEEN="ADAPTER_SIZE_SIXTEEN",n.ADAPTER_SIZE_THIRTY_TWO="ADAPTER_SIZE_THIRTY_TWO"})(Fr||(Fr={}));var Xn;(function(n){n.JOB_STATE_UNSPECIFIED="JOB_STATE_UNSPECIFIED",n.JOB_STATE_QUEUED="JOB_STATE_QUEUED",n.JOB_STATE_PENDING="JOB_STATE_PENDING",n.JOB_STATE_RUNNING="JOB_STATE_RUNNING",n.JOB_STATE_SUCCEEDED="JOB_STATE_SUCCEEDED",n.JOB_STATE_FAILED="JOB_STATE_FAILED",n.JOB_STATE_CANCELLING="JOB_STATE_CANCELLING",n.JOB_STATE_CANCELLED="JOB_STATE_CANCELLED",n.JOB_STATE_PAUSED="JOB_STATE_PAUSED",n.JOB_STATE_EXPIRED="JOB_STATE_EXPIRED",n.JOB_STATE_UPDATING="JOB_STATE_UPDATING",n.JOB_STATE_PARTIALLY_SUCCEEDED="JOB_STATE_PARTIALLY_SUCCEEDED"})(Xn||(Xn={}));var Ur;(function(n){n.TUNING_TASK_UNSPECIFIED="TUNING_TASK_UNSPECIFIED",n.TUNING_TASK_I2V="TUNING_TASK_I2V",n.TUNING_TASK_T2V="TUNING_TASK_T2V",n.TUNING_TASK_R2V="TUNING_TASK_R2V"})(Ur||(Ur={}));var Or;(function(n){n.MEDIA_RESOLUTION_UNSPECIFIED="MEDIA_RESOLUTION_UNSPECIFIED",n.MEDIA_RESOLUTION_LOW="MEDIA_RESOLUTION_LOW",n.MEDIA_RESOLUTION_MEDIUM="MEDIA_RESOLUTION_MEDIUM",n.MEDIA_RESOLUTION_HIGH="MEDIA_RESOLUTION_HIGH",n.MEDIA_RESOLUTION_ULTRA_HIGH="MEDIA_RESOLUTION_ULTRA_HIGH"})(Or||(Or={}));var Qn;(function(n){n.COLLECTION="COLLECTION"})(Qn||(Qn={}));var Br;(function(n){n.FEATURE_SELECTION_PREFERENCE_UNSPECIFIED="FEATURE_SELECTION_PREFERENCE_UNSPECIFIED",n.PRIORITIZE_QUALITY="PRIORITIZE_QUALITY",n.BALANCED="BALANCED",n.PRIORITIZE_COST="PRIORITIZE_COST"})(Br||(Br={}));var $r;(function(n){n.ENVIRONMENT_UNSPECIFIED="ENVIRONMENT_UNSPECIFIED",n.ENVIRONMENT_BROWSER="ENVIRONMENT_BROWSER"})($r||($r={}));var Gr;(function(n){n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(Gr||(Gr={}));var Vr;(function(n){n.DONT_ALLOW="DONT_ALLOW",n.ALLOW_ADULT="ALLOW_ADULT",n.ALLOW_ALL="ALLOW_ALL"})(Vr||(Vr={}));var Hr;(function(n){n.auto="auto",n.en="en",n.ja="ja",n.ko="ko",n.hi="hi",n.zh="zh",n.pt="pt",n.es="es"})(Hr||(Hr={}));var Kr;(function(n){n.MASK_MODE_DEFAULT="MASK_MODE_DEFAULT",n.MASK_MODE_USER_PROVIDED="MASK_MODE_USER_PROVIDED",n.MASK_MODE_BACKGROUND="MASK_MODE_BACKGROUND",n.MASK_MODE_FOREGROUND="MASK_MODE_FOREGROUND",n.MASK_MODE_SEMANTIC="MASK_MODE_SEMANTIC"})(Kr||(Kr={}));var qr;(function(n){n.CONTROL_TYPE_DEFAULT="CONTROL_TYPE_DEFAULT",n.CONTROL_TYPE_CANNY="CONTROL_TYPE_CANNY",n.CONTROL_TYPE_SCRIBBLE="CONTROL_TYPE_SCRIBBLE",n.CONTROL_TYPE_FACE_MESH="CONTROL_TYPE_FACE_MESH"})(qr||(qr={}));var Yr;(function(n){n.SUBJECT_TYPE_DEFAULT="SUBJECT_TYPE_DEFAULT",n.SUBJECT_TYPE_PERSON="SUBJECT_TYPE_PERSON",n.SUBJECT_TYPE_ANIMAL="SUBJECT_TYPE_ANIMAL",n.SUBJECT_TYPE_PRODUCT="SUBJECT_TYPE_PRODUCT"})(Yr||(Yr={}));var Wr;(function(n){n.EDIT_MODE_DEFAULT="EDIT_MODE_DEFAULT",n.EDIT_MODE_INPAINT_REMOVAL="EDIT_MODE_INPAINT_REMOVAL",n.EDIT_MODE_INPAINT_INSERTION="EDIT_MODE_INPAINT_INSERTION",n.EDIT_MODE_OUTPAINT="EDIT_MODE_OUTPAINT",n.EDIT_MODE_CONTROLLED_EDITING="EDIT_MODE_CONTROLLED_EDITING",n.EDIT_MODE_STYLE="EDIT_MODE_STYLE",n.EDIT_MODE_BGSWAP="EDIT_MODE_BGSWAP",n.EDIT_MODE_PRODUCT_IMAGE="EDIT_MODE_PRODUCT_IMAGE"})(Wr||(Wr={}));var Jr;(function(n){n.FOREGROUND="FOREGROUND",n.BACKGROUND="BACKGROUND",n.PROMPT="PROMPT",n.SEMANTIC="SEMANTIC",n.INTERACTIVE="INTERACTIVE"})(Jr||(Jr={}));var zr;(function(n){n.ASSET="ASSET",n.STYLE="STYLE"})(zr||(zr={}));var Xr;(function(n){n.INSERT="INSERT",n.REMOVE="REMOVE",n.REMOVE_STATIC="REMOVE_STATIC",n.OUTPAINT="OUTPAINT"})(Xr||(Xr={}));var Qr;(function(n){n.OPTIMIZED="OPTIMIZED",n.LOSSLESS="LOSSLESS"})(Qr||(Qr={}));var Zr;(function(n){n.SUPERVISED_FINE_TUNING="SUPERVISED_FINE_TUNING",n.PREFERENCE_TUNING="PREFERENCE_TUNING",n.DISTILLATION="DISTILLATION"})(Zr||(Zr={}));var jr;(function(n){n.STATE_UNSPECIFIED="STATE_UNSPECIFIED",n.STATE_PENDING="STATE_PENDING",n.STATE_ACTIVE="STATE_ACTIVE",n.STATE_FAILED="STATE_FAILED"})(jr||(jr={}));var eo;(function(n){n.STATE_UNSPECIFIED="STATE_UNSPECIFIED",n.PROCESSING="PROCESSING",n.ACTIVE="ACTIVE",n.FAILED="FAILED"})(eo||(eo={}));var to;(function(n){n.SOURCE_UNSPECIFIED="SOURCE_UNSPECIFIED",n.UPLOADED="UPLOADED",n.GENERATED="GENERATED",n.REGISTERED="REGISTERED"})(to||(to={}));var io;(function(n){n.TURN_COMPLETE_REASON_UNSPECIFIED="TURN_COMPLETE_REASON_UNSPECIFIED",n.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",n.RESPONSE_REJECTED="RESPONSE_REJECTED",n.NEED_MORE_INPUT="NEED_MORE_INPUT"})(io||(io={}));var no;(function(n){n.MODALITY_UNSPECIFIED="MODALITY_UNSPECIFIED",n.TEXT="TEXT",n.IMAGE="IMAGE",n.VIDEO="VIDEO",n.AUDIO="AUDIO",n.DOCUMENT="DOCUMENT"})(no||(no={}));var so;(function(n){n.VAD_SIGNAL_TYPE_UNSPECIFIED="VAD_SIGNAL_TYPE_UNSPECIFIED",n.VAD_SIGNAL_TYPE_SOS="VAD_SIGNAL_TYPE_SOS",n.VAD_SIGNAL_TYPE_EOS="VAD_SIGNAL_TYPE_EOS"})(so||(so={}));var ro;(function(n){n.TYPE_UNSPECIFIED="TYPE_UNSPECIFIED",n.ACTIVITY_START="ACTIVITY_START",n.ACTIVITY_END="ACTIVITY_END"})(ro||(ro={}));var oo;(function(n){n.START_SENSITIVITY_UNSPECIFIED="START_SENSITIVITY_UNSPECIFIED",n.START_SENSITIVITY_HIGH="START_SENSITIVITY_HIGH",n.START_SENSITIVITY_LOW="START_SENSITIVITY_LOW"})(oo||(oo={}));var ao;(function(n){n.END_SENSITIVITY_UNSPECIFIED="END_SENSITIVITY_UNSPECIFIED",n.END_SENSITIVITY_HIGH="END_SENSITIVITY_HIGH",n.END_SENSITIVITY_LOW="END_SENSITIVITY_LOW"})(ao||(ao={}));var lo;(function(n){n.ACTIVITY_HANDLING_UNSPECIFIED="ACTIVITY_HANDLING_UNSPECIFIED",n.START_OF_ACTIVITY_INTERRUPTS="START_OF_ACTIVITY_INTERRUPTS",n.NO_INTERRUPTION="NO_INTERRUPTION"})(lo||(lo={}));var uo;(function(n){n.TURN_COVERAGE_UNSPECIFIED="TURN_COVERAGE_UNSPECIFIED",n.TURN_INCLUDES_ONLY_ACTIVITY="TURN_INCLUDES_ONLY_ACTIVITY",n.TURN_INCLUDES_ALL_INPUT="TURN_INCLUDES_ALL_INPUT"})(uo||(uo={}));var co;(function(n){n.SCALE_UNSPECIFIED="SCALE_UNSPECIFIED",n.C_MAJOR_A_MINOR="C_MAJOR_A_MINOR",n.D_FLAT_MAJOR_B_FLAT_MINOR="D_FLAT_MAJOR_B_FLAT_MINOR",n.D_MAJOR_B_MINOR="D_MAJOR_B_MINOR",n.E_FLAT_MAJOR_C_MINOR="E_FLAT_MAJOR_C_MINOR",n.E_MAJOR_D_FLAT_MINOR="E_MAJOR_D_FLAT_MINOR",n.F_MAJOR_D_MINOR="F_MAJOR_D_MINOR",n.G_FLAT_MAJOR_E_FLAT_MINOR="G_FLAT_MAJOR_E_FLAT_MINOR",n.G_MAJOR_E_MINOR="G_MAJOR_E_MINOR",n.A_FLAT_MAJOR_F_MINOR="A_FLAT_MAJOR_F_MINOR",n.A_MAJOR_G_FLAT_MINOR="A_MAJOR_G_FLAT_MINOR",n.B_FLAT_MAJOR_G_MINOR="B_FLAT_MAJOR_G_MINOR",n.B_MAJOR_A_FLAT_MINOR="B_MAJOR_A_FLAT_MINOR"})(co||(co={}));var fo;(function(n){n.MUSIC_GENERATION_MODE_UNSPECIFIED="MUSIC_GENERATION_MODE_UNSPECIFIED",n.QUALITY="QUALITY",n.DIVERSITY="DIVERSITY",n.VOCALIZATION="VOCALIZATION"})(fo||(fo={}));var Ot;(function(n){n.PLAYBACK_CONTROL_UNSPECIFIED="PLAYBACK_CONTROL_UNSPECIFIED",n.PLAY="PLAY",n.PAUSE="PAUSE",n.STOP="STOP",n.RESET_CONTEXT="RESET_CONTEXT"})(Ot||(Ot={}));class Zn{constructor(e){const t={};for(const i of e.headers.entries())t[i[0]]=i[1];this.headers=t,this.responseInternal=e}json(){return this.responseInternal.json()}}class ei{get text(){var e,t,i,s,r,o,a,u;if(((s=(i=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||i===void 0?void 0:i.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning text from the first one.");let l="",c=!1;const f=[];for(const p of(u=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)!==null&&u!==void 0?u:[]){for(const[g,m]of Object.entries(p))g!=="text"&&g!=="thought"&&g!=="thoughtSignature"&&(m!==null||m!==void 0)&&f.push(g);if(typeof p.text=="string"){if(typeof p.thought=="boolean"&&p.thought)continue;c=!0,l+=p.text}}return f.length>0&&console.warn(`there are non-text parts ${f} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),c?l:void 0}get data(){var e,t,i,s,r,o,a,u;if(((s=(i=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||i===void 0?void 0:i.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning data from the first one.");let l="";const c=[];for(const f of(u=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)!==null&&u!==void 0?u:[]){for(const[p,g]of Object.entries(f))p!=="inlineData"&&(g!==null||g!==void 0)&&c.push(p);f.inlineData&&typeof f.inlineData.data=="string"&&(l+=atob(f.inlineData.data))}return c.length>0&&console.warn(`there are non-data parts ${c} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),l.length>0?btoa(l):void 0}get functionCalls(){var e,t,i,s,r,o,a,u;if(((s=(i=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||i===void 0?void 0:i.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning function calls from the first one.");const l=(u=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||u===void 0?void 0:u.filter(c=>c.functionCall).map(c=>c.functionCall).filter(c=>c!==void 0);if((l==null?void 0:l.length)!==0)return l}get executableCode(){var e,t,i,s,r,o,a,u,l;if(((s=(i=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||i===void 0?void 0:i.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning executable code from the first one.");const c=(u=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||u===void 0?void 0:u.filter(f=>f.executableCode).map(f=>f.executableCode).filter(f=>f!==void 0);if((c==null?void 0:c.length)!==0)return(l=c==null?void 0:c[0])===null||l===void 0?void 0:l.code}get codeExecutionResult(){var e,t,i,s,r,o,a,u,l;if(((s=(i=(t=(e=this.candidates)===null||e===void 0?void 0:e[0])===null||t===void 0?void 0:t.content)===null||i===void 0?void 0:i.parts)===null||s===void 0?void 0:s.length)===0)return;this.candidates&&this.candidates.length>1&&console.warn("there are multiple candidates in the response, returning code execution result from the first one.");const c=(u=(a=(o=(r=this.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content)===null||a===void 0?void 0:a.parts)===null||u===void 0?void 0:u.filter(f=>f.codeExecutionResult).map(f=>f.codeExecutionResult).filter(f=>f!==void 0);if((c==null?void 0:c.length)!==0)return(l=c==null?void 0:c[0])===null||l===void 0?void 0:l.output}}class ho{}class po{}class td{}class id{}class nd{}class sd{}class go{}class mo{}class yo{}class rd{}class Ji{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){const i=new Ji;let s;const r=e;return t?s=Hc(r):s=Vc(r),Object.assign(i,s),i}}class Eo{}class To{}class vo{}class So{}class od{}class ad{}class ld{}class Ds{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){const i=new Ds,r=Xc(e);return Object.assign(i,r),i}}class ud{}class cd{}class dd{}class fd{}class Ao{}class hd{get text(){var e,t,i;let s="",r=!1;const o=[];for(const a of(i=(t=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||t===void 0?void 0:t.parts)!==null&&i!==void 0?i:[]){for(const[u,l]of Object.entries(a))u!=="text"&&u!=="thought"&&l!==null&&o.push(u);if(typeof a.text=="string"){if(typeof a.thought=="boolean"&&a.thought)continue;r=!0,s+=a.text}}return o.length>0&&console.warn(`there are non-text parts ${o} in the response, returning concatenation of all text parts. Please refer to the non text parts for a full response from model.`),r?s:void 0}get data(){var e,t,i;let s="";const r=[];for(const o of(i=(t=(e=this.serverContent)===null||e===void 0?void 0:e.modelTurn)===null||t===void 0?void 0:t.parts)!==null&&i!==void 0?i:[]){for(const[a,u]of Object.entries(o))a!=="inlineData"&&u!==null&&r.push(a);o.inlineData&&typeof o.inlineData.data=="string"&&(s+=atob(o.inlineData.data))}return r.length>0&&console.warn(`there are non-data parts ${r} in the response, returning concatenation of all data parts. Please refer to the non data parts for a full response from model.`),s.length>0?btoa(s):void 0}}class pd{get audioChunk(){if(this.serverContent&&this.serverContent.audioChunks&&this.serverContent.audioChunks.length>0)return this.serverContent.audioChunks[0]}}class bs{_fromAPIResponse({apiResponse:e,_isVertexAI:t}){const i=new bs,r=cl(e);return Object.assign(i,r),i}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function se(n,e){if(!e||typeof e!="string")throw new Error("model is required and must be a string");if(e.includes("..")||e.includes("?")||e.includes("&"))throw new Error("invalid model parameter");if(n.isVertexAI()){if(e.startsWith("publishers/")||e.startsWith("projects/")||e.startsWith("models/"))return e;if(e.indexOf("/")>=0){const t=e.split("/",2);return`publishers/${t[0]}/models/${t[1]}`}else return`publishers/google/models/${e}`}else return e.startsWith("models/")||e.startsWith("tunedModels/")?e:`models/${e}`}function dl(n,e){const t=se(n,e);return t?t.startsWith("publishers/")&&n.isVertexAI()?`projects/${n.getProject()}/locations/${n.getLocation()}/${t}`:t.startsWith("models/")&&n.isVertexAI()?`projects/${n.getProject()}/locations/${n.getLocation()}/publishers/google/${t}`:t:""}function fl(n){return Array.isArray(n)?n.map(e=>zi(e)):[zi(n)]}function zi(n){if(typeof n=="object"&&n!==null)return n;throw new Error(`Could not parse input as Blob. Unsupported blob type: ${typeof n}`)}function hl(n){const e=zi(n);if(e.mimeType&&e.mimeType.startsWith("image/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function pl(n){const e=zi(n);if(e.mimeType&&e.mimeType.startsWith("audio/"))return e;throw new Error(`Unsupported mime type: ${e.mimeType}`)}function Io(n){if(n==null)throw new Error("PartUnion is required");if(typeof n=="object")return n;if(typeof n=="string")return{text:n};throw new Error(`Unsupported part type: ${typeof n}`)}function gl(n){if(n==null||Array.isArray(n)&&n.length===0)throw new Error("PartListUnion is required");return Array.isArray(n)?n.map(e=>Io(e)):[Io(n)]}function jn(n){return n!=null&&typeof n=="object"&&"parts"in n&&Array.isArray(n.parts)}function _o(n){return n!=null&&typeof n=="object"&&"functionCall"in n}function Ro(n){return n!=null&&typeof n=="object"&&"functionResponse"in n}function Re(n){if(n==null)throw new Error("ContentUnion is required");return jn(n)?n:{role:"user",parts:gl(n)}}function ws(n,e){if(!e)return[];if(n.isVertexAI()&&Array.isArray(e))return e.flatMap(t=>{const i=Re(t);return i.parts&&i.parts.length>0&&i.parts[0].text!==void 0?[i.parts[0].text]:[]});if(n.isVertexAI()){const t=Re(e);return t.parts&&t.parts.length>0&&t.parts[0].text!==void 0?[t.parts[0].text]:[]}return Array.isArray(e)?e.map(t=>Re(t)):[Re(e)]}function Oe(n){if(n==null||Array.isArray(n)&&n.length===0)throw new Error("contents are required");if(!Array.isArray(n)){if(_o(n)||Ro(n))throw new Error("To specify functionCall or functionResponse parts, please wrap them in a Content object, specifying the role for them");return[Re(n)]}const e=[],t=[],i=jn(n[0]);for(const s of n){const r=jn(s);if(r!=i)throw new Error("Mixing Content and Parts is not supported, please group the parts into a the appropriate Content objects and specify the roles for them");if(r)e.push(s);else{if(_o(s)||Ro(s))throw new Error("To specify functionCall or functionResponse parts, please wrap them, and any other parts, in Content objects as appropriate, specifying the role for them");t.push(s)}}return i||e.push({role:"user",parts:gl(t)}),e}function gd(n,e){n.includes("null")&&(e.nullable=!0);const t=n.filter(i=>i!=="null");if(t.length===1)e.type=Object.values(pt).includes(t[0].toUpperCase())?t[0].toUpperCase():pt.TYPE_UNSPECIFIED;else{e.anyOf=[];for(const i of t)e.anyOf.push({type:Object.values(pt).includes(i.toUpperCase())?i.toUpperCase():pt.TYPE_UNSPECIFIED})}}function Gt(n){const e={},t=["items"],i=["anyOf"],s=["properties"];if(n.type&&n.anyOf)throw new Error("type and anyOf cannot be both populated.");const r=n.anyOf;r!=null&&r.length==2&&(r[0].type==="null"?(e.nullable=!0,n=r[1]):r[1].type==="null"&&(e.nullable=!0,n=r[0])),n.type instanceof Array&&gd(n.type,e);for(const[o,a]of Object.entries(n))if(a!=null)if(o=="type"){if(a==="null")throw new Error("type: null can not be the only possible type for the field.");if(a instanceof Array)continue;e.type=Object.values(pt).includes(a.toUpperCase())?a.toUpperCase():pt.TYPE_UNSPECIFIED}else if(t.includes(o))e[o]=Gt(a);else if(i.includes(o)){const u=[];for(const l of a){if(l.type=="null"){e.nullable=!0;continue}u.push(Gt(l))}e[o]=u}else if(s.includes(o)){const u={};for(const[l,c]of Object.entries(a))u[l]=Gt(c);e[o]=u}else{if(o==="additionalProperties")continue;e[o]=a}return e}function ks(n){return Gt(n)}function Ms(n){if(typeof n=="object")return n;if(typeof n=="string")return{voiceConfig:{prebuiltVoiceConfig:{voiceName:n}}};throw new Error(`Unsupported speechConfig type: ${typeof n}`)}function Ns(n){if("multiSpeakerVoiceConfig"in n)throw new Error("multiSpeakerVoiceConfig is not supported in the live API.");return n}function zt(n){if(n.functionDeclarations)for(const e of n.functionDeclarations)e.parameters&&(Object.keys(e.parameters).includes("$schema")?e.parametersJsonSchema||(e.parametersJsonSchema=e.parameters,delete e.parameters):e.parameters=Gt(e.parameters)),e.response&&(Object.keys(e.response).includes("$schema")?e.responseJsonSchema||(e.responseJsonSchema=e.response,delete e.response):e.response=Gt(e.response));return n}function Xt(n){if(n==null)throw new Error("tools is required");if(!Array.isArray(n))throw new Error("tools is required and must be an array of Tools");const e=[];for(const t of n)e.push(t);return e}function md(n,e,t,i=1){const s=!e.startsWith(`${t}/`)&&e.split("/").length===i;return n.isVertexAI()?e.startsWith("projects/")?e:e.startsWith("locations/")?`projects/${n.getProject()}/${e}`:e.startsWith(`${t}/`)?`projects/${n.getProject()}/locations/${n.getLocation()}/${e}`:s?`projects/${n.getProject()}/locations/${n.getLocation()}/${t}/${e}`:e:s?`${t}/${e}`:e}function ut(n,e){if(typeof e!="string")throw new Error("name must be a string");return md(n,e,"cachedContents")}function ml(n){switch(n){case"STATE_UNSPECIFIED":return"JOB_STATE_UNSPECIFIED";case"CREATING":return"JOB_STATE_RUNNING";case"ACTIVE":return"JOB_STATE_SUCCEEDED";case"FAILED":return"JOB_STATE_FAILED";default:return n}}function Et(n){return Ps(n)}function yd(n){return n!=null&&typeof n=="object"&&"name"in n}function Ed(n){return n!=null&&typeof n=="object"&&"video"in n}function Td(n){return n!=null&&typeof n=="object"&&"uri"in n}function yl(n){var e;let t;if(yd(n)&&(t=n.name),!(Td(n)&&(t=n.uri,t===void 0))&&!(Ed(n)&&(t=(e=n.video)===null||e===void 0?void 0:e.uri,t===void 0))){if(typeof n=="string"&&(t=n),t===void 0)throw new Error("Could not extract file name from the provided input.");if(t.startsWith("https://")){const s=t.split("files/")[1].match(/[a-z0-9]+/);if(s===null)throw new Error(`Could not extract file name from URI ${t}`);t=s[0]}else t.startsWith("files/")&&(t=t.split("files/")[1]);return t}}function El(n,e){let t;return n.isVertexAI()?t=e?"publishers/google/models":"models":t=e?"models":"tunedModels",t}function Tl(n){for(const e of["models","tunedModels","publisherModels"])if(vd(n,e))return n[e];return[]}function vd(n,e){return n!==null&&typeof n=="object"&&e in n}function Sd(n,e={}){const t=n,i={name:t.name,description:t.description,parametersJsonSchema:t.inputSchema};return t.outputSchema&&(i.responseJsonSchema=t.outputSchema),e.behavior&&(i.behavior=e.behavior),{functionDeclarations:[i]}}function Ad(n,e={}){const t=[],i=new Set;for(const s of n){const r=s.name;if(i.has(r))throw new Error(`Duplicate function name ${r} found in MCP tools. Please ensure function names are unique.`);i.add(r);const o=Sd(s,e);o.functionDeclarations&&t.push(...o.functionDeclarations)}return{functionDeclarations:t}}function vl(n,e){let t;if(typeof e=="string")if(n.isVertexAI())if(e.startsWith("gs://"))t={format:"jsonl",gcsUri:[e]};else if(e.startsWith("bq://"))t={format:"bigquery",bigqueryUri:e};else throw new Error(`Unsupported string source for Vertex AI: ${e}`);else if(e.startsWith("files/"))t={fileName:e};else throw new Error(`Unsupported string source for Gemini API: ${e}`);else if(Array.isArray(e)){if(n.isVertexAI())throw new Error("InlinedRequest[] is not supported in Vertex AI.");t={inlinedRequests:e}}else t=e;const i=[t.gcsUri,t.bigqueryUri].filter(Boolean).length,s=[t.inlinedRequests,t.fileName].filter(Boolean).length;if(n.isVertexAI()){if(s>0||i!==1)throw new Error("Exactly one of `gcsUri` or `bigqueryUri` must be set for Vertex AI.")}else if(i>0||s!==1)throw new Error("Exactly one of `inlinedRequests`, `fileName`, must be set for Gemini API.");return t}function Id(n){if(typeof n!="string")return n;const e=n;if(e.startsWith("gs://"))return{format:"jsonl",gcsUri:e};if(e.startsWith("bq://"))return{format:"bigquery",bigqueryUri:e};throw new Error(`Unsupported destination: ${e}`)}function Sl(n){if(typeof n!="object"||n===null)return{};const e=n,t=e.inlinedResponses;if(typeof t!="object"||t===null)return n;const s=t.inlinedResponses;if(!Array.isArray(s)||s.length===0)return n;let r=!1;for(const o of s){if(typeof o!="object"||o===null)continue;const u=o.response;if(typeof u!="object"||u===null)continue;if(u.embedding!==void 0){r=!0;break}}return r&&(e.inlinedEmbedContentResponses=e.inlinedResponses,delete e.inlinedResponses),n}function Qt(n,e){const t=e;if(!n.isVertexAI()){if(/batches\/[^/]+$/.test(t))return t.split("/").pop();throw new Error(`Invalid batch job name: ${t}.`)}if(/^projects\/[^/]+\/locations\/[^/]+\/batchPredictionJobs\/[^/]+$/.test(t))return t.split("/").pop();if(/^\d+$/.test(t))return t;throw new Error(`Invalid batch job name: ${t}.`)}function Al(n){const e=n;return e==="BATCH_STATE_UNSPECIFIED"?"JOB_STATE_UNSPECIFIED":e==="BATCH_STATE_PENDING"?"JOB_STATE_PENDING":e==="BATCH_STATE_RUNNING"?"JOB_STATE_RUNNING":e==="BATCH_STATE_SUCCEEDED"?"JOB_STATE_SUCCEEDED":e==="BATCH_STATE_FAILED"?"JOB_STATE_FAILED":e==="BATCH_STATE_CANCELLED"?"JOB_STATE_CANCELLED":e==="BATCH_STATE_EXPIRED"?"JOB_STATE_EXPIRED":e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function _d(n){const e={},t=d(n,["responsesFile"]);t!=null&&h(e,["fileName"],t);const i=d(n,["inlinedResponses","inlinedResponses"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>rf(o))),h(e,["inlinedResponses"],r)}const s=d(n,["inlinedEmbedContentResponses","inlinedResponses"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["inlinedEmbedContentResponses"],r)}return e}function Rd(n){const e={},t=d(n,["predictionsFormat"]);t!=null&&h(e,["format"],t);const i=d(n,["gcsDestination","outputUriPrefix"]);i!=null&&h(e,["gcsUri"],i);const s=d(n,["bigqueryDestination","outputUri"]);return s!=null&&h(e,["bigqueryUri"],s),e}function xd(n){const e={},t=d(n,["format"]);t!=null&&h(e,["predictionsFormat"],t);const i=d(n,["gcsUri"]);i!=null&&h(e,["gcsDestination","outputUriPrefix"],i);const s=d(n,["bigqueryUri"]);if(s!=null&&h(e,["bigqueryDestination","outputUri"],s),d(n,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(d(n,["inlinedResponses"])!==void 0)throw new Error("inlinedResponses parameter is not supported in Vertex AI.");if(d(n,["inlinedEmbedContentResponses"])!==void 0)throw new Error("inlinedEmbedContentResponses parameter is not supported in Vertex AI.");return e}function Ui(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata","displayName"]);i!=null&&h(e,["displayName"],i);const s=d(n,["metadata","state"]);s!=null&&h(e,["state"],Al(s));const r=d(n,["metadata","createTime"]);r!=null&&h(e,["createTime"],r);const o=d(n,["metadata","endTime"]);o!=null&&h(e,["endTime"],o);const a=d(n,["metadata","updateTime"]);a!=null&&h(e,["updateTime"],a);const u=d(n,["metadata","model"]);u!=null&&h(e,["model"],u);const l=d(n,["metadata","output"]);return l!=null&&h(e,["dest"],_d(Sl(l))),e}function es(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["displayName"]);i!=null&&h(e,["displayName"],i);const s=d(n,["state"]);s!=null&&h(e,["state"],Al(s));const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["createTime"]);o!=null&&h(e,["createTime"],o);const a=d(n,["startTime"]);a!=null&&h(e,["startTime"],a);const u=d(n,["endTime"]);u!=null&&h(e,["endTime"],u);const l=d(n,["updateTime"]);l!=null&&h(e,["updateTime"],l);const c=d(n,["model"]);c!=null&&h(e,["model"],c);const f=d(n,["inputConfig"]);f!=null&&h(e,["src"],Cd(f));const p=d(n,["outputConfig"]);p!=null&&h(e,["dest"],Rd(Sl(p)));const g=d(n,["completionStats"]);return g!=null&&h(e,["completionStats"],g),e}function Cd(n){const e={},t=d(n,["instancesFormat"]);t!=null&&h(e,["format"],t);const i=d(n,["gcsSource","uris"]);i!=null&&h(e,["gcsUri"],i);const s=d(n,["bigquerySource","inputUri"]);return s!=null&&h(e,["bigqueryUri"],s),e}function Ld(n,e){const t={};if(d(e,["format"])!==void 0)throw new Error("format parameter is not supported in Gemini API.");if(d(e,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(d(e,["bigqueryUri"])!==void 0)throw new Error("bigqueryUri parameter is not supported in Gemini API.");const i=d(e,["fileName"]);i!=null&&h(t,["fileName"],i);const s=d(e,["inlinedRequests"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>sf(n,o))),h(t,["requests","requests"],r)}return t}function Pd(n){const e={},t=d(n,["format"]);t!=null&&h(e,["instancesFormat"],t);const i=d(n,["gcsUri"]);i!=null&&h(e,["gcsSource","uris"],i);const s=d(n,["bigqueryUri"]);if(s!=null&&h(e,["bigquerySource","inputUri"],s),d(n,["fileName"])!==void 0)throw new Error("fileName parameter is not supported in Vertex AI.");if(d(n,["inlinedRequests"])!==void 0)throw new Error("inlinedRequests parameter is not supported in Vertex AI.");return e}function Dd(n){const e={},t=d(n,["data"]);if(t!=null&&h(e,["data"],t),d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function bd(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function wd(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function kd(n){const e={},t=d(n,["content"]);t!=null&&h(e,["content"],t);const i=d(n,["citationMetadata"]);i!=null&&h(e,["citationMetadata"],Md(i));const s=d(n,["tokenCount"]);s!=null&&h(e,["tokenCount"],s);const r=d(n,["finishReason"]);r!=null&&h(e,["finishReason"],r);const o=d(n,["avgLogprobs"]);o!=null&&h(e,["avgLogprobs"],o);const a=d(n,["groundingMetadata"]);a!=null&&h(e,["groundingMetadata"],a);const u=d(n,["index"]);u!=null&&h(e,["index"],u);const l=d(n,["logprobsResult"]);l!=null&&h(e,["logprobsResult"],l);const c=d(n,["safetyRatings"]);if(c!=null){let p=c;Array.isArray(p)&&(p=p.map(g=>g)),h(e,["safetyRatings"],p)}const f=d(n,["urlContextMetadata"]);return f!=null&&h(e,["urlContextMetadata"],f),e}function Md(n){const e={},t=d(n,["citationSources"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(s=>s)),h(e,["citations"],i)}return e}function Il(n){const e={},t=d(n,["parts"]);if(t!=null){let s=t;Array.isArray(s)&&(s=s.map(r=>ff(r))),h(e,["parts"],s)}const i=d(n,["role"]);return i!=null&&h(e,["role"],i),e}function Nd(n,e){const t={},i=d(n,["displayName"]);if(e!==void 0&&i!=null&&h(e,["batch","displayName"],i),d(n,["dest"])!==void 0)throw new Error("dest parameter is not supported in Gemini API.");return t}function Fd(n,e){const t={},i=d(n,["displayName"]);e!==void 0&&i!=null&&h(e,["displayName"],i);const s=d(n,["dest"]);return e!==void 0&&s!=null&&h(e,["outputConfig"],xd(Id(s))),t}function xo(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["_url","model"],se(n,i));const s=d(e,["src"]);s!=null&&h(t,["batch","inputConfig"],Ld(n,vl(n,s)));const r=d(e,["config"]);return r!=null&&Nd(r,t),t}function Ud(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["model"],se(n,i));const s=d(e,["src"]);s!=null&&h(t,["inputConfig"],Pd(vl(n,s)));const r=d(e,["config"]);return r!=null&&Fd(r,t),t}function Od(n,e){const t={},i=d(n,["displayName"]);return e!==void 0&&i!=null&&h(e,["batch","displayName"],i),t}function Bd(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["_url","model"],se(n,i));const s=d(e,["src"]);s!=null&&h(t,["batch","inputConfig"],Yd(n,s));const r=d(e,["config"]);return r!=null&&Od(r,t),t}function $d(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function Gd(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function Vd(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["name"]);i!=null&&h(e,["name"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);return r!=null&&h(e,["error"],r),e}function Hd(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["name"]);i!=null&&h(e,["name"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);return r!=null&&h(e,["error"],r),e}function Kd(n,e){const t={},i=d(e,["contents"]);if(i!=null){let r=ws(n,i);Array.isArray(r)&&(r=r.map(o=>o)),h(t,["requests[]","request","content"],r)}const s=d(e,["config"]);return s!=null&&(h(t,["_self"],qd(s,t)),$c(t,{"requests[].*":"requests[].request.*"})),t}function qd(n,e){const t={},i=d(n,["taskType"]);e!==void 0&&i!=null&&h(e,["requests[]","taskType"],i);const s=d(n,["title"]);e!==void 0&&s!=null&&h(e,["requests[]","title"],s);const r=d(n,["outputDimensionality"]);if(e!==void 0&&r!=null&&h(e,["requests[]","outputDimensionality"],r),d(n,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(d(n,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return t}function Yd(n,e){const t={},i=d(e,["fileName"]);i!=null&&h(t,["file_name"],i);const s=d(e,["inlinedRequests"]);return s!=null&&h(t,["requests"],Kd(n,s)),t}function Wd(n){const e={};if(d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const t=d(n,["fileUri"]);t!=null&&h(e,["fileUri"],t);const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function Jd(n){const e={},t=d(n,["id"]);t!=null&&h(e,["id"],t);const i=d(n,["args"]);i!=null&&h(e,["args"],i);const s=d(n,["name"]);if(s!=null&&h(e,["name"],s),d(n,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(d(n,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function zd(n){const e={},t=d(n,["allowedFunctionNames"]);t!=null&&h(e,["allowedFunctionNames"],t);const i=d(n,["mode"]);if(i!=null&&h(e,["mode"],i),d(n,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return e}function Xd(n,e,t){const i={},s=d(e,["systemInstruction"]);t!==void 0&&s!=null&&h(t,["systemInstruction"],Il(Re(s)));const r=d(e,["temperature"]);r!=null&&h(i,["temperature"],r);const o=d(e,["topP"]);o!=null&&h(i,["topP"],o);const a=d(e,["topK"]);a!=null&&h(i,["topK"],a);const u=d(e,["candidateCount"]);u!=null&&h(i,["candidateCount"],u);const l=d(e,["maxOutputTokens"]);l!=null&&h(i,["maxOutputTokens"],l);const c=d(e,["stopSequences"]);c!=null&&h(i,["stopSequences"],c);const f=d(e,["responseLogprobs"]);f!=null&&h(i,["responseLogprobs"],f);const p=d(e,["logprobs"]);p!=null&&h(i,["logprobs"],p);const g=d(e,["presencePenalty"]);g!=null&&h(i,["presencePenalty"],g);const m=d(e,["frequencyPenalty"]);m!=null&&h(i,["frequencyPenalty"],m);const E=d(e,["seed"]);E!=null&&h(i,["seed"],E);const y=d(e,["responseMimeType"]);y!=null&&h(i,["responseMimeType"],y);const v=d(e,["responseSchema"]);v!=null&&h(i,["responseSchema"],ks(v));const S=d(e,["responseJsonSchema"]);if(S!=null&&h(i,["responseJsonSchema"],S),d(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(d(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");const A=d(e,["safetySettings"]);if(t!==void 0&&A!=null){let U=A;Array.isArray(U)&&(U=U.map($=>hf($))),h(t,["safetySettings"],U)}const _=d(e,["tools"]);if(t!==void 0&&_!=null){let U=Xt(_);Array.isArray(U)&&(U=U.map($=>gf(zt($)))),h(t,["tools"],U)}const I=d(e,["toolConfig"]);if(t!==void 0&&I!=null&&h(t,["toolConfig"],pf(I)),d(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const P=d(e,["cachedContent"]);t!==void 0&&P!=null&&h(t,["cachedContent"],ut(n,P));const R=d(e,["responseModalities"]);R!=null&&h(i,["responseModalities"],R);const L=d(e,["mediaResolution"]);L!=null&&h(i,["mediaResolution"],L);const C=d(e,["speechConfig"]);if(C!=null&&h(i,["speechConfig"],Ms(C)),d(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");const x=d(e,["thinkingConfig"]);x!=null&&h(i,["thinkingConfig"],x);const w=d(e,["imageConfig"]);w!=null&&h(i,["imageConfig"],nf(w));const M=d(e,["enableEnhancedCivicAnswers"]);if(M!=null&&h(i,["enableEnhancedCivicAnswers"],M),d(e,["modelArmorConfig"])!==void 0)throw new Error("modelArmorConfig parameter is not supported in Gemini API.");return i}function Qd(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["candidates"]);if(i!=null){let u=i;Array.isArray(u)&&(u=u.map(l=>kd(l))),h(e,["candidates"],u)}const s=d(n,["modelVersion"]);s!=null&&h(e,["modelVersion"],s);const r=d(n,["promptFeedback"]);r!=null&&h(e,["promptFeedback"],r);const o=d(n,["responseId"]);o!=null&&h(e,["responseId"],o);const a=d(n,["usageMetadata"]);return a!=null&&h(e,["usageMetadata"],a),e}function Zd(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function jd(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],Qt(n,i)),t}function ef(n){const e={};if(d(n,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const t=d(n,["enableWidget"]);return t!=null&&h(e,["enableWidget"],t),e}function tf(n){const e={};if(d(n,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(d(n,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const t=d(n,["timeRangeFilter"]);return t!=null&&h(e,["timeRangeFilter"],t),e}function nf(n){const e={},t=d(n,["aspectRatio"]);t!=null&&h(e,["aspectRatio"],t);const i=d(n,["imageSize"]);if(i!=null&&h(e,["imageSize"],i),d(n,["personGeneration"])!==void 0)throw new Error("personGeneration parameter is not supported in Gemini API.");if(d(n,["outputMimeType"])!==void 0)throw new Error("outputMimeType parameter is not supported in Gemini API.");if(d(n,["outputCompressionQuality"])!==void 0)throw new Error("outputCompressionQuality parameter is not supported in Gemini API.");return e}function sf(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["request","model"],se(n,i));const s=d(e,["contents"]);if(s!=null){let a=Oe(s);Array.isArray(a)&&(a=a.map(u=>Il(u))),h(t,["request","contents"],a)}const r=d(e,["metadata"]);r!=null&&h(t,["metadata"],r);const o=d(e,["config"]);return o!=null&&h(t,["request","generationConfig"],Xd(n,o,d(t,["request"],{}))),t}function rf(n){const e={},t=d(n,["response"]);t!=null&&h(e,["response"],Qd(t));const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["error"]);return s!=null&&h(e,["error"],s),e}function of(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);if(e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),d(n,["filter"])!==void 0)throw new Error("filter parameter is not supported in Gemini API.");return t}function af(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);e!==void 0&&s!=null&&h(e,["_query","pageToken"],s);const r=d(n,["filter"]);return e!==void 0&&r!=null&&h(e,["_query","filter"],r),t}function lf(n){const e={},t=d(n,["config"]);return t!=null&&of(t,e),e}function uf(n){const e={},t=d(n,["config"]);return t!=null&&af(t,e),e}function cf(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["operations"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>Ui(o))),h(e,["batchJobs"],r)}return e}function df(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["batchPredictionJobs"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>es(o))),h(e,["batchJobs"],r)}return e}function ff(n){const e={},t=d(n,["mediaResolution"]);t!=null&&h(e,["mediaResolution"],t);const i=d(n,["codeExecutionResult"]);i!=null&&h(e,["codeExecutionResult"],i);const s=d(n,["executableCode"]);s!=null&&h(e,["executableCode"],s);const r=d(n,["fileData"]);r!=null&&h(e,["fileData"],Wd(r));const o=d(n,["functionCall"]);o!=null&&h(e,["functionCall"],Jd(o));const a=d(n,["functionResponse"]);a!=null&&h(e,["functionResponse"],a);const u=d(n,["inlineData"]);u!=null&&h(e,["inlineData"],Dd(u));const l=d(n,["text"]);l!=null&&h(e,["text"],l);const c=d(n,["thought"]);c!=null&&h(e,["thought"],c);const f=d(n,["thoughtSignature"]);f!=null&&h(e,["thoughtSignature"],f);const p=d(n,["videoMetadata"]);return p!=null&&h(e,["videoMetadata"],p),e}function hf(n){const e={},t=d(n,["category"]);if(t!=null&&h(e,["category"],t),d(n,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");const i=d(n,["threshold"]);return i!=null&&h(e,["threshold"],i),e}function pf(n){const e={},t=d(n,["retrievalConfig"]);t!=null&&h(e,["retrievalConfig"],t);const i=d(n,["functionCallingConfig"]);return i!=null&&h(e,["functionCallingConfig"],zd(i)),e}function gf(n){const e={};if(d(n,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const t=d(n,["computerUse"]);t!=null&&h(e,["computerUse"],t);const i=d(n,["fileSearch"]);i!=null&&h(e,["fileSearch"],i);const s=d(n,["codeExecution"]);if(s!=null&&h(e,["codeExecution"],s),d(n,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const r=d(n,["functionDeclarations"]);if(r!=null){let c=r;Array.isArray(c)&&(c=c.map(f=>f)),h(e,["functionDeclarations"],c)}const o=d(n,["googleMaps"]);o!=null&&h(e,["googleMaps"],ef(o));const a=d(n,["googleSearch"]);a!=null&&h(e,["googleSearch"],tf(a));const u=d(n,["googleSearchRetrieval"]);u!=null&&h(e,["googleSearchRetrieval"],u);const l=d(n,["urlContext"]);return l!=null&&h(e,["urlContext"],l),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var at;(function(n){n.PAGED_ITEM_BATCH_JOBS="batchJobs",n.PAGED_ITEM_MODELS="models",n.PAGED_ITEM_TUNING_JOBS="tuningJobs",n.PAGED_ITEM_FILES="files",n.PAGED_ITEM_CACHED_CONTENTS="cachedContents",n.PAGED_ITEM_FILE_SEARCH_STORES="fileSearchStores",n.PAGED_ITEM_DOCUMENTS="documents"})(at||(at={}));class Pt{constructor(e,t,i,s){this.pageInternal=[],this.paramsInternal={},this.requestInternal=t,this.init(e,i,s)}init(e,t,i){var s,r;this.nameInternal=e,this.pageInternal=t[this.nameInternal]||[],this.sdkHttpResponseInternal=t==null?void 0:t.sdkHttpResponse,this.idxInternal=0;let o={config:{}};!i||Object.keys(i).length===0?o={config:{}}:typeof i=="object"?o=Object.assign({},i):o=i,o.config&&(o.config.pageToken=t.nextPageToken),this.paramsInternal=o,this.pageInternalSize=(r=(s=o.config)===null||s===void 0?void 0:s.pageSize)!==null&&r!==void 0?r:this.pageInternal.length}initNextPage(e){this.init(this.nameInternal,e,this.paramsInternal)}get page(){return this.pageInternal}get name(){return this.nameInternal}get pageSize(){return this.pageInternalSize}get sdkHttpResponse(){return this.sdkHttpResponseInternal}get params(){return this.paramsInternal}get pageLength(){return this.pageInternal.length}getItem(e){return this.pageInternal[e]}[Symbol.asyncIterator](){return{next:async()=>{if(this.idxInternal>=this.pageLength)if(this.hasNextPage())await this.nextPage();else return{value:void 0,done:!0};const e=this.getItem(this.idxInternal);return this.idxInternal+=1,{value:e,done:!1}},return:async()=>({value:void 0,done:!0})}}async nextPage(){if(!this.hasNextPage())throw new Error("No more pages to fetch.");const e=await this.requestInternal(this.params);return this.initNextPage(e),this.page}hasNextPage(){var e;return((e=this.params.config)===null||e===void 0?void 0:e.pageToken)!==void 0}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class mf extends lt{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new Pt(at.PAGED_ITEM_BATCH_JOBS,i=>this.listInternal(i),await this.listInternal(t),t),this.create=async t=>(this.apiClient.isVertexAI()&&(t.config=this.formatDestination(t.src,t.config)),this.createInternal(t)),this.createEmbeddings=async t=>{if(console.warn("batches.createEmbeddings() is experimental and may change without notice."),this.apiClient.isVertexAI())throw new Error("Vertex AI does not support batches.createEmbeddings.");return this.createEmbeddingsInternal(t)}}createInlinedGenerateContentRequest(e){const t=xo(this.apiClient,e),i=t._url,s=G("{model}:batchGenerateContent",i),a=t.batch.inputConfig.requests,u=a.requests,l=[];for(const c of u){const f=Object.assign({},c);if(f.systemInstruction){const p=f.systemInstruction;delete f.systemInstruction;const g=f.request;g.systemInstruction=p,f.request=g}l.push(f)}return a.requests=l,delete t.config,delete t._url,delete t._query,{path:s,body:t}}getGcsUri(e){if(typeof e=="string")return e.startsWith("gs://")?e:void 0;if(!Array.isArray(e)&&e.gcsUri&&e.gcsUri.length>0)return e.gcsUri[0]}getBigqueryUri(e){if(typeof e=="string")return e.startsWith("bq://")?e:void 0;if(!Array.isArray(e))return e.bigqueryUri}formatDestination(e,t){const i=t?Object.assign({},t):{},s=Date.now().toString();if(i.displayName||(i.displayName=`genaiBatchJob_${s}`),i.dest===void 0){const r=this.getGcsUri(e),o=this.getBigqueryUri(e);if(r)r.endsWith(".jsonl")?i.dest=`${r.slice(0,-6)}/dest`:i.dest=`${r}_dest_${s}`;else if(o)i.dest=`${o}_dest_${s}`;else throw new Error("Unsupported source for Vertex AI: No GCS or BigQuery URI found.")}return i}async createInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Ud(this.apiClient,e);return a=G("batchPredictionJobs",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>es(c))}else{const l=xo(this.apiClient,e);return a=G("{model}:batchGenerateContent",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>Ui(c))}}async createEmbeddingsInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Bd(this.apiClient,e);return r=G("{model}:asyncBatchEmbedContent",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>Ui(u))}}async get(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=jd(this.apiClient,e);return a=G("batchPredictionJobs/{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>es(c))}else{const l=Zd(this.apiClient,e);return a=G("batches/{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>Ui(c))}}async cancel(e){var t,i,s,r;let o="",a={};if(this.apiClient.isVertexAI()){const u=wd(this.apiClient,e);o=G("batchPredictionJobs/{name}:cancel",u._url),a=u._query,delete u._url,delete u._query,await this.apiClient.request({path:o,queryParams:a,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal})}else{const u=bd(this.apiClient,e);o=G("batches/{name}:cancel",u._url),a=u._query,delete u._url,delete u._query,await this.apiClient.request({path:o,queryParams:a,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal})}}async listInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=uf(e);return a=G("batchPredictionJobs",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=df(c),p=new Ao;return Object.assign(p,f),p})}else{const l=lf(e);return a=G("batches",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=cf(c),p=new Ao;return Object.assign(p,f),p})}}async delete(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Gd(this.apiClient,e);return a=G("batchPredictionJobs/{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>Hd(c))}else{const l=$d(this.apiClient,e);return a=G("batches/{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>Vd(c))}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function yf(n){const e={},t=d(n,["data"]);if(t!=null&&h(e,["data"],t),d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function Co(n){const e={},t=d(n,["parts"]);if(t!=null){let s=t;Array.isArray(s)&&(s=s.map(r=>$f(r))),h(e,["parts"],s)}const i=d(n,["role"]);return i!=null&&h(e,["role"],i),e}function Ef(n,e){const t={},i=d(n,["ttl"]);e!==void 0&&i!=null&&h(e,["ttl"],i);const s=d(n,["expireTime"]);e!==void 0&&s!=null&&h(e,["expireTime"],s);const r=d(n,["displayName"]);e!==void 0&&r!=null&&h(e,["displayName"],r);const o=d(n,["contents"]);if(e!==void 0&&o!=null){let c=Oe(o);Array.isArray(c)&&(c=c.map(f=>Co(f))),h(e,["contents"],c)}const a=d(n,["systemInstruction"]);e!==void 0&&a!=null&&h(e,["systemInstruction"],Co(Re(a)));const u=d(n,["tools"]);if(e!==void 0&&u!=null){let c=u;Array.isArray(c)&&(c=c.map(f=>Vf(f))),h(e,["tools"],c)}const l=d(n,["toolConfig"]);if(e!==void 0&&l!=null&&h(e,["toolConfig"],Gf(l)),d(n,["kmsKeyName"])!==void 0)throw new Error("kmsKeyName parameter is not supported in Gemini API.");return t}function Tf(n,e){const t={},i=d(n,["ttl"]);e!==void 0&&i!=null&&h(e,["ttl"],i);const s=d(n,["expireTime"]);e!==void 0&&s!=null&&h(e,["expireTime"],s);const r=d(n,["displayName"]);e!==void 0&&r!=null&&h(e,["displayName"],r);const o=d(n,["contents"]);if(e!==void 0&&o!=null){let f=Oe(o);Array.isArray(f)&&(f=f.map(p=>p)),h(e,["contents"],f)}const a=d(n,["systemInstruction"]);e!==void 0&&a!=null&&h(e,["systemInstruction"],Re(a));const u=d(n,["tools"]);if(e!==void 0&&u!=null){let f=u;Array.isArray(f)&&(f=f.map(p=>Hf(p))),h(e,["tools"],f)}const l=d(n,["toolConfig"]);e!==void 0&&l!=null&&h(e,["toolConfig"],l);const c=d(n,["kmsKeyName"]);return e!==void 0&&c!=null&&h(e,["encryption_spec","kmsKeyName"],c),t}function vf(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["model"],dl(n,i));const s=d(e,["config"]);return s!=null&&Ef(s,t),t}function Sf(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["model"],dl(n,i));const s=d(e,["config"]);return s!=null&&Tf(s,t),t}function Af(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],ut(n,i)),t}function If(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],ut(n,i)),t}function _f(n){const e={},t=d(n,["sdkHttpResponse"]);return t!=null&&h(e,["sdkHttpResponse"],t),e}function Rf(n){const e={},t=d(n,["sdkHttpResponse"]);return t!=null&&h(e,["sdkHttpResponse"],t),e}function xf(n){const e={};if(d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const t=d(n,["fileUri"]);t!=null&&h(e,["fileUri"],t);const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function Cf(n){const e={},t=d(n,["id"]);t!=null&&h(e,["id"],t);const i=d(n,["args"]);i!=null&&h(e,["args"],i);const s=d(n,["name"]);if(s!=null&&h(e,["name"],s),d(n,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(d(n,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function Lf(n){const e={},t=d(n,["allowedFunctionNames"]);t!=null&&h(e,["allowedFunctionNames"],t);const i=d(n,["mode"]);if(i!=null&&h(e,["mode"],i),d(n,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return e}function Pf(n){const e={},t=d(n,["description"]);t!=null&&h(e,["description"],t);const i=d(n,["name"]);i!=null&&h(e,["name"],i);const s=d(n,["parameters"]);s!=null&&h(e,["parameters"],s);const r=d(n,["parametersJsonSchema"]);r!=null&&h(e,["parametersJsonSchema"],r);const o=d(n,["response"]);o!=null&&h(e,["response"],o);const a=d(n,["responseJsonSchema"]);if(a!=null&&h(e,["responseJsonSchema"],a),d(n,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");return e}function Df(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],ut(n,i)),t}function bf(n,e){const t={},i=d(e,["name"]);return i!=null&&h(t,["_url","name"],ut(n,i)),t}function wf(n){const e={};if(d(n,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const t=d(n,["enableWidget"]);return t!=null&&h(e,["enableWidget"],t),e}function kf(n){const e={};if(d(n,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(d(n,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const t=d(n,["timeRangeFilter"]);return t!=null&&h(e,["timeRangeFilter"],t),e}function Mf(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);return e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),t}function Nf(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);return e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),t}function Ff(n){const e={},t=d(n,["config"]);return t!=null&&Mf(t,e),e}function Uf(n){const e={},t=d(n,["config"]);return t!=null&&Nf(t,e),e}function Of(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["cachedContents"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["cachedContents"],r)}return e}function Bf(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["cachedContents"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["cachedContents"],r)}return e}function $f(n){const e={},t=d(n,["mediaResolution"]);t!=null&&h(e,["mediaResolution"],t);const i=d(n,["codeExecutionResult"]);i!=null&&h(e,["codeExecutionResult"],i);const s=d(n,["executableCode"]);s!=null&&h(e,["executableCode"],s);const r=d(n,["fileData"]);r!=null&&h(e,["fileData"],xf(r));const o=d(n,["functionCall"]);o!=null&&h(e,["functionCall"],Cf(o));const a=d(n,["functionResponse"]);a!=null&&h(e,["functionResponse"],a);const u=d(n,["inlineData"]);u!=null&&h(e,["inlineData"],yf(u));const l=d(n,["text"]);l!=null&&h(e,["text"],l);const c=d(n,["thought"]);c!=null&&h(e,["thought"],c);const f=d(n,["thoughtSignature"]);f!=null&&h(e,["thoughtSignature"],f);const p=d(n,["videoMetadata"]);return p!=null&&h(e,["videoMetadata"],p),e}function Gf(n){const e={},t=d(n,["retrievalConfig"]);t!=null&&h(e,["retrievalConfig"],t);const i=d(n,["functionCallingConfig"]);return i!=null&&h(e,["functionCallingConfig"],Lf(i)),e}function Vf(n){const e={};if(d(n,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const t=d(n,["computerUse"]);t!=null&&h(e,["computerUse"],t);const i=d(n,["fileSearch"]);i!=null&&h(e,["fileSearch"],i);const s=d(n,["codeExecution"]);if(s!=null&&h(e,["codeExecution"],s),d(n,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const r=d(n,["functionDeclarations"]);if(r!=null){let c=r;Array.isArray(c)&&(c=c.map(f=>f)),h(e,["functionDeclarations"],c)}const o=d(n,["googleMaps"]);o!=null&&h(e,["googleMaps"],wf(o));const a=d(n,["googleSearch"]);a!=null&&h(e,["googleSearch"],kf(a));const u=d(n,["googleSearchRetrieval"]);u!=null&&h(e,["googleSearchRetrieval"],u);const l=d(n,["urlContext"]);return l!=null&&h(e,["urlContext"],l),e}function Hf(n){const e={},t=d(n,["retrieval"]);t!=null&&h(e,["retrieval"],t);const i=d(n,["computerUse"]);if(i!=null&&h(e,["computerUse"],i),d(n,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const s=d(n,["codeExecution"]);s!=null&&h(e,["codeExecution"],s);const r=d(n,["enterpriseWebSearch"]);r!=null&&h(e,["enterpriseWebSearch"],r);const o=d(n,["functionDeclarations"]);if(o!=null){let f=o;Array.isArray(f)&&(f=f.map(p=>Pf(p))),h(e,["functionDeclarations"],f)}const a=d(n,["googleMaps"]);a!=null&&h(e,["googleMaps"],a);const u=d(n,["googleSearch"]);u!=null&&h(e,["googleSearch"],u);const l=d(n,["googleSearchRetrieval"]);l!=null&&h(e,["googleSearchRetrieval"],l);const c=d(n,["urlContext"]);return c!=null&&h(e,["urlContext"],c),e}function Kf(n,e){const t={},i=d(n,["ttl"]);e!==void 0&&i!=null&&h(e,["ttl"],i);const s=d(n,["expireTime"]);return e!==void 0&&s!=null&&h(e,["expireTime"],s),t}function qf(n,e){const t={},i=d(n,["ttl"]);e!==void 0&&i!=null&&h(e,["ttl"],i);const s=d(n,["expireTime"]);return e!==void 0&&s!=null&&h(e,["expireTime"],s),t}function Yf(n,e){const t={},i=d(e,["name"]);i!=null&&h(t,["_url","name"],ut(n,i));const s=d(e,["config"]);return s!=null&&Kf(s,t),t}function Wf(n,e){const t={},i=d(e,["name"]);i!=null&&h(t,["_url","name"],ut(n,i));const s=d(e,["config"]);return s!=null&&qf(s,t),t}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Jf extends lt{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new Pt(at.PAGED_ITEM_CACHED_CONTENTS,i=>this.listInternal(i),await this.listInternal(t),t)}async create(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Sf(this.apiClient,e);return a=G("cachedContents",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>c)}else{const l=vf(this.apiClient,e);return a=G("cachedContents",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>c)}}async get(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=bf(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>c)}else{const l=Df(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>c)}}async delete(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=If(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Rf(c),p=new vo;return Object.assign(p,f),p})}else{const l=Af(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=_f(c),p=new vo;return Object.assign(p,f),p})}}async update(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Wf(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"PATCH",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>c)}else{const l=Yf(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"PATCH",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>c)}}async listInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Uf(e);return a=G("cachedContents",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Bf(c),p=new So;return Object.assign(p,f),p})}else{const l=Ff(e);return a=G("cachedContents",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Of(c),p=new So;return Object.assign(p,f),p})}}}function Xi(n,e){var t={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,i=Object.getOwnPropertySymbols(n);s<i.length;s++)e.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(n,i[s])&&(t[i[s]]=n[i[s]]);return t}function Lo(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function X(n){return this instanceof X?(this.v=n,this):new X(n)}function qe(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),s,r=[];return s=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),s[Symbol.asyncIterator]=function(){return this},s;function o(g){return function(m){return Promise.resolve(m).then(g,f)}}function a(g,m){i[g]&&(s[g]=function(E){return new Promise(function(y,v){r.push([g,E,y,v])>1||u(g,E)})},m&&(s[g]=m(s[g])))}function u(g,m){try{l(i[g](m))}catch(E){p(r[0][3],E)}}function l(g){g.value instanceof X?Promise.resolve(g.value.v).then(c,f):p(r[0][2],g)}function c(g){u("next",g)}function f(g){u("throw",g)}function p(g,m){g(m),r.shift(),r.length&&u(r[0][0],r[0][1])}}function Ye(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof Lo=="function"?Lo(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(r){t[r]=n[r]&&function(o){return new Promise(function(a,u){o=n[r](o),s(a,u,o.done,o.value)})}}function s(r,o,a,u){Promise.resolve(u).then(function(l){r({value:l,done:a})},o)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function zf(n){var e;if(n.candidates==null||n.candidates.length===0)return!1;const t=(e=n.candidates[0])===null||e===void 0?void 0:e.content;return t===void 0?!1:_l(t)}function _l(n){if(n.parts===void 0||n.parts.length===0)return!1;for(const e of n.parts)if(e===void 0||Object.keys(e).length===0)return!1;return!0}function Xf(n){if(n.length!==0){for(const e of n)if(e.role!=="user"&&e.role!=="model")throw new Error(`Role must be user or model, but got ${e.role}.`)}}function Po(n){if(n===void 0||n.length===0)return[];const e=[],t=n.length;let i=0;for(;i<t;)if(n[i].role==="user")e.push(n[i]),i++;else{const s=[];let r=!0;for(;i<t&&n[i].role==="model";)s.push(n[i]),r&&!_l(n[i])&&(r=!1),i++;r?e.push(...s):e.pop()}return e}class Qf{constructor(e,t){this.modelsModule=e,this.apiClient=t}create(e){return new Zf(this.apiClient,this.modelsModule,e.model,e.config,structuredClone(e.history))}}class Zf{constructor(e,t,i,s={},r=[]){this.apiClient=e,this.modelsModule=t,this.model=i,this.config=s,this.history=r,this.sendPromise=Promise.resolve(),Xf(r)}async sendMessage(e){var t;await this.sendPromise;const i=Re(e.message),s=this.modelsModule.generateContent({model:this.model,contents:this.getHistory(!0).concat(i),config:(t=e.config)!==null&&t!==void 0?t:this.config});return this.sendPromise=(async()=>{var r,o,a;const u=await s,l=(o=(r=u.candidates)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.content,c=u.automaticFunctionCallingHistory,f=this.getHistory(!0).length;let p=[];c!=null&&(p=(a=c.slice(f))!==null&&a!==void 0?a:[]);const g=l?[l]:[];this.recordHistory(i,g,p)})(),await this.sendPromise.catch(()=>{this.sendPromise=Promise.resolve()}),s}async sendMessageStream(e){var t;await this.sendPromise;const i=Re(e.message),s=this.modelsModule.generateContentStream({model:this.model,contents:this.getHistory(!0).concat(i),config:(t=e.config)!==null&&t!==void 0?t:this.config});this.sendPromise=s.then(()=>{}).catch(()=>{});const r=await s;return this.processStreamResponse(r,i)}getHistory(e=!1){const t=e?Po(this.history):this.history;return structuredClone(t)}processStreamResponse(e,t){return qe(this,arguments,function*(){var s,r,o,a,u,l;const c=[];try{for(var f=!0,p=Ye(e),g;g=yield X(p.next()),s=g.done,!s;f=!0){a=g.value,f=!1;const m=a;if(zf(m)){const E=(l=(u=m.candidates)===null||u===void 0?void 0:u[0])===null||l===void 0?void 0:l.content;E!==void 0&&c.push(E)}yield yield X(m)}}catch(m){r={error:m}}finally{try{!f&&!s&&(o=p.return)&&(yield X(o.call(p)))}finally{if(r)throw r.error}}this.recordHistory(t,c)})}recordHistory(e,t,i){let s=[];t.length>0&&t.every(r=>r.role!==void 0)?s=t:s.push({role:"model",parts:[]}),i&&i.length>0?this.history.push(...Po(i)):this.history.push(e),this.history.push(...s)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class li extends Error{constructor(e){super(e.message),this.name="ApiError",this.status=e.status,Object.setPrototypeOf(this,li.prototype)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function jf(n){const e={},t=d(n,["file"]);return t!=null&&h(e,["file"],t),e}function eh(n){const e={},t=d(n,["sdkHttpResponse"]);return t!=null&&h(e,["sdkHttpResponse"],t),e}function th(n){const e={},t=d(n,["name"]);return t!=null&&h(e,["_url","file"],yl(t)),e}function ih(n){const e={},t=d(n,["sdkHttpResponse"]);return t!=null&&h(e,["sdkHttpResponse"],t),e}function nh(n){const e={},t=d(n,["name"]);return t!=null&&h(e,["_url","file"],yl(t)),e}function sh(n){const e={},t=d(n,["uris"]);return t!=null&&h(e,["uris"],t),e}function rh(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);return e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),t}function oh(n){const e={},t=d(n,["config"]);return t!=null&&rh(t,e),e}function ah(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["files"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["files"],r)}return e}function lh(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["files"]);if(i!=null){let s=i;Array.isArray(s)&&(s=s.map(r=>r)),h(e,["files"],s)}return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class uh extends lt{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new Pt(at.PAGED_ITEM_FILES,i=>this.listInternal(i),await this.listInternal(t),t)}async upload(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files. You can share files through a GCS bucket.");return this.apiClient.uploadFile(e.file,e.config).then(t=>t)}async download(e){await this.apiClient.downloadFile(e)}async registerFiles(e){throw new Error("registerFiles is only supported in Node.js environments.")}async _registerFiles(e){return this.registerFilesInternal(e)}async listInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=oh(e);return r=G("files",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>{const l=ah(u),c=new ud;return Object.assign(c,l),c})}}async createInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=jf(e);return r=G("upload/v1beta/files",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=eh(u),c=new cd;return Object.assign(c,l),c})}}async get(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=nh(e);return r=G("files/{file}",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>u)}}async delete(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=th(e);return r=G("files/{file}",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>{const l=ih(u),c=new dd;return Object.assign(c,l),c})}}async registerFilesInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=sh(e);return r=G("files:register",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=lh(u),c=new fd;return Object.assign(c,l),c})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Oi(n){const e={},t=d(n,["data"]);if(t!=null&&h(e,["data"],t),d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function ch(n){const e={},t=d(n,["parts"]);if(t!=null){let s=t;Array.isArray(s)&&(s=s.map(r=>xh(r))),h(e,["parts"],s)}const i=d(n,["role"]);return i!=null&&h(e,["role"],i),e}function dh(n){const e={};if(d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const t=d(n,["fileUri"]);t!=null&&h(e,["fileUri"],t);const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function fh(n){const e={},t=d(n,["id"]);t!=null&&h(e,["id"],t);const i=d(n,["args"]);i!=null&&h(e,["args"],i);const s=d(n,["name"]);if(s!=null&&h(e,["name"],s),d(n,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(d(n,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function hh(n){const e={},t=d(n,["description"]);t!=null&&h(e,["description"],t);const i=d(n,["name"]);i!=null&&h(e,["name"],i);const s=d(n,["parameters"]);s!=null&&h(e,["parameters"],s);const r=d(n,["parametersJsonSchema"]);r!=null&&h(e,["parametersJsonSchema"],r);const o=d(n,["response"]);o!=null&&h(e,["response"],o);const a=d(n,["responseJsonSchema"]);if(a!=null&&h(e,["responseJsonSchema"],a),d(n,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");return e}function ph(n){const e={},t=d(n,["modelSelectionConfig"]);t!=null&&h(e,["modelConfig"],t);const i=d(n,["responseJsonSchema"]);i!=null&&h(e,["responseJsonSchema"],i);const s=d(n,["audioTimestamp"]);s!=null&&h(e,["audioTimestamp"],s);const r=d(n,["candidateCount"]);r!=null&&h(e,["candidateCount"],r);const o=d(n,["enableAffectiveDialog"]);o!=null&&h(e,["enableAffectiveDialog"],o);const a=d(n,["frequencyPenalty"]);a!=null&&h(e,["frequencyPenalty"],a);const u=d(n,["logprobs"]);u!=null&&h(e,["logprobs"],u);const l=d(n,["maxOutputTokens"]);l!=null&&h(e,["maxOutputTokens"],l);const c=d(n,["mediaResolution"]);c!=null&&h(e,["mediaResolution"],c);const f=d(n,["presencePenalty"]);f!=null&&h(e,["presencePenalty"],f);const p=d(n,["responseLogprobs"]);p!=null&&h(e,["responseLogprobs"],p);const g=d(n,["responseMimeType"]);g!=null&&h(e,["responseMimeType"],g);const m=d(n,["responseModalities"]);m!=null&&h(e,["responseModalities"],m);const E=d(n,["responseSchema"]);E!=null&&h(e,["responseSchema"],E);const y=d(n,["routingConfig"]);y!=null&&h(e,["routingConfig"],y);const v=d(n,["seed"]);v!=null&&h(e,["seed"],v);const S=d(n,["speechConfig"]);S!=null&&h(e,["speechConfig"],S);const A=d(n,["stopSequences"]);A!=null&&h(e,["stopSequences"],A);const _=d(n,["temperature"]);_!=null&&h(e,["temperature"],_);const I=d(n,["thinkingConfig"]);I!=null&&h(e,["thinkingConfig"],I);const P=d(n,["topK"]);P!=null&&h(e,["topK"],P);const R=d(n,["topP"]);if(R!=null&&h(e,["topP"],R),d(n,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return e}function gh(n){const e={};if(d(n,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const t=d(n,["enableWidget"]);return t!=null&&h(e,["enableWidget"],t),e}function mh(n){const e={};if(d(n,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(d(n,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const t=d(n,["timeRangeFilter"]);return t!=null&&h(e,["timeRangeFilter"],t),e}function yh(n,e){const t={},i=d(n,["generationConfig"]);e!==void 0&&i!=null&&h(e,["setup","generationConfig"],i);const s=d(n,["responseModalities"]);e!==void 0&&s!=null&&h(e,["setup","generationConfig","responseModalities"],s);const r=d(n,["temperature"]);e!==void 0&&r!=null&&h(e,["setup","generationConfig","temperature"],r);const o=d(n,["topP"]);e!==void 0&&o!=null&&h(e,["setup","generationConfig","topP"],o);const a=d(n,["topK"]);e!==void 0&&a!=null&&h(e,["setup","generationConfig","topK"],a);const u=d(n,["maxOutputTokens"]);e!==void 0&&u!=null&&h(e,["setup","generationConfig","maxOutputTokens"],u);const l=d(n,["mediaResolution"]);e!==void 0&&l!=null&&h(e,["setup","generationConfig","mediaResolution"],l);const c=d(n,["seed"]);e!==void 0&&c!=null&&h(e,["setup","generationConfig","seed"],c);const f=d(n,["speechConfig"]);e!==void 0&&f!=null&&h(e,["setup","generationConfig","speechConfig"],Ns(f));const p=d(n,["thinkingConfig"]);e!==void 0&&p!=null&&h(e,["setup","generationConfig","thinkingConfig"],p);const g=d(n,["enableAffectiveDialog"]);e!==void 0&&g!=null&&h(e,["setup","generationConfig","enableAffectiveDialog"],g);const m=d(n,["systemInstruction"]);e!==void 0&&m!=null&&h(e,["setup","systemInstruction"],ch(Re(m)));const E=d(n,["tools"]);if(e!==void 0&&E!=null){let P=Xt(E);Array.isArray(P)&&(P=P.map(R=>Lh(zt(R)))),h(e,["setup","tools"],P)}const y=d(n,["sessionResumption"]);e!==void 0&&y!=null&&h(e,["setup","sessionResumption"],Ch(y));const v=d(n,["inputAudioTranscription"]);e!==void 0&&v!=null&&h(e,["setup","inputAudioTranscription"],v);const S=d(n,["outputAudioTranscription"]);e!==void 0&&S!=null&&h(e,["setup","outputAudioTranscription"],S);const A=d(n,["realtimeInputConfig"]);e!==void 0&&A!=null&&h(e,["setup","realtimeInputConfig"],A);const _=d(n,["contextWindowCompression"]);e!==void 0&&_!=null&&h(e,["setup","contextWindowCompression"],_);const I=d(n,["proactivity"]);if(e!==void 0&&I!=null&&h(e,["setup","proactivity"],I),d(n,["explicitVadSignal"])!==void 0)throw new Error("explicitVadSignal parameter is not supported in Gemini API.");return t}function Eh(n,e){const t={},i=d(n,["generationConfig"]);e!==void 0&&i!=null&&h(e,["setup","generationConfig"],ph(i));const s=d(n,["responseModalities"]);e!==void 0&&s!=null&&h(e,["setup","generationConfig","responseModalities"],s);const r=d(n,["temperature"]);e!==void 0&&r!=null&&h(e,["setup","generationConfig","temperature"],r);const o=d(n,["topP"]);e!==void 0&&o!=null&&h(e,["setup","generationConfig","topP"],o);const a=d(n,["topK"]);e!==void 0&&a!=null&&h(e,["setup","generationConfig","topK"],a);const u=d(n,["maxOutputTokens"]);e!==void 0&&u!=null&&h(e,["setup","generationConfig","maxOutputTokens"],u);const l=d(n,["mediaResolution"]);e!==void 0&&l!=null&&h(e,["setup","generationConfig","mediaResolution"],l);const c=d(n,["seed"]);e!==void 0&&c!=null&&h(e,["setup","generationConfig","seed"],c);const f=d(n,["speechConfig"]);e!==void 0&&f!=null&&h(e,["setup","generationConfig","speechConfig"],Ns(f));const p=d(n,["thinkingConfig"]);e!==void 0&&p!=null&&h(e,["setup","generationConfig","thinkingConfig"],p);const g=d(n,["enableAffectiveDialog"]);e!==void 0&&g!=null&&h(e,["setup","generationConfig","enableAffectiveDialog"],g);const m=d(n,["systemInstruction"]);e!==void 0&&m!=null&&h(e,["setup","systemInstruction"],Re(m));const E=d(n,["tools"]);if(e!==void 0&&E!=null){let R=Xt(E);Array.isArray(R)&&(R=R.map(L=>Ph(zt(L)))),h(e,["setup","tools"],R)}const y=d(n,["sessionResumption"]);e!==void 0&&y!=null&&h(e,["setup","sessionResumption"],y);const v=d(n,["inputAudioTranscription"]);e!==void 0&&v!=null&&h(e,["setup","inputAudioTranscription"],v);const S=d(n,["outputAudioTranscription"]);e!==void 0&&S!=null&&h(e,["setup","outputAudioTranscription"],S);const A=d(n,["realtimeInputConfig"]);e!==void 0&&A!=null&&h(e,["setup","realtimeInputConfig"],A);const _=d(n,["contextWindowCompression"]);e!==void 0&&_!=null&&h(e,["setup","contextWindowCompression"],_);const I=d(n,["proactivity"]);e!==void 0&&I!=null&&h(e,["setup","proactivity"],I);const P=d(n,["explicitVadSignal"]);return e!==void 0&&P!=null&&h(e,["setup","explicitVadSignal"],P),t}function Th(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["setup","model"],se(n,i));const s=d(e,["config"]);return s!=null&&h(t,["config"],yh(s,t)),t}function vh(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["setup","model"],se(n,i));const s=d(e,["config"]);return s!=null&&h(t,["config"],Eh(s,t)),t}function Sh(n){const e={},t=d(n,["musicGenerationConfig"]);return t!=null&&h(e,["musicGenerationConfig"],t),e}function Ah(n){const e={},t=d(n,["weightedPrompts"]);if(t!=null){let i=t;Array.isArray(i)&&(i=i.map(s=>s)),h(e,["weightedPrompts"],i)}return e}function Ih(n){const e={},t=d(n,["media"]);if(t!=null){let l=fl(t);Array.isArray(l)&&(l=l.map(c=>Oi(c))),h(e,["mediaChunks"],l)}const i=d(n,["audio"]);i!=null&&h(e,["audio"],Oi(pl(i)));const s=d(n,["audioStreamEnd"]);s!=null&&h(e,["audioStreamEnd"],s);const r=d(n,["video"]);r!=null&&h(e,["video"],Oi(hl(r)));const o=d(n,["text"]);o!=null&&h(e,["text"],o);const a=d(n,["activityStart"]);a!=null&&h(e,["activityStart"],a);const u=d(n,["activityEnd"]);return u!=null&&h(e,["activityEnd"],u),e}function _h(n){const e={},t=d(n,["media"]);if(t!=null){let l=fl(t);Array.isArray(l)&&(l=l.map(c=>c)),h(e,["mediaChunks"],l)}const i=d(n,["audio"]);i!=null&&h(e,["audio"],pl(i));const s=d(n,["audioStreamEnd"]);s!=null&&h(e,["audioStreamEnd"],s);const r=d(n,["video"]);r!=null&&h(e,["video"],hl(r));const o=d(n,["text"]);o!=null&&h(e,["text"],o);const a=d(n,["activityStart"]);a!=null&&h(e,["activityStart"],a);const u=d(n,["activityEnd"]);return u!=null&&h(e,["activityEnd"],u),e}function Rh(n){const e={},t=d(n,["setupComplete"]);t!=null&&h(e,["setupComplete"],t);const i=d(n,["serverContent"]);i!=null&&h(e,["serverContent"],i);const s=d(n,["toolCall"]);s!=null&&h(e,["toolCall"],s);const r=d(n,["toolCallCancellation"]);r!=null&&h(e,["toolCallCancellation"],r);const o=d(n,["usageMetadata"]);o!=null&&h(e,["usageMetadata"],Dh(o));const a=d(n,["goAway"]);a!=null&&h(e,["goAway"],a);const u=d(n,["sessionResumptionUpdate"]);u!=null&&h(e,["sessionResumptionUpdate"],u);const l=d(n,["voiceActivityDetectionSignal"]);l!=null&&h(e,["voiceActivityDetectionSignal"],l);const c=d(n,["voiceActivity"]);return c!=null&&h(e,["voiceActivity"],bh(c)),e}function xh(n){const e={},t=d(n,["mediaResolution"]);t!=null&&h(e,["mediaResolution"],t);const i=d(n,["codeExecutionResult"]);i!=null&&h(e,["codeExecutionResult"],i);const s=d(n,["executableCode"]);s!=null&&h(e,["executableCode"],s);const r=d(n,["fileData"]);r!=null&&h(e,["fileData"],dh(r));const o=d(n,["functionCall"]);o!=null&&h(e,["functionCall"],fh(o));const a=d(n,["functionResponse"]);a!=null&&h(e,["functionResponse"],a);const u=d(n,["inlineData"]);u!=null&&h(e,["inlineData"],Oi(u));const l=d(n,["text"]);l!=null&&h(e,["text"],l);const c=d(n,["thought"]);c!=null&&h(e,["thought"],c);const f=d(n,["thoughtSignature"]);f!=null&&h(e,["thoughtSignature"],f);const p=d(n,["videoMetadata"]);return p!=null&&h(e,["videoMetadata"],p),e}function Ch(n){const e={},t=d(n,["handle"]);if(t!=null&&h(e,["handle"],t),d(n,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function Lh(n){const e={};if(d(n,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const t=d(n,["computerUse"]);t!=null&&h(e,["computerUse"],t);const i=d(n,["fileSearch"]);i!=null&&h(e,["fileSearch"],i);const s=d(n,["codeExecution"]);if(s!=null&&h(e,["codeExecution"],s),d(n,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const r=d(n,["functionDeclarations"]);if(r!=null){let c=r;Array.isArray(c)&&(c=c.map(f=>f)),h(e,["functionDeclarations"],c)}const o=d(n,["googleMaps"]);o!=null&&h(e,["googleMaps"],gh(o));const a=d(n,["googleSearch"]);a!=null&&h(e,["googleSearch"],mh(a));const u=d(n,["googleSearchRetrieval"]);u!=null&&h(e,["googleSearchRetrieval"],u);const l=d(n,["urlContext"]);return l!=null&&h(e,["urlContext"],l),e}function Ph(n){const e={},t=d(n,["retrieval"]);t!=null&&h(e,["retrieval"],t);const i=d(n,["computerUse"]);if(i!=null&&h(e,["computerUse"],i),d(n,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const s=d(n,["codeExecution"]);s!=null&&h(e,["codeExecution"],s);const r=d(n,["enterpriseWebSearch"]);r!=null&&h(e,["enterpriseWebSearch"],r);const o=d(n,["functionDeclarations"]);if(o!=null){let f=o;Array.isArray(f)&&(f=f.map(p=>hh(p))),h(e,["functionDeclarations"],f)}const a=d(n,["googleMaps"]);a!=null&&h(e,["googleMaps"],a);const u=d(n,["googleSearch"]);u!=null&&h(e,["googleSearch"],u);const l=d(n,["googleSearchRetrieval"]);l!=null&&h(e,["googleSearchRetrieval"],l);const c=d(n,["urlContext"]);return c!=null&&h(e,["urlContext"],c),e}function Dh(n){const e={},t=d(n,["promptTokenCount"]);t!=null&&h(e,["promptTokenCount"],t);const i=d(n,["cachedContentTokenCount"]);i!=null&&h(e,["cachedContentTokenCount"],i);const s=d(n,["candidatesTokenCount"]);s!=null&&h(e,["responseTokenCount"],s);const r=d(n,["toolUsePromptTokenCount"]);r!=null&&h(e,["toolUsePromptTokenCount"],r);const o=d(n,["thoughtsTokenCount"]);o!=null&&h(e,["thoughtsTokenCount"],o);const a=d(n,["totalTokenCount"]);a!=null&&h(e,["totalTokenCount"],a);const u=d(n,["promptTokensDetails"]);if(u!=null){let g=u;Array.isArray(g)&&(g=g.map(m=>m)),h(e,["promptTokensDetails"],g)}const l=d(n,["cacheTokensDetails"]);if(l!=null){let g=l;Array.isArray(g)&&(g=g.map(m=>m)),h(e,["cacheTokensDetails"],g)}const c=d(n,["candidatesTokensDetails"]);if(c!=null){let g=c;Array.isArray(g)&&(g=g.map(m=>m)),h(e,["responseTokensDetails"],g)}const f=d(n,["toolUsePromptTokensDetails"]);if(f!=null){let g=f;Array.isArray(g)&&(g=g.map(m=>m)),h(e,["toolUsePromptTokensDetails"],g)}const p=d(n,["trafficType"]);return p!=null&&h(e,["trafficType"],p),e}function bh(n){const e={},t=d(n,["type"]);return t!=null&&h(e,["voiceActivityType"],t),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function wh(n,e){const t={},i=d(n,["data"]);if(i!=null&&h(t,["data"],i),d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const s=d(n,["mimeType"]);return s!=null&&h(t,["mimeType"],s),t}function kh(n,e){const t={},i=d(n,["content"]);i!=null&&h(t,["content"],i);const s=d(n,["citationMetadata"]);s!=null&&h(t,["citationMetadata"],Mh(s));const r=d(n,["tokenCount"]);r!=null&&h(t,["tokenCount"],r);const o=d(n,["finishReason"]);o!=null&&h(t,["finishReason"],o);const a=d(n,["avgLogprobs"]);a!=null&&h(t,["avgLogprobs"],a);const u=d(n,["groundingMetadata"]);u!=null&&h(t,["groundingMetadata"],u);const l=d(n,["index"]);l!=null&&h(t,["index"],l);const c=d(n,["logprobsResult"]);c!=null&&h(t,["logprobsResult"],c);const f=d(n,["safetyRatings"]);if(f!=null){let g=f;Array.isArray(g)&&(g=g.map(m=>m)),h(t,["safetyRatings"],g)}const p=d(n,["urlContextMetadata"]);return p!=null&&h(t,["urlContextMetadata"],p),t}function Mh(n,e){const t={},i=d(n,["citationSources"]);if(i!=null){let s=i;Array.isArray(s)&&(s=s.map(r=>r)),h(t,["citations"],s)}return t}function Nh(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let o=Oe(r);Array.isArray(o)&&(o=o.map(a=>a)),h(i,["contents"],o)}return i}function Fh(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["tokensInfo"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(t,["tokensInfo"],r)}return t}function Uh(n,e){const t={},i=d(n,["values"]);i!=null&&h(t,["values"],i);const s=d(n,["statistics"]);return s!=null&&h(t,["statistics"],Oh(s)),t}function Oh(n,e){const t={},i=d(n,["truncated"]);i!=null&&h(t,["truncated"],i);const s=d(n,["token_count"]);return s!=null&&h(t,["tokenCount"],s),t}function dn(n,e){const t={},i=d(n,["parts"]);if(i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>Wp(o))),h(t,["parts"],r)}const s=d(n,["role"]);return s!=null&&h(t,["role"],s),t}function Bh(n,e){const t={},i=d(n,["controlType"]);i!=null&&h(t,["controlType"],i);const s=d(n,["enableControlImageComputation"]);return s!=null&&h(t,["computeControl"],s),t}function $h(n,e){const t={};if(d(n,["systemInstruction"])!==void 0)throw new Error("systemInstruction parameter is not supported in Gemini API.");if(d(n,["tools"])!==void 0)throw new Error("tools parameter is not supported in Gemini API.");if(d(n,["generationConfig"])!==void 0)throw new Error("generationConfig parameter is not supported in Gemini API.");return t}function Gh(n,e,t){const i={},s=d(n,["systemInstruction"]);e!==void 0&&s!=null&&h(e,["systemInstruction"],Re(s));const r=d(n,["tools"]);if(e!==void 0&&r!=null){let a=r;Array.isArray(a)&&(a=a.map(u=>Ll(u))),h(e,["tools"],a)}const o=d(n,["generationConfig"]);return e!==void 0&&o!=null&&h(e,["generationConfig"],wp(o)),i}function Vh(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let a=Oe(r);Array.isArray(a)&&(a=a.map(u=>dn(u))),h(i,["contents"],a)}const o=d(e,["config"]);return o!=null&&$h(o),i}function Hh(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let a=Oe(r);Array.isArray(a)&&(a=a.map(u=>u)),h(i,["contents"],a)}const o=d(e,["config"]);return o!=null&&Gh(o,i),i}function Kh(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["totalTokens"]);s!=null&&h(t,["totalTokens"],s);const r=d(n,["cachedContentTokenCount"]);return r!=null&&h(t,["cachedContentTokenCount"],r),t}function qh(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["totalTokens"]);return s!=null&&h(t,["totalTokens"],s),t}function Yh(n,e,t){const i={},s=d(e,["model"]);return s!=null&&h(i,["_url","name"],se(n,s)),i}function Wh(n,e,t){const i={},s=d(e,["model"]);return s!=null&&h(i,["_url","name"],se(n,s)),i}function Jh(n,e){const t={},i=d(n,["sdkHttpResponse"]);return i!=null&&h(t,["sdkHttpResponse"],i),t}function zh(n,e){const t={},i=d(n,["sdkHttpResponse"]);return i!=null&&h(t,["sdkHttpResponse"],i),t}function Xh(n,e,t){const i={},s=d(n,["outputGcsUri"]);e!==void 0&&s!=null&&h(e,["parameters","storageUri"],s);const r=d(n,["negativePrompt"]);e!==void 0&&r!=null&&h(e,["parameters","negativePrompt"],r);const o=d(n,["numberOfImages"]);e!==void 0&&o!=null&&h(e,["parameters","sampleCount"],o);const a=d(n,["aspectRatio"]);e!==void 0&&a!=null&&h(e,["parameters","aspectRatio"],a);const u=d(n,["guidanceScale"]);e!==void 0&&u!=null&&h(e,["parameters","guidanceScale"],u);const l=d(n,["seed"]);e!==void 0&&l!=null&&h(e,["parameters","seed"],l);const c=d(n,["safetyFilterLevel"]);e!==void 0&&c!=null&&h(e,["parameters","safetySetting"],c);const f=d(n,["personGeneration"]);e!==void 0&&f!=null&&h(e,["parameters","personGeneration"],f);const p=d(n,["includeSafetyAttributes"]);e!==void 0&&p!=null&&h(e,["parameters","includeSafetyAttributes"],p);const g=d(n,["includeRaiReason"]);e!==void 0&&g!=null&&h(e,["parameters","includeRaiReason"],g);const m=d(n,["language"]);e!==void 0&&m!=null&&h(e,["parameters","language"],m);const E=d(n,["outputMimeType"]);e!==void 0&&E!=null&&h(e,["parameters","outputOptions","mimeType"],E);const y=d(n,["outputCompressionQuality"]);e!==void 0&&y!=null&&h(e,["parameters","outputOptions","compressionQuality"],y);const v=d(n,["addWatermark"]);e!==void 0&&v!=null&&h(e,["parameters","addWatermark"],v);const S=d(n,["labels"]);e!==void 0&&S!=null&&h(e,["labels"],S);const A=d(n,["editMode"]);e!==void 0&&A!=null&&h(e,["parameters","editMode"],A);const _=d(n,["baseSteps"]);return e!==void 0&&_!=null&&h(e,["parameters","editConfig","baseSteps"],_),i}function Qh(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["prompt"]);r!=null&&h(i,["instances[0]","prompt"],r);const o=d(e,["referenceImages"]);if(o!=null){let u=o;Array.isArray(u)&&(u=u.map(l=>jp(l))),h(i,["instances[0]","referenceImages"],u)}const a=d(e,["config"]);return a!=null&&Xh(a,i),i}function Zh(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["predictions"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>fn(o))),h(t,["generatedImages"],r)}return t}function jh(n,e,t){const i={},s=d(n,["taskType"]);e!==void 0&&s!=null&&h(e,["requests[]","taskType"],s);const r=d(n,["title"]);e!==void 0&&r!=null&&h(e,["requests[]","title"],r);const o=d(n,["outputDimensionality"]);if(e!==void 0&&o!=null&&h(e,["requests[]","outputDimensionality"],o),d(n,["mimeType"])!==void 0)throw new Error("mimeType parameter is not supported in Gemini API.");if(d(n,["autoTruncate"])!==void 0)throw new Error("autoTruncate parameter is not supported in Gemini API.");return i}function ep(n,e,t){const i={},s=d(n,["taskType"]);e!==void 0&&s!=null&&h(e,["instances[]","task_type"],s);const r=d(n,["title"]);e!==void 0&&r!=null&&h(e,["instances[]","title"],r);const o=d(n,["outputDimensionality"]);e!==void 0&&o!=null&&h(e,["parameters","outputDimensionality"],o);const a=d(n,["mimeType"]);e!==void 0&&a!=null&&h(e,["instances[]","mimeType"],a);const u=d(n,["autoTruncate"]);return e!==void 0&&u!=null&&h(e,["parameters","autoTruncate"],u),i}function tp(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let u=ws(n,r);Array.isArray(u)&&(u=u.map(l=>l)),h(i,["requests[]","content"],u)}const o=d(e,["config"]);o!=null&&jh(o,i);const a=d(e,["model"]);return a!==void 0&&h(i,["requests[]","model"],se(n,a)),i}function ip(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let a=ws(n,r);Array.isArray(a)&&(a=a.map(u=>u)),h(i,["instances[]","content"],a)}const o=d(e,["config"]);return o!=null&&ep(o,i),i}function np(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["embeddings"]);if(s!=null){let o=s;Array.isArray(o)&&(o=o.map(a=>a)),h(t,["embeddings"],o)}const r=d(n,["metadata"]);return r!=null&&h(t,["metadata"],r),t}function sp(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["predictions[]","embeddings"]);if(s!=null){let o=s;Array.isArray(o)&&(o=o.map(a=>Uh(a))),h(t,["embeddings"],o)}const r=d(n,["metadata"]);return r!=null&&h(t,["metadata"],r),t}function rp(n,e){const t={},i=d(n,["endpoint"]);i!=null&&h(t,["name"],i);const s=d(n,["deployedModelId"]);return s!=null&&h(t,["deployedModelId"],s),t}function op(n,e){const t={};if(d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const i=d(n,["fileUri"]);i!=null&&h(t,["fileUri"],i);const s=d(n,["mimeType"]);return s!=null&&h(t,["mimeType"],s),t}function ap(n,e){const t={},i=d(n,["id"]);i!=null&&h(t,["id"],i);const s=d(n,["args"]);s!=null&&h(t,["args"],s);const r=d(n,["name"]);if(r!=null&&h(t,["name"],r),d(n,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(d(n,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return t}function lp(n,e){const t={},i=d(n,["allowedFunctionNames"]);i!=null&&h(t,["allowedFunctionNames"],i);const s=d(n,["mode"]);if(s!=null&&h(t,["mode"],s),d(n,["streamFunctionCallArguments"])!==void 0)throw new Error("streamFunctionCallArguments parameter is not supported in Gemini API.");return t}function up(n,e){const t={},i=d(n,["description"]);i!=null&&h(t,["description"],i);const s=d(n,["name"]);s!=null&&h(t,["name"],s);const r=d(n,["parameters"]);r!=null&&h(t,["parameters"],r);const o=d(n,["parametersJsonSchema"]);o!=null&&h(t,["parametersJsonSchema"],o);const a=d(n,["response"]);a!=null&&h(t,["response"],a);const u=d(n,["responseJsonSchema"]);if(u!=null&&h(t,["responseJsonSchema"],u),d(n,["behavior"])!==void 0)throw new Error("behavior parameter is not supported in Vertex AI.");return t}function cp(n,e,t,i){const s={},r=d(e,["systemInstruction"]);t!==void 0&&r!=null&&h(t,["systemInstruction"],dn(Re(r)));const o=d(e,["temperature"]);o!=null&&h(s,["temperature"],o);const a=d(e,["topP"]);a!=null&&h(s,["topP"],a);const u=d(e,["topK"]);u!=null&&h(s,["topK"],u);const l=d(e,["candidateCount"]);l!=null&&h(s,["candidateCount"],l);const c=d(e,["maxOutputTokens"]);c!=null&&h(s,["maxOutputTokens"],c);const f=d(e,["stopSequences"]);f!=null&&h(s,["stopSequences"],f);const p=d(e,["responseLogprobs"]);p!=null&&h(s,["responseLogprobs"],p);const g=d(e,["logprobs"]);g!=null&&h(s,["logprobs"],g);const m=d(e,["presencePenalty"]);m!=null&&h(s,["presencePenalty"],m);const E=d(e,["frequencyPenalty"]);E!=null&&h(s,["frequencyPenalty"],E);const y=d(e,["seed"]);y!=null&&h(s,["seed"],y);const v=d(e,["responseMimeType"]);v!=null&&h(s,["responseMimeType"],v);const S=d(e,["responseSchema"]);S!=null&&h(s,["responseSchema"],ks(S));const A=d(e,["responseJsonSchema"]);if(A!=null&&h(s,["responseJsonSchema"],A),d(e,["routingConfig"])!==void 0)throw new Error("routingConfig parameter is not supported in Gemini API.");if(d(e,["modelSelectionConfig"])!==void 0)throw new Error("modelSelectionConfig parameter is not supported in Gemini API.");const _=d(e,["safetySettings"]);if(t!==void 0&&_!=null){let $=_;Array.isArray($)&&($=$.map(H=>eg(H))),h(t,["safetySettings"],$)}const I=d(e,["tools"]);if(t!==void 0&&I!=null){let $=Xt(I);Array.isArray($)&&($=$.map(H=>ag(zt(H)))),h(t,["tools"],$)}const P=d(e,["toolConfig"]);if(t!==void 0&&P!=null&&h(t,["toolConfig"],og(P)),d(e,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const R=d(e,["cachedContent"]);t!==void 0&&R!=null&&h(t,["cachedContent"],ut(n,R));const L=d(e,["responseModalities"]);L!=null&&h(s,["responseModalities"],L);const C=d(e,["mediaResolution"]);C!=null&&h(s,["mediaResolution"],C);const x=d(e,["speechConfig"]);if(x!=null&&h(s,["speechConfig"],Ms(x)),d(e,["audioTimestamp"])!==void 0)throw new Error("audioTimestamp parameter is not supported in Gemini API.");const w=d(e,["thinkingConfig"]);w!=null&&h(s,["thinkingConfig"],w);const M=d(e,["imageConfig"]);M!=null&&h(s,["imageConfig"],Up(M));const U=d(e,["enableEnhancedCivicAnswers"]);if(U!=null&&h(s,["enableEnhancedCivicAnswers"],U),d(e,["modelArmorConfig"])!==void 0)throw new Error("modelArmorConfig parameter is not supported in Gemini API.");return s}function dp(n,e,t,i){const s={},r=d(e,["systemInstruction"]);t!==void 0&&r!=null&&h(t,["systemInstruction"],Re(r));const o=d(e,["temperature"]);o!=null&&h(s,["temperature"],o);const a=d(e,["topP"]);a!=null&&h(s,["topP"],a);const u=d(e,["topK"]);u!=null&&h(s,["topK"],u);const l=d(e,["candidateCount"]);l!=null&&h(s,["candidateCount"],l);const c=d(e,["maxOutputTokens"]);c!=null&&h(s,["maxOutputTokens"],c);const f=d(e,["stopSequences"]);f!=null&&h(s,["stopSequences"],f);const p=d(e,["responseLogprobs"]);p!=null&&h(s,["responseLogprobs"],p);const g=d(e,["logprobs"]);g!=null&&h(s,["logprobs"],g);const m=d(e,["presencePenalty"]);m!=null&&h(s,["presencePenalty"],m);const E=d(e,["frequencyPenalty"]);E!=null&&h(s,["frequencyPenalty"],E);const y=d(e,["seed"]);y!=null&&h(s,["seed"],y);const v=d(e,["responseMimeType"]);v!=null&&h(s,["responseMimeType"],v);const S=d(e,["responseSchema"]);S!=null&&h(s,["responseSchema"],ks(S));const A=d(e,["responseJsonSchema"]);A!=null&&h(s,["responseJsonSchema"],A);const _=d(e,["routingConfig"]);_!=null&&h(s,["routingConfig"],_);const I=d(e,["modelSelectionConfig"]);I!=null&&h(s,["modelConfig"],I);const P=d(e,["safetySettings"]);if(t!==void 0&&P!=null){let F=P;Array.isArray(F)&&(F=F.map(Y=>Y)),h(t,["safetySettings"],F)}const R=d(e,["tools"]);if(t!==void 0&&R!=null){let F=Xt(R);Array.isArray(F)&&(F=F.map(Y=>Ll(zt(Y)))),h(t,["tools"],F)}const L=d(e,["toolConfig"]);t!==void 0&&L!=null&&h(t,["toolConfig"],L);const C=d(e,["labels"]);t!==void 0&&C!=null&&h(t,["labels"],C);const x=d(e,["cachedContent"]);t!==void 0&&x!=null&&h(t,["cachedContent"],ut(n,x));const w=d(e,["responseModalities"]);w!=null&&h(s,["responseModalities"],w);const M=d(e,["mediaResolution"]);M!=null&&h(s,["mediaResolution"],M);const U=d(e,["speechConfig"]);U!=null&&h(s,["speechConfig"],Ms(U));const $=d(e,["audioTimestamp"]);$!=null&&h(s,["audioTimestamp"],$);const H=d(e,["thinkingConfig"]);H!=null&&h(s,["thinkingConfig"],H);const N=d(e,["imageConfig"]);if(N!=null&&h(s,["imageConfig"],Op(N)),d(e,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");const q=d(e,["modelArmorConfig"]);return t!==void 0&&q!=null&&h(t,["modelArmorConfig"],q),s}function Do(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let a=Oe(r);Array.isArray(a)&&(a=a.map(u=>dn(u))),h(i,["contents"],a)}const o=d(e,["config"]);return o!=null&&h(i,["generationConfig"],cp(n,o,i)),i}function bo(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["contents"]);if(r!=null){let a=Oe(r);Array.isArray(a)&&(a=a.map(u=>u)),h(i,["contents"],a)}const o=d(e,["config"]);return o!=null&&h(i,["generationConfig"],dp(n,o,i)),i}function wo(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["candidates"]);if(s!=null){let l=s;Array.isArray(l)&&(l=l.map(c=>kh(c))),h(t,["candidates"],l)}const r=d(n,["modelVersion"]);r!=null&&h(t,["modelVersion"],r);const o=d(n,["promptFeedback"]);o!=null&&h(t,["promptFeedback"],o);const a=d(n,["responseId"]);a!=null&&h(t,["responseId"],a);const u=d(n,["usageMetadata"]);return u!=null&&h(t,["usageMetadata"],u),t}function ko(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["candidates"]);if(s!=null){let c=s;Array.isArray(c)&&(c=c.map(f=>f)),h(t,["candidates"],c)}const r=d(n,["createTime"]);r!=null&&h(t,["createTime"],r);const o=d(n,["modelVersion"]);o!=null&&h(t,["modelVersion"],o);const a=d(n,["promptFeedback"]);a!=null&&h(t,["promptFeedback"],a);const u=d(n,["responseId"]);u!=null&&h(t,["responseId"],u);const l=d(n,["usageMetadata"]);return l!=null&&h(t,["usageMetadata"],l),t}function fp(n,e,t){const i={};if(d(n,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(d(n,["negativePrompt"])!==void 0)throw new Error("negativePrompt parameter is not supported in Gemini API.");const s=d(n,["numberOfImages"]);e!==void 0&&s!=null&&h(e,["parameters","sampleCount"],s);const r=d(n,["aspectRatio"]);e!==void 0&&r!=null&&h(e,["parameters","aspectRatio"],r);const o=d(n,["guidanceScale"]);if(e!==void 0&&o!=null&&h(e,["parameters","guidanceScale"],o),d(n,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");const a=d(n,["safetyFilterLevel"]);e!==void 0&&a!=null&&h(e,["parameters","safetySetting"],a);const u=d(n,["personGeneration"]);e!==void 0&&u!=null&&h(e,["parameters","personGeneration"],u);const l=d(n,["includeSafetyAttributes"]);e!==void 0&&l!=null&&h(e,["parameters","includeSafetyAttributes"],l);const c=d(n,["includeRaiReason"]);e!==void 0&&c!=null&&h(e,["parameters","includeRaiReason"],c);const f=d(n,["language"]);e!==void 0&&f!=null&&h(e,["parameters","language"],f);const p=d(n,["outputMimeType"]);e!==void 0&&p!=null&&h(e,["parameters","outputOptions","mimeType"],p);const g=d(n,["outputCompressionQuality"]);if(e!==void 0&&g!=null&&h(e,["parameters","outputOptions","compressionQuality"],g),d(n,["addWatermark"])!==void 0)throw new Error("addWatermark parameter is not supported in Gemini API.");if(d(n,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");const m=d(n,["imageSize"]);if(e!==void 0&&m!=null&&h(e,["parameters","sampleImageSize"],m),d(n,["enhancePrompt"])!==void 0)throw new Error("enhancePrompt parameter is not supported in Gemini API.");return i}function hp(n,e,t){const i={},s=d(n,["outputGcsUri"]);e!==void 0&&s!=null&&h(e,["parameters","storageUri"],s);const r=d(n,["negativePrompt"]);e!==void 0&&r!=null&&h(e,["parameters","negativePrompt"],r);const o=d(n,["numberOfImages"]);e!==void 0&&o!=null&&h(e,["parameters","sampleCount"],o);const a=d(n,["aspectRatio"]);e!==void 0&&a!=null&&h(e,["parameters","aspectRatio"],a);const u=d(n,["guidanceScale"]);e!==void 0&&u!=null&&h(e,["parameters","guidanceScale"],u);const l=d(n,["seed"]);e!==void 0&&l!=null&&h(e,["parameters","seed"],l);const c=d(n,["safetyFilterLevel"]);e!==void 0&&c!=null&&h(e,["parameters","safetySetting"],c);const f=d(n,["personGeneration"]);e!==void 0&&f!=null&&h(e,["parameters","personGeneration"],f);const p=d(n,["includeSafetyAttributes"]);e!==void 0&&p!=null&&h(e,["parameters","includeSafetyAttributes"],p);const g=d(n,["includeRaiReason"]);e!==void 0&&g!=null&&h(e,["parameters","includeRaiReason"],g);const m=d(n,["language"]);e!==void 0&&m!=null&&h(e,["parameters","language"],m);const E=d(n,["outputMimeType"]);e!==void 0&&E!=null&&h(e,["parameters","outputOptions","mimeType"],E);const y=d(n,["outputCompressionQuality"]);e!==void 0&&y!=null&&h(e,["parameters","outputOptions","compressionQuality"],y);const v=d(n,["addWatermark"]);e!==void 0&&v!=null&&h(e,["parameters","addWatermark"],v);const S=d(n,["labels"]);e!==void 0&&S!=null&&h(e,["labels"],S);const A=d(n,["imageSize"]);e!==void 0&&A!=null&&h(e,["parameters","sampleImageSize"],A);const _=d(n,["enhancePrompt"]);return e!==void 0&&_!=null&&h(e,["parameters","enhancePrompt"],_),i}function pp(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["prompt"]);r!=null&&h(i,["instances[0]","prompt"],r);const o=d(e,["config"]);return o!=null&&fp(o,i),i}function gp(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["prompt"]);r!=null&&h(i,["instances[0]","prompt"],r);const o=d(e,["config"]);return o!=null&&hp(o,i),i}function mp(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["predictions"]);if(s!=null){let o=s;Array.isArray(o)&&(o=o.map(a=>Lp(a))),h(t,["generatedImages"],o)}const r=d(n,["positivePromptSafetyAttributes"]);return r!=null&&h(t,["positivePromptSafetyAttributes"],xl(r)),t}function yp(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["predictions"]);if(s!=null){let o=s;Array.isArray(o)&&(o=o.map(a=>fn(a))),h(t,["generatedImages"],o)}const r=d(n,["positivePromptSafetyAttributes"]);return r!=null&&h(t,["positivePromptSafetyAttributes"],Cl(r)),t}function Ep(n,e,t){const i={},s=d(n,["numberOfVideos"]);if(e!==void 0&&s!=null&&h(e,["parameters","sampleCount"],s),d(n,["outputGcsUri"])!==void 0)throw new Error("outputGcsUri parameter is not supported in Gemini API.");if(d(n,["fps"])!==void 0)throw new Error("fps parameter is not supported in Gemini API.");const r=d(n,["durationSeconds"]);if(e!==void 0&&r!=null&&h(e,["parameters","durationSeconds"],r),d(n,["seed"])!==void 0)throw new Error("seed parameter is not supported in Gemini API.");const o=d(n,["aspectRatio"]);e!==void 0&&o!=null&&h(e,["parameters","aspectRatio"],o);const a=d(n,["resolution"]);e!==void 0&&a!=null&&h(e,["parameters","resolution"],a);const u=d(n,["personGeneration"]);if(e!==void 0&&u!=null&&h(e,["parameters","personGeneration"],u),d(n,["pubsubTopic"])!==void 0)throw new Error("pubsubTopic parameter is not supported in Gemini API.");const l=d(n,["negativePrompt"]);e!==void 0&&l!=null&&h(e,["parameters","negativePrompt"],l);const c=d(n,["enhancePrompt"]);if(e!==void 0&&c!=null&&h(e,["parameters","enhancePrompt"],c),d(n,["generateAudio"])!==void 0)throw new Error("generateAudio parameter is not supported in Gemini API.");const f=d(n,["lastFrame"]);e!==void 0&&f!=null&&h(e,["instances[0]","lastFrame"],hn(f));const p=d(n,["referenceImages"]);if(e!==void 0&&p!=null){let g=p;Array.isArray(g)&&(g=g.map(m=>vg(m))),h(e,["instances[0]","referenceImages"],g)}if(d(n,["mask"])!==void 0)throw new Error("mask parameter is not supported in Gemini API.");if(d(n,["compressionQuality"])!==void 0)throw new Error("compressionQuality parameter is not supported in Gemini API.");return i}function Tp(n,e,t){const i={},s=d(n,["numberOfVideos"]);e!==void 0&&s!=null&&h(e,["parameters","sampleCount"],s);const r=d(n,["outputGcsUri"]);e!==void 0&&r!=null&&h(e,["parameters","storageUri"],r);const o=d(n,["fps"]);e!==void 0&&o!=null&&h(e,["parameters","fps"],o);const a=d(n,["durationSeconds"]);e!==void 0&&a!=null&&h(e,["parameters","durationSeconds"],a);const u=d(n,["seed"]);e!==void 0&&u!=null&&h(e,["parameters","seed"],u);const l=d(n,["aspectRatio"]);e!==void 0&&l!=null&&h(e,["parameters","aspectRatio"],l);const c=d(n,["resolution"]);e!==void 0&&c!=null&&h(e,["parameters","resolution"],c);const f=d(n,["personGeneration"]);e!==void 0&&f!=null&&h(e,["parameters","personGeneration"],f);const p=d(n,["pubsubTopic"]);e!==void 0&&p!=null&&h(e,["parameters","pubsubTopic"],p);const g=d(n,["negativePrompt"]);e!==void 0&&g!=null&&h(e,["parameters","negativePrompt"],g);const m=d(n,["enhancePrompt"]);e!==void 0&&m!=null&&h(e,["parameters","enhancePrompt"],m);const E=d(n,["generateAudio"]);e!==void 0&&E!=null&&h(e,["parameters","generateAudio"],E);const y=d(n,["lastFrame"]);e!==void 0&&y!=null&&h(e,["instances[0]","lastFrame"],We(y));const v=d(n,["referenceImages"]);if(e!==void 0&&v!=null){let _=v;Array.isArray(_)&&(_=_.map(I=>Sg(I))),h(e,["instances[0]","referenceImages"],_)}const S=d(n,["mask"]);e!==void 0&&S!=null&&h(e,["instances[0]","mask"],Tg(S));const A=d(n,["compressionQuality"]);return e!==void 0&&A!=null&&h(e,["parameters","compressionQuality"],A),i}function vp(n,e){const t={},i=d(n,["name"]);i!=null&&h(t,["name"],i);const s=d(n,["metadata"]);s!=null&&h(t,["metadata"],s);const r=d(n,["done"]);r!=null&&h(t,["done"],r);const o=d(n,["error"]);o!=null&&h(t,["error"],o);const a=d(n,["response","generateVideoResponse"]);return a!=null&&h(t,["response"],_p(a)),t}function Sp(n,e){const t={},i=d(n,["name"]);i!=null&&h(t,["name"],i);const s=d(n,["metadata"]);s!=null&&h(t,["metadata"],s);const r=d(n,["done"]);r!=null&&h(t,["done"],r);const o=d(n,["error"]);o!=null&&h(t,["error"],o);const a=d(n,["response"]);return a!=null&&h(t,["response"],Rp(a)),t}function Ap(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["prompt"]);r!=null&&h(i,["instances[0]","prompt"],r);const o=d(e,["image"]);o!=null&&h(i,["instances[0]","image"],hn(o));const a=d(e,["video"]);a!=null&&h(i,["instances[0]","video"],Pl(a));const u=d(e,["source"]);u!=null&&xp(u,i);const l=d(e,["config"]);return l!=null&&Ep(l,i),i}function Ip(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["prompt"]);r!=null&&h(i,["instances[0]","prompt"],r);const o=d(e,["image"]);o!=null&&h(i,["instances[0]","image"],We(o));const a=d(e,["video"]);a!=null&&h(i,["instances[0]","video"],Dl(a));const u=d(e,["source"]);u!=null&&Cp(u,i);const l=d(e,["config"]);return l!=null&&Tp(l,i),i}function _p(n,e){const t={},i=d(n,["generatedSamples"]);if(i!=null){let o=i;Array.isArray(o)&&(o=o.map(a=>Dp(a))),h(t,["generatedVideos"],o)}const s=d(n,["raiMediaFilteredCount"]);s!=null&&h(t,["raiMediaFilteredCount"],s);const r=d(n,["raiMediaFilteredReasons"]);return r!=null&&h(t,["raiMediaFilteredReasons"],r),t}function Rp(n,e){const t={},i=d(n,["videos"]);if(i!=null){let o=i;Array.isArray(o)&&(o=o.map(a=>bp(a))),h(t,["generatedVideos"],o)}const s=d(n,["raiMediaFilteredCount"]);s!=null&&h(t,["raiMediaFilteredCount"],s);const r=d(n,["raiMediaFilteredReasons"]);return r!=null&&h(t,["raiMediaFilteredReasons"],r),t}function xp(n,e,t){const i={},s=d(n,["prompt"]);e!==void 0&&s!=null&&h(e,["instances[0]","prompt"],s);const r=d(n,["image"]);e!==void 0&&r!=null&&h(e,["instances[0]","image"],hn(r));const o=d(n,["video"]);return e!==void 0&&o!=null&&h(e,["instances[0]","video"],Pl(o)),i}function Cp(n,e,t){const i={},s=d(n,["prompt"]);e!==void 0&&s!=null&&h(e,["instances[0]","prompt"],s);const r=d(n,["image"]);e!==void 0&&r!=null&&h(e,["instances[0]","image"],We(r));const o=d(n,["video"]);return e!==void 0&&o!=null&&h(e,["instances[0]","video"],Dl(o)),i}function Lp(n,e){const t={},i=d(n,["_self"]);i!=null&&h(t,["image"],Bp(i));const s=d(n,["raiFilteredReason"]);s!=null&&h(t,["raiFilteredReason"],s);const r=d(n,["_self"]);return r!=null&&h(t,["safetyAttributes"],xl(r)),t}function fn(n,e){const t={},i=d(n,["_self"]);i!=null&&h(t,["image"],Rl(i));const s=d(n,["raiFilteredReason"]);s!=null&&h(t,["raiFilteredReason"],s);const r=d(n,["_self"]);r!=null&&h(t,["safetyAttributes"],Cl(r));const o=d(n,["prompt"]);return o!=null&&h(t,["enhancedPrompt"],o),t}function Pp(n,e){const t={},i=d(n,["_self"]);i!=null&&h(t,["mask"],Rl(i));const s=d(n,["labels"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(t,["labels"],r)}return t}function Dp(n,e){const t={},i=d(n,["video"]);return i!=null&&h(t,["video"],yg(i)),t}function bp(n,e){const t={},i=d(n,["_self"]);return i!=null&&h(t,["video"],Eg(i)),t}function wp(n,e){const t={},i=d(n,["modelSelectionConfig"]);i!=null&&h(t,["modelConfig"],i);const s=d(n,["responseJsonSchema"]);s!=null&&h(t,["responseJsonSchema"],s);const r=d(n,["audioTimestamp"]);r!=null&&h(t,["audioTimestamp"],r);const o=d(n,["candidateCount"]);o!=null&&h(t,["candidateCount"],o);const a=d(n,["enableAffectiveDialog"]);a!=null&&h(t,["enableAffectiveDialog"],a);const u=d(n,["frequencyPenalty"]);u!=null&&h(t,["frequencyPenalty"],u);const l=d(n,["logprobs"]);l!=null&&h(t,["logprobs"],l);const c=d(n,["maxOutputTokens"]);c!=null&&h(t,["maxOutputTokens"],c);const f=d(n,["mediaResolution"]);f!=null&&h(t,["mediaResolution"],f);const p=d(n,["presencePenalty"]);p!=null&&h(t,["presencePenalty"],p);const g=d(n,["responseLogprobs"]);g!=null&&h(t,["responseLogprobs"],g);const m=d(n,["responseMimeType"]);m!=null&&h(t,["responseMimeType"],m);const E=d(n,["responseModalities"]);E!=null&&h(t,["responseModalities"],E);const y=d(n,["responseSchema"]);y!=null&&h(t,["responseSchema"],y);const v=d(n,["routingConfig"]);v!=null&&h(t,["routingConfig"],v);const S=d(n,["seed"]);S!=null&&h(t,["seed"],S);const A=d(n,["speechConfig"]);A!=null&&h(t,["speechConfig"],A);const _=d(n,["stopSequences"]);_!=null&&h(t,["stopSequences"],_);const I=d(n,["temperature"]);I!=null&&h(t,["temperature"],I);const P=d(n,["thinkingConfig"]);P!=null&&h(t,["thinkingConfig"],P);const R=d(n,["topK"]);R!=null&&h(t,["topK"],R);const L=d(n,["topP"]);if(L!=null&&h(t,["topP"],L),d(n,["enableEnhancedCivicAnswers"])!==void 0)throw new Error("enableEnhancedCivicAnswers parameter is not supported in Vertex AI.");return t}function kp(n,e,t){const i={},s=d(e,["model"]);return s!=null&&h(i,["_url","name"],se(n,s)),i}function Mp(n,e,t){const i={},s=d(e,["model"]);return s!=null&&h(i,["_url","name"],se(n,s)),i}function Np(n,e){const t={};if(d(n,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const i=d(n,["enableWidget"]);return i!=null&&h(t,["enableWidget"],i),t}function Fp(n,e){const t={};if(d(n,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(d(n,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const i=d(n,["timeRangeFilter"]);return i!=null&&h(t,["timeRangeFilter"],i),t}function Up(n,e){const t={},i=d(n,["aspectRatio"]);i!=null&&h(t,["aspectRatio"],i);const s=d(n,["imageSize"]);if(s!=null&&h(t,["imageSize"],s),d(n,["personGeneration"])!==void 0)throw new Error("personGeneration parameter is not supported in Gemini API.");if(d(n,["outputMimeType"])!==void 0)throw new Error("outputMimeType parameter is not supported in Gemini API.");if(d(n,["outputCompressionQuality"])!==void 0)throw new Error("outputCompressionQuality parameter is not supported in Gemini API.");return t}function Op(n,e){const t={},i=d(n,["aspectRatio"]);i!=null&&h(t,["aspectRatio"],i);const s=d(n,["imageSize"]);s!=null&&h(t,["imageSize"],s);const r=d(n,["personGeneration"]);r!=null&&h(t,["personGeneration"],r);const o=d(n,["outputMimeType"]);o!=null&&h(t,["imageOutputOptions","mimeType"],o);const a=d(n,["outputCompressionQuality"]);return a!=null&&h(t,["imageOutputOptions","compressionQuality"],a),t}function Bp(n,e){const t={},i=d(n,["bytesBase64Encoded"]);i!=null&&h(t,["imageBytes"],Et(i));const s=d(n,["mimeType"]);return s!=null&&h(t,["mimeType"],s),t}function Rl(n,e){const t={},i=d(n,["gcsUri"]);i!=null&&h(t,["gcsUri"],i);const s=d(n,["bytesBase64Encoded"]);s!=null&&h(t,["imageBytes"],Et(s));const r=d(n,["mimeType"]);return r!=null&&h(t,["mimeType"],r),t}function hn(n,e){const t={};if(d(n,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");const i=d(n,["imageBytes"]);i!=null&&h(t,["bytesBase64Encoded"],Et(i));const s=d(n,["mimeType"]);return s!=null&&h(t,["mimeType"],s),t}function We(n,e){const t={},i=d(n,["gcsUri"]);i!=null&&h(t,["gcsUri"],i);const s=d(n,["imageBytes"]);s!=null&&h(t,["bytesBase64Encoded"],Et(s));const r=d(n,["mimeType"]);return r!=null&&h(t,["mimeType"],r),t}function $p(n,e,t,i){const s={},r=d(e,["pageSize"]);t!==void 0&&r!=null&&h(t,["_query","pageSize"],r);const o=d(e,["pageToken"]);t!==void 0&&o!=null&&h(t,["_query","pageToken"],o);const a=d(e,["filter"]);t!==void 0&&a!=null&&h(t,["_query","filter"],a);const u=d(e,["queryBase"]);return t!==void 0&&u!=null&&h(t,["_url","models_url"],El(n,u)),s}function Gp(n,e,t,i){const s={},r=d(e,["pageSize"]);t!==void 0&&r!=null&&h(t,["_query","pageSize"],r);const o=d(e,["pageToken"]);t!==void 0&&o!=null&&h(t,["_query","pageToken"],o);const a=d(e,["filter"]);t!==void 0&&a!=null&&h(t,["_query","filter"],a);const u=d(e,["queryBase"]);return t!==void 0&&u!=null&&h(t,["_url","models_url"],El(n,u)),s}function Vp(n,e,t){const i={},s=d(e,["config"]);return s!=null&&$p(n,s,i),i}function Hp(n,e,t){const i={},s=d(e,["config"]);return s!=null&&Gp(n,s,i),i}function Kp(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["nextPageToken"]);s!=null&&h(t,["nextPageToken"],s);const r=d(n,["_self"]);if(r!=null){let o=Tl(r);Array.isArray(o)&&(o=o.map(a=>ts(a))),h(t,["models"],o)}return t}function qp(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["nextPageToken"]);s!=null&&h(t,["nextPageToken"],s);const r=d(n,["_self"]);if(r!=null){let o=Tl(r);Array.isArray(o)&&(o=o.map(a=>is(a))),h(t,["models"],o)}return t}function Yp(n,e){const t={},i=d(n,["maskMode"]);i!=null&&h(t,["maskMode"],i);const s=d(n,["segmentationClasses"]);s!=null&&h(t,["maskClasses"],s);const r=d(n,["maskDilation"]);return r!=null&&h(t,["dilation"],r),t}function ts(n,e){const t={},i=d(n,["name"]);i!=null&&h(t,["name"],i);const s=d(n,["displayName"]);s!=null&&h(t,["displayName"],s);const r=d(n,["description"]);r!=null&&h(t,["description"],r);const o=d(n,["version"]);o!=null&&h(t,["version"],o);const a=d(n,["_self"]);a!=null&&h(t,["tunedModelInfo"],lg(a));const u=d(n,["inputTokenLimit"]);u!=null&&h(t,["inputTokenLimit"],u);const l=d(n,["outputTokenLimit"]);l!=null&&h(t,["outputTokenLimit"],l);const c=d(n,["supportedGenerationMethods"]);c!=null&&h(t,["supportedActions"],c);const f=d(n,["temperature"]);f!=null&&h(t,["temperature"],f);const p=d(n,["maxTemperature"]);p!=null&&h(t,["maxTemperature"],p);const g=d(n,["topP"]);g!=null&&h(t,["topP"],g);const m=d(n,["topK"]);m!=null&&h(t,["topK"],m);const E=d(n,["thinking"]);return E!=null&&h(t,["thinking"],E),t}function is(n,e){const t={},i=d(n,["name"]);i!=null&&h(t,["name"],i);const s=d(n,["displayName"]);s!=null&&h(t,["displayName"],s);const r=d(n,["description"]);r!=null&&h(t,["description"],r);const o=d(n,["versionId"]);o!=null&&h(t,["version"],o);const a=d(n,["deployedModels"]);if(a!=null){let p=a;Array.isArray(p)&&(p=p.map(g=>rp(g))),h(t,["endpoints"],p)}const u=d(n,["labels"]);u!=null&&h(t,["labels"],u);const l=d(n,["_self"]);l!=null&&h(t,["tunedModelInfo"],ug(l));const c=d(n,["defaultCheckpointId"]);c!=null&&h(t,["defaultCheckpointId"],c);const f=d(n,["checkpoints"]);if(f!=null){let p=f;Array.isArray(p)&&(p=p.map(g=>g)),h(t,["checkpoints"],p)}return t}function Wp(n,e){const t={},i=d(n,["mediaResolution"]);i!=null&&h(t,["mediaResolution"],i);const s=d(n,["codeExecutionResult"]);s!=null&&h(t,["codeExecutionResult"],s);const r=d(n,["executableCode"]);r!=null&&h(t,["executableCode"],r);const o=d(n,["fileData"]);o!=null&&h(t,["fileData"],op(o));const a=d(n,["functionCall"]);a!=null&&h(t,["functionCall"],ap(a));const u=d(n,["functionResponse"]);u!=null&&h(t,["functionResponse"],u);const l=d(n,["inlineData"]);l!=null&&h(t,["inlineData"],wh(l));const c=d(n,["text"]);c!=null&&h(t,["text"],c);const f=d(n,["thought"]);f!=null&&h(t,["thought"],f);const p=d(n,["thoughtSignature"]);p!=null&&h(t,["thoughtSignature"],p);const g=d(n,["videoMetadata"]);return g!=null&&h(t,["videoMetadata"],g),t}function Jp(n,e){const t={},i=d(n,["productImage"]);return i!=null&&h(t,["image"],We(i)),t}function zp(n,e,t){const i={},s=d(n,["numberOfImages"]);e!==void 0&&s!=null&&h(e,["parameters","sampleCount"],s);const r=d(n,["baseSteps"]);e!==void 0&&r!=null&&h(e,["parameters","baseSteps"],r);const o=d(n,["outputGcsUri"]);e!==void 0&&o!=null&&h(e,["parameters","storageUri"],o);const a=d(n,["seed"]);e!==void 0&&a!=null&&h(e,["parameters","seed"],a);const u=d(n,["safetyFilterLevel"]);e!==void 0&&u!=null&&h(e,["parameters","safetySetting"],u);const l=d(n,["personGeneration"]);e!==void 0&&l!=null&&h(e,["parameters","personGeneration"],l);const c=d(n,["addWatermark"]);e!==void 0&&c!=null&&h(e,["parameters","addWatermark"],c);const f=d(n,["outputMimeType"]);e!==void 0&&f!=null&&h(e,["parameters","outputOptions","mimeType"],f);const p=d(n,["outputCompressionQuality"]);e!==void 0&&p!=null&&h(e,["parameters","outputOptions","compressionQuality"],p);const g=d(n,["enhancePrompt"]);e!==void 0&&g!=null&&h(e,["parameters","enhancePrompt"],g);const m=d(n,["labels"]);return e!==void 0&&m!=null&&h(e,["labels"],m),i}function Xp(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["source"]);r!=null&&Zp(r,i);const o=d(e,["config"]);return o!=null&&zp(o,i),i}function Qp(n,e){const t={},i=d(n,["predictions"]);if(i!=null){let s=i;Array.isArray(s)&&(s=s.map(r=>fn(r))),h(t,["generatedImages"],s)}return t}function Zp(n,e,t){const i={},s=d(n,["prompt"]);e!==void 0&&s!=null&&h(e,["instances[0]","prompt"],s);const r=d(n,["personImage"]);e!==void 0&&r!=null&&h(e,["instances[0]","personImage","image"],We(r));const o=d(n,["productImages"]);if(e!==void 0&&o!=null){let a=o;Array.isArray(a)&&(a=a.map(u=>Jp(u))),h(e,["instances[0]","productImages"],a)}return i}function jp(n,e){const t={},i=d(n,["referenceImage"]);i!=null&&h(t,["referenceImage"],We(i));const s=d(n,["referenceId"]);s!=null&&h(t,["referenceId"],s);const r=d(n,["referenceType"]);r!=null&&h(t,["referenceType"],r);const o=d(n,["maskImageConfig"]);o!=null&&h(t,["maskImageConfig"],Yp(o));const a=d(n,["controlImageConfig"]);a!=null&&h(t,["controlImageConfig"],Bh(a));const u=d(n,["styleImageConfig"]);u!=null&&h(t,["styleImageConfig"],u);const l=d(n,["subjectImageConfig"]);return l!=null&&h(t,["subjectImageConfig"],l),t}function xl(n,e){const t={},i=d(n,["safetyAttributes","categories"]);i!=null&&h(t,["categories"],i);const s=d(n,["safetyAttributes","scores"]);s!=null&&h(t,["scores"],s);const r=d(n,["contentType"]);return r!=null&&h(t,["contentType"],r),t}function Cl(n,e){const t={},i=d(n,["safetyAttributes","categories"]);i!=null&&h(t,["categories"],i);const s=d(n,["safetyAttributes","scores"]);s!=null&&h(t,["scores"],s);const r=d(n,["contentType"]);return r!=null&&h(t,["contentType"],r),t}function eg(n,e){const t={},i=d(n,["category"]);if(i!=null&&h(t,["category"],i),d(n,["method"])!==void 0)throw new Error("method parameter is not supported in Gemini API.");const s=d(n,["threshold"]);return s!=null&&h(t,["threshold"],s),t}function tg(n,e){const t={},i=d(n,["image"]);return i!=null&&h(t,["image"],We(i)),t}function ig(n,e,t){const i={},s=d(n,["mode"]);e!==void 0&&s!=null&&h(e,["parameters","mode"],s);const r=d(n,["maxPredictions"]);e!==void 0&&r!=null&&h(e,["parameters","maxPredictions"],r);const o=d(n,["confidenceThreshold"]);e!==void 0&&o!=null&&h(e,["parameters","confidenceThreshold"],o);const a=d(n,["maskDilation"]);e!==void 0&&a!=null&&h(e,["parameters","maskDilation"],a);const u=d(n,["binaryColorThreshold"]);e!==void 0&&u!=null&&h(e,["parameters","binaryColorThreshold"],u);const l=d(n,["labels"]);return e!==void 0&&l!=null&&h(e,["labels"],l),i}function ng(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["source"]);r!=null&&rg(r,i);const o=d(e,["config"]);return o!=null&&ig(o,i),i}function sg(n,e){const t={},i=d(n,["predictions"]);if(i!=null){let s=i;Array.isArray(s)&&(s=s.map(r=>Pp(r))),h(t,["generatedMasks"],s)}return t}function rg(n,e,t){const i={},s=d(n,["prompt"]);e!==void 0&&s!=null&&h(e,["instances[0]","prompt"],s);const r=d(n,["image"]);e!==void 0&&r!=null&&h(e,["instances[0]","image"],We(r));const o=d(n,["scribbleImage"]);return e!==void 0&&o!=null&&h(e,["instances[0]","scribble"],tg(o)),i}function og(n,e){const t={},i=d(n,["retrievalConfig"]);i!=null&&h(t,["retrievalConfig"],i);const s=d(n,["functionCallingConfig"]);return s!=null&&h(t,["functionCallingConfig"],lp(s)),t}function ag(n,e){const t={};if(d(n,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const i=d(n,["computerUse"]);i!=null&&h(t,["computerUse"],i);const s=d(n,["fileSearch"]);s!=null&&h(t,["fileSearch"],s);const r=d(n,["codeExecution"]);if(r!=null&&h(t,["codeExecution"],r),d(n,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const o=d(n,["functionDeclarations"]);if(o!=null){let f=o;Array.isArray(f)&&(f=f.map(p=>p)),h(t,["functionDeclarations"],f)}const a=d(n,["googleMaps"]);a!=null&&h(t,["googleMaps"],Np(a));const u=d(n,["googleSearch"]);u!=null&&h(t,["googleSearch"],Fp(u));const l=d(n,["googleSearchRetrieval"]);l!=null&&h(t,["googleSearchRetrieval"],l);const c=d(n,["urlContext"]);return c!=null&&h(t,["urlContext"],c),t}function Ll(n,e){const t={},i=d(n,["retrieval"]);i!=null&&h(t,["retrieval"],i);const s=d(n,["computerUse"]);if(s!=null&&h(t,["computerUse"],s),d(n,["fileSearch"])!==void 0)throw new Error("fileSearch parameter is not supported in Vertex AI.");const r=d(n,["codeExecution"]);r!=null&&h(t,["codeExecution"],r);const o=d(n,["enterpriseWebSearch"]);o!=null&&h(t,["enterpriseWebSearch"],o);const a=d(n,["functionDeclarations"]);if(a!=null){let p=a;Array.isArray(p)&&(p=p.map(g=>up(g))),h(t,["functionDeclarations"],p)}const u=d(n,["googleMaps"]);u!=null&&h(t,["googleMaps"],u);const l=d(n,["googleSearch"]);l!=null&&h(t,["googleSearch"],l);const c=d(n,["googleSearchRetrieval"]);c!=null&&h(t,["googleSearchRetrieval"],c);const f=d(n,["urlContext"]);return f!=null&&h(t,["urlContext"],f),t}function lg(n,e){const t={},i=d(n,["baseModel"]);i!=null&&h(t,["baseModel"],i);const s=d(n,["createTime"]);s!=null&&h(t,["createTime"],s);const r=d(n,["updateTime"]);return r!=null&&h(t,["updateTime"],r),t}function ug(n,e){const t={},i=d(n,["labels","google-vertex-llm-tuning-base-model-id"]);i!=null&&h(t,["baseModel"],i);const s=d(n,["createTime"]);s!=null&&h(t,["createTime"],s);const r=d(n,["updateTime"]);return r!=null&&h(t,["updateTime"],r),t}function cg(n,e,t){const i={},s=d(n,["displayName"]);e!==void 0&&s!=null&&h(e,["displayName"],s);const r=d(n,["description"]);e!==void 0&&r!=null&&h(e,["description"],r);const o=d(n,["defaultCheckpointId"]);return e!==void 0&&o!=null&&h(e,["defaultCheckpointId"],o),i}function dg(n,e,t){const i={},s=d(n,["displayName"]);e!==void 0&&s!=null&&h(e,["displayName"],s);const r=d(n,["description"]);e!==void 0&&r!=null&&h(e,["description"],r);const o=d(n,["defaultCheckpointId"]);return e!==void 0&&o!=null&&h(e,["defaultCheckpointId"],o),i}function fg(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","name"],se(n,s));const r=d(e,["config"]);return r!=null&&cg(r,i),i}function hg(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["config"]);return r!=null&&dg(r,i),i}function pg(n,e,t){const i={},s=d(n,["outputGcsUri"]);e!==void 0&&s!=null&&h(e,["parameters","storageUri"],s);const r=d(n,["safetyFilterLevel"]);e!==void 0&&r!=null&&h(e,["parameters","safetySetting"],r);const o=d(n,["personGeneration"]);e!==void 0&&o!=null&&h(e,["parameters","personGeneration"],o);const a=d(n,["includeRaiReason"]);e!==void 0&&a!=null&&h(e,["parameters","includeRaiReason"],a);const u=d(n,["outputMimeType"]);e!==void 0&&u!=null&&h(e,["parameters","outputOptions","mimeType"],u);const l=d(n,["outputCompressionQuality"]);e!==void 0&&l!=null&&h(e,["parameters","outputOptions","compressionQuality"],l);const c=d(n,["enhanceInputImage"]);e!==void 0&&c!=null&&h(e,["parameters","upscaleConfig","enhanceInputImage"],c);const f=d(n,["imagePreservationFactor"]);e!==void 0&&f!=null&&h(e,["parameters","upscaleConfig","imagePreservationFactor"],f);const p=d(n,["labels"]);e!==void 0&&p!=null&&h(e,["labels"],p);const g=d(n,["numberOfImages"]);e!==void 0&&g!=null&&h(e,["parameters","sampleCount"],g);const m=d(n,["mode"]);return e!==void 0&&m!=null&&h(e,["parameters","mode"],m),i}function gg(n,e,t){const i={},s=d(e,["model"]);s!=null&&h(i,["_url","model"],se(n,s));const r=d(e,["image"]);r!=null&&h(i,["instances[0]","image"],We(r));const o=d(e,["upscaleFactor"]);o!=null&&h(i,["parameters","upscaleConfig","upscaleFactor"],o);const a=d(e,["config"]);return a!=null&&pg(a,i),i}function mg(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["predictions"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>fn(o))),h(t,["generatedImages"],r)}return t}function yg(n,e){const t={},i=d(n,["uri"]);i!=null&&h(t,["uri"],i);const s=d(n,["encodedVideo"]);s!=null&&h(t,["videoBytes"],Et(s));const r=d(n,["encoding"]);return r!=null&&h(t,["mimeType"],r),t}function Eg(n,e){const t={},i=d(n,["gcsUri"]);i!=null&&h(t,["uri"],i);const s=d(n,["bytesBase64Encoded"]);s!=null&&h(t,["videoBytes"],Et(s));const r=d(n,["mimeType"]);return r!=null&&h(t,["mimeType"],r),t}function Tg(n,e){const t={},i=d(n,["image"]);i!=null&&h(t,["_self"],We(i));const s=d(n,["maskMode"]);return s!=null&&h(t,["maskMode"],s),t}function vg(n,e){const t={},i=d(n,["image"]);i!=null&&h(t,["image"],hn(i));const s=d(n,["referenceType"]);return s!=null&&h(t,["referenceType"],s),t}function Sg(n,e){const t={},i=d(n,["image"]);i!=null&&h(t,["image"],We(i));const s=d(n,["referenceType"]);return s!=null&&h(t,["referenceType"],s),t}function Pl(n,e){const t={},i=d(n,["uri"]);i!=null&&h(t,["uri"],i);const s=d(n,["videoBytes"]);s!=null&&h(t,["encodedVideo"],Et(s));const r=d(n,["mimeType"]);return r!=null&&h(t,["encoding"],r),t}function Dl(n,e){const t={},i=d(n,["uri"]);i!=null&&h(t,["gcsUri"],i);const s=d(n,["videoBytes"]);s!=null&&h(t,["bytesBase64Encoded"],Et(s));const r=d(n,["mimeType"]);return r!=null&&h(t,["mimeType"],r),t}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Ag(n,e){const t={},i=d(n,["displayName"]);return e!==void 0&&i!=null&&h(e,["displayName"],i),t}function Ig(n){const e={},t=d(n,["config"]);return t!=null&&Ag(t,e),e}function _g(n,e){const t={},i=d(n,["force"]);return e!==void 0&&i!=null&&h(e,["_query","force"],i),t}function Rg(n){const e={},t=d(n,["name"]);t!=null&&h(e,["_url","name"],t);const i=d(n,["config"]);return i!=null&&_g(i,e),e}function xg(n){const e={},t=d(n,["name"]);return t!=null&&h(e,["_url","name"],t),e}function Cg(n,e){const t={},i=d(n,["customMetadata"]);if(e!==void 0&&i!=null){let r=i;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["customMetadata"],r)}const s=d(n,["chunkingConfig"]);return e!==void 0&&s!=null&&h(e,["chunkingConfig"],s),t}function Lg(n){const e={},t=d(n,["name"]);t!=null&&h(e,["name"],t);const i=d(n,["metadata"]);i!=null&&h(e,["metadata"],i);const s=d(n,["done"]);s!=null&&h(e,["done"],s);const r=d(n,["error"]);r!=null&&h(e,["error"],r);const o=d(n,["response"]);return o!=null&&h(e,["response"],Dg(o)),e}function Pg(n){const e={},t=d(n,["fileSearchStoreName"]);t!=null&&h(e,["_url","file_search_store_name"],t);const i=d(n,["fileName"]);i!=null&&h(e,["fileName"],i);const s=d(n,["config"]);return s!=null&&Cg(s,e),e}function Dg(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["parent"]);i!=null&&h(e,["parent"],i);const s=d(n,["documentName"]);return s!=null&&h(e,["documentName"],s),e}function bg(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);return e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),t}function wg(n){const e={},t=d(n,["config"]);return t!=null&&bg(t,e),e}function kg(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["fileSearchStores"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["fileSearchStores"],r)}return e}function bl(n,e){const t={},i=d(n,["mimeType"]);e!==void 0&&i!=null&&h(e,["mimeType"],i);const s=d(n,["displayName"]);e!==void 0&&s!=null&&h(e,["displayName"],s);const r=d(n,["customMetadata"]);if(e!==void 0&&r!=null){let a=r;Array.isArray(a)&&(a=a.map(u=>u)),h(e,["customMetadata"],a)}const o=d(n,["chunkingConfig"]);return e!==void 0&&o!=null&&h(e,["chunkingConfig"],o),t}function Mg(n){const e={},t=d(n,["fileSearchStoreName"]);t!=null&&h(e,["_url","file_search_store_name"],t);const i=d(n,["config"]);return i!=null&&bl(i,e),e}function Ng(n){const e={},t=d(n,["sdkHttpResponse"]);return t!=null&&h(e,["sdkHttpResponse"],t),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Fg="Content-Type",Ug="X-Server-Timeout",Og="User-Agent",ns="x-goog-api-client",Bg="1.40.0",$g=`google-genai-sdk/${Bg}`,Gg="v1beta1",Vg="v1beta";class Hg{constructor(e){var t,i,s;this.clientOptions=Object.assign({},e),this.customBaseUrl=(t=e.httpOptions)===null||t===void 0?void 0:t.baseUrl,this.clientOptions.vertexai&&(this.clientOptions.project&&this.clientOptions.location?this.clientOptions.apiKey=void 0:this.clientOptions.apiKey&&(this.clientOptions.project=void 0,this.clientOptions.location=void 0));const r={};if(this.clientOptions.vertexai){if(!this.clientOptions.location&&!this.clientOptions.apiKey&&!this.customBaseUrl&&(this.clientOptions.location="global"),!(this.clientOptions.project&&this.clientOptions.location||this.clientOptions.apiKey)&&!this.customBaseUrl)throw new Error("Authentication is not set up. Please provide either a project and location, or an API key, or a custom base URL.");const a=e.project&&e.location||!!e.apiKey;this.customBaseUrl&&!a?(r.baseUrl=this.customBaseUrl,this.clientOptions.project=void 0,this.clientOptions.location=void 0):this.clientOptions.apiKey||this.clientOptions.location==="global"?r.baseUrl="https://aiplatform.googleapis.com/":this.clientOptions.project&&this.clientOptions.location&&(r.baseUrl=`https://${this.clientOptions.location}-aiplatform.googleapis.com/`),r.apiVersion=(i=this.clientOptions.apiVersion)!==null&&i!==void 0?i:Gg}else{if(!this.clientOptions.apiKey)throw new li({message:"API key must be set when using the Gemini API.",status:403});r.apiVersion=(s=this.clientOptions.apiVersion)!==null&&s!==void 0?s:Vg,r.baseUrl="https://generativelanguage.googleapis.com/"}r.headers=this.getDefaultHeaders(),this.clientOptions.httpOptions=r,e.httpOptions&&(this.clientOptions.httpOptions=this.patchHttpOptions(r,e.httpOptions))}isVertexAI(){var e;return(e=this.clientOptions.vertexai)!==null&&e!==void 0?e:!1}getProject(){return this.clientOptions.project}getLocation(){return this.clientOptions.location}getCustomBaseUrl(){return this.customBaseUrl}async getAuthHeaders(){const e=new Headers;return await this.clientOptions.auth.addAuthHeaders(e),e}getApiVersion(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.apiVersion!==void 0)return this.clientOptions.httpOptions.apiVersion;throw new Error("API version is not set.")}getBaseUrl(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.baseUrl!==void 0)return this.clientOptions.httpOptions.baseUrl;throw new Error("Base URL is not set.")}getRequestUrl(){return this.getRequestUrlInternal(this.clientOptions.httpOptions)}getHeaders(){if(this.clientOptions.httpOptions&&this.clientOptions.httpOptions.headers!==void 0)return this.clientOptions.httpOptions.headers;throw new Error("Headers are not set.")}getRequestUrlInternal(e){if(!e||e.baseUrl===void 0||e.apiVersion===void 0)throw new Error("HTTP options are not correctly set.");const i=[e.baseUrl.endsWith("/")?e.baseUrl.slice(0,-1):e.baseUrl];return e.apiVersion&&e.apiVersion!==""&&i.push(e.apiVersion),i.join("/")}getBaseResourcePath(){return`projects/${this.clientOptions.project}/locations/${this.clientOptions.location}`}getApiKey(){return this.clientOptions.apiKey}getWebsocketBaseUrl(){const e=this.getBaseUrl(),t=new URL(e);return t.protocol=t.protocol=="http:"?"ws":"wss",t.toString()}setBaseUrl(e){if(this.clientOptions.httpOptions)this.clientOptions.httpOptions.baseUrl=e;else throw new Error("HTTP options are not correctly set.")}constructUrl(e,t,i){const s=[this.getRequestUrlInternal(t)];return i&&s.push(this.getBaseResourcePath()),e!==""&&s.push(e),new URL(`${s.join("/")}`)}shouldPrependVertexProjectPath(e,t){return!(t.baseUrl&&t.baseUrlResourceScope===Qn.COLLECTION||this.clientOptions.apiKey||!this.clientOptions.vertexai||e.path.startsWith("projects/")||e.httpMethod==="GET"&&e.path.startsWith("publishers/google/models"))}async request(e){let t=this.clientOptions.httpOptions;e.httpOptions&&(t=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));const i=this.shouldPrependVertexProjectPath(e,t),s=this.constructUrl(e.path,t,i);if(e.queryParams)for(const[o,a]of Object.entries(e.queryParams))s.searchParams.append(o,String(a));let r={};if(e.httpMethod==="GET"){if(e.body&&e.body!=="{}")throw new Error("Request body should be empty for GET request, but got non empty request body")}else r.body=e.body;return r=await this.includeExtraHttpOptionsToRequestInit(r,t,s.toString(),e.abortSignal),this.unaryApiCall(s,r,e.httpMethod)}patchHttpOptions(e,t){const i=JSON.parse(JSON.stringify(e));for(const[s,r]of Object.entries(t))typeof r=="object"?i[s]=Object.assign(Object.assign({},i[s]),r):r!==void 0&&(i[s]=r);return i}async requestStream(e){let t=this.clientOptions.httpOptions;e.httpOptions&&(t=this.patchHttpOptions(this.clientOptions.httpOptions,e.httpOptions));const i=this.shouldPrependVertexProjectPath(e,t),s=this.constructUrl(e.path,t,i);(!s.searchParams.has("alt")||s.searchParams.get("alt")!=="sse")&&s.searchParams.set("alt","sse");let r={};return r.body=e.body,r=await this.includeExtraHttpOptionsToRequestInit(r,t,s.toString(),e.abortSignal),this.streamApiCall(s,r,e.httpMethod)}async includeExtraHttpOptionsToRequestInit(e,t,i,s){if(t&&t.timeout||s){const r=new AbortController,o=r.signal;if(t.timeout&&(t==null?void 0:t.timeout)>0){const a=setTimeout(()=>r.abort(),t.timeout);a&&typeof a.unref=="function"&&a.unref()}s&&s.addEventListener("abort",()=>{r.abort()}),e.signal=o}return t&&t.extraBody!==null&&Kg(e,t.extraBody),e.headers=await this.getHeadersInternal(t,i),e}async unaryApiCall(e,t,i){return this.apiCall(e.toString(),Object.assign(Object.assign({},t),{method:i})).then(async s=>(await Mo(s),new Zn(s))).catch(s=>{throw s instanceof Error?s:new Error(JSON.stringify(s))})}async streamApiCall(e,t,i){return this.apiCall(e.toString(),Object.assign(Object.assign({},t),{method:i})).then(async s=>(await Mo(s),this.processStreamResponse(s))).catch(s=>{throw s instanceof Error?s:new Error(JSON.stringify(s))})}processStreamResponse(e){return qe(this,arguments,function*(){var i;const s=(i=e==null?void 0:e.body)===null||i===void 0?void 0:i.getReader(),r=new TextDecoder("utf-8");if(!s)throw new Error("Response body is empty");try{let o="";const a="data:",u=[`

`,"\r\r",`\r
\r
`];for(;;){const{done:l,value:c}=yield X(s.read());if(l){if(o.trim().length>0)throw new Error("Incomplete JSON segment at the end");break}const f=r.decode(c,{stream:!0});try{const m=JSON.parse(f);if("error"in m){const E=JSON.parse(JSON.stringify(m.error)),y=E.status,v=E.code,S=`got status: ${y}. ${JSON.stringify(m)}`;if(v>=400&&v<600)throw new li({message:S,status:v})}}catch(m){if(m.name==="ApiError")throw m}o+=f;let p=-1,g=0;for(;;){p=-1,g=0;for(const y of u){const v=o.indexOf(y);v!==-1&&(p===-1||v<p)&&(p=v,g=y.length)}if(p===-1)break;const m=o.substring(0,p);o=o.substring(p+g);const E=m.trim();if(E.startsWith(a)){const y=E.substring(a.length).trim();try{const v=new Response(y,{headers:e==null?void 0:e.headers,status:e==null?void 0:e.status,statusText:e==null?void 0:e.statusText});yield yield X(new Zn(v))}catch(v){throw new Error(`exception parsing stream chunk ${y}. ${v}`)}}}}}finally{s.releaseLock()}})}async apiCall(e,t){return fetch(e,t).catch(i=>{throw new Error(`exception ${i} sending request`)})}getDefaultHeaders(){const e={},t=$g+" "+this.clientOptions.userAgentExtra;return e[Og]=t,e[ns]=t,e[Fg]="application/json",e}async getHeadersInternal(e,t){const i=new Headers;if(e&&e.headers){for(const[s,r]of Object.entries(e.headers))i.append(s,r);e.timeout&&e.timeout>0&&i.append(Ug,String(Math.ceil(e.timeout/1e3)))}return await this.clientOptions.auth.addAuthHeaders(i,t),i}getFileName(e){var t;let i="";return typeof e=="string"&&(i=e.replace(/[/\\]+$/,""),i=(t=i.split(/[/\\]/).pop())!==null&&t!==void 0?t:""),i}async uploadFile(e,t){var i;const s={};t!=null&&(s.mimeType=t.mimeType,s.name=t.name,s.displayName=t.displayName),s.name&&!s.name.startsWith("files/")&&(s.name=`files/${s.name}`);const r=this.clientOptions.uploader,o=await r.stat(e);s.sizeBytes=String(o.size);const a=(i=t==null?void 0:t.mimeType)!==null&&i!==void 0?i:o.type;if(a===void 0||a==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");s.mimeType=a;const u={file:s},l=this.getFileName(e),c=G("upload/v1beta/files",u._url),f=await this.fetchUploadUrl(c,s.sizeBytes,s.mimeType,l,u,t==null?void 0:t.httpOptions);return r.upload(e,f,this)}async uploadFileToFileSearchStore(e,t,i){var s;const r=this.clientOptions.uploader,o=await r.stat(t),a=String(o.size),u=(s=i==null?void 0:i.mimeType)!==null&&s!==void 0?s:o.type;if(u===void 0||u==="")throw new Error("Can not determine mimeType. Please provide mimeType in the config.");const l=`upload/v1beta/${e}:uploadToFileSearchStore`,c=this.getFileName(t),f={};i!=null&&bl(i,f);const p=await this.fetchUploadUrl(l,a,u,c,f,i==null?void 0:i.httpOptions);return r.uploadToFileSearchStore(t,p,this)}async downloadFile(e){await this.clientOptions.downloader.download(e,this)}async fetchUploadUrl(e,t,i,s,r,o){var a;let u={};o?u=o:u={apiVersion:"",headers:Object.assign({"Content-Type":"application/json","X-Goog-Upload-Protocol":"resumable","X-Goog-Upload-Command":"start","X-Goog-Upload-Header-Content-Length":`${t}`,"X-Goog-Upload-Header-Content-Type":`${i}`},s?{"X-Goog-Upload-File-Name":s}:{})};const l=await this.request({path:e,body:JSON.stringify(r),httpMethod:"POST",httpOptions:u});if(!l||!(l!=null&&l.headers))throw new Error("Server did not return an HttpResponse or the returned HttpResponse did not have headers.");const c=(a=l==null?void 0:l.headers)===null||a===void 0?void 0:a["x-goog-upload-url"];if(c===void 0)throw new Error("Failed to get upload url. Server did not return the x-google-upload-url in the headers");return c}}async function Mo(n){var e;if(n===void 0)throw new Error("response is undefined");if(!n.ok){const t=n.status;let i;!((e=n.headers.get("content-type"))===null||e===void 0)&&e.includes("application/json")?i=await n.json():i={error:{message:await n.text(),code:n.status,status:n.statusText}};const s=JSON.stringify(i);throw t>=400&&t<600?new li({message:s,status:t}):new Error(s)}}function Kg(n,e){if(!e||Object.keys(e).length===0)return;if(n.body instanceof Blob){console.warn("includeExtraBodyToRequestInit: extraBody provided but current request body is a Blob. extraBody will be ignored as merging is not supported for Blob bodies.");return}let t={};if(typeof n.body=="string"&&n.body.length>0)try{const r=JSON.parse(n.body);if(typeof r=="object"&&r!==null&&!Array.isArray(r))t=r;else{console.warn("includeExtraBodyToRequestInit: Original request body is valid JSON but not a non-array object. Skip applying extraBody to the request body.");return}}catch{console.warn("includeExtraBodyToRequestInit: Original request body is not valid JSON. Skip applying extraBody to the request body.");return}function i(r,o){const a=Object.assign({},r);for(const u in o)if(Object.prototype.hasOwnProperty.call(o,u)){const l=o[u],c=a[u];l&&typeof l=="object"&&!Array.isArray(l)&&c&&typeof c=="object"&&!Array.isArray(c)?a[u]=i(c,l):(c&&l&&typeof c!=typeof l&&console.warn(`includeExtraBodyToRequestInit:deepMerge: Type mismatch for key "${u}". Original type: ${typeof c}, New type: ${typeof l}. Overwriting.`),a[u]=l)}return a}const s=i(t,e);n.body=JSON.stringify(s)}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const qg="mcp_used/unknown";let Yg=!1;function wl(n){for(const e of n)if(Wg(e)||typeof e=="object"&&"inputSchema"in e)return!0;return Yg}function kl(n){var e;const t=(e=n[ns])!==null&&e!==void 0?e:"";n[ns]=(t+` ${qg}`).trimStart()}function Wg(n){return n!==null&&typeof n=="object"&&n instanceof Fs}function Jg(n){return qe(this,arguments,function*(t,i=100){let s,r=0;for(;r<i;){const o=yield X(t.listTools({cursor:s}));for(const a of o.tools)yield yield X(a),r++;if(!o.nextCursor)break;s=o.nextCursor}})}class Fs{constructor(e=[],t){this.mcpTools=[],this.functionNameToMcpClient={},this.mcpClients=e,this.config=t}static create(e,t){return new Fs(e,t)}async initialize(){var e,t,i,s;if(this.mcpTools.length>0)return;const r={},o=[];for(const c of this.mcpClients)try{for(var a=!0,u=(t=void 0,Ye(Jg(c))),l;l=await u.next(),e=l.done,!e;a=!0){s=l.value,a=!1;const f=s;o.push(f);const p=f.name;if(r[p])throw new Error(`Duplicate function name ${p} found in MCP tools. Please ensure function names are unique.`);r[p]=c}}catch(f){t={error:f}}finally{try{!a&&!e&&(i=u.return)&&await i.call(u)}finally{if(t)throw t.error}}this.mcpTools=o,this.functionNameToMcpClient=r}async tool(){return await this.initialize(),Ad(this.mcpTools,this.config)}async callTool(e){await this.initialize();const t=[];for(const i of e)if(i.name in this.functionNameToMcpClient){const s=this.functionNameToMcpClient[i.name];let r;this.config.timeout&&(r={timeout:this.config.timeout});const o=await s.callTool({name:i.name,arguments:i.args},void 0,r);t.push({functionResponse:{name:i.name,response:o.isError?{error:o}:o}})}return t}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */async function zg(n,e,t){const i=new pd;let s;t.data instanceof Blob?s=JSON.parse(await t.data.text()):s=JSON.parse(t.data),Object.assign(i,s),e(i)}class Xg{constructor(e,t,i){this.apiClient=e,this.auth=t,this.webSocketFactory=i}async connect(e){var t,i;if(this.apiClient.isVertexAI())throw new Error("Live music is not supported for Vertex AI.");console.warn("Live music generation is experimental and may change in future versions.");const s=this.apiClient.getWebsocketBaseUrl(),r=this.apiClient.getApiVersion(),o=jg(this.apiClient.getDefaultHeaders()),a=this.apiClient.getApiKey(),u=`${s}/ws/google.ai.generativelanguage.${r}.GenerativeService.BidiGenerateMusic?key=${a}`;let l=()=>{};const c=new Promise(A=>{l=A}),f=e.callbacks,p=function(){l({})},g=this.apiClient,m={onopen:p,onmessage:A=>{zg(g,f.onmessage,A)},onerror:(t=f==null?void 0:f.onerror)!==null&&t!==void 0?t:function(A){},onclose:(i=f==null?void 0:f.onclose)!==null&&i!==void 0?i:function(A){}},E=this.webSocketFactory.create(u,Zg(o),m);E.connect(),await c;const S={setup:{model:se(this.apiClient,e.model)}};return E.send(JSON.stringify(S)),new Qg(E,this.apiClient)}}class Qg{constructor(e,t){this.conn=e,this.apiClient=t}async setWeightedPrompts(e){if(!e.weightedPrompts||Object.keys(e.weightedPrompts).length===0)throw new Error("Weighted prompts must be set and contain at least one entry.");const t=Ah(e);this.conn.send(JSON.stringify({clientContent:t}))}async setMusicGenerationConfig(e){e.musicGenerationConfig||(e.musicGenerationConfig={});const t=Sh(e);this.conn.send(JSON.stringify(t))}sendPlaybackControl(e){const t={playbackControl:e};this.conn.send(JSON.stringify(t))}play(){this.sendPlaybackControl(Ot.PLAY)}pause(){this.sendPlaybackControl(Ot.PAUSE)}stop(){this.sendPlaybackControl(Ot.STOP)}resetContext(){this.sendPlaybackControl(Ot.RESET_CONTEXT)}close(){this.conn.close()}}function Zg(n){const e={};return n.forEach((t,i)=>{e[i]=t}),e}function jg(n){const e=new Headers;for(const[t,i]of Object.entries(n))e.append(t,i);return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const em="FunctionResponse request must have an `id` field from the response of a ToolCall.FunctionalCalls in Google AI.";async function tm(n,e,t){const i=new hd;let s;t.data instanceof Blob?s=await t.data.text():t.data instanceof ArrayBuffer?s=new TextDecoder().decode(t.data):s=t.data;const r=JSON.parse(s);if(n.isVertexAI()){const o=Rh(r);Object.assign(i,o)}else Object.assign(i,r);e(i)}class im{constructor(e,t,i){this.apiClient=e,this.auth=t,this.webSocketFactory=i,this.music=new Xg(this.apiClient,this.auth,this.webSocketFactory)}async connect(e){var t,i,s,r,o,a;if(e.config&&e.config.httpOptions)throw new Error("The Live module does not support httpOptions at request-level in LiveConnectConfig yet. Please use the client-level httpOptions configuration instead.");const u=this.apiClient.getWebsocketBaseUrl(),l=this.apiClient.getApiVersion();let c;const f=this.apiClient.getHeaders();e.config&&e.config.tools&&wl(e.config.tools)&&kl(f);const p=om(f);if(this.apiClient.isVertexAI()){const C=this.apiClient.getProject(),x=this.apiClient.getLocation(),w=this.apiClient.getApiKey(),M=!!C&&!!x||!!w;this.apiClient.getCustomBaseUrl()&&!M?c=u:(c=`${u}/ws/google.cloud.aiplatform.${l}.LlmBidiService/BidiGenerateContent`,await this.auth.addAuthHeaders(p,c))}else{const C=this.apiClient.getApiKey();let x="BidiGenerateContent",w="key";C!=null&&C.startsWith("auth_tokens/")&&(console.warn("Warning: Ephemeral token support is experimental and may change in future versions."),l!=="v1alpha"&&console.warn("Warning: The SDK's ephemeral token support is in v1alpha only. Please use const ai = new GoogleGenAI({apiKey: token.name, httpOptions: { apiVersion: 'v1alpha' }}); before session connection."),x="BidiGenerateContentConstrained",w="access_token"),c=`${u}/ws/google.ai.generativelanguage.${l}.GenerativeService.${x}?${w}=${C}`}let g=()=>{};const m=new Promise(C=>{g=C}),E=e.callbacks,y=function(){var C;(C=E==null?void 0:E.onopen)===null||C===void 0||C.call(E),g({})},v=this.apiClient,S={onopen:y,onmessage:C=>{tm(v,E.onmessage,C)},onerror:(t=E==null?void 0:E.onerror)!==null&&t!==void 0?t:function(C){},onclose:(i=E==null?void 0:E.onclose)!==null&&i!==void 0?i:function(C){}},A=this.webSocketFactory.create(c,rm(p),S);A.connect(),await m;let _=se(this.apiClient,e.model);if(this.apiClient.isVertexAI()&&_.startsWith("publishers/")){const C=this.apiClient.getProject(),x=this.apiClient.getLocation();C&&x&&(_=`projects/${C}/locations/${x}/`+_)}let I={};this.apiClient.isVertexAI()&&((s=e.config)===null||s===void 0?void 0:s.responseModalities)===void 0&&(e.config===void 0?e.config={responseModalities:[Wi.AUDIO]}:e.config.responseModalities=[Wi.AUDIO]),!((r=e.config)===null||r===void 0)&&r.generationConfig&&console.warn("Setting `LiveConnectConfig.generation_config` is deprecated, please set the fields on `LiveConnectConfig` directly. This will become an error in a future version (not before Q3 2025).");const P=(a=(o=e.config)===null||o===void 0?void 0:o.tools)!==null&&a!==void 0?a:[],R=[];for(const C of P)if(this.isCallableTool(C)){const x=C;R.push(await x.tool())}else R.push(C);R.length>0&&(e.config.tools=R);const L={model:_,config:e.config,callbacks:e.callbacks};return this.apiClient.isVertexAI()?I=vh(this.apiClient,L):I=Th(this.apiClient,L),delete I.config,A.send(JSON.stringify(I)),new sm(A,this.apiClient)}isCallableTool(e){return"callTool"in e&&typeof e.callTool=="function"}}const nm={turnComplete:!0};class sm{constructor(e,t){this.conn=e,this.apiClient=t}tLiveClientContent(e,t){if(t.turns!==null&&t.turns!==void 0){let i=[];try{i=Oe(t.turns),e.isVertexAI()||(i=i.map(s=>dn(s)))}catch{throw new Error(`Failed to parse client content "turns", type: '${typeof t.turns}'`)}return{clientContent:{turns:i,turnComplete:t.turnComplete}}}return{clientContent:{turnComplete:t.turnComplete}}}tLiveClienttToolResponse(e,t){let i=[];if(t.functionResponses==null)throw new Error("functionResponses is required.");if(Array.isArray(t.functionResponses)?i=t.functionResponses:i=[t.functionResponses],i.length===0)throw new Error("functionResponses is required.");for(const r of i){if(typeof r!="object"||r===null||!("name"in r)||!("response"in r))throw new Error(`Could not parse function response, type '${typeof r}'.`);if(!e.isVertexAI()&&!("id"in r))throw new Error(em)}return{toolResponse:{functionResponses:i}}}sendClientContent(e){e=Object.assign(Object.assign({},nm),e);const t=this.tLiveClientContent(this.apiClient,e);this.conn.send(JSON.stringify(t))}sendRealtimeInput(e){let t={};this.apiClient.isVertexAI()?t={realtimeInput:_h(e)}:t={realtimeInput:Ih(e)},this.conn.send(JSON.stringify(t))}sendToolResponse(e){if(e.functionResponses==null)throw new Error("Tool response parameters are required.");const t=this.tLiveClienttToolResponse(this.apiClient,e);this.conn.send(JSON.stringify(t))}close(){this.conn.close()}}function rm(n){const e={};return n.forEach((t,i)=>{e[i]=t}),e}function om(n){const e=new Headers;for(const[t,i]of Object.entries(n))e.append(t,i);return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const No=10;function Fo(n){var e,t,i;if(!((e=n==null?void 0:n.automaticFunctionCalling)===null||e===void 0)&&e.disable)return!0;let s=!1;for(const o of(t=n==null?void 0:n.tools)!==null&&t!==void 0?t:[])if(Vt(o)){s=!0;break}if(!s)return!0;const r=(i=n==null?void 0:n.automaticFunctionCalling)===null||i===void 0?void 0:i.maximumRemoteCalls;return r&&(r<0||!Number.isInteger(r))||r==0?(console.warn("Invalid maximumRemoteCalls value provided for automatic function calling. Disabled automatic function calling. Please provide a valid integer value greater than 0. maximumRemoteCalls provided:",r),!0):!1}function Vt(n){return"callTool"in n&&typeof n.callTool=="function"}function am(n){var e,t,i;return(i=(t=(e=n.config)===null||e===void 0?void 0:e.tools)===null||t===void 0?void 0:t.some(s=>Vt(s)))!==null&&i!==void 0?i:!1}function Uo(n){var e;const t=[];return!((e=n==null?void 0:n.config)===null||e===void 0)&&e.tools&&n.config.tools.forEach((i,s)=>{if(Vt(i))return;const r=i;r.functionDeclarations&&r.functionDeclarations.length>0&&t.push(s)}),t}function Oo(n){var e;return!(!((e=n==null?void 0:n.automaticFunctionCalling)===null||e===void 0)&&e.ignoreCallHistory)}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class lm extends lt{constructor(e){super(),this.apiClient=e,this.generateContent=async t=>{var i,s,r,o,a;const u=await this.processParamsMaybeAddMcpUsage(t);if(this.maybeMoveToResponseJsonSchem(t),!am(t)||Fo(t.config))return await this.generateContentInternal(u);const l=Uo(t);if(l.length>0){const E=l.map(y=>`tools[${y}]`).join(", ");throw new Error(`Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations is not yet supported. Incompatible tools found at ${E}.`)}let c,f;const p=Oe(u.contents),g=(r=(s=(i=u.config)===null||i===void 0?void 0:i.automaticFunctionCalling)===null||s===void 0?void 0:s.maximumRemoteCalls)!==null&&r!==void 0?r:No;let m=0;for(;m<g&&(c=await this.generateContentInternal(u),!(!c.functionCalls||c.functionCalls.length===0));){const E=c.candidates[0].content,y=[];for(const v of(a=(o=t.config)===null||o===void 0?void 0:o.tools)!==null&&a!==void 0?a:[])if(Vt(v)){const A=await v.callTool(c.functionCalls);y.push(...A)}m++,f={role:"user",parts:y},u.contents=Oe(u.contents),u.contents.push(E),u.contents.push(f),Oo(u.config)&&(p.push(E),p.push(f))}return Oo(u.config)&&(c.automaticFunctionCallingHistory=p),c},this.generateContentStream=async t=>{var i,s,r,o,a;if(this.maybeMoveToResponseJsonSchem(t),Fo(t.config)){const f=await this.processParamsMaybeAddMcpUsage(t);return await this.generateContentStreamInternal(f)}const u=Uo(t);if(u.length>0){const f=u.map(p=>`tools[${p}]`).join(", ");throw new Error(`Incompatible tools found at ${f}. Automatic function calling with CallableTools (or MCP objects) and basic FunctionDeclarations" is not yet supported.`)}const l=(r=(s=(i=t==null?void 0:t.config)===null||i===void 0?void 0:i.toolConfig)===null||s===void 0?void 0:s.functionCallingConfig)===null||r===void 0?void 0:r.streamFunctionCallArguments,c=(a=(o=t==null?void 0:t.config)===null||o===void 0?void 0:o.automaticFunctionCalling)===null||a===void 0?void 0:a.disable;if(l&&!c)throw new Error("Running in streaming mode with 'streamFunctionCallArguments' enabled, this feature is not compatible with automatic function calling (AFC). Please set 'config.automaticFunctionCalling.disable' to true to disable AFC or leave 'config.toolConfig.functionCallingConfig.streamFunctionCallArguments' to be undefined or set to false to disable streaming function call arguments feature.");return await this.processAfcStream(t)},this.generateImages=async t=>await this.generateImagesInternal(t).then(i=>{var s;let r;const o=[];if(i!=null&&i.generatedImages)for(const u of i.generatedImages)u&&(u!=null&&u.safetyAttributes)&&((s=u==null?void 0:u.safetyAttributes)===null||s===void 0?void 0:s.contentType)==="Positive Prompt"?r=u==null?void 0:u.safetyAttributes:o.push(u);let a;return r?a={generatedImages:o,positivePromptSafetyAttributes:r,sdkHttpResponse:i.sdkHttpResponse}:a={generatedImages:o,sdkHttpResponse:i.sdkHttpResponse},a}),this.list=async t=>{var i;const o={config:Object.assign(Object.assign({},{queryBase:!0}),t==null?void 0:t.config)};if(this.apiClient.isVertexAI()&&!o.config.queryBase){if(!((i=o.config)===null||i===void 0)&&i.filter)throw new Error("Filtering tuned models list for Vertex AI is not currently supported");o.config.filter="labels.tune-type:*"}return new Pt(at.PAGED_ITEM_MODELS,a=>this.listInternal(a),await this.listInternal(o),o)},this.editImage=async t=>{const i={model:t.model,prompt:t.prompt,referenceImages:[],config:t.config};return t.referenceImages&&t.referenceImages&&(i.referenceImages=t.referenceImages.map(s=>s.toReferenceImageAPI())),await this.editImageInternal(i)},this.upscaleImage=async t=>{let i={numberOfImages:1,mode:"upscale"};t.config&&(i=Object.assign(Object.assign({},i),t.config));const s={model:t.model,image:t.image,upscaleFactor:t.upscaleFactor,config:i};return await this.upscaleImageInternal(s)},this.generateVideos=async t=>{var i,s,r,o,a,u;if((t.prompt||t.image||t.video)&&t.source)throw new Error("Source and prompt/image/video are mutually exclusive. Please only use source.");return this.apiClient.isVertexAI()||(!((i=t.video)===null||i===void 0)&&i.uri&&(!((s=t.video)===null||s===void 0)&&s.videoBytes)?t.video={uri:t.video.uri,mimeType:t.video.mimeType}:!((o=(r=t.source)===null||r===void 0?void 0:r.video)===null||o===void 0)&&o.uri&&(!((u=(a=t.source)===null||a===void 0?void 0:a.video)===null||u===void 0)&&u.videoBytes)&&(t.source.video={uri:t.source.video.uri,mimeType:t.source.video.mimeType})),await this.generateVideosInternal(t)}}maybeMoveToResponseJsonSchem(e){e.config&&e.config.responseSchema&&(e.config.responseJsonSchema||Object.keys(e.config.responseSchema).includes("$schema")&&(e.config.responseJsonSchema=e.config.responseSchema,delete e.config.responseSchema))}async processParamsMaybeAddMcpUsage(e){var t,i,s;const r=(t=e.config)===null||t===void 0?void 0:t.tools;if(!r)return e;const o=await Promise.all(r.map(async u=>Vt(u)?await u.tool():u)),a={model:e.model,contents:e.contents,config:Object.assign(Object.assign({},e.config),{tools:o})};if(a.config.tools=o,e.config&&e.config.tools&&wl(e.config.tools)){const u=(s=(i=e.config.httpOptions)===null||i===void 0?void 0:i.headers)!==null&&s!==void 0?s:{};let l=Object.assign({},u);Object.keys(l).length===0&&(l=this.apiClient.getDefaultHeaders()),kl(l),a.config.httpOptions=Object.assign(Object.assign({},e.config.httpOptions),{headers:l})}return a}async initAfcToolsMap(e){var t,i,s;const r=new Map;for(const o of(i=(t=e.config)===null||t===void 0?void 0:t.tools)!==null&&i!==void 0?i:[])if(Vt(o)){const a=o,u=await a.tool();for(const l of(s=u.functionDeclarations)!==null&&s!==void 0?s:[]){if(!l.name)throw new Error("Function declaration name is required.");if(r.has(l.name))throw new Error(`Duplicate tool declaration name: ${l.name}`);r.set(l.name,a)}}return r}async processAfcStream(e){var t,i,s;const r=(s=(i=(t=e.config)===null||t===void 0?void 0:t.automaticFunctionCalling)===null||i===void 0?void 0:i.maximumRemoteCalls)!==null&&s!==void 0?s:No;let o=!1,a=0;const u=await this.initAfcToolsMap(e);return(function(l,c,f){return qe(this,arguments,function*(){for(var p,g,m,E,y,v;a<r;){o&&(a++,o=!1);const I=yield X(l.processParamsMaybeAddMcpUsage(f)),P=yield X(l.generateContentStreamInternal(I)),R=[],L=[];try{for(var S=!0,A=(g=void 0,Ye(P)),_;_=yield X(A.next()),p=_.done,!p;S=!0){E=_.value,S=!1;const C=E;if(yield yield X(C),C.candidates&&(!((y=C.candidates[0])===null||y===void 0)&&y.content)){L.push(C.candidates[0].content);for(const x of(v=C.candidates[0].content.parts)!==null&&v!==void 0?v:[])if(a<r&&x.functionCall){if(!x.functionCall.name)throw new Error("Function call name was not returned by the model.");if(c.has(x.functionCall.name)){const w=yield X(c.get(x.functionCall.name).callTool([x.functionCall]));R.push(...w)}else throw new Error(`Automatic function calling was requested, but not all the tools the model used implement the CallableTool interface. Available tools: ${c.keys()}, mising tool: ${x.functionCall.name}`)}}}}catch(C){g={error:C}}finally{try{!S&&!p&&(m=A.return)&&(yield X(m.call(A)))}finally{if(g)throw g.error}}if(R.length>0){o=!0;const C=new ei;C.candidates=[{content:{role:"user",parts:R}}],yield yield X(C);const x=[];x.push(...L),x.push({role:"user",parts:R});const w=Oe(f.contents).concat(x);f.contents=w}else break}})})(this,u,e)}async generateContentInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=bo(this.apiClient,e);return a=G("{model}:generateContent",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=ko(c),p=new ei;return Object.assign(p,f),p})}else{const l=Do(this.apiClient,e);return a=G("{model}:generateContent",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=wo(c),p=new ei;return Object.assign(p,f),p})}}async generateContentStreamInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=bo(this.apiClient,e);return a=G("{model}:streamGenerateContent?alt=sse",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.requestStream({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}),o.then(function(f){return qe(this,arguments,function*(){var p,g,m,E;try{for(var y=!0,v=Ye(f),S;S=yield X(v.next()),p=S.done,!p;y=!0){E=S.value,y=!1;const A=E,_=ko(yield X(A.json()),e);_.sdkHttpResponse={headers:A.headers};const I=new ei;Object.assign(I,_),yield yield X(I)}}catch(A){g={error:A}}finally{try{!y&&!p&&(m=v.return)&&(yield X(m.call(v)))}finally{if(g)throw g.error}}})})}else{const l=Do(this.apiClient,e);return a=G("{model}:streamGenerateContent?alt=sse",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.requestStream({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}),o.then(function(f){return qe(this,arguments,function*(){var p,g,m,E;try{for(var y=!0,v=Ye(f),S;S=yield X(v.next()),p=S.done,!p;y=!0){E=S.value,y=!1;const A=E,_=wo(yield X(A.json()),e);_.sdkHttpResponse={headers:A.headers};const I=new ei;Object.assign(I,_),yield yield X(I)}}catch(A){g={error:A}}finally{try{!y&&!p&&(m=v.return)&&(yield X(m.call(v)))}finally{if(g)throw g.error}}})})}}async embedContent(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=ip(this.apiClient,e);return a=G("{model}:predict",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=sp(c),p=new ho;return Object.assign(p,f),p})}else{const l=tp(this.apiClient,e);return a=G("{model}:batchEmbedContents",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=np(c),p=new ho;return Object.assign(p,f),p})}}async generateImagesInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=gp(this.apiClient,e);return a=G("{model}:predict",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=yp(c),p=new po;return Object.assign(p,f),p})}else{const l=pp(this.apiClient,e);return a=G("{model}:predict",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=mp(c),p=new po;return Object.assign(p,f),p})}}async editImageInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=Qh(this.apiClient,e);return r=G("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>{const l=Zh(u),c=new td;return Object.assign(c,l),c})}else throw new Error("This method is only supported by the Vertex AI.")}async upscaleImageInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=gg(this.apiClient,e);return r=G("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>{const l=mg(u),c=new id;return Object.assign(c,l),c})}else throw new Error("This method is only supported by the Vertex AI.")}async recontextImage(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=Xp(this.apiClient,e);return r=G("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=Qp(u),c=new nd;return Object.assign(c,l),c})}else throw new Error("This method is only supported by the Vertex AI.")}async segmentImage(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=ng(this.apiClient,e);return r=G("{model}:predict",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=sg(u),c=new sd;return Object.assign(c,l),c})}else throw new Error("This method is only supported by the Vertex AI.")}async get(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Mp(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>is(c))}else{const l=kp(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>ts(c))}}async listInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Hp(this.apiClient,e);return a=G("{models_url}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=qp(c),p=new go;return Object.assign(p,f),p})}else{const l=Vp(this.apiClient,e);return a=G("{models_url}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Kp(c),p=new go;return Object.assign(p,f),p})}}async update(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=hg(this.apiClient,e);return a=G("{model}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"PATCH",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>is(c))}else{const l=fg(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"PATCH",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>ts(c))}}async delete(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Wh(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=zh(c),p=new mo;return Object.assign(p,f),p})}else{const l=Yh(this.apiClient,e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"DELETE",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Jh(c),p=new mo;return Object.assign(p,f),p})}}async countTokens(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Hh(this.apiClient,e);return a=G("{model}:countTokens",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=qh(c),p=new yo;return Object.assign(p,f),p})}else{const l=Vh(this.apiClient,e);return a=G("{model}:countTokens",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=Kh(c),p=new yo;return Object.assign(p,f),p})}}async computeTokens(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=Nh(this.apiClient,e);return r=G("{model}:computeTokens",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>{const l=Fh(u),c=new rd;return Object.assign(c,l),c})}else throw new Error("This method is only supported by the Vertex AI.")}async generateVideosInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=Ip(this.apiClient,e);return a=G("{model}:predictLongRunning",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o.then(c=>{const f=Sp(c),p=new Ji;return Object.assign(p,f),p})}else{const l=Ap(this.apiClient,e);return a=G("{model}:predictLongRunning",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o.then(c=>{const f=vp(c),p=new Ji;return Object.assign(p,f),p})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class um extends lt{constructor(e){super(),this.apiClient=e}async getVideosOperation(e){const t=e.operation,i=e.config;if(t.name===void 0||t.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){const s=t.name.split("/operations/")[0];let r;i&&"httpOptions"in i&&(r=i.httpOptions);const o=await this.fetchPredictVideosOperationInternal({operationName:t.name,resourceName:s,config:{httpOptions:r}});return t._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{const s=await this.getVideosOperationInternal({operationName:t.name,config:i});return t._fromAPIResponse({apiResponse:s,_isVertexAI:!1})}}async get(e){const t=e.operation,i=e.config;if(t.name===void 0||t.name==="")throw new Error("Operation name is required.");if(this.apiClient.isVertexAI()){const s=t.name.split("/operations/")[0];let r;i&&"httpOptions"in i&&(r=i.httpOptions);const o=await this.fetchPredictVideosOperationInternal({operationName:t.name,resourceName:s,config:{httpOptions:r}});return t._fromAPIResponse({apiResponse:o,_isVertexAI:!0})}else{const s=await this.getVideosOperationInternal({operationName:t.name,config:i});return t._fromAPIResponse({apiResponse:s,_isVertexAI:!1})}}async getVideosOperationInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=zc(e);return a=G("{operationName}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json()),o}else{const l=Jc(e);return a=G("{operationName}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json()),o}}async fetchPredictVideosOperationInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=Gc(e);return r=G("{resourceName}:fetchPredictOperation",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s}else throw new Error("This method is only supported by the Vertex AI.")}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function cm(n){const e={},t=d(n,["data"]);if(t!=null&&h(e,["data"],t),d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function dm(n){const e={},t=d(n,["parts"]);if(t!=null){let s=t;Array.isArray(s)&&(s=s.map(r=>vm(r))),h(e,["parts"],s)}const i=d(n,["role"]);return i!=null&&h(e,["role"],i),e}function fm(n,e,t){const i={},s=d(e,["expireTime"]);t!==void 0&&s!=null&&h(t,["expireTime"],s);const r=d(e,["newSessionExpireTime"]);t!==void 0&&r!=null&&h(t,["newSessionExpireTime"],r);const o=d(e,["uses"]);t!==void 0&&o!=null&&h(t,["uses"],o);const a=d(e,["liveConnectConstraints"]);t!==void 0&&a!=null&&h(t,["bidiGenerateContentSetup"],Tm(n,a));const u=d(e,["lockAdditionalFields"]);return t!==void 0&&u!=null&&h(t,["fieldMask"],u),i}function hm(n,e){const t={},i=d(e,["config"]);return i!=null&&h(t,["config"],fm(n,i,t)),t}function pm(n){const e={};if(d(n,["displayName"])!==void 0)throw new Error("displayName parameter is not supported in Gemini API.");const t=d(n,["fileUri"]);t!=null&&h(e,["fileUri"],t);const i=d(n,["mimeType"]);return i!=null&&h(e,["mimeType"],i),e}function gm(n){const e={},t=d(n,["id"]);t!=null&&h(e,["id"],t);const i=d(n,["args"]);i!=null&&h(e,["args"],i);const s=d(n,["name"]);if(s!=null&&h(e,["name"],s),d(n,["partialArgs"])!==void 0)throw new Error("partialArgs parameter is not supported in Gemini API.");if(d(n,["willContinue"])!==void 0)throw new Error("willContinue parameter is not supported in Gemini API.");return e}function mm(n){const e={};if(d(n,["authConfig"])!==void 0)throw new Error("authConfig parameter is not supported in Gemini API.");const t=d(n,["enableWidget"]);return t!=null&&h(e,["enableWidget"],t),e}function ym(n){const e={};if(d(n,["excludeDomains"])!==void 0)throw new Error("excludeDomains parameter is not supported in Gemini API.");if(d(n,["blockingConfidence"])!==void 0)throw new Error("blockingConfidence parameter is not supported in Gemini API.");const t=d(n,["timeRangeFilter"]);return t!=null&&h(e,["timeRangeFilter"],t),e}function Em(n,e){const t={},i=d(n,["generationConfig"]);e!==void 0&&i!=null&&h(e,["setup","generationConfig"],i);const s=d(n,["responseModalities"]);e!==void 0&&s!=null&&h(e,["setup","generationConfig","responseModalities"],s);const r=d(n,["temperature"]);e!==void 0&&r!=null&&h(e,["setup","generationConfig","temperature"],r);const o=d(n,["topP"]);e!==void 0&&o!=null&&h(e,["setup","generationConfig","topP"],o);const a=d(n,["topK"]);e!==void 0&&a!=null&&h(e,["setup","generationConfig","topK"],a);const u=d(n,["maxOutputTokens"]);e!==void 0&&u!=null&&h(e,["setup","generationConfig","maxOutputTokens"],u);const l=d(n,["mediaResolution"]);e!==void 0&&l!=null&&h(e,["setup","generationConfig","mediaResolution"],l);const c=d(n,["seed"]);e!==void 0&&c!=null&&h(e,["setup","generationConfig","seed"],c);const f=d(n,["speechConfig"]);e!==void 0&&f!=null&&h(e,["setup","generationConfig","speechConfig"],Ns(f));const p=d(n,["thinkingConfig"]);e!==void 0&&p!=null&&h(e,["setup","generationConfig","thinkingConfig"],p);const g=d(n,["enableAffectiveDialog"]);e!==void 0&&g!=null&&h(e,["setup","generationConfig","enableAffectiveDialog"],g);const m=d(n,["systemInstruction"]);e!==void 0&&m!=null&&h(e,["setup","systemInstruction"],dm(Re(m)));const E=d(n,["tools"]);if(e!==void 0&&E!=null){let P=Xt(E);Array.isArray(P)&&(P=P.map(R=>Am(zt(R)))),h(e,["setup","tools"],P)}const y=d(n,["sessionResumption"]);e!==void 0&&y!=null&&h(e,["setup","sessionResumption"],Sm(y));const v=d(n,["inputAudioTranscription"]);e!==void 0&&v!=null&&h(e,["setup","inputAudioTranscription"],v);const S=d(n,["outputAudioTranscription"]);e!==void 0&&S!=null&&h(e,["setup","outputAudioTranscription"],S);const A=d(n,["realtimeInputConfig"]);e!==void 0&&A!=null&&h(e,["setup","realtimeInputConfig"],A);const _=d(n,["contextWindowCompression"]);e!==void 0&&_!=null&&h(e,["setup","contextWindowCompression"],_);const I=d(n,["proactivity"]);if(e!==void 0&&I!=null&&h(e,["setup","proactivity"],I),d(n,["explicitVadSignal"])!==void 0)throw new Error("explicitVadSignal parameter is not supported in Gemini API.");return t}function Tm(n,e){const t={},i=d(e,["model"]);i!=null&&h(t,["setup","model"],se(n,i));const s=d(e,["config"]);return s!=null&&h(t,["config"],Em(s,t)),t}function vm(n){const e={},t=d(n,["mediaResolution"]);t!=null&&h(e,["mediaResolution"],t);const i=d(n,["codeExecutionResult"]);i!=null&&h(e,["codeExecutionResult"],i);const s=d(n,["executableCode"]);s!=null&&h(e,["executableCode"],s);const r=d(n,["fileData"]);r!=null&&h(e,["fileData"],pm(r));const o=d(n,["functionCall"]);o!=null&&h(e,["functionCall"],gm(o));const a=d(n,["functionResponse"]);a!=null&&h(e,["functionResponse"],a);const u=d(n,["inlineData"]);u!=null&&h(e,["inlineData"],cm(u));const l=d(n,["text"]);l!=null&&h(e,["text"],l);const c=d(n,["thought"]);c!=null&&h(e,["thought"],c);const f=d(n,["thoughtSignature"]);f!=null&&h(e,["thoughtSignature"],f);const p=d(n,["videoMetadata"]);return p!=null&&h(e,["videoMetadata"],p),e}function Sm(n){const e={},t=d(n,["handle"]);if(t!=null&&h(e,["handle"],t),d(n,["transparent"])!==void 0)throw new Error("transparent parameter is not supported in Gemini API.");return e}function Am(n){const e={};if(d(n,["retrieval"])!==void 0)throw new Error("retrieval parameter is not supported in Gemini API.");const t=d(n,["computerUse"]);t!=null&&h(e,["computerUse"],t);const i=d(n,["fileSearch"]);i!=null&&h(e,["fileSearch"],i);const s=d(n,["codeExecution"]);if(s!=null&&h(e,["codeExecution"],s),d(n,["enterpriseWebSearch"])!==void 0)throw new Error("enterpriseWebSearch parameter is not supported in Gemini API.");const r=d(n,["functionDeclarations"]);if(r!=null){let c=r;Array.isArray(c)&&(c=c.map(f=>f)),h(e,["functionDeclarations"],c)}const o=d(n,["googleMaps"]);o!=null&&h(e,["googleMaps"],mm(o));const a=d(n,["googleSearch"]);a!=null&&h(e,["googleSearch"],ym(a));const u=d(n,["googleSearchRetrieval"]);u!=null&&h(e,["googleSearchRetrieval"],u);const l=d(n,["urlContext"]);return l!=null&&h(e,["urlContext"],l),e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Im(n){const e=[];for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)){const i=n[t];if(typeof i=="object"&&i!=null&&Object.keys(i).length>0){const s=Object.keys(i).map(r=>`${t}.${r}`);e.push(...s)}else e.push(t)}return e.join(",")}function _m(n,e){let t=null;const i=n.bidiGenerateContentSetup;if(typeof i=="object"&&i!==null&&"setup"in i){const r=i.setup;typeof r=="object"&&r!==null?(n.bidiGenerateContentSetup=r,t=r):delete n.bidiGenerateContentSetup}else i!==void 0&&delete n.bidiGenerateContentSetup;const s=n.fieldMask;if(t){const r=Im(t);if(Array.isArray(e==null?void 0:e.lockAdditionalFields)&&(e==null?void 0:e.lockAdditionalFields.length)===0)r?n.fieldMask=r:delete n.fieldMask;else if(e!=null&&e.lockAdditionalFields&&e.lockAdditionalFields.length>0&&s!==null&&Array.isArray(s)&&s.length>0){const o=["temperature","topK","topP","maxOutputTokens","responseModalities","seed","speechConfig"];let a=[];s.length>0&&(a=s.map(l=>o.includes(l)?`generationConfig.${l}`:l));const u=[];r&&u.push(r),a.length>0&&u.push(...a),u.length>0?n.fieldMask=u.join(","):delete n.fieldMask}else delete n.fieldMask}else s!==null&&Array.isArray(s)&&s.length>0?n.fieldMask=s.join(","):delete n.fieldMask;return n}class Rm extends lt{constructor(e){super(),this.apiClient=e}async create(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("The client.tokens.create method is only supported by the Gemini Developer API.");{const a=hm(this.apiClient,e);r=G("auth_tokens",a._url),o=a._query,delete a.config,delete a._url,delete a._query;const u=_m(a,e.config);return s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(u),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(l=>l.json()),s.then(l=>l)}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function xm(n,e){const t={},i=d(n,["force"]);return e!==void 0&&i!=null&&h(e,["_query","force"],i),t}function Cm(n){const e={},t=d(n,["name"]);t!=null&&h(e,["_url","name"],t);const i=d(n,["config"]);return i!=null&&xm(i,e),e}function Lm(n){const e={},t=d(n,["name"]);return t!=null&&h(e,["_url","name"],t),e}function Pm(n,e){const t={},i=d(n,["pageSize"]);e!==void 0&&i!=null&&h(e,["_query","pageSize"],i);const s=d(n,["pageToken"]);return e!==void 0&&s!=null&&h(e,["_query","pageToken"],s),t}function Dm(n){const e={},t=d(n,["parent"]);t!=null&&h(e,["_url","parent"],t);const i=d(n,["config"]);return i!=null&&Pm(i,e),e}function bm(n){const e={},t=d(n,["sdkHttpResponse"]);t!=null&&h(e,["sdkHttpResponse"],t);const i=d(n,["nextPageToken"]);i!=null&&h(e,["nextPageToken"],i);const s=d(n,["documents"]);if(s!=null){let r=s;Array.isArray(r)&&(r=r.map(o=>o)),h(e,["documents"],r)}return e}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class wm extends lt{constructor(e){super(),this.apiClient=e,this.list=async t=>new Pt(at.PAGED_ITEM_DOCUMENTS,i=>this.listInternal({parent:t.parent,config:i.config}),await this.listInternal(t),t)}async get(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Lm(e);return r=G("{name}",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>u)}}async delete(e){var t,i;let s="",r={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const o=Cm(e);s=G("{name}",o._url),r=o._query,delete o._url,delete o._query,await this.apiClient.request({path:s,queryParams:r,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal})}}async listInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Dm(e);return r=G("{parent}/documents",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=bm(u),c=new od;return Object.assign(c,l),c})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class km extends lt{constructor(e,t=new wm(e)){super(),this.apiClient=e,this.documents=t,this.list=async(i={})=>new Pt(at.PAGED_ITEM_FILE_SEARCH_STORES,s=>this.listInternal(s),await this.listInternal(i),i)}async uploadToFileSearchStore(e){if(this.apiClient.isVertexAI())throw new Error("Vertex AI does not support uploading files to a file search store.");return this.apiClient.uploadFileToFileSearchStore(e.fileSearchStoreName,e.file,e.config)}async create(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Ig(e);return r=G("fileSearchStores",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>u)}}async get(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=xg(e);return r=G("{name}",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>u)}}async delete(e){var t,i;let s="",r={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const o=Rg(e);s=G("{name}",o._url),r=o._query,delete o._url,delete o._query,await this.apiClient.request({path:s,queryParams:r,body:JSON.stringify(o),httpMethod:"DELETE",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal})}}async listInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=wg(e);return r=G("fileSearchStores",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=kg(u),c=new ad;return Object.assign(c,l),c})}}async uploadToFileSearchStoreInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Mg(e);return r=G("upload/v1beta/{file_search_store_name}:uploadToFileSearchStore",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=Ng(u),c=new ld;return Object.assign(c,l),c})}}async importFile(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=Pg(e);return r=G("{file_search_store_name}:importFile",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json()),s.then(u=>{const l=Lg(u),c=new Ds;return Object.assign(c,l),c})}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */let Ml=function(){const{crypto:n}=globalThis;if(n!=null&&n.randomUUID)return Ml=n.randomUUID.bind(n),n.randomUUID();const e=new Uint8Array(1),t=n?()=>n.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,i=>(+i^t()&15>>+i/4).toString(16))};const Mm=()=>Ml();/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function ss(n){return typeof n=="object"&&n!==null&&("name"in n&&n.name==="AbortError"||"message"in n&&String(n.message).includes("FetchRequestCanceledException"))}const rs=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null){try{if(Object.prototype.toString.call(n)==="[object Error]"){const e=new Error(n.message,n.cause?{cause:n.cause}:{});return n.stack&&(e.stack=n.stack),n.cause&&!e.cause&&(e.cause=n.cause),n.name&&(e.name=n.name),e}}catch{}try{return new Error(JSON.stringify(n))}catch{}}return new Error(n)};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Be extends Error{}class Le extends Be{constructor(e,t,i,s){super(`${Le.makeMessage(e,t,i)}`),this.status=e,this.headers=s,this.error=t}static makeMessage(e,t,i){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):i;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,i,s){if(!e||!s)return new pn({message:i,cause:rs(t)});const r=t;return e===400?new Fl(e,r,i,s):e===401?new Ul(e,r,i,s):e===403?new Ol(e,r,i,s):e===404?new Bl(e,r,i,s):e===409?new $l(e,r,i,s):e===422?new Gl(e,r,i,s):e===429?new Vl(e,r,i,s):e>=500?new Hl(e,r,i,s):new Le(e,r,i,s)}}class os extends Le{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class pn extends Le{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class Nl extends pn{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Fl extends Le{}class Ul extends Le{}class Ol extends Le{}class Bl extends Le{}class $l extends Le{}class Gl extends Le{}class Vl extends Le{}class Hl extends Le{}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Nm=/^[a-z][a-z0-9+.-]*:/i,Fm=n=>Nm.test(n);let as=n=>(as=Array.isArray,as(n));const Um=as;let Om=Um;const Bo=Om;function Bm(n){if(!n)return!0;for(const e in n)return!1;return!0}function $m(n,e){return Object.prototype.hasOwnProperty.call(n,e)}const Gm=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new Be(`${n} must be an integer`);if(e<0)throw new Be(`${n} must be a positive integer`);return e},Vm=n=>{try{return JSON.parse(n)}catch{return}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Hm=n=>new Promise(e=>setTimeout(e,n));/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Ft="0.0.1";/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Km(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const qm=()=>{var n,e,t,i,s;const r=Km();if(r==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ft,"X-Stainless-OS":Go(Deno.build.os),"X-Stainless-Arch":$o(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(e=(n=Deno.version)===null||n===void 0?void 0:n.deno)!==null&&e!==void 0?e:"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ft,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(r==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ft,"X-Stainless-OS":Go((t=globalThis.process.platform)!==null&&t!==void 0?t:"unknown"),"X-Stainless-Arch":$o((i=globalThis.process.arch)!==null&&i!==void 0?i:"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":(s=globalThis.process.version)!==null&&s!==void 0?s:"unknown"};const o=Ym();return o?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ft,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${o.browser}`,"X-Stainless-Runtime-Version":o.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ft,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Ym(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const i=t.exec(navigator.userAgent);if(i){const s=i[1]||0,r=i[2]||0,o=i[3]||0;return{browser:e,version:`${s}.${r}.${o}`}}}return null}const $o=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Go=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let yi;const Wm=()=>yi??(yi=qm());/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function Jm(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new GeminiNextGenAPIClient({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Kl(...n){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...n)}function zm(n){let e=Symbol.asyncIterator in n?n[Symbol.asyncIterator]():n[Symbol.iterator]();return Kl({start(){},async pull(t){const{done:i,value:s}=await e.next();i?t.close():t.enqueue(s)},async cancel(){var t;await((t=e.return)===null||t===void 0?void 0:t.call(e))}})}function ql(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function Xm(n){var e,t;if(n===null||typeof n!="object")return;if(n[Symbol.asyncIterator]){await((t=(e=n[Symbol.asyncIterator]()).return)===null||t===void 0?void 0:t.call(e));return}const i=n.getReader(),s=i.cancel();i.releaseLock(),await s}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Qm=({headers:n,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Yl=()=>{var n;if(typeof File>"u"){const{process:e}=globalThis,t=typeof((n=e==null?void 0:e.versions)===null||n===void 0?void 0:n.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function An(n,e,t){return Yl(),new File(n,e??"unknown_file",t)}function Zm(n){return(typeof n=="object"&&n!==null&&("name"in n&&n.name&&String(n.name)||"url"in n&&n.url&&String(n.url)||"filename"in n&&n.filename&&String(n.filename)||"path"in n&&n.path&&String(n.path))||"").split(/[\\/]/).pop()||void 0}const jm=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function";/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Wl=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",e0=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&Wl(n),t0=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function";async function i0(n,e,t){if(Yl(),n=await n,e0(n))return n instanceof File?n:An([await n.arrayBuffer()],n.name);if(t0(n)){const s=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()),An(await ls(s),e,t)}const i=await ls(n);if(e||(e=Zm(n)),!(t!=null&&t.type)){const s=i.find(r=>typeof r=="object"&&"type"in r&&r.type);typeof s=="string"&&(t=Object.assign(Object.assign({},t),{type:s}))}return An(i,e,t)}async function ls(n){var e,t,i,s,r;let o=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)o.push(n);else if(Wl(n))o.push(n instanceof Blob?n:await n.arrayBuffer());else if(jm(n))try{for(var a=!0,u=Ye(n),l;l=await u.next(),e=l.done,!e;a=!0){s=l.value,a=!1;const c=s;o.push(...await ls(c))}}catch(c){t={error:c}}finally{try{!a&&!e&&(i=u.return)&&await i.call(u)}finally{if(t)throw t.error}}else{const c=(r=n==null?void 0:n.constructor)===null||r===void 0?void 0:r.name;throw new Error(`Unexpected data type: ${typeof n}${c?`; constructor: ${c}`:""}${n0(n)}`)}return o}function n0(n){return typeof n!="object"||n===null?"":`; props: [${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Jl{constructor(e){this._client=e}}Jl._key=[];/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function zl(n){return n.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Vo=Object.freeze(Object.create(null)),s0=(n=zl)=>(function(t,...i){if(t.length===1)return t[0];let s=!1;const r=[],o=t.reduce((c,f,p)=>{var g,m,E;/[?#]/.test(f)&&(s=!0);const y=i[p];let v=(s?encodeURIComponent:n)(""+y);return p!==i.length&&(y==null||typeof y=="object"&&y.toString===((E=Object.getPrototypeOf((m=Object.getPrototypeOf((g=y.hasOwnProperty)!==null&&g!==void 0?g:Vo))!==null&&m!==void 0?m:Vo))===null||E===void 0?void 0:E.toString))&&(v=y+"",r.push({start:c.length+f.length,length:v.length,error:`Value of type ${Object.prototype.toString.call(y).slice(8,-1)} is not a valid path parameter`})),c+f+(p===i.length?"":v)},""),a=o.split(/[?#]/,1)[0],u=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let l;for(;(l=u.exec(a))!==null;)r.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(r.sort((c,f)=>c.start-f.start),r.length>0){let c=0;const f=r.reduce((p,g)=>{const m=" ".repeat(g.start-c),E="^".repeat(g.length);return c=g.start+g.length,p+m+E},"");throw new Be(`Path parameters result in path with invalid segments:
${r.map(p=>p.error).join(`
`)}
${o}
${f}`)}return o}),Ei=s0(zl);/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Xl extends Jl{create(e,t){var i;const{api_version:s=this._client.apiVersion}=e,r=Xi(e,["api_version"]);if("model"in r&&"agent_config"in r)throw new Be("Invalid request: specified `model` and `agent_config`. If specifying `model`, use `generation_config`.");if("agent"in r&&"generation_config"in r)throw new Be("Invalid request: specified `agent` and `generation_config`. If specifying `agent`, use `agent_config`.");return this._client.post(Ei`/${s}/interactions`,Object.assign(Object.assign({body:r},t),{stream:(i=e.stream)!==null&&i!==void 0?i:!1}))}delete(e,t={},i){const{api_version:s=this._client.apiVersion}=t??{};return this._client.delete(Ei`/${s}/interactions/${e}`,i)}cancel(e,t={},i){const{api_version:s=this._client.apiVersion}=t??{};return this._client.post(Ei`/${s}/interactions/${e}/cancel`,i)}get(e,t={},i){var s;const r=t??{},{api_version:o=this._client.apiVersion}=r,a=Xi(r,["api_version"]);return this._client.get(Ei`/${o}/interactions/${e}`,Object.assign(Object.assign({query:a},i),{stream:(s=t==null?void 0:t.stream)!==null&&s!==void 0?s:!1}))}}Xl._key=Object.freeze(["interactions"]);class Ql extends Xl{}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function r0(n){let e=0;for(const s of n)e+=s.length;const t=new Uint8Array(e);let i=0;for(const s of n)t.set(s,i),i+=s.length;return t}let Ti;function Us(n){let e;return(Ti??(e=new globalThis.TextEncoder,Ti=e.encode.bind(e)))(n)}let vi;function Ho(n){let e;return(vi??(e=new globalThis.TextDecoder,vi=e.decode.bind(e)))(n)}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class gn{constructor(){this.buffer=new Uint8Array,this.carriageReturnIndex=null}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?Us(e):e;this.buffer=r0([this.buffer,t]);const i=[];let s;for(;(s=o0(this.buffer,this.carriageReturnIndex))!=null;){if(s.carriage&&this.carriageReturnIndex==null){this.carriageReturnIndex=s.index;continue}if(this.carriageReturnIndex!=null&&(s.index!==this.carriageReturnIndex+1||s.carriage)){i.push(Ho(this.buffer.subarray(0,this.carriageReturnIndex-1))),this.buffer=this.buffer.subarray(this.carriageReturnIndex),this.carriageReturnIndex=null;continue}const r=this.carriageReturnIndex!==null?s.preceding-1:s.preceding,o=Ho(this.buffer.subarray(0,r));i.push(o),this.buffer=this.buffer.subarray(s.index),this.carriageReturnIndex=null}return i}flush(){return this.buffer.length?this.decode(`
`):[]}}gn.NEWLINE_CHARS=new Set([`
`,"\r"]);gn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function o0(n,e){for(let s=e??0;s<n.length;s++){if(n[s]===10)return{preceding:s,index:s+1,carriage:!1};if(n[s]===13)return{preceding:s,index:s+1,carriage:!0}}return null}function a0(n){for(let i=0;i<n.length-1;i++){if(n[i]===10&&n[i+1]===10||n[i]===13&&n[i+1]===13)return i+2;if(n[i]===13&&n[i+1]===10&&i+3<n.length&&n[i+2]===13&&n[i+3]===10)return i+4}return-1}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Qi={off:0,error:200,warn:300,info:400,debug:500},Ko=(n,e,t)=>{if(n){if($m(Qi,n))return n;xe(t).warn(`${e} was set to ${JSON.stringify(n)}, expected one of ${JSON.stringify(Object.keys(Qi))}`)}};function ni(){}function Si(n,e,t){return!e||Qi[n]>Qi[t]?ni:e[n].bind(e)}const l0={error:ni,warn:ni,info:ni,debug:ni};let qo=new WeakMap;function xe(n){var e;const t=n.logger,i=(e=n.logLevel)!==null&&e!==void 0?e:"off";if(!t)return l0;const s=qo.get(t);if(s&&s[0]===i)return s[1];const r={error:Si("error",t,i),warn:Si("warn",t,i),info:Si("info",t,i),debug:Si("debug",t,i)};return qo.set(t,[i,r]),r}const _t=n=>(n.options&&(n.options=Object.assign({},n.options),delete n.options.headers),n.headers&&(n.headers=Object.fromEntries((n.headers instanceof Headers?[...n.headers]:Object.entries(n.headers)).map(([e,t])=>[e,e.toLowerCase()==="x-goog-api-key"||e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in n&&(n.retryOfRequestLogID&&(n.retryOf=n.retryOfRequestLogID),delete n.retryOfRequestLogID),n);/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Bt{constructor(e,t,i){this.iterator=e,this.controller=t,this.client=i}static fromSSEResponse(e,t,i){let s=!1;const r=i?xe(i):console;function o(){return qe(this,arguments,function*(){var u,l,c,f;if(s)throw new Be("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let p=!1;try{try{for(var g=!0,m=Ye(u0(e,t)),E;E=yield X(m.next()),u=E.done,!u;g=!0){f=E.value,g=!1;const y=f;if(!p)if(y.data.startsWith("[DONE]")){p=!0;continue}else try{yield yield X(JSON.parse(y.data))}catch(v){throw r.error("Could not parse message into JSON:",y.data),r.error("From chunk:",y.raw),v}}}catch(y){l={error:y}}finally{try{!g&&!u&&(c=m.return)&&(yield X(c.call(m)))}finally{if(l)throw l.error}}p=!0}catch(y){if(ss(y))return yield X(void 0);throw y}finally{p||t.abort()}})}return new Bt(o,t,i)}static fromReadableStream(e,t,i){let s=!1;function r(){return qe(this,arguments,function*(){var u,l,c,f;const p=new gn,g=ql(e);try{for(var m=!0,E=Ye(g),y;y=yield X(E.next()),u=y.done,!u;m=!0){f=y.value,m=!1;const v=f;for(const S of p.decode(v))yield yield X(S)}}catch(v){l={error:v}}finally{try{!m&&!u&&(c=E.return)&&(yield X(c.call(E)))}finally{if(l)throw l.error}}for(const v of p.flush())yield yield X(v)})}function o(){return qe(this,arguments,function*(){var u,l,c,f;if(s)throw new Be("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let p=!1;try{try{for(var g=!0,m=Ye(r()),E;E=yield X(m.next()),u=E.done,!u;g=!0){f=E.value,g=!1;const y=f;p||y&&(yield yield X(JSON.parse(y)))}}catch(y){l={error:y}}finally{try{!g&&!u&&(c=m.return)&&(yield X(c.call(m)))}finally{if(l)throw l.error}}p=!0}catch(y){if(ss(y))return yield X(void 0);throw y}finally{p||t.abort()}})}return new Bt(o,t,i)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],i=this.iterator(),s=r=>({next:()=>{if(r.length===0){const o=i.next();e.push(o),t.push(o)}return r.shift()}});return[new Bt(()=>s(e),this.controller,this.client),new Bt(()=>s(t),this.controller,this.client)]}toReadableStream(){const e=this;let t;return Kl({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{const{value:s,done:r}=await t.next();if(r)return i.close();const o=Us(JSON.stringify(s)+`
`);i.enqueue(o)}catch(s){i.error(s)}},async cancel(){var i;await((i=t.return)===null||i===void 0?void 0:i.call(t))}})}}function u0(n,e){return qe(this,arguments,function*(){var i,s,r,o;if(!n.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new Be("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new Be("Attempted to iterate over a response with no body");const a=new d0,u=new gn,l=ql(n.body);try{for(var c=!0,f=Ye(c0(l)),p;p=yield X(f.next()),i=p.done,!i;c=!0){o=p.value,c=!1;const g=o;for(const m of u.decode(g)){const E=a.decode(m);E&&(yield yield X(E))}}}catch(g){s={error:g}}finally{try{!c&&!i&&(r=f.return)&&(yield X(r.call(f)))}finally{if(s)throw s.error}}for(const g of u.flush()){const m=a.decode(g);m&&(yield yield X(m))}})}function c0(n){return qe(this,arguments,function*(){var t,i,s,r;let o=new Uint8Array;try{for(var a=!0,u=Ye(n),l;l=yield X(u.next()),t=l.done,!t;a=!0){r=l.value,a=!1;const c=r;if(c==null)continue;const f=c instanceof ArrayBuffer?new Uint8Array(c):typeof c=="string"?Us(c):c;let p=new Uint8Array(o.length+f.length);p.set(o),p.set(f,o.length),o=p;let g;for(;(g=a0(o))!==-1;)yield yield X(o.slice(0,g)),o=o.slice(g)}}catch(c){i={error:c}}finally{try{!a&&!t&&(s=u.return)&&(yield X(s.call(u)))}finally{if(i)throw i.error}}o.length>0&&(yield yield X(o))})}class d0{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const r={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],r}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,i,s]=f0(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}function f0(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */async function h0(n,e){const{response:t,requestLogID:i,retryOfRequestLogID:s,startTime:r}=e,o=await(async()=>{var a;if(e.options.stream)return xe(n).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,n):Bt.fromSSEResponse(t,e.controller,n);if(t.status===204)return null;if(e.options.__binaryResponse)return t;const u=t.headers.get("content-type"),l=(a=u==null?void 0:u.split(";")[0])===null||a===void 0?void 0:a.trim();return(l==null?void 0:l.includes("application/json"))||(l==null?void 0:l.endsWith("+json"))?t.headers.get("content-length")==="0"?void 0:await t.json():await t.text()})();return xe(n).debug(`[${i}] response parsed`,_t({retryOfRequestLogID:s,url:t.url,status:t.status,body:o,durationMs:Date.now()-r})),o}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Os extends Promise{constructor(e,t,i=h0){super(s=>{s(null)}),this.responsePromise=t,this.parseResponse=i,this.client=e}_thenUnwrap(e){return new Os(this.client,this.responsePromise,async(t,i)=>e(await this.parseResponse(t,i),i))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(this.client,e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Zl=Symbol("brand.privateNullableHeaders");function*p0(n){if(!n)return;if(Zl in n){const{values:i,nulls:s}=n;yield*i.entries();for(const r of s)yield[r,null];return}let e=!1,t;n instanceof Headers?t=n.entries():Bo(n)?t=n:(e=!0,t=Object.entries(n??{}));for(let i of t){const s=i[0];if(typeof s!="string")throw new TypeError("expected header name to be a string");const r=Bo(i[1])?i[1]:[i[1]];let o=!1;for(const a of r)a!==void 0&&(e&&!o&&(o=!0,yield[s,null]),yield[s,a])}}const ti=n=>{const e=new Headers,t=new Set;for(const i of n){const s=new Set;for(const[r,o]of p0(i)){const a=r.toLowerCase();s.has(a)||(e.delete(r),s.add(a)),o===null?(e.delete(r),t.add(a)):(e.append(r,o),t.delete(a))}}return{[Zl]:!0,values:e,nulls:t}};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const In=n=>{var e,t,i,s,r,o;if(typeof globalThis.process<"u")return(i=(t=(e=Nc)===null||e===void 0?void 0:e[n])===null||t===void 0?void 0:t.trim())!==null&&i!==void 0?i:void 0;if(typeof globalThis.Deno<"u")return(o=(r=(s=globalThis.Deno.env)===null||s===void 0?void 0:s.get)===null||r===void 0?void 0:r.call(s,n))===null||o===void 0?void 0:o.trim()};/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var jl;class mn{constructor(e){var t,i,s,r,o,a,u,{baseURL:l=In("GEMINI_NEXT_GEN_API_BASE_URL"),apiKey:c=(t=In("GEMINI_API_KEY"))!==null&&t!==void 0?t:null,apiVersion:f="v1beta"}=e,p=Xi(e,["baseURL","apiKey","apiVersion"]);const g=Object.assign(Object.assign({apiKey:c,apiVersion:f},p),{baseURL:l||"https://generativelanguage.googleapis.com"});this.baseURL=g.baseURL,this.timeout=(i=g.timeout)!==null&&i!==void 0?i:mn.DEFAULT_TIMEOUT,this.logger=(s=g.logger)!==null&&s!==void 0?s:console;const m="warn";this.logLevel=m,this.logLevel=(o=(r=Ko(g.logLevel,"ClientOptions.logLevel",this))!==null&&r!==void 0?r:Ko(In("GEMINI_NEXT_GEN_API_LOG"),"process.env['GEMINI_NEXT_GEN_API_LOG']",this))!==null&&o!==void 0?o:m,this.fetchOptions=g.fetchOptions,this.maxRetries=(a=g.maxRetries)!==null&&a!==void 0?a:2,this.fetch=(u=g.fetch)!==null&&u!==void 0?u:Jm(),this.encoder=Qm,this._options=g,this.apiKey=c,this.apiVersion=f,this.clientAdapter=g.clientAdapter}withOptions(e){return new this.constructor(Object.assign(Object.assign(Object.assign({},this._options),{baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,apiVersion:this.apiVersion}),e))}baseURLOverridden(){return this.baseURL!=="https://generativelanguage.googleapis.com"}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.has("authorization")||e.has("x-goog-api-key"))&&!(this.apiKey&&e.get("x-goog-api-key"))&&!t.has("x-goog-api-key"))throw new Error('Could not resolve authentication method. Expected the apiKey to be set. Or for the "x-goog-api-key" headers to be explicitly omitted')}async authHeaders(e){const t=ti([e.headers]);if(!(t.values.has("authorization")||t.values.has("x-goog-api-key"))){if(this.apiKey)return ti([{"x-goog-api-key":this.apiKey}]);if(this.clientAdapter.isVertexAI())return ti([await this.clientAdapter.getAuthHeaders()])}}stringifyQuery(e){return Object.entries(e).filter(([t,i])=>typeof i<"u").map(([t,i])=>{if(typeof i=="string"||typeof i=="number"||typeof i=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(i)}`;if(i===null)return`${encodeURIComponent(t)}=`;throw new Be(`Cannot stringify type ${typeof i}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${Ft}`}defaultIdempotencyKey(){return`stainless-node-retry-${Mm()}`}makeStatusError(e,t,i,s){return Le.generate(e,t,i,s)}buildURL(e,t,i){const s=!this.baseURLOverridden()&&i||this.baseURL,r=Fm(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return Bm(o)||(t=Object.assign(Object.assign({},o),t)),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){if(this.clientAdapter&&this.clientAdapter.isVertexAI()&&!e.path.startsWith(`/${this.apiVersion}/projects/`)){const t=e.path.slice(this.apiVersion.length+1);e.path=`/${this.apiVersion}/projects/${this.clientAdapter.getProject()}/locations/${this.clientAdapter.getLocation()}${t}`}}async prepareRequest(e,{url:t,options:i}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,i){return this.request(Promise.resolve(i).then(s=>Object.assign({method:e,path:t},s)))}request(e,t=null){return new Os(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,i){var s,r,o;const a=await e,u=(s=a.maxRetries)!==null&&s!==void 0?s:this.maxRetries;t==null&&(t=u),await this.prepareOptions(a);const{req:l,url:c,timeout:f}=await this.buildRequest(a,{retryCount:u-t});await this.prepareRequest(l,{url:c,options:a});const p="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),g=i===void 0?"":`, retryOf: ${i}`,m=Date.now();if(xe(this).debug(`[${p}] sending request`,_t({retryOfRequestLogID:i,method:a.method,url:c,options:a,headers:l.headers})),!((r=a.signal)===null||r===void 0)&&r.aborted)throw new os;const E=new AbortController,y=await this.fetchWithTimeout(c,l,f,E).catch(rs),v=Date.now();if(y instanceof globalThis.Error){const A=`retrying, ${t} attempts remaining`;if(!((o=a.signal)===null||o===void 0)&&o.aborted)throw new os;const _=ss(y)||/timed? ?out/i.test(String(y)+("cause"in y?String(y.cause):""));if(t)return xe(this).info(`[${p}] connection ${_?"timed out":"failed"} - ${A}`),xe(this).debug(`[${p}] connection ${_?"timed out":"failed"} (${A})`,_t({retryOfRequestLogID:i,url:c,durationMs:v-m,message:y.message})),this.retryRequest(a,t,i??p);throw xe(this).info(`[${p}] connection ${_?"timed out":"failed"} - error; no more retries left`),xe(this).debug(`[${p}] connection ${_?"timed out":"failed"} (error; no more retries left)`,_t({retryOfRequestLogID:i,url:c,durationMs:v-m,message:y.message})),_?new Nl:new pn({cause:y})}const S=`[${p}${g}] ${l.method} ${c} ${y.ok?"succeeded":"failed"} with status ${y.status} in ${v-m}ms`;if(!y.ok){const A=await this.shouldRetry(y);if(t&&A){const C=`retrying, ${t} attempts remaining`;return await Xm(y.body),xe(this).info(`${S} - ${C}`),xe(this).debug(`[${p}] response error (${C})`,_t({retryOfRequestLogID:i,url:y.url,status:y.status,headers:y.headers,durationMs:v-m})),this.retryRequest(a,t,i??p,y.headers)}const _=A?"error; no more retries left":"error; not retryable";xe(this).info(`${S} - ${_}`);const I=await y.text().catch(C=>rs(C).message),P=Vm(I),R=P?void 0:I;throw xe(this).debug(`[${p}] response error (${_})`,_t({retryOfRequestLogID:i,url:y.url,status:y.status,headers:y.headers,message:R,durationMs:Date.now()-m})),this.makeStatusError(y.status,P,R,y.headers)}return xe(this).info(S),xe(this).debug(`[${p}] response start`,_t({retryOfRequestLogID:i,url:y.url,status:y.status,headers:y.headers,durationMs:v-m})),{response:y,options:a,controller:E,requestLogID:p,retryOfRequestLogID:i,startTime:m}}async fetchWithTimeout(e,t,i,s){const r=t||{},{signal:o,method:a}=r,u=Xi(r,["signal","method"]),l=s.abort.bind(s);o&&o.addEventListener("abort",l,{once:!0});const c=setTimeout(l,i),f=globalThis.ReadableStream&&u.body instanceof globalThis.ReadableStream||typeof u.body=="object"&&u.body!==null&&Symbol.asyncIterator in u.body,p=Object.assign(Object.assign(Object.assign({signal:s.signal},f?{duplex:"half"}:{}),{method:"GET"}),u);a&&(p.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,p)}finally{clearTimeout(c)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,i,s){var r;let o;const a=s==null?void 0:s.get("retry-after-ms");if(a){const l=parseFloat(a);Number.isNaN(l)||(o=l)}const u=s==null?void 0:s.get("retry-after");if(u&&!o){const l=parseFloat(u);Number.isNaN(l)?o=Date.parse(u)-Date.now():o=l*1e3}if(!(o&&0<=o&&o<60*1e3)){const l=(r=e.maxRetries)!==null&&r!==void 0?r:this.maxRetries;o=this.calculateDefaultRetryTimeoutMillis(t,l)}return await Hm(o),this.makeRequest(e,t-1,i)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e,o=Math.min(.5*Math.pow(2,r),8),a=1-Math.random()*.25;return o*a*1e3}async buildRequest(e,{retryCount:t=0}={}){var i,s,r;const o=Object.assign({},e),{method:a,path:u,query:l,defaultBaseURL:c}=o,f=this.buildURL(u,l,c);"timeout"in o&&Gm("timeout",o.timeout),o.timeout=(i=o.timeout)!==null&&i!==void 0?i:this.timeout;const{bodyHeaders:p,body:g}=this.buildBody({options:o}),m=await this.buildHeaders({options:e,method:a,bodyHeaders:p,retryCount:t});return{req:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({method:a,headers:m},o.signal&&{signal:o.signal}),globalThis.ReadableStream&&g instanceof globalThis.ReadableStream&&{duplex:"half"}),g&&{body:g}),(s=this.fetchOptions)!==null&&s!==void 0?s:{}),(r=o.fetchOptions)!==null&&r!==void 0?r:{}),url:f,timeout:o.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:i,retryCount:s}){let r={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const o=await this.authHeaders(e);let a=ti([r,Object.assign(Object.assign({Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s)},e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{}),Wm()),this._options.defaultHeaders,i,e.headers,o]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const i=ti([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&i.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:zm(e)}:this.encoder({body:e,headers:i})}}mn.DEFAULT_TIMEOUT=6e4;class Ee extends mn{constructor(){super(...arguments),this.interactions=new Ql(this)}}jl=Ee;Ee.GeminiNextGenAPIClient=jl;Ee.GeminiNextGenAPIClientError=Be;Ee.APIError=Le;Ee.APIConnectionError=pn;Ee.APIConnectionTimeoutError=Nl;Ee.APIUserAbortError=os;Ee.NotFoundError=Bl;Ee.ConflictError=$l;Ee.RateLimitError=Vl;Ee.BadRequestError=Fl;Ee.AuthenticationError=Ul;Ee.InternalServerError=Hl;Ee.PermissionDeniedError=Ol;Ee.UnprocessableEntityError=Gl;Ee.toFile=i0;Ee.Interactions=Ql;/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */function g0(n,e){const t={},i=d(n,["name"]);return i!=null&&h(t,["_url","name"],i),t}function m0(n,e){const t={},i=d(n,["name"]);return i!=null&&h(t,["_url","name"],i),t}function y0(n,e){const t={},i=d(n,["sdkHttpResponse"]);return i!=null&&h(t,["sdkHttpResponse"],i),t}function E0(n,e){const t={},i=d(n,["sdkHttpResponse"]);return i!=null&&h(t,["sdkHttpResponse"],i),t}function T0(n,e,t){const i={};if(d(n,["validationDataset"])!==void 0)throw new Error("validationDataset parameter is not supported in Gemini API.");const s=d(n,["tunedModelDisplayName"]);if(e!==void 0&&s!=null&&h(e,["displayName"],s),d(n,["description"])!==void 0)throw new Error("description parameter is not supported in Gemini API.");const r=d(n,["epochCount"]);e!==void 0&&r!=null&&h(e,["tuningTask","hyperparameters","epochCount"],r);const o=d(n,["learningRateMultiplier"]);if(o!=null&&h(i,["tuningTask","hyperparameters","learningRateMultiplier"],o),d(n,["exportLastCheckpointOnly"])!==void 0)throw new Error("exportLastCheckpointOnly parameter is not supported in Gemini API.");if(d(n,["preTunedModelCheckpointId"])!==void 0)throw new Error("preTunedModelCheckpointId parameter is not supported in Gemini API.");if(d(n,["adapterSize"])!==void 0)throw new Error("adapterSize parameter is not supported in Gemini API.");if(d(n,["tuningMode"])!==void 0)throw new Error("tuningMode parameter is not supported in Gemini API.");if(d(n,["customBaseModel"])!==void 0)throw new Error("customBaseModel parameter is not supported in Gemini API.");const a=d(n,["batchSize"]);e!==void 0&&a!=null&&h(e,["tuningTask","hyperparameters","batchSize"],a);const u=d(n,["learningRate"]);if(e!==void 0&&u!=null&&h(e,["tuningTask","hyperparameters","learningRate"],u),d(n,["labels"])!==void 0)throw new Error("labels parameter is not supported in Gemini API.");if(d(n,["beta"])!==void 0)throw new Error("beta parameter is not supported in Gemini API.");if(d(n,["baseTeacherModel"])!==void 0)throw new Error("baseTeacherModel parameter is not supported in Gemini API.");if(d(n,["tunedTeacherModelSource"])!==void 0)throw new Error("tunedTeacherModelSource parameter is not supported in Gemini API.");if(d(n,["sftLossWeightMultiplier"])!==void 0)throw new Error("sftLossWeightMultiplier parameter is not supported in Gemini API.");if(d(n,["outputUri"])!==void 0)throw new Error("outputUri parameter is not supported in Gemini API.");return i}function v0(n,e,t){const i={};let s=d(t,["config","method"]);if(s===void 0&&(s="SUPERVISED_FINE_TUNING"),s==="SUPERVISED_FINE_TUNING"){const I=d(n,["validationDataset"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec"],_n(I))}else if(s==="PREFERENCE_TUNING"){const I=d(n,["validationDataset"]);e!==void 0&&I!=null&&h(e,["preferenceOptimizationSpec"],_n(I))}else if(s==="DISTILLATION"){const I=d(n,["validationDataset"]);e!==void 0&&I!=null&&h(e,["distillationSpec"],_n(I))}const r=d(n,["tunedModelDisplayName"]);e!==void 0&&r!=null&&h(e,["tunedModelDisplayName"],r);const o=d(n,["description"]);e!==void 0&&o!=null&&h(e,["description"],o);let a=d(t,["config","method"]);if(a===void 0&&(a="SUPERVISED_FINE_TUNING"),a==="SUPERVISED_FINE_TUNING"){const I=d(n,["epochCount"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","hyperParameters","epochCount"],I)}else if(a==="PREFERENCE_TUNING"){const I=d(n,["epochCount"]);e!==void 0&&I!=null&&h(e,["preferenceOptimizationSpec","hyperParameters","epochCount"],I)}else if(a==="DISTILLATION"){const I=d(n,["epochCount"]);e!==void 0&&I!=null&&h(e,["distillationSpec","hyperParameters","epochCount"],I)}let u=d(t,["config","method"]);if(u===void 0&&(u="SUPERVISED_FINE_TUNING"),u==="SUPERVISED_FINE_TUNING"){const I=d(n,["learningRateMultiplier"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","hyperParameters","learningRateMultiplier"],I)}else if(u==="PREFERENCE_TUNING"){const I=d(n,["learningRateMultiplier"]);e!==void 0&&I!=null&&h(e,["preferenceOptimizationSpec","hyperParameters","learningRateMultiplier"],I)}else if(u==="DISTILLATION"){const I=d(n,["learningRateMultiplier"]);e!==void 0&&I!=null&&h(e,["distillationSpec","hyperParameters","learningRateMultiplier"],I)}let l=d(t,["config","method"]);if(l===void 0&&(l="SUPERVISED_FINE_TUNING"),l==="SUPERVISED_FINE_TUNING"){const I=d(n,["exportLastCheckpointOnly"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","exportLastCheckpointOnly"],I)}else if(l==="PREFERENCE_TUNING"){const I=d(n,["exportLastCheckpointOnly"]);e!==void 0&&I!=null&&h(e,["preferenceOptimizationSpec","exportLastCheckpointOnly"],I)}else if(l==="DISTILLATION"){const I=d(n,["exportLastCheckpointOnly"]);e!==void 0&&I!=null&&h(e,["distillationSpec","exportLastCheckpointOnly"],I)}let c=d(t,["config","method"]);if(c===void 0&&(c="SUPERVISED_FINE_TUNING"),c==="SUPERVISED_FINE_TUNING"){const I=d(n,["adapterSize"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","hyperParameters","adapterSize"],I)}else if(c==="PREFERENCE_TUNING"){const I=d(n,["adapterSize"]);e!==void 0&&I!=null&&h(e,["preferenceOptimizationSpec","hyperParameters","adapterSize"],I)}else if(c==="DISTILLATION"){const I=d(n,["adapterSize"]);e!==void 0&&I!=null&&h(e,["distillationSpec","hyperParameters","adapterSize"],I)}let f=d(t,["config","method"]);if(f===void 0&&(f="SUPERVISED_FINE_TUNING"),f==="SUPERVISED_FINE_TUNING"){const I=d(n,["tuningMode"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","tuningMode"],I)}const p=d(n,["customBaseModel"]);e!==void 0&&p!=null&&h(e,["customBaseModel"],p);let g=d(t,["config","method"]);if(g===void 0&&(g="SUPERVISED_FINE_TUNING"),g==="SUPERVISED_FINE_TUNING"){const I=d(n,["batchSize"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","hyperParameters","batchSize"],I)}let m=d(t,["config","method"]);if(m===void 0&&(m="SUPERVISED_FINE_TUNING"),m==="SUPERVISED_FINE_TUNING"){const I=d(n,["learningRate"]);e!==void 0&&I!=null&&h(e,["supervisedTuningSpec","hyperParameters","learningRate"],I)}const E=d(n,["labels"]);e!==void 0&&E!=null&&h(e,["labels"],E);const y=d(n,["beta"]);e!==void 0&&y!=null&&h(e,["preferenceOptimizationSpec","hyperParameters","beta"],y);const v=d(n,["baseTeacherModel"]);e!==void 0&&v!=null&&h(e,["distillationSpec","baseTeacherModel"],v);const S=d(n,["tunedTeacherModelSource"]);e!==void 0&&S!=null&&h(e,["distillationSpec","tunedTeacherModelSource"],S);const A=d(n,["sftLossWeightMultiplier"]);e!==void 0&&A!=null&&h(e,["distillationSpec","hyperParameters","sftLossWeightMultiplier"],A);const _=d(n,["outputUri"]);return e!==void 0&&_!=null&&h(e,["outputUri"],_),i}function S0(n,e){const t={},i=d(n,["baseModel"]);i!=null&&h(t,["baseModel"],i);const s=d(n,["preTunedModel"]);s!=null&&h(t,["preTunedModel"],s);const r=d(n,["trainingDataset"]);r!=null&&w0(r);const o=d(n,["config"]);return o!=null&&T0(o,t),t}function A0(n,e){const t={},i=d(n,["baseModel"]);i!=null&&h(t,["baseModel"],i);const s=d(n,["preTunedModel"]);s!=null&&h(t,["preTunedModel"],s);const r=d(n,["trainingDataset"]);r!=null&&k0(r,t,e);const o=d(n,["config"]);return o!=null&&v0(o,t,e),t}function I0(n,e){const t={},i=d(n,["name"]);return i!=null&&h(t,["_url","name"],i),t}function _0(n,e){const t={},i=d(n,["name"]);return i!=null&&h(t,["_url","name"],i),t}function R0(n,e,t){const i={},s=d(n,["pageSize"]);e!==void 0&&s!=null&&h(e,["_query","pageSize"],s);const r=d(n,["pageToken"]);e!==void 0&&r!=null&&h(e,["_query","pageToken"],r);const o=d(n,["filter"]);return e!==void 0&&o!=null&&h(e,["_query","filter"],o),i}function x0(n,e,t){const i={},s=d(n,["pageSize"]);e!==void 0&&s!=null&&h(e,["_query","pageSize"],s);const r=d(n,["pageToken"]);e!==void 0&&r!=null&&h(e,["_query","pageToken"],r);const o=d(n,["filter"]);return e!==void 0&&o!=null&&h(e,["_query","filter"],o),i}function C0(n,e){const t={},i=d(n,["config"]);return i!=null&&R0(i,t),t}function L0(n,e){const t={},i=d(n,["config"]);return i!=null&&x0(i,t),t}function P0(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["nextPageToken"]);s!=null&&h(t,["nextPageToken"],s);const r=d(n,["tunedModels"]);if(r!=null){let o=r;Array.isArray(o)&&(o=o.map(a=>eu(a))),h(t,["tuningJobs"],o)}return t}function D0(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["nextPageToken"]);s!=null&&h(t,["nextPageToken"],s);const r=d(n,["tuningJobs"]);if(r!=null){let o=r;Array.isArray(o)&&(o=o.map(a=>us(a))),h(t,["tuningJobs"],o)}return t}function b0(n,e){const t={},i=d(n,["name"]);i!=null&&h(t,["model"],i);const s=d(n,["name"]);return s!=null&&h(t,["endpoint"],s),t}function w0(n,e){const t={};if(d(n,["gcsUri"])!==void 0)throw new Error("gcsUri parameter is not supported in Gemini API.");if(d(n,["vertexDatasetResource"])!==void 0)throw new Error("vertexDatasetResource parameter is not supported in Gemini API.");const i=d(n,["examples"]);if(i!=null){let s=i;Array.isArray(s)&&(s=s.map(r=>r)),h(t,["examples","examples"],s)}return t}function k0(n,e,t){const i={};let s=d(t,["config","method"]);if(s===void 0&&(s="SUPERVISED_FINE_TUNING"),s==="SUPERVISED_FINE_TUNING"){const o=d(n,["gcsUri"]);e!==void 0&&o!=null&&h(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(s==="PREFERENCE_TUNING"){const o=d(n,["gcsUri"]);e!==void 0&&o!=null&&h(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}else if(s==="DISTILLATION"){const o=d(n,["gcsUri"]);e!==void 0&&o!=null&&h(e,["distillationSpec","promptDatasetUri"],o)}let r=d(t,["config","method"]);if(r===void 0&&(r="SUPERVISED_FINE_TUNING"),r==="SUPERVISED_FINE_TUNING"){const o=d(n,["vertexDatasetResource"]);e!==void 0&&o!=null&&h(e,["supervisedTuningSpec","trainingDatasetUri"],o)}else if(r==="PREFERENCE_TUNING"){const o=d(n,["vertexDatasetResource"]);e!==void 0&&o!=null&&h(e,["preferenceOptimizationSpec","trainingDatasetUri"],o)}else if(r==="DISTILLATION"){const o=d(n,["vertexDatasetResource"]);e!==void 0&&o!=null&&h(e,["distillationSpec","promptDatasetUri"],o)}if(d(n,["examples"])!==void 0)throw new Error("examples parameter is not supported in Vertex AI.");return i}function eu(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["name"]);s!=null&&h(t,["name"],s);const r=d(n,["state"]);r!=null&&h(t,["state"],ml(r));const o=d(n,["createTime"]);o!=null&&h(t,["createTime"],o);const a=d(n,["tuningTask","startTime"]);a!=null&&h(t,["startTime"],a);const u=d(n,["tuningTask","completeTime"]);u!=null&&h(t,["endTime"],u);const l=d(n,["updateTime"]);l!=null&&h(t,["updateTime"],l);const c=d(n,["description"]);c!=null&&h(t,["description"],c);const f=d(n,["baseModel"]);f!=null&&h(t,["baseModel"],f);const p=d(n,["_self"]);return p!=null&&h(t,["tunedModel"],b0(p)),t}function us(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["name"]);s!=null&&h(t,["name"],s);const r=d(n,["state"]);r!=null&&h(t,["state"],ml(r));const o=d(n,["createTime"]);o!=null&&h(t,["createTime"],o);const a=d(n,["startTime"]);a!=null&&h(t,["startTime"],a);const u=d(n,["endTime"]);u!=null&&h(t,["endTime"],u);const l=d(n,["updateTime"]);l!=null&&h(t,["updateTime"],l);const c=d(n,["error"]);c!=null&&h(t,["error"],c);const f=d(n,["description"]);f!=null&&h(t,["description"],f);const p=d(n,["baseModel"]);p!=null&&h(t,["baseModel"],p);const g=d(n,["tunedModel"]);g!=null&&h(t,["tunedModel"],g);const m=d(n,["preTunedModel"]);m!=null&&h(t,["preTunedModel"],m);const E=d(n,["supervisedTuningSpec"]);E!=null&&h(t,["supervisedTuningSpec"],E);const y=d(n,["preferenceOptimizationSpec"]);y!=null&&h(t,["preferenceOptimizationSpec"],y);const v=d(n,["distillationSpec"]);v!=null&&h(t,["distillationSpec"],v);const S=d(n,["tuningDataStats"]);S!=null&&h(t,["tuningDataStats"],S);const A=d(n,["encryptionSpec"]);A!=null&&h(t,["encryptionSpec"],A);const _=d(n,["partnerModelTuningSpec"]);_!=null&&h(t,["partnerModelTuningSpec"],_);const I=d(n,["customBaseModel"]);I!=null&&h(t,["customBaseModel"],I);const P=d(n,["experiment"]);P!=null&&h(t,["experiment"],P);const R=d(n,["labels"]);R!=null&&h(t,["labels"],R);const L=d(n,["outputUri"]);L!=null&&h(t,["outputUri"],L);const C=d(n,["pipelineJob"]);C!=null&&h(t,["pipelineJob"],C);const x=d(n,["serviceAccount"]);x!=null&&h(t,["serviceAccount"],x);const w=d(n,["tunedModelDisplayName"]);w!=null&&h(t,["tunedModelDisplayName"],w);const M=d(n,["veoTuningSpec"]);return M!=null&&h(t,["veoTuningSpec"],M),t}function M0(n,e){const t={},i=d(n,["sdkHttpResponse"]);i!=null&&h(t,["sdkHttpResponse"],i);const s=d(n,["name"]);s!=null&&h(t,["name"],s);const r=d(n,["metadata"]);r!=null&&h(t,["metadata"],r);const o=d(n,["done"]);o!=null&&h(t,["done"],o);const a=d(n,["error"]);return a!=null&&h(t,["error"],a),t}function _n(n,e){const t={},i=d(n,["gcsUri"]);i!=null&&h(t,["validationDatasetUri"],i);const s=d(n,["vertexDatasetResource"]);return s!=null&&h(t,["validationDatasetUri"],s),t}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class N0 extends lt{constructor(e){super(),this.apiClient=e,this.list=async(t={})=>new Pt(at.PAGED_ITEM_TUNING_JOBS,i=>this.listInternal(i),await this.listInternal(t),t),this.get=async t=>await this.getInternal(t),this.tune=async t=>{var i;if(this.apiClient.isVertexAI())if(t.baseModel.startsWith("projects/")){const s={tunedModelName:t.baseModel};!((i=t.config)===null||i===void 0)&&i.preTunedModelCheckpointId&&(s.checkpointId=t.config.preTunedModelCheckpointId);const r=Object.assign(Object.assign({},t),{preTunedModel:s});return r.baseModel=void 0,await this.tuneInternal(r)}else{const s=Object.assign({},t);return await this.tuneInternal(s)}else{const s=Object.assign({},t),r=await this.tuneMldevInternal(s);let o="";return r.metadata!==void 0&&r.metadata.tunedModel!==void 0?o=r.metadata.tunedModel:r.name!==void 0&&r.name.includes("/operations/")&&(o=r.name.split("/operations/")[0]),{name:o,state:Xn.JOB_STATE_QUEUED}}}}async getInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=_0(e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>us(c))}else{const l=I0(e);return a=G("{name}",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>eu(c))}}async listInternal(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=L0(e);return a=G("tuningJobs",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=D0(c),p=new Eo;return Object.assign(p,f),p})}else{const l=C0(e);return a=G("tunedModels",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"GET",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=P0(c),p=new Eo;return Object.assign(p,f),p})}}async cancel(e){var t,i,s,r;let o,a="",u={};if(this.apiClient.isVertexAI()){const l=m0(e);return a=G("{name}:cancel",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=E0(c),p=new To;return Object.assign(p,f),p})}else{const l=g0(e);return a=G("{name}:cancel",l._url),u=l._query,delete l._url,delete l._query,o=this.apiClient.request({path:a,queryParams:u,body:JSON.stringify(l),httpMethod:"POST",httpOptions:(s=e.config)===null||s===void 0?void 0:s.httpOptions,abortSignal:(r=e.config)===null||r===void 0?void 0:r.abortSignal}).then(c=>c.json().then(f=>{const p=f;return p.sdkHttpResponse={headers:c.headers},p})),o.then(c=>{const f=y0(c),p=new To;return Object.assign(p,f),p})}}async tuneInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI()){const a=A0(e,e);return r=G("tuningJobs",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>us(u))}else throw new Error("This method is only supported by the Vertex AI.")}async tuneMldevInternal(e){var t,i;let s,r="",o={};if(this.apiClient.isVertexAI())throw new Error("This method is only supported by the Gemini Developer API.");{const a=S0(e);return r=G("tunedModels",a._url),o=a._query,delete a._url,delete a._query,s=this.apiClient.request({path:r,queryParams:o,body:JSON.stringify(a),httpMethod:"POST",httpOptions:(t=e.config)===null||t===void 0?void 0:t.httpOptions,abortSignal:(i=e.config)===null||i===void 0?void 0:i.abortSignal}).then(u=>u.json().then(l=>{const c=l;return c.sdkHttpResponse={headers:u.headers},c})),s.then(u=>M0(u))}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class F0{async download(e,t){throw new Error("Download to file is not supported in the browser, please use a browser compliant download like an <a> tag.")}}const U0=1024*1024*8,O0=3,B0=1e3,$0=2,Zi="x-goog-upload-status";async function G0(n,e,t){var i;const s=await tu(n,e,t),r=await(s==null?void 0:s.json());if(((i=s==null?void 0:s.headers)===null||i===void 0?void 0:i[Zi])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");return r.file}async function V0(n,e,t){var i;const s=await tu(n,e,t),r=await(s==null?void 0:s.json());if(((i=s==null?void 0:s.headers)===null||i===void 0?void 0:i[Zi])!=="final")throw new Error("Failed to upload file: Upload status is not finalized.");const o=cl(r),a=new bs;return Object.assign(a,o),a}async function tu(n,e,t){var i,s;let r=0,o=0,a=new Zn(new Response),u="upload";for(r=n.size;o<r;){const l=Math.min(U0,r-o),c=n.slice(o,o+l);o+l>=r&&(u+=", finalize");let f=0,p=B0;for(;f<O0&&(a=await t.request({path:"",body:c,httpMethod:"POST",httpOptions:{apiVersion:"",baseUrl:e,headers:{"X-Goog-Upload-Command":u,"X-Goog-Upload-Offset":String(o),"Content-Length":String(l)}}}),!(!((i=a==null?void 0:a.headers)===null||i===void 0)&&i[Zi]));)f++,await K0(p),p=p*$0;if(o+=l,((s=a==null?void 0:a.headers)===null||s===void 0?void 0:s[Zi])!=="active")break;if(r<=o)throw new Error("All content has been uploaded, but the upload status is not finalized.")}return a}async function H0(n){return{size:n.size,type:n.type}}function K0(n){return new Promise(e=>setTimeout(e,n))}class q0{async upload(e,t,i){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await G0(e,t,i)}async uploadToFileSearchStore(e,t,i){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await V0(e,t,i)}async stat(e){if(typeof e=="string")throw new Error("File path is not supported in browser uploader.");return await H0(e)}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */class Y0{create(e,t,i){return new W0(e,t,i)}}class W0{constructor(e,t,i){this.url=e,this.headers=t,this.callbacks=i}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=this.callbacks.onopen,this.ws.onerror=this.callbacks.onerror,this.ws.onclose=this.callbacks.onclose,this.ws.onmessage=this.callbacks.onmessage}send(e){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.send(e)}close(){if(this.ws===void 0)throw new Error("WebSocket is not connected");this.ws.close()}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const Yo="x-goog-api-key";class J0{constructor(e){this.apiKey=e}async addAuthHeaders(e,t){if(e.get(Yo)===null){if(this.apiKey.startsWith("auth_tokens/"))throw new Error("Ephemeral tokens are only supported by the live API.");if(!this.apiKey)throw new Error("API key is missing. Please provide a valid API key.");e.append(Yo,this.apiKey)}}}/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const z0="gl-node/";class eA{get interactions(){if(this._interactions!==void 0)return this._interactions;console.warn("GoogleGenAI.interactions: Interactions usage is experimental and may change in future versions.");const e=this.httpOptions;e!=null&&e.extraBody&&console.warn("GoogleGenAI.interactions: Client level httpOptions.extraBody is not supported by the interactions client and will be ignored.");const t=new Ee({baseURL:this.apiClient.getBaseUrl(),apiKey:this.apiKey,apiVersion:this.apiClient.getApiVersion(),clientAdapter:this.apiClient,defaultHeaders:this.apiClient.getDefaultHeaders(),timeout:e==null?void 0:e.timeout});return this._interactions=t.interactions,this._interactions}constructor(e){var t;if(e.apiKey==null)throw new Error("An API Key must be set when running in a browser");if(e.project||e.location)throw new Error("Vertex AI project based authentication is not supported on browser runtimes. Please do not provide a project or location.");this.vertexai=(t=e.vertexai)!==null&&t!==void 0?t:!1,this.apiKey=e.apiKey;const i=Bc(e.httpOptions,e.vertexai,void 0,void 0);i&&(e.httpOptions?e.httpOptions.baseUrl=i:e.httpOptions={baseUrl:i}),this.apiVersion=e.apiVersion,this.httpOptions=e.httpOptions;const s=new J0(this.apiKey);this.apiClient=new Hg({auth:s,apiVersion:this.apiVersion,apiKey:this.apiKey,vertexai:this.vertexai,httpOptions:this.httpOptions,userAgentExtra:z0+"web",uploader:new q0,downloader:new F0}),this.models=new lm(this.apiClient),this.live=new im(this.apiClient,s,new Y0),this.batches=new mf(this.apiClient),this.chats=new Qf(this.models,this.apiClient),this.caches=new Jf(this.apiClient),this.files=new uh(this.apiClient),this.operations=new um(this.apiClient),this.authTokens=new Rm(this.apiClient),this.tunings=new N0(this.apiClient),this.fileSearchStores=new km(this.apiClient)}}const V=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},X0=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=Q0},Q0=Number.MAX_SAFE_INTEGER||9007199254740991;let W=(function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n})({}),b=(function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",n.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",n.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.ASSET_LIST_LOAD_ERROR="assetListLoadError",n.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",n.ASSET_LIST_PARSING_ERROR="assetListParsingError",n.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.ATTACH_MEDIA_ERROR="attachMediaError",n.UNKNOWN="unknown",n})({}),T=(function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.MEDIA_ENDED="hlsMediaEnded",n.STALL_RESOLVED="hlsStallResolved",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFERED_TO_END="hlsBufferedToEnd",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n.ASSET_LIST_LOADING="hlsAssetListLoading",n.ASSET_LIST_LOADED="hlsAssetListLoaded",n.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",n.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",n.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",n.INTERSTITIAL_STARTED="hlsInterstitialStarted",n.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",n.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",n.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",n.INTERSTITIAL_ENDED="hlsInterstitialEnded",n.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",n.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",n.EVENT_CUE_ENTER="hlsEventCueEnter",n})({});var te={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},K={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class bt{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Z0{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new bt(e),this.fast_=new bt(t),this.defaultTTFB_=s,this.ttfb_=new bt(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new bt(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new bt(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new bt(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function j0(n,e,t){return(e=ty(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function le(){return le=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},le.apply(null,arguments)}function Wo(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function oe(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Wo(Object(t),!0).forEach(function(i){j0(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Wo(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function ey(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function ty(n){var e=ey(n,"string");return typeof e=="symbol"?e:e+""}class Ge{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=ft,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const ft=function(){},iy={trace:ft,debug:ft,log:ft,warn:ft,info:ft,error:ft};function cs(){return le({},iy)}function ny(n,e){const t=self.console[n];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${n}] >`):ft}function Jo(n,e,t){return e[n]?e[n].bind(e):ny(n,t)}const ds=cs();function sy(n,e,t){const i=cs();if(typeof console=="object"&&n===!0||typeof n=="object"){const s=["debug","log","info","warn","error"];s.forEach(r=>{i[r]=Jo(r,n,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.15`)}catch{return cs()}s.forEach(r=>{ds[r]=Jo(r,n)})}else le(ds,i);return i}const ae=ds;function mt(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function ry(n){return typeof self<"u"&&n===self.ManagedMediaSource}function iu(n,e){const t=Object.keys(n),i=Object.keys(e),s=t.length,r=i.length;return!s||!r||s===r&&!t.some(o=>i.indexOf(o)===-1)}function Ne(n,e=!1){if(typeof TextDecoder<"u"){const l=new TextDecoder("utf-8").decode(n);if(e){const c=l.indexOf("\0");return c!==-1?l.substring(0,c):l}return l.replace(/\0/g,"")}const t=n.length;let i,s,r,o="",a=0;for(;a<t;){if(i=n[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:s=n[a++],o+=String.fromCharCode((i&31)<<6|s&63);break;case 14:s=n[a++],r=n[a++],o+=String.fromCharCode((i&15)<<12|(s&63)<<6|(r&63)<<0);break}}return o}function Se(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}function nu(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function oy(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Rn={exports:{}},zo;function ay(){return zo||(zo=1,(function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(u,l,c){if(c=c||{},u=u.trim(),l=l.trim(),!l){if(!c.alwaysNormalize)return u;var f=a.parseURL(u);if(!f)throw new Error("Error trying to parse base URL.");return f.path=a.normalizePath(f.path),a.buildURLFromParts(f)}var p=a.parseURL(l);if(!p)throw new Error("Error trying to parse relative URL.");if(p.scheme)return c.alwaysNormalize?(p.path=a.normalizePath(p.path),a.buildURLFromParts(p)):l;var g=a.parseURL(u);if(!g)throw new Error("Error trying to parse base URL.");if(!g.netLoc&&g.path&&g.path[0]!=="/"){var m=s.exec(g.path);g.netLoc=m[1],g.path=m[2]}g.netLoc&&!g.path&&(g.path="/");var E={scheme:g.scheme,netLoc:p.netLoc,path:null,params:p.params,query:p.query,fragment:p.fragment};if(!p.netLoc&&(E.netLoc=g.netLoc,p.path[0]!=="/"))if(!p.path)E.path=g.path,p.params||(E.params=g.params,p.query||(E.query=g.query));else{var y=g.path,v=y.substring(0,y.lastIndexOf("/")+1)+p.path;E.path=a.normalizePath(v)}return E.path===null&&(E.path=c.alwaysNormalize?a.normalizePath(p.path):p.path),a.buildURLFromParts(E)},parseURL:function(u){var l=i.exec(u);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(u){for(u=u.split("").reverse().join("").replace(r,"");u.length!==(u=u.replace(o,"")).length;);return u.split("").reverse().join("")},buildURLFromParts:function(u){return u.scheme+u.netLoc+u.path+u.params+u.query+u.fragment}};n.exports=a})()})(Rn)),Rn.exports}var Bs=ay();class $s{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ue={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class su{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,uy(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let s;i.length===1?s=(t==null?void 0:t.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[ue.AUDIO]:null,[ue.VIDEO]:null,[ue.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new $s),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Bs.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[ue.AUDIO]=null,e[ue.VIDEO]=null,e[ue.AUDIOVIDEO]=null}}function pe(n){return n.sn!=="initSegment"}class xn extends su{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange.length){const e=this.byteRange[0],t=this.byteRange[1];if(V(e)&&V(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){var e;const{levelkeys:t}=this;if(!t||t.NONE)return null;if(t.identity)this._decryptdata||(this._decryptdata=t.identity.getDecryptData(this.sn));else if(!((e=this._decryptdata)!=null&&e.keyId)){const i=Object.keys(t);if(i.length===1){const s=this._decryptdata=t[i[0]]||null;s&&(this._decryptdata=s.getDecryptData(this.sn,t))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=V(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;const i=Object.keys(this.levelkeys),s=i.length;if(s>1||s===1&&(t=this.levelkeys[i[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!V(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return pe(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){const t=this.levelkeys;if(t){var i;const s=t[e];s&&!((i=this._decryptdata)!=null&&i.keyId)&&(this._decryptdata=s.getDecryptData(this.sn,t))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,o=!1){const{elementaryStreams:a}=this,u=a[e];if(!u){a[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:o};return}u.startPTS=Math.min(u.startPTS,t),u.endPTS=Math.max(u.endPTS,i),u.startDTS=Math.min(u.startDTS,s),u.endDTS=Math.max(u.endDTS,r)}}class ly extends su{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function ru(n,e){const t=Object.getPrototypeOf(n);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||ru(t,e)}}function uy(n,e){const t=ru(n,e);t&&(t.enumerable=!0,Object.defineProperty(n,e,t))}const Xo=Math.pow(2,32)-1,cy=[].push,ou={video:1,audio:2,id3:3,text:4};function ge(n){return String.fromCharCode.apply(null,n)}function au(n,e){const t=n[e]<<8|n[e+1];return t<0?65536+t:t}function z(n,e){const t=lu(n,e);return t<0?4294967296+t:t}function Qo(n,e){let t=z(n,e);return t*=Math.pow(2,32),t+=z(n,e+4),t}function lu(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function dy(n){const e=n.byteLength;for(let t=0;t<e;){const i=z(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function ee(n,e){const t=[];if(!e.length)return t;const i=n.byteLength;for(let s=0;s<i;){const r=z(n,s),o=ge(n.subarray(s+4,s+8)),a=r>1?s+r:i;if(o===e[0])if(e.length===1)t.push(n.subarray(s+8,a));else{const u=ee(n.subarray(s+8,a),e.slice(1));u.length&&cy.apply(t,u)}s=a}return t}function fy(n){const e=[],t=n[0];let i=8;const s=z(n,i);i+=4;let r=0,o=0;t===0?(r=z(n,i),o=z(n,i+4),i+=8):(r=Qo(n,i),o=Qo(n,i+8),i+=16),i+=2;let a=n.length+o;const u=au(n,i);i+=2;for(let l=0;l<u;l++){let c=i;const f=z(n,c);c+=4;const p=f&2147483647;if((f&2147483648)>>>31===1)return ae.warn("SIDX has hierarchical references (not supported)"),null;const m=z(n,c);c+=4,e.push({referenceSize:p,subsegmentDuration:m,info:{duration:m/s,start:a,end:a+p-1}}),a+=p,c+=4,i=c}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:u,references:e}}function uu(n){const e=[],t=ee(n,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],o=ee(r,["tkhd"])[0];if(o){let a=o[0];const u=z(o,a===0?12:20),l=ee(r,["mdia","mdhd"])[0];if(l){a=l[0];const c=z(l,a===0?12:20),f=ee(r,["mdia","hdlr"])[0];if(f){const p=ge(f.subarray(8,12)),g={soun:ue.AUDIO,vide:ue.VIDEO}[p],m=ee(r,["mdia","minf","stbl","stsd"])[0],E=hy(m);g?(e[u]={timescale:c,type:g,stsd:E},e[g]=oe({timescale:c,id:u},E)):e[u]={timescale:c,type:p,stsd:E}}}}}return ee(n,["moov","mvex","trex"]).forEach(s=>{const r=z(s,4),o=e[r];o&&(o.default={duration:z(s,12),flags:z(s,20)})}),e}function hy(n){const e=n.subarray(8),t=e.subarray(86),i=ge(e.subarray(4,8));let s=i,r;const o=i==="enca"||i==="encv";if(o){const l=ee(e,[i])[0].subarray(i==="enca"?28:78);ee(l,["sinf"]).forEach(f=>{const p=ee(f,["schm"])[0];if(p){const g=ge(p.subarray(4,8));if(g==="cbcs"||g==="cenc"){const m=ee(f,["frma"])[0];m&&(s=ge(m))}}})}const a=s;switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const u=ee(t,["avcC"])[0];u&&u.length>3&&(s+="."+Ii(u[1])+Ii(u[2])+Ii(u[3]),r=Ai(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const u=ee(e,[i])[0],l=ee(u.subarray(28),["esds"])[0];if(l&&l.length>7){let c=4;if(l[c++]!==3)break;c=Cn(l,c),c+=2;const f=l[c++];if(f&128&&(c+=2),f&64&&(c+=l[c++]),l[c++]!==4)break;c=Cn(l,c);const p=l[c++];if(p===64)s+="."+Ii(p);else break;if(c+=12,l[c++]!==5)break;c=Cn(l,c);const g=l[c++];let m=(g&248)>>3;m===31&&(m+=1+((g&7)<<3)+((l[c]&224)>>5)),s+="."+m}break}case"hvc1":case"hev1":{const u=ee(t,["hvcC"])[0];if(u&&u.length>12){const l=u[1],c=["","A","B","C"][l>>6],f=l&31,p=z(u,2),g=(l&32)>>5?"H":"L",m=u[12],E=u.subarray(6,12);s+="."+c+f,s+="."+py(p).toString(16).toUpperCase(),s+="."+g+m;let y="";for(let v=E.length;v--;){const S=E[v];(S||y)&&(y="."+S.toString(16).toUpperCase()+y)}s+=y}r=Ai(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{s=Ai(s,t)||s;break}case"vp09":{const u=ee(t,["vpcC"])[0];if(u&&u.length>6){const l=u[4],c=u[5],f=u[6]>>4&15;s+="."+Qe(l)+"."+Qe(c)+"."+Qe(f)}break}case"av01":{const u=ee(t,["av1C"])[0];if(u&&u.length>2){const l=u[1]>>>5,c=u[1]&31,f=u[2]>>>7?"H":"M",p=(u[2]&64)>>6,g=(u[2]&32)>>5,m=l===2&&p?g?12:10:p?10:8,E=(u[2]&16)>>4,y=(u[2]&8)>>3,v=(u[2]&4)>>2,S=u[2]&3;s+="."+l+"."+Qe(c)+f+"."+Qe(m)+"."+E+"."+y+v+S+"."+Qe(1)+"."+Qe(1)+"."+Qe(1)+"."+0,r=Ai("dav1",t)}break}}return{codec:s,encrypted:o,supplemental:r}}function Ai(n,e){const t=ee(e,["dvvC"]),i=t.length?t[0]:ee(e,["dvcC"])[0];if(i){const s=i[2]>>1&127,r=i[2]<<5&32|i[3]>>3&31;return n+"."+Qe(s)+"."+Qe(r)}}function py(n){let e=0;for(let t=0;t<32;t++)e|=(n>>t&1)<<31-t;return e>>>0}function Cn(n,e){const t=e+5;for(;n[e++]&128&&e<t;);return e}function Ii(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Qe(n){return(n<10?"0":"")+n}function gy(n,e){if(!n||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&cu(n,(i,s)=>{const r=i.subarray(8,24);r.some(o=>o!==0)||(ae.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${Se(r)} -> ${Se(t)}`),i.set(t,8))})}function my(n){const e=[];return cu(n,t=>e.push(t.subarray(8,24))),e}function cu(n,e){ee(n,["moov","trak"]).forEach(i=>{const s=ee(i,["mdia","minf","stbl","stsd"])[0];if(!s)return;const r=s.subarray(8);let o=ee(r,["enca"]);const a=o.length>0;a||(o=ee(r,["encv"])),o.forEach(u=>{const l=a?u.subarray(28):u.subarray(78);ee(l,["sinf"]).forEach(f=>{const p=du(f);p&&e(p,a)})})})}function du(n){const e=ee(n,["schm"])[0];if(e){const t=ge(e.subarray(4,8));if(t==="cbcs"||t==="cenc"){const i=ee(n,["schi","tenc"])[0];if(i)return i}}}function yy(n,e,t){const i={},s=ee(n,["moof","traf"]);for(let r=0;r<s.length;r++){const o=s[r],a=ee(o,["tfhd"])[0],u=z(a,4),l=e[u];if(!l)continue;i[u]||(i[u]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type});const c=i[u],f=ee(o,["tfdt"])[0];if(f){const A=f[0];let _=z(f,4);A===1&&(_===Xo?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(_*=Xo+1,_+=z(f,8))),V(_)&&(!V(c.start)||_<c.start)&&(c.start=_)}const p=l.default,g=z(a,0)|(p==null?void 0:p.flags);let m=(p==null?void 0:p.duration)||0;g&8&&(g&2?m=z(a,12):m=z(a,8));const E=ee(o,["trun"]);let y=c.start||0,v=0,S=m;for(let A=0;A<E.length;A++){const _=E[A],I=z(_,4),P=c.sampleCount;c.sampleCount+=I;const R=_[3]&1,L=_[3]&4,C=_[2]&1,x=_[2]&2,w=_[2]&4,M=_[2]&8;let U=8,$=I;for(R&&(U+=4),L&&I&&(!(_[U+1]&1)&&c.keyFrameIndex===void 0&&(c.keyFrameIndex=P),U+=4,C?(S=z(_,U),U+=4):S=m,x&&(U+=4),M&&(U+=4),y+=S,v+=S,$--);$--;)C?(S=z(_,U),U+=4):S=m,x&&(U+=4),w&&(_[U+1]&1||c.keyFrameIndex===void 0&&(c.keyFrameIndex=c.sampleCount-($+1),c.keyFrameStart=y),U+=4),M&&(U+=4),y+=S,v+=S;!v&&m&&(v+=m*I)}c.duration+=v}if(!Object.keys(i).some(r=>i[r].duration)){let r=1/0,o=0;const a=ee(n,["sidx"]);for(let u=0;u<a.length;u++){const l=fy(a[u]);if(l!=null&&l.references){r=Math.min(r,l.earliestPresentationTime/l.timescale);const c=l.references.reduce((f,p)=>f+p.info.duration||0,0);o=Math.max(o,c+l.earliestPresentationTime/l.timescale)}}o&&V(o)&&Object.keys(i).forEach(u=>{i[u].duration||(i[u].duration=o*i[u].timescale-i[u].start)})}return i}function Ey(n){const e={valid:null,remainder:null},t=ee(n,["moof"]);if(t.length<2)return e.remainder=n,e;const i=t[t.length-1];return e.valid=n.slice(0,i.byteOffset-8),e.remainder=n.slice(i.byteOffset-8),e}function $e(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Zo(n,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let o=!1;return ee(i,["moof"]).map(u=>{const l=u.byteOffset-8;ee(u,["traf"]).map(f=>{const p=ee(f,["tfdt"]).map(g=>{const m=g[0];let E=z(g,4);return m===1&&(E*=Math.pow(2,32),E+=z(g,8)),E/s})[0];return p!==void 0&&(n=p),ee(f,["tfhd"]).map(g=>{const m=z(g,4),E=z(g,0)&16777215,y=(E&1)!==0,v=(E&2)!==0,S=(E&8)!==0;let A=0;const _=(E&16)!==0;let I=0;const P=(E&32)!==0;let R=8;m===r&&(y&&(R+=8),v&&(R+=4),S&&(A=z(g,R),R+=4),_&&(I=z(g,R),R+=4),P&&(R+=4),e.type==="video"&&(o=yn(e.codec)),ee(f,["trun"]).map(L=>{const C=L[0],x=z(L,0)&16777215,w=(x&1)!==0;let M=0;const U=(x&4)!==0,$=(x&256)!==0;let H=0;const N=(x&512)!==0;let q=0;const F=(x&1024)!==0,Y=(x&2048)!==0;let J=0;const O=z(L,4);let B=8;w&&(M=z(L,B),B+=4),U&&(B+=4);let Z=M+l;for(let re=0;re<O;re++){if($?(H=z(L,B),B+=4):H=A,N?(q=z(L,B),B+=4):q=I,F&&(B+=4),Y&&(C===0?J=z(L,B):J=lu(L,B),B+=4),e.type===ue.VIDEO){let j=0;for(;j<q;){const ie=z(i,Z);if(Z+=4,Ty(o,i[Z])){const Ie=i.subarray(Z,Z+ie);Gs(Ie,o?2:1,n+J/s,t)}Z+=ie,j+=ie+4}}n+=H/s}}))})})}),t}function yn(n){if(!n)return!1;const e=n.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function Ty(n,e){if(n){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function Gs(n,e,t,i){const s=fu(n);let r=0;r+=e;let o=0,a=0,u=0;for(;r<s.length;){o=0;do{if(r>=s.length)break;u=s[r++],o+=u}while(u===255);a=0;do{if(r>=s.length)break;u=s[r++],a+=u}while(u===255);const l=s.length-r;let c=r;if(a<l)r+=a;else if(a>l){ae.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(o===4){if(s[c++]===181){const p=au(s,c);if(c+=2,p===49){const g=z(s,c);if(c+=4,g===1195456820){const m=s[c++];if(m===3){const E=s[c++],y=31&E,v=64&E,S=v?2+y*3:0,A=new Uint8Array(S);if(v){A[0]=E;for(let _=1;_<S;_++)A[_]=s[c++]}i.push({type:m,payloadType:o,pts:t,bytes:A})}}}}}else if(o===5&&a>16){const f=[];for(let m=0;m<16;m++){const E=s[c++].toString(16);f.push(E.length==1?"0"+E:E),(m===3||m===5||m===7||m===9)&&f.push("-")}const p=a-16,g=new Uint8Array(p);for(let m=0;m<p;m++)g[m]=s[c++];i.push({payloadType:o,pts:t,uuid:f.join(""),userData:Ne(g),userDataBytes:g})}}}function fu(n){const e=n.byteLength,t=[];let i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;const s=e-t.length,r=new Uint8Array(s);let o=0;for(i=0;i<s;o++,i++)o===t[0]&&(o++,t.shift()),r[i]=n[o];return r}function vy(n){const e=n[0];let t="",i="",s=0,r=0,o=0,a=0,u=0,l=0;if(e===0){for(;ge(n.subarray(l,l+1))!=="\0";)t+=ge(n.subarray(l,l+1)),l+=1;for(t+=ge(n.subarray(l,l+1)),l+=1;ge(n.subarray(l,l+1))!=="\0";)i+=ge(n.subarray(l,l+1)),l+=1;i+=ge(n.subarray(l,l+1)),l+=1,s=z(n,12),r=z(n,16),a=z(n,20),u=z(n,24),l=28}else if(e===1){l+=4,s=z(n,l),l+=4;const f=z(n,l);l+=4;const p=z(n,l);for(l+=4,o=2**32*f+p,X0(o)||(o=Number.MAX_SAFE_INTEGER,ae.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=z(n,l),l+=4,u=z(n,l),l+=4;ge(n.subarray(l,l+1))!=="\0";)t+=ge(n.subarray(l,l+1)),l+=1;for(t+=ge(n.subarray(l,l+1)),l+=1;ge(n.subarray(l,l+1))!=="\0";)i+=ge(n.subarray(l,l+1)),l+=1;i+=ge(n.subarray(l,l+1)),l+=1}const c=n.subarray(l,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:u,payload:c}}function Sy(n,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function Ay(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const o=new Uint8Array(4);return t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),Sy([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,o,t)}function Iy(n){const e=[];if(n instanceof ArrayBuffer){const t=n.byteLength;let i=0;for(;i+32<t;){const s=new DataView(n,i),r=_y(s);e.push(r),i+=r.size}}return e}function _y(n){const e=n.getUint32(0),t=n.byteOffset,i=n.byteLength;if(i<e)return{offset:t,size:i};if(n.getUint32(4)!==1886614376)return{offset:t,size:e};const r=n.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const o=n.buffer,a=Se(new Uint8Array(o,t+12,16));let u=null,l=null,c=0;if(r===0)c=28;else{const p=n.getUint32(28);if(!p||i<32+p*16)return{offset:t,size:e};u=[];for(let g=0;g<p;g++)u.push(new Uint8Array(o,t+32+g*16,16));c=32+p*16}if(!c)return{offset:t,size:e};const f=n.getUint32(c);return e-32<f?{offset:t,size:e}:(l=new Uint8Array(o,t+c+4,f),{version:r,systemId:a,kids:u,data:l,offset:t,size:e})}const hu=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Wt={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Vs(n,e){const t=Wt[e];return!!t&&!!t[n.slice(0,4)]}function ui(n,e,t=!0){return!n.split(",").some(i=>!Hs(i,e,t))}function Hs(n,e,t=!0){var i;const s=mt(t);return(i=s==null?void 0:s.isTypeSupported(ci(n,e)))!=null?i:!1}function ci(n,e){return`${e}/mp4;codecs=${n}`}function jo(n){if(n){const e=n.substring(0,4);return Wt.video[e]}return 2}function ji(n){const e=hu();return n.split(",").reduce((t,i)=>{const r=e&&yn(i)?9:Wt.video[i];return r?(r*2+t)/(t?3:2):(Wt.audio[i]+t)/(t?2:1)},0)}const Ln={};function Ry(n,e=!0){if(Ln[n])return Ln[n];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[n];for(let s=0;s<t.length;s++){var i;if(Hs(t[s],"audio",e))return Ln[n]=t[s],t[s];if(t[s]==="mp3"&&(i=mt(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return n}const xy=/flac|opus|mp4a\.40\.34/i;function en(n,e=!0){return n.replace(xy,t=>Ry(t.toLowerCase(),e))}function Cy(n,e){const t=[];if(n){const i=n.split(",");for(let s=0;s<i.length;s++)Vs(i[s],"video")||t.push(i[s])}return e&&t.push(e),t.join(",")}function Bi(n,e){if(n&&(n.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(n)!==-1)&&(ea(n,"audio")||ea(n,"video")))return n;if(e){const t=e.split(",");if(t.length>1){if(n){for(let i=t.length;i--;)if(t[i].substring(0,4)===n.substring(0,4))return t[i]}return t[0]}}return e||n}function ea(n,e){return Vs(n,e)&&Hs(n,e)}function Ly(n){const e=n.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function Py(n){if(n.startsWith("av01.")){const e=n.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return n}function ta(n){const e=mt(n)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function fs(n){return n.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Dy={supported:!0,powerEfficient:!0,smooth:!0},by={supported:!1,smooth:!1,powerEfficient:!1},pu={supported:!0,configurations:[],decodingInfoResults:[Dy]};function gu(n,e){return{supported:!1,configurations:e,decodingInfoResults:[by],error:n}}function wy(n,e,t,i,s,r){const o=n.videoCodec,a=n.audioCodec?n.audioGroups:null,u=r==null?void 0:r.audioCodec,l=r==null?void 0:r.channels,c=l?parseInt(l):u?1/0:2;let f=null;if(a!=null&&a.length)try{a.length===1&&a[0]?f=e.groups[a[0]].channels:f=a.reduce((p,g)=>{if(g){const m=e.groups[g];if(!m)throw new Error(`Audio track group ${g} not found`);Object.keys(m.channels).forEach(E=>{p[E]=(p[E]||0)+m.channels[E]})}return p},{2:0})}catch{return!0}return o!==void 0&&(o.split(",").some(p=>yn(p))||n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!f&&V(c)&&Object.keys(f).some(p=>parseInt(p)>c)}function mu(n,e,t,i={}){const s=n.videoCodec;if(!s&&!n.audioCodec||!t)return Promise.resolve(pu);const r=[],o=ky(n),a=o.length,u=My(n,e,a>0),l=u.length;for(let c=a||1*l||1;c--;){const f={type:"media-source"};if(a&&(f.video=o[c%a]),l){f.audio=u[c%l];const p=f.audio.bitrate;f.video&&p&&(f.video.bitrate-=p)}r.push(f)}if(s){const c=navigator.userAgent;if(s.split(",").some(f=>yn(f))&&hu())return Promise.resolve(gu(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${c})`),r))}return Promise.all(r.map(c=>{const f=Fy(c);return i[f]||(i[f]=t.decodingInfo(c))})).then(c=>({supported:!c.some(f=>!f.supported),configurations:r,decodingInfoResults:c})).catch(c=>({supported:!1,configurations:r,decodingInfoResults:[],error:c}))}function ky(n){var e;const t=(e=n.videoCodec)==null?void 0:e.split(","),i=yu(n),s=n.width||640,r=n.height||480,o=n.frameRate||30,a=n.videoRange.toLowerCase();return t?t.map(u=>{const l={contentType:ci(Py(u),"video"),width:s,height:r,bitrate:i,framerate:o};return a!=="sdr"&&(l.transferFunction=a),l}):[]}function My(n,e,t){var i;const s=(i=n.audioCodec)==null?void 0:i.split(","),r=yu(n);return s&&n.audioGroups?n.audioGroups.reduce((o,a)=>{var u;const l=a?(u=e.groups[a])==null?void 0:u.tracks:null;return l?l.reduce((c,f)=>{if(f.groupId===a){const p=parseFloat(f.channels||"");s.forEach(g=>{const m={contentType:ci(g,"audio"),bitrate:t?Ny(g,r):r};p&&(m.channels=""+p),c.push(m)})}return c},o):o},[]):[]}function Ny(n,e){if(e<=1)return 1;let t=128e3;return n==="ec-3"?t=768e3:n==="ac-3"&&(t=64e4),Math.min(e/2,t)}function yu(n){return Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)/1e3)*1e3||1}function Fy(n){let e="";const{audio:t,video:i}=n;if(i){const s=fs(i.contentType);e+=`${s}_r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${Math.ceil(i.bitrate/1e5)}`}if(t){const s=fs(t.contentType);e+=`${i?"_":""}${s}_c${t.channels}`}return e}const hs=["NONE","TYPE-0","TYPE-1",null];function Uy(n){return hs.indexOf(n)>-1}const tn=["SDR","PQ","HLG"];function Oy(n){return!!n&&tn.indexOf(n)>-1}var $i={No:"",Yes:"YES",v2:"v2"};function ia(n){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=n,s=i<e/2;return e&&s?t?$i.v2:$i.Yes:$i.No}class na{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class di{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return sa(this._audioGroups,e)}hasSubtitleGroup(e){return sa(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function sa(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function By(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function $y(n,e){let t=!1,i=[];if(n&&(t=n!=="SDR",i=[n]),e){i=e.allowedVideoRanges||tn.slice(0);const s=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:s&&By(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const Gy=n=>{const e=new WeakSet;return(t,i)=>{if(n&&(i=n(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},ce=(n,e)=>JSON.stringify(n,Gy(e));function Vy(n,e,t,i,s){const r=Object.keys(n),o=i==null?void 0:i.channels,a=i==null?void 0:i.audioCodec,u=s==null?void 0:s.videoCodec,l=o&&parseInt(o)===2;let c=!1,f=!1,p=1/0,g=1/0,m=1/0,E=1/0,y=0,v=[];const{preferHDR:S,allowedVideoRanges:A}=$y(e,s);for(let L=r.length;L--;){const C=n[r[L]];c||(c=C.channels[2]>0),p=Math.min(p,C.minHeight),g=Math.min(g,C.minFramerate),m=Math.min(m,C.minBitrate),A.filter(w=>C.videoRanges[w]>0).length>0&&(f=!0)}p=V(p)?p:0,g=V(g)?g:0;const _=Math.max(1080,p),I=Math.max(30,g);m=V(m)?m:t,t=Math.max(m,t),f||(e=void 0);const P=r.length>1;return{codecSet:r.reduce((L,C)=>{const x=n[C];if(C===L)return L;if(v=f?A.filter(w=>x.videoRanges[w]>0):[],P){if(x.minBitrate>t)return ze(C,`min bitrate of ${x.minBitrate} > current estimate of ${t}`),L;if(!x.hasDefaultAudio)return ze(C,"no renditions with default or auto-select sound found"),L;if(a&&C.indexOf(a.substring(0,4))%5!==0)return ze(C,`audio codec preference "${a}" not found`),L;if(o&&!l){if(!x.channels[o])return ze(C,`no renditions with ${o} channel sound found (channels options: ${Object.keys(x.channels)})`),L}else if((!a||l)&&c&&x.channels[2]===0)return ze(C,"no renditions with stereo sound found"),L;if(x.minHeight>_)return ze(C,`min resolution of ${x.minHeight} > maximum of ${_}`),L;if(x.minFramerate>I)return ze(C,`min framerate of ${x.minFramerate} > maximum of ${I}`),L;if(!v.some(w=>x.videoRanges[w]>0))return ze(C,`no variants with VIDEO-RANGE of ${ce(v)} found`),L;if(u&&C.indexOf(u.substring(0,4))%5!==0)return ze(C,`video codec preference "${u}" not found`),L;if(x.maxScore<y)return ze(C,`max score of ${x.maxScore} < selected max of ${y}`),L}return L&&(ji(C)>=ji(L)||x.fragmentError>n[L].fragmentError)?L:(E=x.minIndex,y=x.maxScore,C)},void 0),videoRanges:v,preferHDR:S,minFramerate:g,minBitrate:m,minIndex:E}}function ze(n,e){ae.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function Eu(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Hy(n,e,t,i){return n.slice(t,i+1).reduce((s,r,o)=>{if(!r.codecSet)return s;const a=r.audioGroups;let u=s[r.codecSet];u||(s[r.codecSet]=u={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),u.minBitrate=Math.min(u.minBitrate,r.bitrate);const l=Math.min(r.height,r.width);return u.minHeight=Math.min(u.minHeight,l),u.minFramerate=Math.min(u.minFramerate,r.frameRate),u.minIndex=Math.min(u.minIndex,o),u.maxScore=Math.max(u.maxScore,r.score),u.fragmentError+=r.fragmentError,u.videoRanges[r.videoRange]=(u.videoRanges[r.videoRange]||0)+1,a&&a.forEach(c=>{if(!c)return;const f=e.groups[c];f&&(u.hasDefaultAudio=u.hasDefaultAudio||e.hasDefaultAudio?f.hasDefault:f.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(f.channels).forEach(p=>{u.channels[p]=(u.channels[p]||0)+f.channels[p]}))}),s},{})}function ra(n){if(!n)return n;const{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}=n;return{lang:e,assocLang:t,characteristics:i,channels:s,audioCodec:r}}function je(n,e,t){if("attrs"in n){const i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){const s=e[i];if(Ct(n,s,t))return i}return-1}function Ct(n,e,t){const{groupId:i,name:s,lang:r,assocLang:o,default:a}=n,u=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||Ky(r,e.lang))&&(r===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(u===void 0||e.forced===u)&&(!("characteristics"in n)||qy(n.characteristics||"",e.characteristics))&&(t===void 0||t(n,e))}function Ky(n,e="--"){return n.length===e.length?n===e:n.startsWith(e)||e.startsWith(n)}function qy(n,e=""){const t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function Rt(n,e){const{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function Yy(n,e,t,i,s){const r=e[i],a=e.reduce((p,g,m)=>{const E=g.uri;return(p[E]||(p[E]=[])).push(m),p},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const u=r.videoRange,l=r.frameRate,c=r.codecSet.substring(0,4),f=oa(e,i,p=>{if(p.videoRange!==u||p.frameRate!==l||p.codecSet.substring(0,4)!==c)return!1;const g=p.audioGroups,m=t.filter(E=>!g||g.indexOf(E.groupId)!==-1);return je(n,m,s)>-1});return f>-1?f:oa(e,i,p=>{const g=p.audioGroups,m=t.filter(E=>!g||g.indexOf(E.groupId)!==-1);return je(n,m,s)>-1})}function oa(n,e,t){for(let i=e;i>-1;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}function nn(n,e){var t;return!!n&&n!==((t=e.loadLevelObj)==null?void 0:t.uri)}class Wy extends Ge{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:s,partCurrent:r,hls:o}=this,{autoLevelEnabled:a,media:u}=o;if(!s||!u)return;const l=performance.now(),c=r?r.stats:s.stats,f=r?r.duration:s.duration,p=l-c.loading.start,g=o.minAutoLevel,m=s.level,E=this._nextAutoLevel;if(c.aborted||c.loaded&&c.loaded===c.total||m<=g){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const y=E>-1&&E!==m,v=!!t||y;if(!v&&(u.paused||!u.playbackRate||!u.readyState))return;const S=o.mainForwardBufferInfo;if(!v&&S===null)return;const A=this.bwEstimator.getEstimateTTFB(),_=Math.abs(u.playbackRate);if(p<=Math.max(A,1e3*(f/(_*2))))return;const I=S?S.len/_:0,P=c.loading.first?c.loading.first-c.loading.start:-1,R=c.loaded&&P>-1,L=this.getBwEstimate(),C=o.levels,x=C[m],w=Math.max(c.loaded,Math.round(f*(s.bitrate||x.averageBitrate)/8));let M=R?p-P:p;M<1&&R&&(M=Math.min(p,c.loaded*8/L));const U=R?c.loaded*1e3/M:0,$=A/1e3,H=U?(w-c.loaded)/U:w*8/L+$;if(H<=I)return;const N=U?U*8:L,q=((i=(t==null?void 0:t.details)||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,F=this.hls.config.abrBandWidthUpFactor;let Y=Number.POSITIVE_INFINITY,J;for(J=m-1;J>g;J--){const re=C[J].maxBitrate,j=!C[J].details||q;if(Y=this.getTimeToLoadFrag($,N,f*re,j),Y<Math.min(I,f+$))break}if(Y>=H||Y>f*10)return;R?this.bwEstimator.sample(p-Math.min(A,P),c.loaded):this.bwEstimator.sampleTTFB(p);const O=C[J].maxBitrate;this.getBwEstimate()*F>O&&this.resetEstimator(O);const B=this.findBestLevel(O,g,J,0,I,1,1);B>-1&&(J=B),this.warn(`Fragment ${s.sn}${r?" part "+r.index:""} of level ${m} is loading too slowly;
      Fragment duration: ${s.duration.toFixed(3)}
      Time to underbuffer: ${I.toFixed(3)} s
      Estimated load time for current fragment: ${H.toFixed(3)} s
      Estimated load time for down switch fragment: ${Y.toFixed(3)} s
      TTFB estimate: ${P|0} ms
      Current BW estimate: ${V(L)?L|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${J} @ ${O|0} bps`),o.nextLoadLevel=o.nextAutoLevel=J,this.clearTimer();const Z=()=>{if(this.clearTimer(),this.fragCurrent===s&&this.hls.loadLevel===J&&J>0){const re=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${J>0?"and switching down":""}
      Fragment duration: ${s.duration.toFixed(3)} s
      Time to underbuffer: ${re.toFixed(3)} s`),s.abortRequests(),this.fragCurrent=this.partCurrent=null,J>g){let j=this.findBestLevel(this.hls.levels[g].bitrate,g,J,0,re,1,1);j===-1&&(j=g),this.hls.nextLoadLevel=this.hls.nextAutoLevel=j,this.resetEstimator(this.hls.levels[j].bitrate)}}};y||H>Y*2?Z():this.timer=self.setInterval(Z,Y*1e3),o.trigger(T.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:r,stats:c})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new Z0(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.FRAG_LOADING,this.onFragLoading,this),e.on(T.FRAG_LOADED,this.onFragLoaded,this),e.on(T.FRAG_BUFFERED,this.onFragBuffered,this),e.on(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(T.LEVEL_LOADED,this.onLevelLoaded,this),e.on(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(T.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.FRAG_LOADING,this.onFragLoading,this),e.off(T.FRAG_LOADED,this.onFragLoaded,this),e.off(T.FRAG_BUFFERED,this.onFragBuffered,this),e.off(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(T.LEVEL_LOADED,this.onLevelLoaded,this),e.off(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(T.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(T.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case b.BUFFER_ADD_CODEC_ERROR:case b.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case b.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const o=performance.now(),a=r?r.stats:i.stats,u=o-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){const f=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(u-Math.min(f,l),a.loaded)}else this.bwEstimator.sampleTTFB(u)}break}}}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,o=s?e+this.lastLevelLoadSec:0;return r+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:s}=t.stats,r=s.end-s.first;V(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===K.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+s.loaded,u=(o.loaded?o.loaded.duration:0)+r;o.loaded={bytes:a,duration:u},o.realBitrate=Math.round(8*a/u)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(T.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const o=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==K.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,r)&&o[e].loadError<=o[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:s,config:r,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,u=this.getBwEstimate(),l=this.getStarvationDelay();let c=r.abrBandWidthFactor,f=r.abrBandWidthUpFactor;if(l){const y=this.findBestLevel(u,o,s,l,0,c,f);if(y>=0)return this.rebufferNotice=-1,y}let p=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!l){const y=this.bitrateTestDelay;y&&(p=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-y,this.info(`bitrate test took ${Math.round(1e3*y)}ms, set first fragment max fetchDuration to ${Math.round(1e3*p)} ms`),c=f=1)}const g=this.findBestLevel(u,o,s,l,p,c,f);if(this.rebufferNotice!==g&&(this.rebufferNotice=g,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${g}`)),g>-1)return g;const m=i.levels[o],E=i.loadLevelObj;return E&&(m==null?void 0:m.bitrate)<E.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,s=e.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,o,a){var u;const l=s+r,c=this.lastLoadedFragLevel,f=c===-1?this.hls.firstLevel:c,{fragCurrent:p,partCurrent:g}=this,{levels:m,allAudioTracks:E,loadLevel:y,config:v}=this.hls;if(m.length===1)return 0;const S=m[f],A=!!((u=this.hls.latestLevelDetails)!=null&&u.live),_=y===-1||c===-1;let I,P="SDR",R=(S==null?void 0:S.frameRate)||0;const{audioPreference:L,videoPreference:C}=v,x=this.audioTracksByGroup||(this.audioTracksByGroup=Eu(E));let w=-1;if(_){if(this.firstSelection!==-1)return this.firstSelection;const N=this.codecTiers||(this.codecTiers=Hy(m,x,t,i)),q=Vy(N,P,e,L,C),{codecSet:F,videoRanges:Y,minFramerate:J,minBitrate:O,minIndex:B,preferHDR:Z}=q;w=B,I=F,P=Z?Y[Y.length-1]:Y[0],R=J,e=Math.max(e,O),this.log(`picked start tier ${ce(q)}`)}else I=S==null?void 0:S.codecSet,P=S==null?void 0:S.videoRange;const M=g?g.duration:p?p.duration:0,U=this.bwEstimator.getEstimateTTFB()/1e3,$=[];for(let N=i;N>=t;N--){var H;const q=m[N],F=N>f;if(!q)continue;if(v.useMediaCapabilities&&!q.supportedResult&&!q.supportedPromise){const j=navigator.mediaCapabilities;typeof(j==null?void 0:j.decodingInfo)=="function"&&wy(q,x,P,R,e,L)?(q.supportedPromise=mu(q,x,j,this.supportedCache),q.supportedPromise.then(ie=>{if(!this.hls)return;q.supportedResult=ie;const Ie=this.hls.levels,Te=Ie.indexOf(q);ie.error?this.warn(`MediaCapabilities decodingInfo error: "${ie.error}" for level ${Te} ${ce(ie)}`):ie.supported?ie.decodingInfoResults.some(Fe=>Fe.smooth===!1||Fe.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${Te} not smooth or powerEfficient: ${ce(ie)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${Te} ${ce(ie)}`),Te>-1&&Ie.length>1&&(this.log(`Removing unsupported level ${Te}`),this.hls.removeLevel(Te),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(ie=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${ie}`)})):q.supportedResult=pu}if((I&&q.codecSet!==I||P&&q.videoRange!==P||F&&R>q.frameRate||!F&&R>0&&R<q.frameRate||(H=q.supportedResult)!=null&&(H=H.decodingInfoResults)!=null&&H.some(j=>j.smooth===!1))&&(!_||N!==w)){$.push(N);continue}const Y=q.details,J=(g?Y==null?void 0:Y.partTarget:Y==null?void 0:Y.averagetargetduration)||M;let O;F?O=a*e:O=o*e;const B=M&&s>=M*2&&r===0?q.averageBitrate:q.maxBitrate,Z=this.getTimeToLoadFrag(U,O,B*J,Y===void 0);if(O>=B&&(N===c||q.loadError===0&&q.fragmentError===0)&&(Z<=U||!V(Z)||A&&!this.bitrateTestDelay||Z<l)){const j=this.forcedAutoLevel;return N!==y&&(j===-1||j!==y)&&($.length&&this.trace(`Skipped level(s) ${$.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[$[0]].codecs}" ${m[$[0]].videoRange}; not compatible with "${I}" ${P}`),this.info(`switch candidate:${f}->${N} adjustedbw(${Math.round(O)})-bitrate=${Math.round(O-B)} ttfb:${U.toFixed(1)} avgDuration:${J.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${Z.toFixed(1)} firstSelection:${_} codecSet:${q.codecSet} videoRange:${q.videoRange} hls.loadLevel:${y}`)),_&&(this.firstSelection=N),N}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const Tu={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];const o=e(r);if(o>0)t=s+1;else if(o<0)i=s-1;else return r}return null}};function Jy(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!V(e))return null;const i=n[0].programDateTime;if(e<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;for(let r=0;r<n.length;++r){const o=n[r];if(Xy(e,t,o))return o}return null}function Lt(n,e,t=0,i=0,s=.005){let r=null;if(n){r=e[1+n.sn-e[0].sn]||null;const a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),r&&n.level!==r.level&&r.end<=n.end&&(r=e[2+n.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!n||n.level===r.level)&&aa(t,i,r)===0||zy(r,n,Math.min(s,i))))return r;const o=Tu.search(e,aa.bind(null,t,i));return o&&(o!==n||!r)?o:r}function zy(n,e,t){if(e&&e.start===0&&e.level<n.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((s,r)=>(r[0]==="INF"&&(s+=parseFloat(r[1])),s),t);return n.start<=i}return!1}function aa(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function Xy(n,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function vu(n,e,t){if(n&&n.startCC<=e&&n.endCC>=e){let i=n.fragments;const{fragmentHint:s}=n;s&&(i=i.concat(s));let r;return Tu.search(i,o=>o.cc<e?1:o.cc>e?-1:(r=o,o.end<=t?1:o.start>t?-1:0)),r||null}return null}function sn(n){switch(n.details){case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_TIMEOUT:case b.LEVEL_LOAD_TIMEOUT:case b.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Su(n){return n.details.startsWith("key")}function Au(n){return Su(n)&&!!n.frag&&!n.frag.decryptdata}function la(n,e){const t=sn(e);return n.default[`${t?"timeout":"error"}Retry`]}function Ks(n,e){const t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function ua(n){return oe(oe({},n),{errorRetry:null,timeoutRetry:null})}function rn(n,e,t,i){if(!n)return!1;const s=i==null?void 0:i.code,r=e<n.maxNumRetry&&(Qy(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function Qy(n){return ps(n)||!!n&&(n<400||n>499)}function ps(n){return n===0&&navigator.onLine===!1}var ve={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},we={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4};class Zy extends Ge{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(T.ERROR,this.onError,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(T.ERROR,this.onError,this),e.off(T.ERROR,this.onErrorOut,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===K.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;const t=this.hls,i=t.currentLevel;return(e=t.loadLevelObj)!=null&&e.details||i===-1?t.loadLevel:i}variantHasKey(e,t){if(e){var i;if((i=e.details)!=null&&i.hasKey(t))return!0;const s=e.audioGroups;if(s)return this.hls.allAudioTracks.filter(o=>s.indexOf(o.groupId)>=0).some(o=>{var a;return(a=o.details)==null?void 0:a.hasKey(t)})}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const s=this.hls,r=t.context;switch(t.details){case b.FRAG_LOAD_ERROR:case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_ERROR:case b.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case b.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Ht();return}case b.FRAG_GAP:case b.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=ve.SendAlternateToPenaltyBox;return}case b.LEVEL_EMPTY_ERROR:case b.LEVEL_PARSING_ERROR:{var o;const u=t.parent===K.MAIN?t.level:s.loadLevel;t.details===b.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(o=o.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,u):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,u))}return;case b.LEVEL_LOAD_ERROR:case b.LEVEL_LOAD_TIMEOUT:typeof(r==null?void 0:r.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case b.AUDIO_TRACK_LOAD_ERROR:case b.AUDIO_TRACK_LOAD_TIMEOUT:case b.SUBTITLE_LOAD_ERROR:case b.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const u=s.loadLevelObj;if(u&&(r.type===te.AUDIO_TRACK&&u.hasAudioGroup(r.groupId)||r.type===te.SUBTITLE_TRACK&&u.hasSubtitleGroup(r.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=ve.SendAlternateToPenaltyBox,t.errorAction.flags=we.MoveAllAlternatesMatchingHost;return}}return;case b.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:ve.SendAlternateToPenaltyBox,flags:we.MoveAllAlternatesMatchingHDCP};return;case b.KEY_SYSTEM_SESSION_UPDATE_FAILED:case b.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case b.KEY_SYSTEM_NO_SESSION:t.errorAction={action:ve.SendAlternateToPenaltyBox,flags:we.MoveAllAlternatesMatchingKey};return;case b.BUFFER_ADD_CODEC_ERROR:case b.REMUX_ALLOC_ERROR:case b.BUFFER_APPEND_ERROR:if(!t.errorAction){var a;t.errorAction=this.getLevelSwitchAction(t,(a=t.level)!=null?a:s.loadLevel)}return;case b.INTERNAL_EXCEPTION:case b.BUFFER_APPENDING_ERROR:case b.BUFFER_FULL_ERROR:case b.LEVEL_SWITCH_ERROR:case b.BUFFER_STALLED_ERROR:case b.BUFFER_SEEK_OVER_HOLE:case b.BUFFER_NUDGE_ON_STALL:t.errorAction=Ht();return}t.type===W.KEY_SYSTEM_ERROR&&(t.levelRetry=!1,t.errorAction=Ht())}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,s=la(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(rn(s,r,sn(e),e.response))return{action:ve.RetryRequest,flags:we.None,retryConfig:s,retryCount:r};const a=this.getLevelSwitchAction(e,t);return s&&(a.retryConfig=s,a.retryCount=r),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:o}=t.config,a=la(Su(e)?o:r,e),u=t.levels.reduce((c,f)=>c+f.fragmentError,0);if(s&&(e.details!==b.FRAG_GAP&&s.fragmentError++,!Au(e)&&rn(a,u,sn(e),e.response)))return{action:ve.RetryRequest,flags:we.None,retryConfig:a,retryCount:u};const l=this.getLevelSwitchAction(e,i);return a&&(l.retryConfig=a,l.retryCount=u),l}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s){var r,o;const l=e.details;s.loadError++,l===b.BUFFER_APPEND_ERROR&&s.fragmentError++;let c=-1;const{levels:f,loadLevel:p,minAutoLevel:g,maxAutoLevel:m}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const E=(r=e.frag)==null?void 0:r.type,v=(E===K.AUDIO&&l===b.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(l===b.BUFFER_ADD_CODEC_ERROR||l===b.BUFFER_APPEND_ERROR))&&f.some(({audioCodec:P})=>s.audioCodec!==P),A=e.sourceBufferName==="video"&&(l===b.BUFFER_ADD_CODEC_ERROR||l===b.BUFFER_APPEND_ERROR)&&f.some(({codecSet:P,audioCodec:R})=>s.codecSet!==P&&s.audioCodec===R),{type:_,groupId:I}=(o=e.context)!=null?o:{};for(let P=f.length;P--;){const R=(P+p)%f.length;if(R!==p&&R>=g&&R<=m&&f[R].loadError===0){var a,u;const L=f[R];if(l===b.FRAG_GAP&&E===K.MAIN&&e.frag){const C=f[R].details;if(C){const x=Lt(e.frag,C.fragments,e.frag.start);if(x!=null&&x.gap)continue}}else{if(_===te.AUDIO_TRACK&&L.hasAudioGroup(I)||_===te.SUBTITLE_TRACK&&L.hasSubtitleGroup(I))continue;if(E===K.AUDIO&&(a=s.audioGroups)!=null&&a.some(C=>L.hasAudioGroup(C))||E===K.SUBTITLE&&(u=s.subtitleGroups)!=null&&u.some(C=>L.hasSubtitleGroup(C))||v&&s.audioCodec===L.audioCodec||A&&s.codecSet===L.codecSet||!v&&s.codecSet!==L.codecSet)continue}c=R;break}}if(c>-1&&i.loadLevel!==c)return e.levelRetry=!0,this.playlistError=0,{action:ve.SendAlternateToPenaltyBox,flags:we.None,nextAutoLevel:c}}return{action:ve.SendAlternateToPenaltyBox,flags:we.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case ve.DoNothing:break;case ve.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==b.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s}=i,r=i.nextAutoLevel;switch(s){case we.None:this.switchLevel(e,r);break;case we.MoveAllAlternatesMatchingHDCP:{const u=this.getVariantLevelIndex(e.frag),l=t.levels[u],c=l==null?void 0:l.attrs["HDCP-LEVEL"];if(i.hdcpLevel=c,c==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(c){t.maxHdcpLevel=hs[hs.indexOf(c)-1],i.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case we.MoveAllAlternatesMatchingKey:{const u=e.decryptdata;if(u){const l=this.hls.levels,c=l.length;for(let p=c;p--;)if(this.variantHasKey(l[p],u)){var o,a;this.log(`Banned key found in level ${p} (${l[p].bitrate}bps) or audio group "${(o=l[p].audioGroups)==null?void 0:o.join(",")}" (${(a=e.frag)==null?void 0:a.type} fragment) ${Se(u.keyId||[])}`),l[p].fragmentError++,l[p].loadError++,this.log(`Removing level ${p} with key error (${e.error})`),this.hls.removeLevel(p)}const f=e.frag;if(this.hls.levels.length<c)i.resolved=!0;else if(f&&f.type!==K.MAIN){const p=f.decryptdata;p&&!u.matches(p)&&(i.resolved=!0)}}break}}i.resolved||this.switchLevel(e,r)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===b.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=fs(e.mimeType),s=this.hls.levels;for(let r=s.length;r--;)s[r][`${e.sourceBufferName}Codec`]===i&&(this.log(`Removing level ${r} for ${e.details} ("${i}" not supported)`),this.hls.removeLevel(r))}}}function Ht(n){const e={action:ve.DoNothing,flags:we.None};return n&&(e.resolved=!0),e}var me={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class jy{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e&&(e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.BUFFER_APPENDED,this.onBufferAppended,this),e.on(T.FRAG_BUFFERED,this.onFragBuffered,this),e.on(T.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.BUFFER_APPENDED,this.onBufferAppended,this),e.off(T.FRAG_BUFFERED,this.onFragBuffered,this),e.off(T.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;if(r.start<=e&&e<=r.end&&r.loaded)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:s}=this,r=Object.keys(s);for(let o=r.length;o--;){const a=s[r[o]];if((a==null?void 0:a.body.type)===t&&(!i||a.buffered)){const u=a.body;if(u.start<=e&&e<=u.end)return u}}return null}detectEvictedFragments(e,t,i,s,r){this.timeRanges&&(this.timeRanges[e]=t);const o=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(a=>{const u=this.fragments[a];if(!u||o>=u.body.sn)return;if(!u.buffered&&(!u.loaded||r)){u.body.type===i&&this.removeFragment(u.body);return}const l=u.range[e];if(l){if(l.time.length===0){this.removeFragment(u.body);return}l.time.some(c=>{const f=!this.isTimeBuffered(c.startPTS,c.endPTS,t);return f&&this.removeFragment(u.body),f})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,s=wt(i),r=this.fragments[s];if(!r||r.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const u=i.elementaryStreams[a];if(!u)return;const l=t[a],c=o||u.partial===!0;r.range[a]=this.getBufferedTimes(i,e.part,c,l)}),r.loaded=null,Object.keys(r.range).length?(this.bufferedEnd(r,i),_i(r)||this.removeParts(i.sn-1,i.type)):this.removeFragment(r.body)}bufferedEnd(e,t){e.buffered=!0,(e.body.endList=t.endList||e.body.endList)&&(this.endListFragments[e.body.type]=e)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=ca(i,s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=wt(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,this.bufferedEnd(s,e))}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},o=e.start,a=e.end,u=e.minEndPTS||a,l=e.maxStartPTS||o;for(let c=0;c<s.length;c++){const f=s.start(c)-this.bufferPadding,p=s.end(c)+this.bufferPadding;if(l>=f&&u<=p){r.time.push({startPTS:Math.max(o,s.start(c)),endPTS:Math.min(a,s.end(c))});break}else if(o<p&&a>f){const g=Math.max(o,s.start(c)),m=Math.min(a,s.end(c));m>g&&(r.partial=!0,r.time.push({startPTS:g,endPTS:m}))}else if(a<=f)break}return r}getPartialFragment(e){let t=null,i,s,r,o=0;const{bufferPadding:a,fragments:u}=this;return Object.keys(u).forEach(l=>{const c=u[l];c&&_i(c)&&(s=c.body.start-a,r=c.body.end+a,e>=s&&e<=r&&(i=Math.min(e-s,r-e),o<=i&&(t=c.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||_i(t))}getState(e){const t=wt(e),i=this.fragments[t];return i?i.buffered?_i(i)?me.PARTIAL:me.OK:me.APPENDING:me.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let o=0;o<i.length;o++){if(s=i.start(o)-this.bufferPadding,r=i.end(o)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,s=t.part?null:t,r=wt(i);this.fragments[r]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(s){let l=this.activePartLists[a];l||(this.activePartLists[a]=l=[]),l.push(s)}this.timeRanges=r;const u=r[o];this.detectEvictedFragments(o,u,a,s)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=wt(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let s=i.length;s--;){const r=t[i[s]];if((r==null?void 0:r.body.type)===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const u=a.body;u.type!==i||s&&!u.gap||u.start<t&&u.end>e&&(a.buffered||r)&&this.removeFragment(u)})}removeFragment(e){const t=wt(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=ca(i,r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(i=>i.clearElementaryStreamInfo())}}function _i(n){var e,t,i;return n.buffered&&!!(n.body.gap||(e=n.range.video)!=null&&e.partial||(t=n.range.audio)!=null&&t.partial||(i=n.range.audiovideo)!=null&&i.partial)}function wt(n){return`${n.type}_${n.level}_${n.sn}`}function ca(n,e){return n.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var yt={cbc:0,ctr:1};class eE{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case yt.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case yt.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function tE(n){const e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?n.slice(0,e-t):n}class iE{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],o=i[2],a=i[3],u=this.invSubMix,l=u[0],c=u[1],f=u[2],p=u[3],g=new Uint32Array(256);let m=0,E=0,y=0;for(y=0;y<256;y++)y<128?g[y]=y<<1:g[y]=y<<1^283;for(y=0;y<256;y++){let v=E^E<<1^E<<2^E<<3^E<<4;v=v>>>8^v&255^99,e[m]=v,t[v]=m;const S=g[m],A=g[S],_=g[A];let I=g[v]*257^v*16843008;s[m]=I<<24|I>>>8,r[m]=I<<16|I>>>16,o[m]=I<<8|I>>>24,a[m]=I,I=_*16843009^A*65537^S*257^m*16843008,l[v]=I<<24|I>>>8,c[v]=I<<16|I>>>16,f[v]=I<<8|I>>>24,p[v]=I,m?(m=S^g[g[g[_^S]]],E^=g[g[E]]):m=E=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const o=this.ksRows=(r+6+1)*4;let a,u;const l=this.keySchedule=new Uint32Array(o),c=this.invKeySchedule=new Uint32Array(o),f=this.sBox,p=this.rcon,g=this.invSubMix,m=g[0],E=g[1],y=g[2],v=g[3];let S,A;for(a=0;a<o;a++){if(a<r){S=l[a]=t[a];continue}A=S,a%r===0?(A=A<<8|A>>>24,A=f[A>>>24]<<24|f[A>>>16&255]<<16|f[A>>>8&255]<<8|f[A&255],A^=p[a/r|0]<<24):r>6&&a%r===4&&(A=f[A>>>24]<<24|f[A>>>16&255]<<16|f[A>>>8&255]<<8|f[A&255]),l[a]=S=(l[a-r]^A)>>>0}for(u=0;u<o;u++)a=o-u,u&3?A=l[a]:A=l[a-4],u<4||a<=4?c[u]=A:c[u]=m[f[A>>>24]]^E[f[A>>>16&255]]^y[f[A>>>8&255]]^v[f[A&255]],c[u]=c[u]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,u=a[0],l=a[1],c=a[2],f=a[3],p=this.uint8ArrayToUint32Array_(i);let g=p[0],m=p[1],E=p[2],y=p[3];const v=new Int32Array(e),S=new Int32Array(v.length);let A,_,I,P,R,L,C,x,w,M,U,$,H,N;const q=this.networkToHostOrderSwap;for(;t<v.length;){for(w=q(v[t]),M=q(v[t+1]),U=q(v[t+2]),$=q(v[t+3]),R=w^r[0],L=$^r[1],C=U^r[2],x=M^r[3],H=4,N=1;N<s;N++)A=u[R>>>24]^l[L>>16&255]^c[C>>8&255]^f[x&255]^r[H],_=u[L>>>24]^l[C>>16&255]^c[x>>8&255]^f[R&255]^r[H+1],I=u[C>>>24]^l[x>>16&255]^c[R>>8&255]^f[L&255]^r[H+2],P=u[x>>>24]^l[R>>16&255]^c[L>>8&255]^f[C&255]^r[H+3],R=A,L=_,C=I,x=P,H=H+4;A=o[R>>>24]<<24^o[L>>16&255]<<16^o[C>>8&255]<<8^o[x&255]^r[H],_=o[L>>>24]<<24^o[C>>16&255]<<16^o[x>>8&255]<<8^o[R&255]^r[H+1],I=o[C>>>24]<<24^o[x>>16&255]<<16^o[R>>8&255]<<8^o[L&255]^r[H+2],P=o[x>>>24]<<24^o[R>>16&255]<<16^o[L>>8&255]<<8^o[C&255]^r[H+3],S[t]=q(A^g),S[t+1]=q(P^m),S[t+2]=q(I^E),S[t+3]=q(_^y),g=w,m=M,E=U,y=$,t=t+4}return S.buffer}}class nE{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=sE(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function sE(n){switch(n){case yt.cbc:return"AES-CBC";case yt.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${n}`)}}const rE=16;class qs{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?tE(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,s){return this.useSoftware?new Promise((r,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,s);const u=this.flush();u?r(u.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,s)}softwareDecrypt(e,t,i,s){const{currentIV:r,currentResult:o,remainderData:a}=this;if(s!==yt.cbc||t.byteLength!==16)return ae.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=$e(a,e),this.remainderData=null);const u=this.getValidChunk(e);if(!u.length)return null;r&&(i=r);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new iE),l.expandKey(t);const c=o;return this.currentResult=l.decrypt(u.buffer,0,i),this.currentIV=u.slice(-16).buffer,c||null}webCryptoDecrypt(e,t,i,s){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,s));this.key=t,this.fastAesKey=new nE(this.subtle,t,s)}return this.fastAesKey.expandKey().then(r=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new eE(this.subtle,new Uint8Array(i),s).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(ae.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i,s)))}onWebCryptoError(e,t,i,s){const r=this.enableSoftwareAES;if(r){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,s);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(r?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%rE;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(ae.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const da=Math.pow(2,17);class oE{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new rt({type:W.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,u)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(m=>m[0]==="GAP")){u(ha(e));return}else e.gap=!1;const l=this.loader=r?new r(s):new o(s),c=fa(e);e.loader=l;const f=ua(s.fragLoadPolicy.default),p={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:da};e.stats=l.stats;const g={onSuccess:(m,E,y,v)=>{this.resetLoader(e,l);let S=m.data;y.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(S.slice(0,16)),S=S.slice(16)),a({frag:e,part:null,payload:S,networkDetails:v})},onError:(m,E,y,v)=>{this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:oe({url:i,data:void 0},m),error:new Error(`HTTP Error ${m.code} ${m.text}`),networkDetails:y,stats:v}))},onAbort:(m,E,y)=>{this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:y,stats:m}))},onTimeout:(m,E,y)=>{this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${p.timeout}ms`),networkDetails:y,stats:m}))}};t&&(g.onProgress=(m,E,y,v)=>t({frag:e,part:null,payload:y,networkDetails:v})),l.load(c,p,g)})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,u)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){u(ha(e,t));return}const l=this.loader=r?new r(s):new o(s),c=fa(e,t);e.loader=l;const f=ua(s.fragLoadPolicy.default),p={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:da};t.stats=l.stats,l.load(c,p,{onSuccess:(g,m,E,y)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const v={frag:e,part:t,payload:g.data,networkDetails:y};i(v),a(v)},onError:(g,m,E,y)=>{this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:oe({url:c.url,data:void 0},g),error:new Error(`HTTP Error ${g.code} ${g.text}`),networkDetails:E,stats:y}))},onAbort:(g,m,E)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:E,stats:g}))},onTimeout:(g,m,E)=>{this.resetLoader(e,l),u(new rt({type:W.NETWORK_ERROR,details:b.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${p.timeout}ms`),networkDetails:E,stats:g}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const u=Math.round(e.duration/t.duration),l=Math.min(Math.round(i.loaded/r),u),f=(u-l)*Math.round(i.loaded/l);i.total=i.loaded+f}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=s.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function fa(n,e=null){const t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(V(s)&&V(r)){var o;let a=s,u=r;if(n.sn==="initSegment"&&aE((o=n.decryptdata)==null?void 0:o.method)){const l=r-s;l%16&&(u=r+(16-l%16)),s!==0&&(i.resetIV=!0,a=s-16)}i.rangeStart=a,i.rangeEnd=u}return i}function ha(n,e){const t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:W.MEDIA_ERROR,details:b.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new rt(i)}function aE(n){return n==="AES-128"||n==="AES-256"}class rt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Iu extends Ge{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Ys{constructor(e,t,i,s=0,r=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ri(),this.buffering={audio:Ri(),video:Ri(),audiovideo:Ri()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=o}}function Ri(){return{start:0,executeStart:0,executeEnd:0,end:0}}const pa={length:0,start:()=>0,end:()=>0};class Q{static isBuffered(e,t){if(e){const i=Q.getBuffered(e);for(let s=i.length;s--;)if(t>=i.start(s)&&t<=i.end(s))return!0}return!1}static bufferedRanges(e){if(e){const t=Q.getBuffered(e);return Q.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const s=Q.bufferedRanges(e);if(s.length)return Q.bufferedInfo(s,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((c,f)=>c.start-f.start||f.end-c.end);let s=-1,r=[];if(i)for(let c=0;c<e.length;c++){t>=e[c].start&&t<=e[c].end&&(s=c);const f=r.length;if(f){const p=r[f-1].end;e[c].start-p<i?e[c].end>p&&(r[f-1].end=e[c].end):r.push(e[c])}else r.push(e[c])}else r=e;let o=0,a,u=t,l=t;for(let c=0;c<r.length;c++){const f=r[c].start,p=r[c].end;if(s===-1&&t>=f&&t<=p&&(s=c),t+i>=f&&t<p)u=f,l=p,o=l-t;else if(t+i<f){a=f;break}}return{len:o,start:u||0,end:l||0,nextStart:a,buffered:e,bufferedIndex:s}}static getBuffered(e){try{return e.buffered||pa}catch(t){return ae.log("failed to get media.buffered",t),pa}}}const _u=/\{\$([a-zA-Z0-9-_]+)\}/g;function ga(n){return _u.test(n)}function gs(n,e){if(n.variableList!==null||n.hasVariableRefs){const t=n.variableList;return e.replace(_u,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function ma(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(s))r=o.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(o){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function lE(n,e,t){const i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const uE=/^(\d+)x(\d+)$/,ya=/(.+?)=(".*?"|.*?)(?:,|$)/g;class de{constructor(e,t){typeof e=="string"&&(e=de.parseAttrList(e,t)),le(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((s,r)=>(s[r.toLowerCase()]=!0,s),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=uE.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const s={};for(ya.lastIndex=0;(i=ya.exec(e))!==null;){const o=i[1].trim();let a=i[2];const u=a.indexOf('"')===0&&a.lastIndexOf('"')===a.length-1;let l=!1;if(u)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":l=!0}if(t&&(u||l))a=gs(t,a);else if(!l&&!u)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":ae.warn(`${e}: attribute ${o} is missing quotes`)}s[o]=a}return s}}const cE="com.apple.hls.interstitial";function dE(n){return n!=="ID"&&n!=="CLASS"&&n!=="CUE"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function fE(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"||n==="SCTE35-CMD"}class Ru{constructor(e,t,i=0){var s;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(t==null?void 0:t.tagAnchor)||null,this.tagOrder=(s=t==null?void 0:t.tagOrder)!=null?s:i,t){const r=t.attr;for(const o in r)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==r[o]){ae.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=le(new de({}),r,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const r=(t==null?void 0:t.endDate)||new Date(this.attr["END-DATE"]);V(r.getTime())&&(this._endDate=r)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(ae.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(V(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===cE}get isValid(){return!!this.id&&!this._badValueForSameId&&V(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const hE=10;class pE{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}hasKey(e){return this.encryptedFragments.some(t=>{let i=t.decryptdata;return i||(t.setKeyFormat(e.keyFormat),i=t.decryptdata),!!i&&e.matches(i)})}get hasProgramDateTime(){return this.fragments.length?V(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||hE}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function on(n,e){return n.length===e.length?!n.some((t,i)=>t!==e[i]):!1}function Ea(n,e){return!n&&!e?!0:!n||!e?!1:on(n,e)}function Kt(n){return n==="AES-128"||n==="AES-256"||n==="AES-256-CTR"}function Ws(n){switch(n){case"AES-128":case"AES-256":return yt.cbc;case"AES-256-CTR":return yt.ctr;default:throw new Error(`invalid full segment method ${n}`)}}function Js(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function ms(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}function gE(n){const e=ms(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function xu(n){const e=function(i,s,r){const o=i[s];i[s]=i[r],i[r]=o};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function Cu(n){const e=n.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",o=s[1];r?(i.splice(-1,1),t=Js(o)):t=gE(o)}}return t}const an=typeof self<"u"?self:void 0;var fe={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ae={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function Gi(n){switch(n){case Ae.FAIRPLAY:return fe.FAIRPLAY;case Ae.PLAYREADY:return fe.PLAYREADY;case Ae.WIDEVINE:return fe.WIDEVINE;case Ae.CLEARKEY:return fe.CLEARKEY}}function Pn(n){switch(n){case fe.FAIRPLAY:return Ae.FAIRPLAY;case fe.PLAYREADY:return Ae.PLAYREADY;case fe.WIDEVINE:return Ae.WIDEVINE;case fe.CLEARKEY:return Ae.CLEARKEY}}function si(n){const{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[fe.FAIRPLAY,fe.WIDEVINE,fe.PLAYREADY,fe.CLEARKEY].filter(s=>!!e[s]):[];return!i[fe.WIDEVINE]&&t&&i.push(fe.WIDEVINE),i}const Lu=(function(n){return an!=null&&(n=an.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function mE(n,e,t,i){let s;switch(n){case fe.FAIRPLAY:s=["cenc","sinf"];break;case fe.WIDEVINE:case fe.PLAYREADY:s=["cenc"];break;case fe.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return yE(s,e,t,i)}function yE(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs=${r}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs=${r}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function EE(n){var e;return!!n&&(n.sessionType==="persistent-license"||!!((e=n.sessionTypes)!=null&&e.some(t=>t==="persistent-license")))}function Pu(n){const e=new Uint16Array(n.buffer,n.byteOffset,n.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const u=Js(a).subarray(0,16);return xu(u),u}}return null}let kt={};class gt{static clearKeyUriToKeyIdMap(){kt={}}static setKeyIdForUri(e,t){kt[e]=t}static addKeyIdForUri(e){const t=Object.keys(kt).length%Number.MAX_SAFE_INTEGER,i=new Uint8Array(16);return new DataView(i.buffer,12,4).setUint32(0,t),kt[e]=i,i}constructor(e,t,i,s=[1],r=null,o){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Kt(e),o!=null&&o.startsWith("0x")&&(this.keyId=new Uint8Array(nu(o)))}matches(e){return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&on(e.keyFormatVersions,this.keyFormatVersions)&&Ea(e.iv,this.iv)&&Ea(e.keyId,this.keyId)}isSupported(){if(this.method){if(Kt(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Ae.FAIRPLAY:case Ae.WIDEVINE:case Ae.PLAYREADY:case Ae.CLEARKEY:return["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e,t){if(!this.encrypted||!this.uri)return null;if(Kt(this.method)){let r=this.iv;return r||(typeof e!="number"&&(ae.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0),r=vE(e)),new gt(this.method,this.uri,"identity",this.keyFormatVersions,r)}if(this.keyId){const r=kt[this.uri];if(r&&!on(this.keyId,r)&&gt.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}const i=Cu(this.uri);if(i)switch(this.keyFormat){case Ae.WIDEVINE:if(this.pssh=i,!this.keyId){const r=Iy(i.buffer);if(r.length){var s;const o=r[0];this.keyId=(s=o.kids)!=null&&s.length?o.kids[0]:null}}this.keyId||(this.keyId=Ta(t));break;case Ae.PLAYREADY:{const r=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Ay(r,null,i),this.keyId=Pu(i);break}default:{let r=i.subarray(0,16);if(r.length!==16){const o=new Uint8Array(16);o.set(r,16-r.length),r=o}this.keyId=r;break}}if(!this.keyId||this.keyId.byteLength!==16){let r;r=TE(t),r||(r=Ta(t),r||(r=kt[this.uri])),r&&(this.keyId=r,gt.setKeyIdForUri(this.uri,r))}return this}}function TE(n){const e=n==null?void 0:n[Ae.WIDEVINE];return e?e.keyId:null}function Ta(n){const e=n==null?void 0:n[Ae.PLAYREADY];if(e){const t=Cu(e.uri);if(t)return Pu(t)}return null}function vE(n){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}const va=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Sa=/#EXT-X-MEDIA:(.*)/g,SE=/^#EXT(?:INF|-X-TARGETDURATION):/m,Dn=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),AE=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class et{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static resolve(e,t){return Bs.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return SE.test(e)}static parseMasterPlaylist(e,t){const i=ga(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];if(va.lastIndex=0,!e.startsWith("#EXTM3U"))return s.playlistParsingError=new Error("no EXTM3U delimiter"),s;let o;for(;(o=va.exec(e))!=null;)if(o[1]){var a;const l=new de(o[1],s),c=gs(s,o[2]),f={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:et.resolve(c,t)},p=l.decimalResolution("RESOLUTION");p&&(f.width=p.width,f.height=p.height),_a(l.CODECS,f);const g=l["SUPPLEMENTAL-CODECS"];g&&(f.supplemental={},_a(g,f.supplemental)),(a=f.unknownCodecs)!=null&&a.length||r.push(f),s.levels.push(f)}else if(o[3]){const l=o[3],c=o[4];switch(l){case"SESSION-DATA":{const f=new de(c,s),p=f["DATA-ID"];p&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[p]=f);break}case"SESSION-KEY":{const f=Aa(c,t,s);f.encrypted&&f.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(f)):ae.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${c}"`);break}case"DEFINE":{{const f=new de(c,s);ma(s,f,t)}break}case"CONTENT-STEERING":{const f=new de(c,s);s.contentSteering={uri:et.resolve(f["SERVER-URI"],t),pathwayId:f["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=Ia(c);break}}}const u=r.length>0&&r.length<s.levels.length;return s.levels=u?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},o=i.levels,a={AUDIO:o.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:o.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]};let u=0;for(Sa.lastIndex=0;(s=Sa.exec(e))!==null;){const l=new de(s[1],i),c=l.TYPE;if(c){const f=a[c],p=r[c]||[];r[c]=p;const g=l.LANGUAGE,m=l["ASSOC-LANGUAGE"],E=l.CHANNELS,y=l.CHARACTERISTICS,v=l["INSTREAM-ID"],S={attrs:l,bitrate:0,id:u++,groupId:l["GROUP-ID"]||"",name:l.NAME||g||"",type:c,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:g,url:l.URI?et.resolve(l.URI,t):""};if(m&&(S.assocLang=m),E&&(S.channels=E),y&&(S.characteristics=y),v&&(S.instreamId=v),f!=null&&f.length){const A=et.findGroup(f,S.groupId)||f[0];Ra(S,A,"audioCodec"),Ra(S,A,"textCodec")}p.push(S)}}return r}static parseLevelPlaylist(e,t,i,s,r,o){var a;const u={url:t},l=new pE(t),c=l.fragments,f=[];let p=null,g=0,m=0,E=0,y=0,v=0,S=null,A=new xn(s,u),_,I,P,R=-1,L=!1,C=null,x;if(Dn.lastIndex=0,l.m3u8=e,l.hasVariableRefs=ga(e),((a=Dn.exec(e))==null?void 0:a[0])!=="#EXTM3U")return l.playlistParsingError=new Error("Missing format identifier #EXTM3U"),l;for(;(_=Dn.exec(e))!==null;){L&&(L=!1,A=new xn(s,u),A.playlistOffset=E,A.setStart(E),A.sn=g,A.cc=y,v&&(A.bitrate=v),A.level=i,p&&(A.initSegment=p,p.rawProgramDateTime&&(A.rawProgramDateTime=p.rawProgramDateTime,p.rawProgramDateTime=null),C&&(A.setByteRange(C),C=null)));const $=_[1];if($){A.duration=parseFloat($);const H=(" "+_[2]).slice(1);A.title=H||null,A.tagList.push(H?["INF",$,H]:["INF",$])}else if(_[3]){if(V(A.duration)){A.playlistOffset=E,A.setStart(E),P&&Ca(A,P,l),A.sn=g,A.level=i,A.cc=y,c.push(A);const H=(" "+_[3]).slice(1);A.relurl=gs(l,H),ys(A,S,f),S=A,E+=A.duration,g++,m=0,L=!0}}else{if(_=_[0].match(AE),!_){ae.warn("No matches on slow regex match for level playlist!");continue}for(I=1;I<_.length&&_[I]===void 0;I++);const H=(" "+_[I]).slice(1),N=(" "+_[I+1]).slice(1),q=_[I+2]?(" "+_[I+2]).slice(1):null;switch(H){case"BYTERANGE":S?A.setByteRange(N,S):A.setByteRange(N);break;case"PROGRAM-DATE-TIME":A.rawProgramDateTime=N,A.tagList.push(["PROGRAM-DATE-TIME",N]),R===-1&&(R=c.length);break;case"PLAYLIST-TYPE":l.type&&nt(l,H,_),l.type=N.toUpperCase();break;case"MEDIA-SEQUENCE":l.startSN!==0?nt(l,H,_):c.length>0&&La(l,H,_),g=l.startSN=parseInt(N);break;case"SKIP":{l.skippedSegments&&nt(l,H,_);const F=new de(N,l),Y=F.decimalInteger("SKIPPED-SEGMENTS");if(V(Y)){l.skippedSegments+=Y;for(let O=Y;O--;)c.push(null);g+=Y}const J=F.enumeratedString("RECENTLY-REMOVED-DATERANGES");J&&(l.recentlyRemovedDateranges=(l.recentlyRemovedDateranges||[]).concat(J.split("	")));break}case"TARGETDURATION":l.targetduration!==0&&nt(l,H,_),l.targetduration=Math.max(parseInt(N),1);break;case"VERSION":l.version!==null&&nt(l,H,_),l.version=parseInt(N);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":l.live||nt(l,H,_),l.live=!1;break;case"#":(N||q)&&A.tagList.push(q?[N,q]:[N]);break;case"DISCONTINUITY":y++,A.tagList.push(["DIS"]);break;case"GAP":A.gap=!0,A.tagList.push([H]);break;case"BITRATE":A.tagList.push([H,N]),v=parseInt(N)*1e3,V(v)?A.bitrate=v:v=0;break;case"DATERANGE":{const F=new de(N,l),Y=new Ru(F,l.dateRanges[F.ID],l.dateRangeTagCount);l.dateRangeTagCount++,Y.isValid||l.skippedSegments?l.dateRanges[Y.id]=Y:ae.warn(`Ignoring invalid DATERANGE tag: "${N}"`),A.tagList.push(["EXT-X-DATERANGE",N]);break}case"DEFINE":{{const F=new de(N,l);"IMPORT"in F?lE(l,F,o):ma(l,F,t)}break}case"DISCONTINUITY-SEQUENCE":l.startCC!==0?nt(l,H,_):c.length>0&&La(l,H,_),l.startCC=y=parseInt(N);break;case"KEY":{const F=Aa(N,t,l);if(F.isSupported()){if(F.method==="NONE"){P=void 0;break}P||(P={});const Y=P[F.keyFormat];Y!=null&&Y.matches(F)||(Y&&(P=le({},P)),P[F.keyFormat]=F)}else ae.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${N}"`);break}case"START":l.startTimeOffset=Ia(N);break;case"MAP":{const F=new de(N,l);if(A.duration){const Y=new xn(s,u);xa(Y,F,i,P),p=Y,A.initSegment=p,p.rawProgramDateTime&&!A.rawProgramDateTime&&(A.rawProgramDateTime=p.rawProgramDateTime)}else{const Y=A.byteRangeEndOffset;if(Y){const J=A.byteRangeStartOffset;C=`${Y-J}@${J}`}else C=null;xa(A,F,i,P),p=A,L=!0}p.cc=y;break}case"SERVER-CONTROL":{x&&nt(l,H,_),x=new de(N),l.canBlockReload=x.bool("CAN-BLOCK-RELOAD"),l.canSkipUntil=x.optionalFloat("CAN-SKIP-UNTIL",0),l.canSkipDateRanges=l.canSkipUntil>0&&x.bool("CAN-SKIP-DATERANGES"),l.partHoldBack=x.optionalFloat("PART-HOLD-BACK",0),l.holdBack=x.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{l.partTarget&&nt(l,H,_);const F=new de(N);l.partTarget=F.decimalFloatingPoint("PART-TARGET");break}case"PART":{let F=l.partList;F||(F=l.partList=[]);const Y=m>0?F[F.length-1]:void 0,J=m++,O=new de(N,l),B=new ly(O,A,u,J,Y);F.push(B),A.duration+=B.duration;break}case"PRELOAD-HINT":{const F=new de(N,l);l.preloadHint=F;break}case"RENDITION-REPORT":{const F=new de(N,l);l.renditionReports=l.renditionReports||[],l.renditionReports.push(F);break}default:ae.warn(`line parsed but not handled: ${_}`);break}}}S&&!S.relurl?(c.pop(),E-=S.duration,l.partList&&(l.fragmentHint=S)):l.partList&&(ys(A,S,f),A.cc=y,l.fragmentHint=A,P&&Ca(A,P,l)),l.targetduration||(l.playlistParsingError=new Error("Missing Target Duration"));const w=c.length,M=c[0],U=c[w-1];if(E+=l.skippedSegments*l.targetduration,E>0&&w&&U){l.averagetargetduration=E/w;const $=U.sn;l.endSN=$!=="initSegment"?$:0,l.live||(U.endList=!0),R>0&&(_E(c,R),M&&f.unshift(M))}return l.fragmentHint&&(E+=l.fragmentHint.duration),l.totalduration=E,f.length&&l.dateRangeTagCount&&M&&Du(f,l),l.endCC=y,l}}function Du(n,e){let t=n.length;if(!t)if(e.hasProgramDateTime){const a=e.fragments[e.fragments.length-1];n.push(a),t++}else return;const i=n[t-1],s=e.live?1/0:e.totalduration,r=Object.keys(e.dateRanges);for(let a=r.length;a--;){const u=e.dateRanges[r[a]],l=u.startDate.getTime();u.tagAnchor=i.ref;for(let c=t;c--;){var o;if(((o=n[c])==null?void 0:o.sn)<e.startSN)break;const f=IE(e,l,n,c,s);if(f!==-1){u.tagAnchor=e.fragments[f].ref;break}}}}function IE(n,e,t,i,s){const r=t[i];if(r){const a=r.programDateTime;if(e>=a||i===0){var o;const u=(((o=t[i+1])==null?void 0:o.start)||s)-r.start;if(e<=a+u*1e3){const l=t[i].sn-n.startSN;if(l<0)return-1;const c=n.fragments;if(c.length>t.length){const p=(t[i+1]||c[c.length-1]).sn-n.startSN;for(let g=p;g>l;g--){const m=c[g].programDateTime;if(e>=m&&e<m+c[g].duration*1e3)return g}}return l}}}return-1}function Aa(n,e,t){var i,s;const r=new de(n,t),o=(i=r.METHOD)!=null?i:"",a=r.URI,u=r.hexadecimalInteger("IV"),l=r.KEYFORMATVERSIONS,c=(s=r.KEYFORMAT)!=null?s:"identity";a&&r.IV&&!u&&ae.error(`Invalid IV: ${r.IV}`);const f=a?et.resolve(a,e):"",p=(l||"1").split("/").map(Number).filter(Number.isFinite);return new gt(o,f,c,p,u,r.KEYID)}function Ia(n){const t=new de(n).decimalFloatingPoint("TIME-OFFSET");return V(t)?t:null}function _a(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=t.filter(r=>Vs(r,i));s.length&&(e[`${i}Codec`]=s.map(r=>r.split("/")[0]).join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function Ra(n,e,t){const i=e[t];i&&(n[t]=i)}function _E(n,e){let t=n[e];for(let i=e;i--;){const s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function ys(n,e,t){n.rawProgramDateTime?t.push(n):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime)}function xa(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function Ca(n,e,t){n.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}function nt(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function La(n,e,t){n.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function bn(n,e){const t=e.startPTS;if(V(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&s.setDuration(i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.setStart(n.start+(n.minEndPTS-n.start)):e.setStart(n.start+n.duration):e.setStart(Math.max(n.start-e.duration,0))}function bu(n,e,t,i,s,r,o){i-t<=0&&(o.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let u=t,l=i;const c=e.startPTS,f=e.endPTS;if(V(c)){const v=Math.abs(c-t);n&&v>n.totalduration?o.warn(`media timestamps and playlist times differ by ${v}s for level ${e.level} ${n.url}`):V(e.deltaPTS)?e.deltaPTS=Math.max(v,e.deltaPTS):e.deltaPTS=v,u=Math.max(t,c),t=Math.min(t,c),s=e.startDTS!==void 0?Math.min(s,e.startDTS):s,l=Math.min(i,f),i=Math.max(i,f),r=e.endDTS!==void 0?Math.max(r,e.endDTS):r}const p=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=u,e.startDTS=s,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const g=e.sn;if(!n||g<n.startSN||g>n.endSN)return 0;let m;const E=g-n.startSN,y=n.fragments;for(y[E]=e,m=E;m>0;m--)bn(y[m],y[m-1]);for(m=E;m<y.length-1;m++)bn(y[m],y[m+1]);return n.fragmentHint&&bn(y[y.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,p}function RE(n,e,t){if(n===e)return;let i=null;const s=n.fragments;for(let c=s.length-1;c>=0;c--){const f=s[c].initSegment;if(f){i=f;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let r;LE(n,e,(c,f,p,g)=>{if((!e.startCC||e.skippedSegments)&&f.cc!==c.cc){const m=c.cc-f.cc;for(let E=p;E<g.length;E++)g[E].cc+=m;e.endCC=g[g.length-1].cc}V(c.startPTS)&&V(c.endPTS)&&(f.setStart(f.startPTS=c.startPTS),f.startDTS=c.startDTS,f.maxStartPTS=c.maxStartPTS,f.endPTS=c.endPTS,f.endDTS=c.endDTS,f.minEndPTS=c.minEndPTS,f.setDuration(c.endPTS-c.startPTS),f.duration&&(r=f),e.PTSKnown=e.alignedSliding=!0),c.hasStreams&&(f.elementaryStreams=c.elementaryStreams),f.loader=c.loader,c.hasStats&&(f.stats=c.stats),c.initSegment&&(f.initSegment=c.initSegment,i=c.initSegment)});const o=e.fragments,a=e.fragmentHint?o.concat(e.fragmentHint):o;if(i&&a.forEach(c=>{var f;c&&(!c.initSegment||c.initSegment.relurl===((f=i)==null?void 0:f.relurl))&&(c.initSegment=i)}),e.skippedSegments){if(e.deltaUpdateFailed=o.some(c=>!c),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let c=e.skippedSegments;c--;)o.shift();e.startSN=o[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=xE(n.dateRanges,e,t));const c=n.fragments.filter(f=>f.rawProgramDateTime);if(n.hasProgramDateTime&&!e.hasProgramDateTime)for(let f=1;f<a.length;f++)a[f].programDateTime===null&&ys(a[f],a[f-1],c);Du(c,e)}e.endCC=o[o.length-1].cc}if(!e.startCC){var u;const c=Mu(n,e.startSN-1);e.startCC=(u=c==null?void 0:c.cc)!=null?u:o[0].cc}CE(n.partList,e.partList,(c,f)=>{f.elementaryStreams=c.elementaryStreams,f.stats=c.stats}),r?bu(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS,t):wu(n,e),o.length&&(e.totalduration=e.edge-o[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;const l=e.advancedDateTime;if(e.advanced&&l){const c=e.edge;e.driftStart||(e.driftStartTime=l,e.driftStart=c),e.driftEndTime=l,e.driftEnd=c}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=n.requestScheduled)}function xE(n,e,t){const{dateRanges:i,recentlyRemovedDateranges:s}=e,r=le({},n);s&&s.forEach(u=>{delete r[u]});const a=Object.keys(r).length;return a?(Object.keys(i).forEach(u=>{const l=r[u],c=new Ru(i[u].attr,l);c.isValid?(r[u]=c,l||(c.tagOrder+=a)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${ce(i[u].attr)}"`)}),r):i}function CE(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){const o=n[s],a=e[s+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function LE(n,e,t){const i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,o=e.startSN-n.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,u=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let l=s;l<=r;l++){const c=u[o+l];let f=a[l];if(i&&!f&&c&&(f=e.fragments[l]=c),c&&f){t(c,f,l,a);const p=c.relurl,g=f.relurl;if(p&&PE(p,g)){e.playlistParsingError=Pa(`media sequence mismatch ${f.sn}:`,n,e,c,f);return}else if(c.cc!==f.cc){e.playlistParsingError=Pa(`discontinuity sequence mismatch (${c.cc}!=${f.cc})`,n,e,c,f);return}}}}function Pa(n,e,t,i,s){return new Error(`${n} ${s.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function wu(n,e,t=!0){const i=e.startSN+e.skippedSegments-n.startSN,s=n.fragments,r=i>=0;let o=0;if(r&&i<s.length)o=s[i].start;else if(r&&e.startSN===n.endSN+1)o=n.fragmentEnd;else if(r&&t)o=n.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=n.fragmentStart;else return;Es(e,o)}function Es(n,e){if(e){const t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].addStart(e);n.fragmentHint&&n.fragmentHint.addStart(e)}}function ku(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function Mu(n,e,t){if(!n)return null;let i=n.fragments[e-n.startSN];return i||(i=n.fragmentHint,i&&i.sn===e)?i:e<n.startSN&&t&&t.sn===e?t:null}function Da(n,e,t){return n?Nu(n.partList,e,t):null}function Nu(n,e,t){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function Fu(n){n.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(s=>{s.level=t,s.initSegment&&(s.initSegment.level=t)})})}function PE(n,e){return n!==e&&e?ba(n)!==ba(e):!1}function ba(n){return n.replace(/\?[^?]*$/,"")}function ri(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function DE(n,e){return!!(n&&e.startCC<n.endCC&&e.endCC>n.startCC)}function wa(n,e){const t=n.start+e;n.startPTS=t,n.setStart(t),n.endPTS=t+n.duration}function Uu(n,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)wa(t[i],n);e.fragmentHint&&wa(e.fragmentHint,n),e.alignedSliding=!0}function bE(n,e){n&&(Ou(e,n),e.alignedSliding||ln(e,n),!e.alignedSliding&&!e.skippedSegments&&wu(n,e,!1))}function Ou(n,e){if(!DE(e,n))return;const t=Math.min(e.endCC,n.endCC),i=ri(e.fragments,t),s=ri(n.fragments,t);if(!i||!s)return;ae.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const r=i.start-s.start;Uu(r,n)}function ln(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;const t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r;const o=Math.min(e.endCC,n.endCC);e.startCC<o&&n.startCC<o&&(s=ri(i,o),r=ri(t,o)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=ri(t,s.cc)||t[Math.floor(t.length/2)]);const a=s.programDateTime,u=r.programDateTime;if(!a||!u)return;const l=(u-a)/1e3-(r.start-s.start);Uu(l,n)}function Ce(n,e,t){De(n,e,t),n.addEventListener(e,t)}function De(n,e,t){n.removeEventListener(e,t)}const wE={toString:function(n){let e="";const t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},k={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class zs extends Iu{constructor(e,t,i,s,r){super(s,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=k.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:u,mediaBuffer:l,state:c}=this,f=u?u.currentTime:0,p=Q.bufferInfo(l||u,f,o.maxBufferHole),g=!p.len;if(this.log(`Media seeking to ${V(f)?f.toFixed(3):f}, state: ${c}, ${g?"out of":"in"} buffer`),this.state===k.ENDED)this.resetLoadingState();else if(a){const m=o.maxFragLookUpTolerance,E=a.start-m,y=a.start+a.duration+m;if(g||y<p.start||E>p.end){const v=f>y;(f<E||v)&&(v&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(u){this.fragmentTracker.removeFragmentsInRange(f,1/0,this.playlistType,!0);const m=this.lastCurrentTime;if(f>m&&(this.lastCurrentTime=f),!this.loadingParts){const E=Math.max(p.end,f),y=this.shouldLoadParts(this.getLevelDetails(),E);y&&(this.log(`LL-Part loading ON after seeking to ${f.toFixed(2)} with buffer @${E.toFixed(2)}`),this.loadingParts=y)}}this.hls.hasEnoughToStart||(this.log(`Setting ${g?"startPosition":"nextLoadPosition"} to ${f} for seek without enough to start`),this.nextLoadPosition=f,g&&(this.startPosition=f)),g&&this.state===k.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new oE(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new qs(e.config)}registerListeners(){const{hls:e}=this;e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(T.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===k.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=k.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,s=this.config.timelineOffset||0;if(i<=s)return!1;const r=e.buffered;this.config.maxBufferHole&&r&&r.length>1&&(e=Q.bufferedInfo(r,e.start,0));const o=e.nextStart;if(o&&o>s&&o<t.edge||this.media.currentTime<e.start)return!1;const u=t.partList;if(u!=null&&u.length){const c=u[u.length-1];return Q.isBuffered(this.media,c.start+c.duration/2)}const l=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(l)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;Ce(i,"seeking",this.onMediaSeeking),Ce(i,"ended",this.onMediaEnded);const s=this.config;this.levels&&s.autoStartLoad&&this.state===k.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,s=this.media;if(s!==null){if(s.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),De(s,"seeking",this.onMediaSeeking),De(s,"ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=k.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{const o=r.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${r.part?" part: "+r.part.index:""} of ${this.fragInfo(o,!1,r.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const o=this.state,a=r.frag;if(this.fragContextChanged(a)){(o===k.FRAG_LOADING||!this.fragCurrent&&o===k.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=k.IDLE);return}"payload"in r&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(T.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===k.STOPPED||this.state===k.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===me.APPENDING){const r=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,r),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),u=this.backtrackFragment;((u?e.sn-u.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===me.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(T.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const s=i==null?void 0:i.frag;if(!s||this.fragContextChanged(s)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{frag:r,payload:o}=i,a=r.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&Kt(a.method)){const u=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,Ws(a.method)).catch(l=>{throw s.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:r}),l}).then(l=>{const c=self.performance.now();return s.trigger(T.FRAG_DECRYPTED,{frag:r,payload:l,stats:{tstart:u,tdecrypt:c}}),i.payload=l,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===k.STOPPED||this.state===k.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==k.STOPPED&&(this.state=k.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var i,s;const r=e.tracks;if(r&&!t.encrypted&&((i=r.audio)!=null&&i.encrypted||(s=r.video)!=null&&s.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const o=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${o?"attached mediaKeys: "+o.mediaKeys:"detached"})`);return this.warn(a.message),!o||o.mediaKeys?!1:(this.hls.trigger(T.ERROR,{type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?wE.toString(Q.getBuffered(i)):"(detached)"})`),pe(e)){var s;if(e.type!==K.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=k.IDLE;return}}const r=(s=this.levels)==null?void 0:s[e.level];r!=null&&r.fragmentError&&(this.log(`Resetting level fragment error count of ${r.fragmentError} on frag buffered`),r.fragmentError=0)}this.state=k.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,o=!r||r.length===0||r.some(u=>!u),a=new Ys(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;this.fragCurrent=e;const o=t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)){if(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=k.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(p=>{if(!this.fragContextChanged(p.frag))return this.hls.trigger(T.KEY_LOADED,p),this.state===k.KEY_LOADING&&(this.state=k.IDLE),p}),this.hls.trigger(T.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const u=this.fragPrevious;if(pe(e)&&(!u||e.sn!==u.sn)){const p=this.shouldLoadParts(t.details,e.end);p!==this.loadingParts&&(this.log(`LL-Part loading ${p?"ON":"OFF"} loading sn ${u==null?void 0:u.sn}->${e.sn}`),this.loadingParts=p)}if(i=Math.max(e.start,i||0),this.loadingParts&&pe(e)){const p=o.partList;if(p&&s){i>o.fragmentEnd&&o.fragmentHint&&(e=o.fragmentHint);const g=this.getNextPart(p,e,i);if(g>-1){const m=p[g];e=this.fragCurrent=m.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${m.index} (${g}/${p.length-1}) of ${this.fragInfo(e,!1,m)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=m.start+m.duration,this.state=k.FRAG_LOADING;let E;return a?E=a.then(y=>!y||this.fragContextChanged(y.frag)?null:this.doFragPartsLoad(e,m,t,s)).catch(y=>this.handleFragLoadError(y)):E=this.doFragPartsLoad(e,m,t,s).catch(y=>this.handleFragLoadError(y)),this.hls.trigger(T.FRAG_LOADING,{frag:e,part:m,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):E}else if(!e.url||this.loadedEndOfParts(p,i))return Promise.resolve(null)}}if(pe(e)&&this.loadingParts){var l;this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(l=o.partList)==null?void 0:l.filter(p=>p.loaded).map(p=>`[${p.start}-${p.end}]`)}`),this.loadingParts=!1}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${"["+o.startSN+"-"+o.endSN+"]"}, target: ${parseFloat(i.toFixed(3))}`),V(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=k.FRAG_LOADING;const c=this.config.progressive&&e.type!==K.SUBTITLE;let f;return c&&a?f=a.then(p=>!p||this.fragContextChanged(p.frag)?null:this.fragmentLoader.load(e,s)).catch(p=>this.handleFragLoadError(p)):f=Promise.all([this.fragmentLoader.load(e,c?s:void 0),a]).then(([p])=>(!c&&s&&s(p),p)).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(T.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):f}doFragPartsLoad(e,t,i,s){return new Promise((r,o)=>{var a;const u=[],l=(a=i.details)==null?void 0:a.partList,c=f=>{this.fragmentLoader.loadPart(e,f,s).then(p=>{u[f.index]=p;const g=p.part;this.hls.trigger(T.FRAG_LOADED,p);const m=Da(i.details,e.sn,f.index+1)||Nu(l,e.sn,f.index+1);if(m)c(m);else return r({frag:e,part:g,partsLoaded:u})}).catch(o)};c(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;t.frag&&t.details===b.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===W.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(T.ERROR,t)}else this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==k.PARSING){!this.fragCurrent&&this.state!==k.STOPPED&&this.state!==k.ERROR&&(this.state=k.IDLE);return}const{frag:i,part:s,level:r}=t,o=self.performance.now();i.stats.parsing.end=o,s&&(s.stats.parsing.end=o);const a=this.getLevelDetails(),l=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);l!==this.loadingParts&&(this.log(`LL-Part loading ${l?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=l),this.updateLevelTiming(i,s,r,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var i;const r=e.partList[0];if(r.fragment.type===K.SUBTITLE)return!1;const o=r.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var s;if((this.hls.hasEnoughToStart?((s=this.media)==null?void 0:s.currentTime)||this.lastCurrentTime:this.getLoadPosition())>r.start-r.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:o}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of ${this.playlistLabel()} ${s}. The current chunk will not be buffered.`),null;const a=t[s],u=a.details,l=o>-1?Da(u,r,o):null,c=l?l.fragment:Mu(u,r,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:l,level:a}):null}bufferFragmentData(e,t,i,s,r){if(this.state!==k.PARSING)return;const{data1:o,data2:a}=e;let u=o;if(a&&(u=$e(o,a)),!u.length)return;const l=this.initPTS[t.cc],c=l?-l.baseTime/l.timescale:void 0,f={type:e.type,frag:t,part:i,chunkMeta:s,offset:c,parent:t.type,data:u};if(this.hls.trigger(T.BUFFER_APPENDING,f),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Q.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=Q.bufferInfo(t,i,0),r=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),a=Math.max(Math.min(e.start-o,s.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const s=this.getLoadPosition();if(!V(s))return null;const o=this.lastCurrentTime>s||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,s,t,o)}getFwdBufferInfoAtPos(e,t,i,s){const r=Q.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(r.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(r.nextStart,o.end)-t,s);return Q.bufferInfo(e,t,a)}}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,s=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,s);return r>=s?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=K.MAIN){const i=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,o=i[0].start,a=r.lowLatencyMode&&!!t.partList;let u=null;if(t.live){const f=r.initialLiveManifestSize;if(s<f)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${f})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),u=this.getInitialLiveFragment(t);const p=this.hls.startPosition,g=this.hls.liveSyncPosition,m=u?(p!==-1&&p>=o?p:g)||u.start:e;this.log(`Setting startPosition to ${m} to match start frag at live edge. mainStart: ${p} liveSyncPosition: ${g} frag.start: ${(l=u)==null?void 0:l.start}`),this.startPosition=this.nextLoadPosition=m}}else e<=o&&(u=i[0]);if(!u){const f=this.loadingParts?t.partEnd:t.fragmentEnd;u=this.getFragmentAtPosition(e,f,t)}let c=this.filterReplacedPrimary(u,t);if(!c&&u){const f=u.sn-t.startSN;c=this.filterReplacedPrimary(i[f+1]||null,t)}return this.mapToInitFragWhenRequired(c)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===me.OK||i===me.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s,0);if(a!==null&&i.len+a.len>=r){const u=o.sn;return this.loopSn!==u&&(this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${u}`),this.loopSn=u),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(ka(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(ka(this.config)&&e.type!==K.SUBTITLE){const i=this.hls.interstitialsManager,s=i==null?void 0:i.bufferingItem;if(s){const o=s.event;if(o){if(o.appendInPlace||Math.abs(e.start-s.start)>1||s.start===0)return null}else if(e.end<=s.start&&(t==null?void 0:t.live)===!1||e.start>s.end&&s.nextEvent&&(s.nextEvent.appendInPlace||e.start-s.end>1))return null}const r=i==null?void 0:i.playerQueue;if(r)for(let o=r.length;o--;){const a=r[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,o=!0;for(let a=0,u=e.length;a<u;a++){const l=e[a];if(o=o&&!l.independent,s>-1&&i<l.start)break;const c=l.loaded;c?s=-1:(r||(l.independent||o)&&l.fragment===t)&&(l.fragment!==t&&this.warn(`Need buffer at ${i} but next unloaded part starts at ${l.start}`),s=a),r=c}return s}loadedEndOfParts(e,t){let i;for(let s=e.length;s--;){if(i=e[s],!i.loaded)return!1;if(t>i.start)return!0}return!1}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=Jy(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const o=t[r-e.startSN];i.cc===o.cc&&(s=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=vu(e,i.cc,i.end),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:o,endSN:a}=i;const{fragmentHint:u}=i,{maxFragLookUpTolerance:l}=s,c=i.partList,f=!!(this.loadingParts&&c!=null&&c.length&&u);f&&!this.bitrateTest&&c[c.length-1].fragment.sn===u.sn&&(o=o.concat(u),a=u.sn);let p;if(e<t){var g;const E=e<this.lastCurrentTime||e>t-l||(g=this.media)!=null&&g.paused||!this.startFragRequested?0:l;p=Lt(r,o,e,E)}else p=o[o.length-1];if(p){const m=p.sn-i.startSN,E=this.fragmentTracker.getState(p);if((E===me.OK||E===me.PARTIAL&&p.gap)&&(r=p),r&&p.sn===r.sn&&(!f||c[0].fragment.sn>p.sn||!i.live)&&p.level===r.level){const v=o[m+1];p.sn<a&&this.fragmentTracker.getState(v)!==me.OK?p=v:p=null}}return p}alignPlaylists(e,t,i){const s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,o=!t,a=e.alignedSliding&&V(r);if(o||!a&&!r){bE(i,e);const u=e.fragmentStart;return this.log(`Live playlist sliding: ${u.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${s}`),u}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const s=this.timelineOffset;if(i===-1){const r=this.startTimeOffset!==null,o=r?this.startTimeOffset:e.startTimeOffset;o!==null&&V(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${r?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+s}this.nextLoadPosition=i+s}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&pe(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==k.FRAG_LOADING_WAITING_RETRY)&&(this.state=k.IDLE)}onFragmentOrKeyLoadError(e,t){var i;if(t.chunkMeta&&!t.frag){const v=this.getCurrentContext(t.chunkMeta);v&&(t.frag=v.frag)}const s=t.frag;if(!s||s.type!==e||!this.levels)return;if(this.fragContextChanged(s)){var r;this.warn(`Frag load error must match current frag to retry ${s.url} > ${(r=this.fragCurrent)==null?void 0:r.url}`);return}const o=t.details===b.FRAG_GAP;o&&this.fragmentTracker.fragBuffered(s,!0);const a=t.errorAction;if(!a){this.state=k.ERROR;return}const{action:u,flags:l,retryCount:c=0,retryConfig:f}=a,p=!!f,g=p&&u===ve.RetryRequest,m=p&&!a.resolved&&l===we.MoveAllAlternatesMatchingHost,E=(i=this.hls.latestLevelDetails)==null?void 0:i.live;if(!g&&m&&pe(s)&&!s.endList&&E&&!Au(t))this.resetFragmentErrors(e),this.treatAsGap(s),a.resolved=!0;else if((g||m)&&c<f.maxNumRetry){var y;const v=ps((y=t.response)==null?void 0:y.code),S=Ks(f,c);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+S,this.state=k.FRAG_LOADING_WAITING_RETRY,a.resolved=!0,v){this.log("Waiting for connection (offline)"),this.retryDate=1/0,t.reason="offline";return}this.warn(`Fragment ${s.sn} of ${e} ${s.level} errored with ${t.details}, retrying loading ${c+1}/${f.maxNumRetry} in ${S}ms`)}else if(f)if(this.resetFragmentErrors(e),c<f.maxNumRetry)!o&&u!==ve.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${c})`);return}else u===ve.SendAlternateToPenaltyBox?this.state=k.WAITING_LEVEL:this.state=k.ERROR;this.tickImmediate()}checkRetryDate(){const e=self.performance.now(),t=this.retryDate,i=t===1/0;(!t||e>=t||i&&!ps(0))&&(i&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=k.IDLE)}reduceLengthAndFlushBuffer(e){if(this.state===k.PARSING||this.state===k.PARSED){const t=e.frag,i=e.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,(t==null?void 0:t.duration)||10);const o=!r;return o&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===K.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==k.STOPPED&&(this.state=k.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=Q.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===k.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==k.STOPPED&&(this.state=k.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?"<removed>":e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){const r=i.details;if(!r){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((u,l)=>{const c=e.elementaryStreams[l];if(c){const f=c.endPTS-c.startPTS;if(f<=0)return this.warn(`Could not parse fragment ${e.sn} ${l} duration reliably (${f})`),u||!1;const p=s?0:bu(r,e,c.startPTS,c.endPTS,c.startDTS,c.endDTS,this);return this.hls.trigger(T.LEVEL_PTS_UPDATED,{details:r,level:i,drift:p,type:l,frag:e,start:c.startPTS,end:c.endPTS}),!0}return u},!1)){var a;const u=((a=this.transmuxer)==null?void 0:a.error)===null;if((i.fragmentError===0||u&&(i.fragmentError<2||e.endList))&&this.treatAsGap(e,i),u){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=k.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(T.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===K.MAIN?"level":"track"}fragInfo(e,t=!0,i){var s,r;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((s=t&&!i?e.startPTS:(i||e).start)!=null?s:NaN).toFixed(3)}-${((r=t&&!i?e.endPTS:(i||e).end)!=null?r:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function ka(n){return!!n.interstitialsController&&n.enableInterstitialPlayback!==!1}class Bu{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=kE(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function kE(n,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<n.length;s++){const r=n[s];t.set(r,i),i+=r.length}return t}var wn={exports:{}},Ma;function ME(){return Ma||(Ma=1,(function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(u,l,c){this.fn=u,this.context=l,this.once=c||!1}function r(u,l,c,f,p){if(typeof c!="function")throw new TypeError("The listener must be a function");var g=new s(c,f||u,p),m=t?t+l:l;return u._events[m]?u._events[m].fn?u._events[m]=[u._events[m],g]:u._events[m].push(g):(u._events[m]=g,u._eventsCount++),u}function o(u,l){--u._eventsCount===0?u._events=new i:delete u._events[l]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],c,f;if(this._eventsCount===0)return l;for(f in c=this._events)e.call(c,f)&&l.push(t?f.slice(1):f);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(c)):l},a.prototype.listeners=function(l){var c=t?t+l:l,f=this._events[c];if(!f)return[];if(f.fn)return[f.fn];for(var p=0,g=f.length,m=new Array(g);p<g;p++)m[p]=f[p].fn;return m},a.prototype.listenerCount=function(l){var c=t?t+l:l,f=this._events[c];return f?f.fn?1:f.length:0},a.prototype.emit=function(l,c,f,p,g,m){var E=t?t+l:l;if(!this._events[E])return!1;var y=this._events[E],v=arguments.length,S,A;if(y.fn){switch(y.once&&this.removeListener(l,y.fn,void 0,!0),v){case 1:return y.fn.call(y.context),!0;case 2:return y.fn.call(y.context,c),!0;case 3:return y.fn.call(y.context,c,f),!0;case 4:return y.fn.call(y.context,c,f,p),!0;case 5:return y.fn.call(y.context,c,f,p,g),!0;case 6:return y.fn.call(y.context,c,f,p,g,m),!0}for(A=1,S=new Array(v-1);A<v;A++)S[A-1]=arguments[A];y.fn.apply(y.context,S)}else{var _=y.length,I;for(A=0;A<_;A++)switch(y[A].once&&this.removeListener(l,y[A].fn,void 0,!0),v){case 1:y[A].fn.call(y[A].context);break;case 2:y[A].fn.call(y[A].context,c);break;case 3:y[A].fn.call(y[A].context,c,f);break;case 4:y[A].fn.call(y[A].context,c,f,p);break;default:if(!S)for(I=1,S=new Array(v-1);I<v;I++)S[I-1]=arguments[I];y[A].fn.apply(y[A].context,S)}}return!0},a.prototype.on=function(l,c,f){return r(this,l,c,f,!1)},a.prototype.once=function(l,c,f){return r(this,l,c,f,!0)},a.prototype.removeListener=function(l,c,f,p){var g=t?t+l:l;if(!this._events[g])return this;if(!c)return o(this,g),this;var m=this._events[g];if(m.fn)m.fn===c&&(!p||m.once)&&(!f||m.context===f)&&o(this,g);else{for(var E=0,y=[],v=m.length;E<v;E++)(m[E].fn!==c||p&&!m[E].once||f&&m[E].context!==f)&&y.push(m[E]);y.length?this._events[g]=y.length===1?y[0]:y:o(this,g)}return this},a.prototype.removeAllListeners=function(l){var c;return l?(c=t?t+l:l,this._events[c]&&o(this,c)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a})(wn)),wn.exports}var NE=ME(),Xs=oy(NE);const fi="1.6.15",Jt={};function FE(){return typeof __HLS_WORKER_BUNDLE__=="function"}function UE(){const n=Jt[fi];if(n)return n.clientCount++,n;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),s={worker:new self.Worker(t),objectURL:t,clientCount:1};return Jt[fi]=s,s}function OE(n){const e=Jt[n];if(e)return e.clientCount++,e;const t=new self.URL(n,self.location.href).href,s={worker:new self.Worker(t),scriptURL:t,clientCount:1};return Jt[n]=s,s}function BE(n){const e=Jt[n||fi];if(e&&e.clientCount--===1){const{worker:i,objectURL:s}=e;delete Jt[n||fi],s&&self.URL.revokeObjectURL(s),i.terminate()}}function $u(n,e){return e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function Qs(n,e){return e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128}function En(n,e){let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t}function hi(n,e){const t=e;let i=0;for(;Qs(n,e);){i+=10;const s=En(n,e+6);i+=s,$u(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)}function $E(n,e,t,i){const s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],r=e[t+2],o=r>>2&15;if(o>12){const g=new Error(`invalid ADTS sampling index:${o}`);n.emit(T.ERROR,T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!0,error:g,reason:g.message});return}const a=(r>>6&3)+1,u=e[t+3]>>6&3|(r&1)<<2,l="mp4a.40."+a,c=s[o];let f=o;(a===5||a===29)&&(f-=3);const p=[a<<3|(f&14)>>1,(f&1)<<7|u<<3];return ae.log(`manifest codec:${i}, parsed codec:${l}, channels:${u}, rate:${c} (ADTS object type:${a} sampling index:${o})`),{config:p,samplerate:c,channelCount:u,codec:l,parsedCodec:l,manifestCodec:i}}function Gu(n,e){return n[e]===255&&(n[e+1]&246)===240}function Vu(n,e){return n[e+1]&1?7:9}function Zs(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function GE(n,e){return e+5<n.length}function un(n,e){return e+1<n.length&&Gu(n,e)}function VE(n,e){return GE(n,e)&&Gu(n,e)&&Zs(n,e)<=n.length-e}function HE(n,e){if(un(n,e)){const t=Vu(n,e);if(e+t>=n.length)return!1;const i=Zs(n,e);if(i<=t)return!1;const s=e+i;return s===n.length||un(n,s)}return!1}function Hu(n,e,t,i,s){if(!n.samplerate){const r=$E(e,t,i,s);if(!r)return;le(n,r)}}function Ku(n){return 1024*9e4/n}function KE(n,e){const t=Vu(n,e);if(e+t<=n.length){const i=Zs(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function qu(n,e,t,i,s){const r=Ku(n.samplerate),o=i+s*r,a=KE(e,t);let u;if(a){const{frameLength:f,headerLength:p}=a,g=p+f,m=Math.max(0,t+g-e.length);m?(u=new Uint8Array(g-p),u.set(e.subarray(t+p,e.length),0)):u=e.subarray(t+p,t+g);const E={unit:u,pts:o};return m||n.samples.push(E),{sample:E,length:g,missing:m}}const l=e.length-t;return u=new Uint8Array(l),u.set(e.subarray(t,e.length),0),{sample:{unit:u,pts:o},length:l,missing:-1}}function qE(n,e){return Qs(n,e)&&En(n,e+6)+10<=n.length-e}function YE(n){return n instanceof ArrayBuffer?n:n.byteOffset==0&&n.byteLength==n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer}function kn(n,e=0,t=1/0){return WE(n,e,t,Uint8Array)}function WE(n,e,t,i){const s=JE(n);let r=1;"BYTES_PER_ELEMENT"in i&&(r=i.BYTES_PER_ELEMENT);const o=zE(n)?n.byteOffset:0,a=(o+n.byteLength)/r,u=(o+e)/r,l=Math.floor(Math.max(0,Math.min(u,a))),c=Math.floor(Math.min(l+Math.max(t,0),a));return new i(s,l,c-l)}function JE(n){return n instanceof ArrayBuffer?n:n.buffer}function zE(n){return n&&n.buffer instanceof ArrayBuffer&&n.byteLength!==void 0&&n.byteOffset!==void 0}function XE(n){const e={key:n.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(n.size<2)return;if(n.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=n.data.subarray(1).indexOf(0);if(i===-1)return;const s=Ne(kn(n.data,1,i)),r=n.data[2+i],o=n.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=Ne(kn(n.data,3+i,o));let u;return s==="-->"?u=Ne(kn(n.data,4+i+o)):u=YE(n.data.subarray(4+i+o)),e.mimeType=s,e.pictureType=r,e.description=a,e.data=u,e}function QE(n){if(n.size<2)return;const e=Ne(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}}function ZE(n){if(n.size<2)return;if(n.type==="TXXX"){let t=1;const i=Ne(n.data.subarray(t),!0);t+=i.length+1;const s=Ne(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Ne(n.data.subarray(1));return{key:n.type,info:"",data:e}}function jE(n){if(n.type==="WXXX"){if(n.size<2)return;let t=1;const i=Ne(n.data.subarray(t),!0);t+=i.length+1;const s=Ne(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=Ne(n.data);return{key:n.type,info:"",data:e}}function eT(n){return n.type==="PRIV"?QE(n):n.type[0]==="W"?jE(n):n.type==="APIC"?XE(n):ZE(n)}function tT(n){const e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=En(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}}const xi=10,iT=10;function Yu(n){let e=0;const t=[];for(;Qs(n,e);){const i=En(n,e+6);n[e+5]>>6&1&&(e+=xi),e+=xi;const s=e+i;for(;e+iT<s;){const r=tT(n.subarray(e)),o=eT(r);o&&t.push(o),e+=r.size+xi}$u(n,e)&&(e+=xi)}return t}function Wu(n){return n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp"}function nT(n){if(n.data.byteLength===8){const e=new Uint8Array(n.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function js(n){const e=Yu(n);for(let t=0;t<e.length;t++){const i=e[t];if(Wu(i))return nT(i)}}let Me=(function(n){return n.audioId3="org.id3",n.dateRange="com.apple.quicktime.HLS",n.emsg="https://aomedia.org/emsg/ID3",n.misbklv="urn:misb:KLV:bin:1910.1",n})({});function Ze(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class er{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=$e(this.cachedData,e),this.cachedData=null);let i=hi(e,0),s=i?i.length:0,r;const o=this._audioTrack,a=this._id3Track,u=i?js(i):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&V(u))&&(this.basePTS=sT(u,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Me.audioId3,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(e,s)){const c=this.appendFrame(o,e,s);c?(this.frameIndex++,this.lastPTS=c.sample.pts,s+=c.length,r=s):s=l}else qE(e,s)?(i=hi(e,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Me.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===l&&r!==l){const c=e.slice(r);this.cachedData?this.cachedData=$e(this.cachedData,c):this.cachedData=c}}return{audioTrack:o,videoTrack:Ze(),id3Track:a,textTrack:Ze()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Ze(),id3Track:this._id3Track,textTrack:Ze()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const sT=(n,e,t)=>{if(V(n))return n*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let Ci=null;const rT=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],oT=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],aT=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],lT=[0,1,1,4];function Ju(n,e,t,i,s){if(t+24>e.length)return;const r=zu(e,t);if(r&&t+r.frameLength<=e.length){const o=r.samplesPerFrame*9e4/r.sampleRate,a=i+s*o,u={unit:e.subarray(t,t+r.frameLength),pts:a,dts:a};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(u),{sample:u,length:r.frameLength,missing:0}}}function zu(n,e){const t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const o=n[e+2]>>1&1,a=n[e+3]>>6,u=t===3?3-i:i===3?3:4,l=rT[u*14+s-1]*1e3,f=oT[(t===3?0:t===2?1:2)*3+r],p=a===3?1:2,g=aT[t][i],m=lT[i],E=g*8*m,y=Math.floor(g*l/f+o)*m;if(Ci===null){const A=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Ci=A?parseInt(A[1]):0}return!!Ci&&Ci<=87&&i===2&&l>=224e3&&a===0&&(n[e+3]=n[e+3]|128),{sampleRate:f,channelCount:p,frameLength:y,samplesPerFrame:E}}}function tr(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function Xu(n,e){return e+1<n.length&&tr(n,e)}function uT(n,e){return tr(n,e)&&4<=n.length-e}function Qu(n,e){if(e+1<n.length&&tr(n,e)){const i=zu(n,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===n.length||Xu(n,r)}return!1}class cT extends er{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=hi(e,0);let s=(i==null?void 0:i.length)||0;if(Qu(e,s))return!1;for(let r=e.length;s<r;s++)if(HE(e,s))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return VE(e,t)}appendFrame(e,t,i){Hu(e,this.observer,t,i,e.manifestCodec);const s=qu(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const Zu=(n,e)=>{let t=0,i=5;e+=i;const s=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=n[e];const a=Math.min(i,8),u=8-a;r[0]=4278190080>>>24+u<<u,s[0]=(o[0]&r[0])>>u,t=t?t<<a|s[0]:s[0],e+=1,i-=a}return t};class dT extends er{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const s=ju(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;const t=hi(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&js(t)!==void 0&&Zu(e,i)<16}}function ju(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],u=e[t+4]&63,c=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][u*3+r]*2;if(t+c>e.length)return-1;const f=e[t+6]>>5;let p=0;f===2?p+=2:(f&1&&f!==1&&(p+=2),f&4&&(p+=2));const g=(e[t+6]<<8|e[t+7])>>12-p&1,E=[2,1,2,3,3,4,4,5][f]+g,y=e[t+5]>>3,v=e[t+5]&7,S=new Uint8Array([r<<6|y<<1|v>>2,(v&3)<<6|f<<3|g<<2|u>>4,u<<4&224]),A=1536/a*9e4,_=i+s*A,I=e.subarray(t,t+c);return n.config=S,n.channelCount=E,n.samplerate=a,n.samples.push({unit:I,pts:_}),c}class fT extends er{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=hi(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&js(t)!==void 0&&Zu(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(Qu(e,i))return ae.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return uT(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return Ju(e,t,i,this.basePTS,this.frameIndex)}}const hT=/\/emsg[-/]ID3/i;class pT{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=Ze("video",1),o=this.audioTrack=Ze("audio",1),a=this.txtTrack=Ze("text",1);if(this.id3Track=Ze("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const u=uu(e);if(u.video){const{id:l,timescale:c,codec:f,supplemental:p}=u.video;r.id=l,r.timescale=a.timescale=c,r.codec=f,r.supplemental=p}if(u.audio){const{id:l,timescale:c,codec:f}=u.audio;o.id=l,o.timescale=c,o.codec=f}a.id=ou.text,r.sampleDuration=0,r.duration=o.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return dy(e)}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=$e(this.remainderData,e));const a=Ey(i);this.remainderData=a.remainder,s.samples=a.valid||new Uint8Array}else s.samples=i;const o=this.extractID3Track(s,t);return r.samples=Zo(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=Zo(e,t),{videoTrack:t,audioTrack:Ze(),id3Track:s,textTrack:Ze()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=ee(e.samples,["emsg"]);s&&s.forEach(r=>{const o=vy(r);if(hT.test(o.schemeIdUri)){const a=Na(o,t);let u=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;u<=.001&&(u=Number.POSITIVE_INFINITY);const l=o.payload;i.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:Me.emsg,duration:u})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=Na(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:Me.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function Na(n,e){return V(n.presentationTime)?n.presentationTime/n.timeScale:e+n.presentationTimeDelta/n.timeScale}class gT{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new qs(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,yt.cbc)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(o).then(a=>{const u=new Uint8Array(a);s.set(u,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)}).catch(i)}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const o=fu(r.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(u=>{r.data=this.getAvcDecryptedUnit(o,u),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)}).catch(s)}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const o=r[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,s,o),!this.decrypter.isSync()))return}}}}class ec{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,s=i.length;if(s){const r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const s=t.byteLength;let r=e.naluState||0;const o=r,a=[];let u=0,l,c,f,p=-1,g=0;for(r===-1&&(p=0,g=this.getNALuType(t,0),r=0,u=1);u<s;){if(l=t[u++],!r){r=l?0:1;continue}if(r===1){r=l?0:2;continue}if(!l)r=3;else if(l===1){if(c=u-r-1,p>=0){const m={data:t.subarray(p,c),type:g};a.push(m)}else{const m=this.getLastNalUnit(e.samples);m&&(o&&u<=4-o&&m.state&&(m.data=m.data.subarray(0,m.data.byteLength-o)),c>0&&(m.data=$e(m.data,t.subarray(0,c)),m.state=0))}u<s?(f=this.getNALuType(t,u),p=u,g=f,r=0):r=-1}else r=0}if(p>=0&&r>=0){const m={data:t.subarray(p,s),type:g,state:r};a.push(m)}if(a.length===0){const m=this.getLastNalUnit(e.samples);m&&(m.data=$e(m.data,t))}return e.naluState=r,a}}class oi{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&ae.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class mT extends ec{parsePES(e,t,i,s){const r=this.parseNALu(e,i.data,s);let o=this.VideoSample,a,u=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var c,f;switch(l.type){case 1:{let E=!1;a=!0;const y=l.data;if(u&&y.length>4){const v=this.readSliceType(y);(v===2||v===4||v===7||v===9)&&(E=!0)}if(E){var p;(p=o)!=null&&p.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=E;break}case 5:a=!0,(c=o)!=null&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,Gs(l.data,1,i.pts,t.samples);break}case 7:{var g,m;a=!0,u=!0;const E=l.data,y=this.readSPS(E);if(!e.sps||e.width!==y.width||e.height!==y.height||((g=e.pixelRatio)==null?void 0:g[0])!==y.pixelRatio[0]||((m=e.pixelRatio)==null?void 0:m[1])!==y.pixelRatio[1]){e.width=y.width,e.height=y.height,e.pixelRatio=y.pixelRatio,e.sps=[E];const v=E.subarray(1,4);let S="avc1.";for(let A=0;A<3;A++){let _=v[A].toString(16);_.length<2&&(_="0"+_),S+=_}e.codec=S}break}case 8:a=!0,e.pps=[l.data];break;case 9:a=!0,e.audFound=!0,(f=o)!=null&&f.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(l)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new oi(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,s=8,r;for(let o=0;o<e;o++)s!==0&&(r=t.readEG(),s=(i+r+256)%256),i=s===0?i:s}readSPS(e){const t=new oi(e);let i=0,s=0,r=0,o=0,a,u,l;const c=t.readUByte.bind(t),f=t.readBits.bind(t),p=t.readUEG.bind(t),g=t.readBoolean.bind(t),m=t.skipBits.bind(t),E=t.skipEG.bind(t),y=t.skipUEG.bind(t),v=this.skipScalingList.bind(this);c();const S=c();if(f(5),m(3),c(),y(),S===100||S===110||S===122||S===244||S===44||S===83||S===86||S===118||S===128){const L=p();if(L===3&&m(1),y(),y(),m(1),g())for(u=L!==3?8:12,l=0;l<u;l++)g()&&(l<6?v(16,t):v(64,t))}y();const A=p();if(A===0)p();else if(A===1)for(m(1),E(),E(),a=p(),l=0;l<a;l++)E();y(),m(1);const _=p(),I=p(),P=f(1);P===0&&m(1),m(1),g()&&(i=p(),s=p(),r=p(),o=p());let R=[1,1];if(g()&&g())switch(c()){case 1:R=[1,1];break;case 2:R=[12,11];break;case 3:R=[10,11];break;case 4:R=[16,11];break;case 5:R=[40,33];break;case 6:R=[24,11];break;case 7:R=[20,11];break;case 8:R=[32,11];break;case 9:R=[80,33];break;case 10:R=[18,11];break;case 11:R=[15,11];break;case 12:R=[64,33];break;case 13:R=[160,99];break;case 14:R=[4,3];break;case 15:R=[3,2];break;case 16:R=[2,1];break;case 255:{R=[c()<<8|c(),c()<<8|c()];break}}return{width:Math.ceil((_+1)*16-i*2-s*2),height:(2-P)*(I+1)*16-(P?2:4)*(r+o),pixelRatio:R}}}class yT extends ec{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,s){const r=this.parseNALu(e,i.data,s);let o=this.VideoSample,a,u=!1;i.data=null,o&&r.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),r.forEach(l=>{var c,f;switch(l.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,u){var p;(p=o)!=null&&p.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(c=o)!=null&&c.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,Gs(l.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=le(e.params,this.readVPS(l.data)),this.initVPS=l.data),e.vps=[l.data];break;case 33:if(a=!0,u=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],l.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const g=this.readSPS(l.data);e.width=g.width,e.height=g.height,e.pixelRatio=g.pixelRatio,e.codec=g.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const m in g.params)e.params[m]=g.params[m]}this.pushParameterSet(e.sps,l.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const g=this.readPPS(l.data);for(const m in g)e.params[m]=g[m]}this.pushParameterSet(e.pps,l.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(f=o)!=null&&f.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(l)}),s&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let s=0;s<e.byteLength;s++)s>=2&&e[s]===3&&e[s-1]===0&&e[s-2]===0||(t[i]=e[s],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new oi(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),s=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:s}}readSPS(e){const t=new oi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const s=t.readBits(2),r=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),u=t.readUByte(),l=t.readUByte(),c=t.readUByte(),f=t.readUByte(),p=t.readUByte(),g=t.readUByte(),m=t.readUByte(),E=t.readUByte(),y=t.readUByte(),v=t.readUByte(),S=[],A=[];for(let ne=0;ne<i;ne++)S.push(t.readBoolean()),A.push(t.readBoolean());if(i>0)for(let ne=i;ne<8;ne++)t.readBits(2);for(let ne=0;ne<i;ne++)S[ne]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),A[ne]&&t.readUByte();t.readUEG();const _=t.readUEG();_==3&&t.skipBits(1);const I=t.readUEG(),P=t.readUEG(),R=t.readBoolean();let L=0,C=0,x=0,w=0;R&&(L+=t.readUEG(),C+=t.readUEG(),x+=t.readUEG(),w+=t.readUEG());const M=t.readUEG(),U=t.readUEG(),$=t.readUEG(),H=t.readBoolean();for(let ne=H?0:i;ne<=i;ne++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let _e=0;_e<4;_e++)for(let Ue=0;Ue<(_e===3?2:6);Ue++)if(!t.readBoolean())t.readUEG();else{const Ve=Math.min(64,1<<4+(_e<<1));_e>1&&t.readEG();for(let Dt=0;Dt<Ve;Dt++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const F=t.readUEG();let Y=0;for(let ne=0;ne<F;ne++){let _e=!1;if(ne!==0&&(_e=t.readBoolean()),_e){ne===F&&t.readUEG(),t.readBoolean(),t.readUEG();let Ue=0;for(let vt=0;vt<=Y;vt++){const Ve=t.readBoolean();let Dt=!1;Ve||(Dt=t.readBoolean()),(Ve||Dt)&&Ue++}Y=Ue}else{const Ue=t.readUEG(),vt=t.readUEG();Y=Ue+vt;for(let Ve=0;Ve<Ue;Ve++)t.readUEG(),t.readBoolean();for(let Ve=0;Ve<vt;Ve++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const ne=t.readUEG();for(let _e=0;_e<ne;_e++){for(let Ue=0;Ue<$+4;Ue++)t.readBits(1);t.readBits(1)}}let O=0,B=1,Z=1,re=!0,j=1,ie=0;t.readBoolean(),t.readBoolean();let Ie=!1;if(t.readBoolean()){if(t.readBoolean()){const St=t.readUByte(),ur=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],mi=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];St>0&&St<16?(B=ur[St-1],Z=mi[St-1]):St===255&&(B=t.readBits(16),Z=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),Ie=t.readBoolean(),Ie&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(j=t.readBits(32),ie=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const mi=t.readBoolean(),cr=t.readBoolean();let Zt=!1;(mi||cr)&&(Zt=t.readBoolean(),Zt&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),Zt&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let dr=0;dr<=i;dr++){re=t.readBoolean();const Mc=re||t.readBoolean();let fr=!1;Mc?t.readEG():fr=t.readBoolean();const hr=fr?1:t.readUEG()+1;if(mi)for(let jt=0;jt<hr;jt++)t.readUEG(),t.readUEG(),Zt&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(cr)for(let jt=0;jt<hr;jt++)t.readUEG(),t.readUEG(),Zt&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),O=t.readUEG())}let Fe=I,Je=P;if(R){let ne=1,_e=1;_===1?ne=_e=2:_==2&&(ne=2),Fe=I-ne*C-ne*L,Je=P-_e*w-_e*x}const Tt=s?["A","B","C"][s]:"",kc=a<<24|u<<16|l<<8|c;let vn=0;for(let ne=0;ne<32;ne++)vn=(vn|(kc>>ne&1)<<31-ne)>>>0;let Sn=vn.toString(16);return o===1&&Sn==="2"&&(Sn="6"),{codecString:`hvc1.${Tt}${o}.${Sn}.${r?"H":"L"}${v}.B0`,params:{general_tier_flag:r,general_profile_idc:o,general_profile_space:s,general_profile_compatibility_flags:[a,u,l,c],general_constraint_indicator_flags:[f,p,g,m,E,y],general_level_idc:v,bit_depth:M+8,bit_depth_luma_minus8:M,bit_depth_chroma_minus8:U,min_spatial_segmentation_idc:O,chroma_format_idc:_,frame_rate:{fixed:re,fps:ie/j}},width:Fe,height:Je,pixelRatio:[B,Z]}}readPPS(e){const t=new oi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const s=t.readBoolean(),r=t.readBoolean();let o=1;return r&&s?o=0:r?o=3:s&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const ye=188;class ht{constructor(e,t,i,s){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=s,this.videoParser=null}static probe(e,t){const i=ht.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(ye*5,t-ye)+1,s=0;for(;s<i;){let r=!1,o=-1,a=0;for(let u=s;u<t;u+=ye)if(e[u]===71&&(t-u===ye||e[u+ye]===71)){if(a++,o===-1&&(o=u,o!==0&&(i=Math.min(o+ye*99,e.length-ye)+1)),r||(r=Ts(e,u)===0),r&&a>1&&(o===0&&a>2||u+ye>i))return o}else{if(a)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:ou[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=ht.createTrack("video"),this._videoTrack.duration=s,this._audioTrack=ht.createTrack("audio",s),this._id3Track=ht.createTrack("id3"),this._txtTrack=ht.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const o=this._videoTrack,a=this._audioTrack,u=this._id3Track,l=this._txtTrack;let c=o.pid,f=o.pesData,p=a.pid,g=u.pid,m=a.pesData,E=u.pesData,y=null,v=this.pmtParsed,S=this._pmtId,A=e.length;if(this.remainderData&&(e=$e(this.remainderData,e),A=e.length,this.remainderData=null),A<ye&&!s)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:u,textTrack:l};const _=Math.max(0,ht.syncOffset(e));A-=(A-_)%ye,A<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,A,e.buffer.byteLength-A));let I=0;for(let R=_;R<A;R+=ye)if(e[R]===71){const L=!!(e[R+1]&64),C=Ts(e,R),x=(e[R+3]&48)>>4;let w;if(x>1){if(w=R+5+e[R+4],w===R+ye)continue}else w=R+4;switch(C){case c:L&&(f&&(r=Mt(f,this.logger))&&(this.readyVideoParser(o.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(o,l,r,!1)),f={data:[],size:0}),f&&(f.data.push(e.subarray(w,R+ye)),f.size+=R+ye-w);break;case p:if(L){if(m&&(r=Mt(m,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r);break}m={data:[],size:0}}m&&(m.data.push(e.subarray(w,R+ye)),m.size+=R+ye-w);break;case g:L&&(E&&(r=Mt(E,this.logger))&&this.parseID3PES(u,r),E={data:[],size:0}),E&&(E.data.push(e.subarray(w,R+ye)),E.size+=R+ye-w);break;case 0:L&&(w+=e[w]+1),S=this._pmtId=ET(e,w);break;case S:{L&&(w+=e[w]+1);const M=TT(e,w,this.typeSupported,i,this.observer,this.logger);c=M.videoPid,c>0&&(o.pid=c,o.segmentCodec=M.segmentVideoCodec),p=M.audioPid,p>0&&(a.pid=p,a.segmentCodec=M.segmentAudioCodec),g=M.id3Pid,g>0&&(u.pid=g),y!==null&&!v&&(this.logger.warn(`MPEG-TS PMT found at ${R} after unknown PID '${y}'. Backtracking to sync byte @${_} to parse all TS packets.`),y=null,R=_-188),v=this.pmtParsed=!0;break}case 17:case 8191:break;default:y=C;break}}else I++;I>0&&vs(this.observer,new Error(`Found ${I} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=f,a.pesData=m,u.pesData=E;const P={audioTrack:a,videoTrack:o,id3Track:u,textTrack:l};return s&&this.extractRemainingSamples(P),P}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,o=i.pesData,a=t.pesData,u=s.pesData;let l;if(o&&(l=Mt(o,this.logger))?(this.readyVideoParser(i.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(i,r,l,!0),i.pesData=null)):i.pesData=o,a&&(l=Mt(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;u&&(l=Mt(u,this.logger))?(this.parseID3PES(s,l),s.pesData=null):s.pesData=u}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new gT(this.observer,this.config,t);return this.decrypt(s,r)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new mT:e==="hevc"&&(this.videoParser=new yT))}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const f=s.missing,p=s.sample.unit.byteLength;if(f===-1)r=$e(s.sample.unit,r);else{const g=p-f;s.sample.unit.set(r.subarray(0,f),g),e.samples.push(s.sample),i=s.missing}}let o,a;for(o=i,a=r.length;o<a-1&&!un(r,o);o++);if(o!==i){let f;const p=o<a-1;if(p?f=`AAC PES did not start with ADTS header,offset:${o}`:f="No ADTS header found in AAC PES",vs(this.observer,new Error(f),p,this.logger),!p)return}Hu(e,this.observer,r,o,this.audioCodec);let u;if(t.pts!==void 0)u=t.pts;else if(s){const f=Ku(e.samplerate);u=s.sample.pts+f}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,c;for(;o<a;)if(c=qu(e,r,o,u,l),o+=c.length,c.missing){this.aacOverFlow=c;break}else for(l++;o<a-1&&!un(r,o);o++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<s;)if(Xu(i,o)){const u=Ju(e,i,o,a,r);if(u)o+=u.length,r++;else break}else o++}parseAC3PES(e,t){{const i=t.data,s=t.pts;if(s===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let o=0,a=0,u;for(;a<r&&(u=ju(e,i,a,s,o++))>0;)a+=u}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=le({},t,{type:this._videoTrack?Me.emsg:Me.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Ts(n,e){return((n[e+1]&31)<<8)+n[e+2]}function ET(n,e){return(n[e+10]&31)<<8|n[e+11]}function TT(n,e,t,i,s,r){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(n[e+1]&15)<<8|n[e+2],u=e+3+a-4,l=(n[e+10]&15)<<8|n[e+11];for(e+=12+l;e<u;){const c=Ts(n,e),f=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){Mn("ADTS AAC",r);break}case 15:o.audioPid===-1&&(o.audioPid=c);break;case 21:o.id3Pid===-1&&(o.id3Pid=c);break;case 219:if(!i){Mn("H.264",r);break}case 27:o.videoPid===-1&&(o.videoPid=c);break;case 3:case 4:!t.mpeg&&!t.mp3?r.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=c,o.segmentAudioCodec="mp3");break;case 193:if(!i){Mn("AC-3",r);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=c,o.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&f>0){let p=e+5,g=f;for(;g>2;){switch(n[p]){case 106:t.ac3!==!0?r.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=c,o.segmentAudioCodec="ac3");break}const E=n[p+1]+2;p+=E,g-=E}}break;case 194:case 135:return vs(s,new Error("Unsupported EC-3 in M2TS found"),void 0,r),o;case 36:o.videoPid===-1&&(o.videoPid=c,o.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"));break}e+=f+5}return o}function vs(n,e,t,i){i.warn(`parsing error: ${e.message}`),n.emit(T.ERROR,T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Mn(n,e){e.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Mt(n,e){let t=0,i,s,r,o,a;const u=n.data;if(!n||n.size===0)return null;for(;u[0].length<19&&u.length>1;)u[0]=$e(u[0],u[1]),u.splice(1,1);if(i=u[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(s=(i[4]<<8)+i[5],s&&s>n.size-6)return null;const c=i[7];c&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,c&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),r=i[8];let f=r+9;if(n.size<=f)return null;n.size-=f;const p=new Uint8Array(n.size);for(let g=0,m=u.length;g<m;g++){i=u[g];let E=i.byteLength;if(f)if(f>E){f-=E;continue}else i=i.subarray(f),E-=f,f=0;p.set(i,t),t+=E}return s&&(s-=r+3),{data:p,pts:o,dts:a,len:s}}return null}class vT{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const ct=Math.pow(2,32)-1;class D{static init(){D.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in D.types)D.types.hasOwnProperty(e)&&(D.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);D.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);D.STTS=D.STSC=D.STCO=r,D.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),D.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),D.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),D.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);D.FTYP=D.box(D.types.ftyp,o,u,o,a),D.DINF=D.box(D.types.dinf,D.box(D.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),s=0,i=8;s<r;s++)o.set(t[s],i),i+=t[s].byteLength;return o}static hdlr(e){return D.box(D.types.hdlr,D.HDLR_TYPES[e])}static mdat(e){return D.box(D.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(ct+1)),s=Math.floor(t%(ct+1));return D.box(D.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return D.box(D.types.mdia,D.mdhd(e.timescale||0,e.duration||0),D.hdlr(e.type),D.minf(e))}static mfhd(e){return D.box(D.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?D.box(D.types.minf,D.box(D.types.smhd,D.SMHD),D.DINF,D.stbl(e)):D.box(D.types.minf,D.box(D.types.vmhd,D.VMHD),D.DINF,D.stbl(e))}static moof(e,t,i){return D.box(D.types.moof,D.mfhd(e),D.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=D.trak(e[t]);return D.box.apply(null,[D.types.moov,D.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(D.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=D.trex(e[t]);return D.box.apply(null,[D.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(ct+1)),s=Math.floor(t%(ct+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return D.box(D.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return D.box(D.types.sdtp,i)}static stbl(e){return D.box(D.types.stbl,D.stsd(e),D.box(D.types.stts,D.STTS),D.box(D.types.stsc,D.STSC),D.box(D.types.stsz,D.STSZ),D.box(D.types.stco,D.STCO))}static avc1(e){let t=[],i=[],s,r,o;for(s=0;s<e.sps.length;s++)r=e.sps[s],o=r.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],o=r.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(r));const a=D.box(D.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),u=e.width,l=e.height,c=e.pixelRatio[0],f=e.pixelRatio[1];return D.box(D.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,D.box(D.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),D.box(D.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,c&255,f>>24,f>>16&255,f>>8&255,f&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return D.box(D.types.mp4a,D.audioStsd(e),D.box(D.types.esds,D.esds(e)))}static mp3(e){return D.box(D.types[".mp3"],D.audioStsd(e))}static ac3(e){return D.box(D.types["ac-3"],D.audioStsd(e),D.box(D.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return D.box(D.types.stsd,D.STSD,D.mp4a(e));if(t==="ac3"&&e.config)return D.box(D.types.stsd,D.STSD,D.ac3(e));if(t==="mp3"&&e.codec==="mp3")return D.box(D.types.stsd,D.STSD,D.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return D.box(D.types.stsd,D.STSD,D.avc1(e));if(t==="hevc"&&e.vps)return D.box(D.types.stsd,D.STSD,D.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),s=e.width||0,r=e.height||0,o=Math.floor(i/(ct+1)),a=Math.floor(i%(ct+1));return D.box(D.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=D.sdtp(e),s=e.id,r=Math.floor(t/(ct+1)),o=Math.floor(t%(ct+1));return D.box(D.types.traf,D.box(D.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),D.box(D.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,o>>24,o>>16&255,o>>8&255,o&255])),D.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,D.box(D.types.trak,D.tkhd(e),D.mdia(e))}static trex(e){const t=e.id;return D.box(D.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,o=new Uint8Array(r);let a,u,l,c,f,p;for(t+=8+r,o.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<s;a++)u=i[a],l=u.duration,c=u.size,f=u.flags,p=u.cts,o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,f.isLeading<<2|f.dependsOn,f.isDependedOn<<6|f.hasRedundancy<<4|f.paddingValue<<1|f.isNonSync,f.degradPrio&61440,f.degradPrio&15,p>>>24&255,p>>>16&255,p>>>8&255,p&255],12+16*a);return D.box(D.types.trun,o)}static initSegment(e){D.types||D.init();const t=D.moov(e);return $e(D.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],s=4,r=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),s-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=r.length;for(let m=0;m<i.length;m+=1){o+=3;for(let E=0;E<i[m].length;E+=1)o+=2+i[m][E].length}const a=new Uint8Array(o);a.set(r,0),o=r.length;const u=i.length-1;for(let m=0;m<i.length;m+=1){a.set(new Uint8Array([32+m|(m===u?128:0),0,i[m].length]),o),o+=3;for(let E=0;E<i[m].length;E+=1)a.set(new Uint8Array([i[m][E].length>>8,i[m][E].length&255]),o),o+=2,a.set(i[m][E],o),o+=i[m][E].length}const l=D.box(D.types.hvcC,a),c=e.width,f=e.height,p=e.pixelRatio[0],g=e.pixelRatio[1];return D.box(D.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,f>>8&255,f&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,D.box(D.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),D.box(D.types.pasp,new Uint8Array([p>>24,p>>16&255,p>>8&255,p&255,g>>24,g>>16&255,g>>8&255,g&255])))}}D.types=void 0;D.HDLR_TYPES=void 0;D.STTS=void 0;D.STSC=void 0;D.STCO=void 0;D.STSZ=void 0;D.VMHD=void 0;D.SMHD=void 0;D.STSD=void 0;D.FTYP=void 0;D.DINF=void 0;const tc=9e4;function ir(n,e,t=1,i=!1){const s=n*e*t;return i?Math.round(s):s}function ST(n,e,t=1,i=!1){return ir(n,e,1/t,i)}function ii(n,e=!1){return ir(n,1e3,1/tc,e)}function AT(n,e=1){return ir(n,tc,1/e)}function Fa(n){const{baseTime:e,timescale:t,trackId:i}=n;return`${e/t} (${e}/${t}) trackId: ${i}`}const IT=10*1e3,_T=1024,RT=1152,xT=1536;let Nt=null,Nn=null;function Ua(n,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:n?2:1,isNonSync:n?0:1}}}class Vi extends Ge{constructor(e,t,i,s){if(super("mp4-remuxer",s),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,Nt===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Nt=o?parseInt(o[1]):0}if(Nn===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Nn=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){const t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&Fa(t)} > ${e&&Fa(e)}`),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,s=e.reduce((r,o)=>{let a=o.pts,u=a-r;return u<-4294967296&&(t=!0,a=ke(a,i),u=a-r),u>0?r:a},i);return t&&this.debug("PTS rollover detected"),s}remux(e,t,i,s,r,o,a,u){let l,c,f,p,g,m,E=r,y=r;const v=e.pid>-1,S=t.pid>-1,A=t.samples.length,_=e.samples.length>0,I=a&&A>0||A>1;if((!v||_)&&(!S||I)||this.ISGenerated||a){if(this.ISGenerated){var R,L,C,x;const $=this.videoTrackConfig;($&&(t.width!==$.width||t.height!==$.height||((R=t.pixelRatio)==null?void 0:R[0])!==((L=$.pixelRatio)==null?void 0:L[0])||((C=t.pixelRatio)==null?void 0:C[1])!==((x=$.pixelRatio)==null?void 0:x[1]))||!$&&I||this.nextAudioTs===null&&_)&&this.resetInitSegment()}this.ISGenerated||(f=this.generateIS(e,t,r,o));const w=this.isVideoContiguous;let M=-1,U;if(I&&(M=CT(t.samples),!w&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,M>0){this.warn(`Dropped ${M} out of ${A} video samples due to a missing keyframe`);const $=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(M),t.dropped+=M,y+=(t.samples[0].pts-$)/t.inputTimeScale,U=y}else M===-1&&(this.warn(`No keyframe found out of ${A} video samples`),m=!1);if(this.ISGenerated){if(_&&I){const $=this.getVideoStartPts(t.samples),N=(ke(e.samples[0].pts,$)-$)/t.inputTimeScale;E+=Math.max(0,N),y+=Math.max(0,-N)}if(_){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),f=this.generateIS(e,t,r,o)),c=this.remuxAudio(e,E,this.isAudioContiguous,o,S||I||u===K.AUDIO?y:void 0),I){const $=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),f=this.generateIS(e,t,r,o)),l=this.remuxVideo(t,y,w,$)}}else I&&(l=this.remuxVideo(t,y,w,0));l&&(l.firstKeyFrame=M,l.independent=M!==-1,l.firstKeyFramePTS=U)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(g=ic(i,r,this._initPTS,this._initDTS)),s.samples.length&&(p=nc(s,r,this._initPTS))),{audio:c,video:l,initSegment:f,independent:m,text:p,id3:g}}computeInitPts(e,t,i,s){const r=Math.round(i*t);let o=ke(e,r);if(o<r+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(r-o)/t} ${s}`);o<r+t;)o+=8589934592;return o-r}generateIS(e,t,i,s){const r=e.samples,o=t.samples,a=this.typeSupported,u={},l=this._initPTS;let c=!l||s,f="audio/mp4",p,g,m,E=-1;if(c&&(p=g=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(f="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}u.audio={id:"audio",container:f,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):D.initSegment([e]),metadata:{channelCount:e.channelCount}},c&&(E=e.id,m=e.inputTimeScale,!l||m!==l.timescale?p=g=this.computeInitPts(r[0].pts,m,i,"audio"):c=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,u.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:D.initSegment([t]),metadata:{width:t.width,height:t.height}},c)if(E=t.id,m=t.inputTimeScale,!l||m!==l.timescale){const y=this.getVideoStartPts(o),v=ke(o[0].dts,y),S=this.computeInitPts(v,m,i,"video"),A=this.computeInitPts(y,m,i,"video");g=Math.min(g,S),p=Math.min(p,A)}else c=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(u).length)return this.ISGenerated=!0,c?(l&&this.warn(`Timestamps at playlist time: ${s?"":"~"}${i} ${p/m} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${i} offset: ${p/m} (${p}/${m}) trackId: ${E}`),this._initPTS={baseTime:p,timescale:m,trackId:E},this._initDTS={baseTime:g,timescale:m,trackId:E}):p=m=void 0,{tracks:u,initPTS:p,timescale:m,trackId:E}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,o=e.samples,a=[],u=o.length,l=this._initPTS,c=l.baseTime*r/l.timescale;let f=this.nextVideoTs,p=8,g=this.videoSampleDuration,m,E,y=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,S=!1;if(!i||f===null){const O=c+t*r,B=o[0].pts-ke(o[0].dts,o[0].pts);Nt&&f!==null&&Math.abs(O-B-(f+c))<15e3?i=!0:f=O-B-c}const A=f+c;for(let O=0;O<u;O++){const B=o[O];B.pts=ke(B.pts,A),B.dts=ke(B.dts,A),B.dts<o[O>0?O-1:O].dts&&(S=!0)}S&&o.sort(function(O,B){const Z=O.dts-B.dts,re=O.pts-B.pts;return Z||re}),m=o[0].dts,E=o[o.length-1].dts;const _=E-m,I=_?Math.round(_/(u-1)):g||e.inputTimeScale/30;if(i){const O=m-A,B=O>I,Z=O<-1;if((B||Z)&&(B?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ii(O,!0)} ms (${O}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${ii(-O,!0)} ms (${O}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!Z||A>=o[0].pts||Nt)){m=A;const re=o[0].pts-O;if(B)o[0].dts=m,o[0].pts=re;else{let j=!0;for(let ie=0;ie<o.length&&!(o[ie].dts>re&&j);ie++){const Ie=o[ie].pts;if(o[ie].dts-=O,o[ie].pts-=O,ie<o.length-1){const Te=o[ie+1].pts,Fe=o[ie].pts,Je=Te<=Fe,Tt=Te<=Ie;j=Je==Tt}}}this.log(`Video: Initial PTS/DTS adjusted: ${ii(re,!0)}/${ii(m,!0)}, delta: ${ii(O,!0)} ms`)}}m=Math.max(0,m);let P=0,R=0,L=m;for(let O=0;O<u;O++){const B=o[O],Z=B.units,re=Z.length;let j=0;for(let ie=0;ie<re;ie++)j+=Z[ie].data.length;R+=j,P+=re,B.length=j,B.dts<L?(B.dts=L,L+=I/4|0||1):L=B.dts,y=Math.min(B.pts,y),v=Math.max(B.pts,v)}E=o[u-1].dts;const C=R+4*P+8;let x;try{x=new Uint8Array(C)}catch(O){this.observer.emit(T.ERROR,T.ERROR,{type:W.MUX_ERROR,details:b.REMUX_ALLOC_ERROR,fatal:!1,error:O,bytes:C,reason:`fail allocating video mdat ${C}`});return}const w=new DataView(x.buffer);w.setUint32(0,C),x.set(D.types.mdat,4);let M=!1,U=Number.POSITIVE_INFINITY,$=Number.POSITIVE_INFINITY,H=Number.NEGATIVE_INFINITY,N=Number.NEGATIVE_INFINITY;for(let O=0;O<u;O++){const B=o[O],Z=B.units;let re=0;for(let Ie=0,Te=Z.length;Ie<Te;Ie++){const Fe=Z[Ie],Je=Fe.data,Tt=Fe.data.byteLength;w.setUint32(p,Tt),p+=4,x.set(Je,p),p+=Tt,re+=4+Tt}let j;if(O<u-1)g=o[O+1].dts-B.dts,j=o[O+1].pts-B.pts;else{const Ie=this.config,Te=O>0?B.dts-o[O-1].dts:I;if(j=O>0?B.pts-o[O-1].pts:I,Ie.stretchShortVideoTrack&&this.nextAudioTs!==null){const Fe=Math.floor(Ie.maxBufferHole*r),Je=(s?y+s*r:this.nextAudioTs+c)-B.pts;Je>Fe?(g=Je-Te,g<0?g=Te:M=!0,this.log(`It is approximately ${Je/90} ms to the next segment; using duration ${g/90} ms for the last video frame.`)):g=Te}else g=Te}const ie=Math.round(B.pts-B.dts);U=Math.min(U,g),H=Math.max(H,g),$=Math.min($,j),N=Math.max(N,j),a.push(Ua(B.key,g,re,ie))}if(a.length){if(Nt){if(Nt<70){const O=a[0].flags;O.dependsOn=2,O.isNonSync=0}}else if(Nn&&N-$<H-U&&I/H<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let O=m;for(let B=0,Z=a.length;B<Z;B++){const re=O+a[B].duration,j=O+a[B].cts;if(B<Z-1){const ie=re+a[B+1].cts;a[B].duration=ie-j}else a[B].duration=B?a[B-1].duration:I;a[B].cts=0,O=re}}}g=M||!g?I:g;const q=E+g;this.nextVideoTs=f=q-c,this.videoSampleDuration=g,this.isVideoContiguous=!0;const J={data1:D.moof(e.sequenceNumber++,m,le(e,{samples:a})),data2:x,startPTS:(y-c)/r,endPTS:(v+g-c)/r,startDTS:(m-c)/r,endDTS:f/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,J}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return RT;case"ac3":return xT;default:return _T}}remuxAudio(e,t,i,s,r){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,u=o/a,l=this.getSamplesPerFrame(e),c=l*u,f=this._initPTS,p=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],m=r!==void 0;let E=e.samples,y=p?0:8,v=this.nextAudioTs||-1;const S=f.baseTime*o/f.timescale,A=S+t*o;if(this.isAudioContiguous=i=i||E.length&&v>0&&(s&&Math.abs(A-(v+S))<9e3||Math.abs(ke(E[0].pts,A)-(v+S))<20*c),E.forEach(function(N){N.pts=ke(N.pts,A)}),!i||v<0){const N=E.length;if(E=E.filter(q=>q.pts>=0),N!==E.length&&this.warn(`Removed ${E.length-N} of ${N} samples (initPTS ${S} / ${o})`),!E.length)return;r===0?v=0:s&&!m?v=Math.max(0,A-S):v=E[0].pts-S}if(e.segmentCodec==="aac"){const N=this.config.maxAudioFramesDrift;for(let q=0,F=v+S;q<E.length;q++){const Y=E[q],J=Y.pts,O=J-F,B=Math.abs(1e3*O/o);if(O<=-N*c&&m)q===0&&(this.warn(`Audio frame @ ${(J/o).toFixed(3)}s overlaps marker by ${Math.round(1e3*O/o)} ms.`),this.nextAudioTs=v=J-S,F=J);else if(O>=N*c&&B<IT&&m){let Z=Math.round(O/c);for(F=J-Z*c;F<0&&Z&&c;)Z--,F+=c;q===0&&(this.nextAudioTs=v=F-S),this.warn(`Injecting ${Z} audio frames @ ${((F-S)/o).toFixed(3)}s due to ${Math.round(1e3*O/o)} ms gap.`);for(let re=0;re<Z;re++){let j=vT.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);j||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),j=Y.unit.subarray()),E.splice(q,0,{unit:j,pts:F}),F+=c,q++}}Y.pts=F,F+=c}}let _=null,I=null,P,R=0,L=E.length;for(;L--;)R+=E[L].unit.byteLength;for(let N=0,q=E.length;N<q;N++){const F=E[N],Y=F.unit;let J=F.pts;if(I!==null){const B=g[N-1];B.duration=Math.round((J-I)/u)}else if(i&&e.segmentCodec==="aac"&&(J=v+S),_=J,R>0){R+=y;try{P=new Uint8Array(R)}catch(B){this.observer.emit(T.ERROR,T.ERROR,{type:W.MUX_ERROR,details:b.REMUX_ALLOC_ERROR,fatal:!1,error:B,bytes:R,reason:`fail allocating audio mdat ${R}`});return}p||(new DataView(P.buffer).setUint32(0,R),P.set(D.types.mdat,4))}else return;P.set(Y,y);const O=Y.byteLength;y+=O,g.push(Ua(!0,l,O,0)),I=J}const C=g.length;if(!C)return;const x=g[g.length-1];v=I-S,this.nextAudioTs=v+u*x.duration;const w=p?new Uint8Array(0):D.moof(e.sequenceNumber++,_/u,le({},e,{samples:g}));e.samples=[];const M=(_-S)/o,U=this.nextAudioTs/o,H={data1:w,data2:P,startPTS:M,endPTS:U,startDTS:M,endDTS:U,type:"audio",hasAudio:!0,hasVideo:!1,nb:C};return this.isAudioContiguous=!0,H}}function ke(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function CT(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function ic(n,e,t,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let a=0;a<s;a++){const u=n.samples[a];u.pts=ke(u.pts-t.baseTime*r/t.timescale,e*r)/r,u.dts=ke(u.dts-i.baseTime*r/i.timescale,e*r)/r}const o=n.samples;return n.samples=[],{samples:o}}function nc(n,e,t){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let o=0;o<i;o++){const a=n.samples[o];a.pts=ke(a.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((o,a)=>o.pts-a.pts);const r=n.samples;return n.samples=[],{samples:r}}class LT extends Ge{constructor(e,t,i,s){super("passthrough-remuxer",s),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(e,s),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:i,videoCodec:s}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:r,video:o}=this.initData=uu(e);if(t)gy(e,t);else{const u=r||o;u!=null&&u.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${u.codec}")!`)}r&&(i=Oa(r,ue.AUDIO,this)),o&&(s=Oa(o,ue.VIDEO,this));const a={};r&&o?a.audiovideo={container:"video/mp4",codec:i+","+s,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:r?a.audio={container:"audio/mp4",codec:i,encrypted:r.encrypted,initSegment:e,id:"audio"}:o?a.video={container:"video/mp4",codec:s,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,i,s,r,o){var a,u;let{initPTS:l,lastEndTime:c}=this;const f={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};V(c)||(c=this.lastEndTime=r||0);const p=t.samples;if(!p.length)return f;const g={initPTS:void 0,timescale:void 0,trackId:void 0};let m=this.initData;if((a=m)!=null&&a.length||(this.generateInitSegment(p),m=this.initData),!((u=m)!=null&&u.length))return this.warn("Failed to generate initSegment."),f;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);const E=yy(p,m,this),y=m.audio?E[m.audio.id]:null,v=m.video?E[m.video.id]:null,S=Li(v,1/0),A=Li(y,1/0),_=Li(v,0,!0),I=Li(y,0,!0);let P=r,R=0;const L=y&&(!v||!l&&A<S||l&&l.trackId===m.audio.id),C=L?y:v;if(C){const F=C.timescale,Y=C.start-r*F,J=L?m.audio.id:m.video.id;P=C.start/F,R=L?I-A:_-S,(o||!l)&&(PT(l,P,r,R)||F!==l.timescale)&&(l&&this.warn(`Timestamps at playlist time: ${o?"":"~"}${r} ${Y/F} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${r} offset: ${P-r} (${Y}/${F}) trackId: ${J}`),l=null,g.initPTS=Y,g.timescale=F,g.trackId=J)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${r}`);l?(g.initPTS=l.baseTime,g.timescale=l.timescale,g.trackId=l.trackId):((!g.timescale||g.trackId===void 0||g.initPTS===void 0)&&(this.warn("Could not set initPTS"),g.initPTS=P,g.timescale=1,g.trackId=-1),this.initPTS=l={baseTime:g.initPTS,timescale:g.timescale,trackId:g.trackId});const x=P-l.baseTime/l.timescale,w=x+R;R>0?this.lastEndTime=w:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const M=!!m.audio,U=!!m.video;let $="";M&&($+="audio"),U&&($+="video");const H=(m.audio?m.audio.encrypted:!1)||(m.video?m.video.encrypted:!1),N={data1:p,startPTS:x,startDTS:x,endPTS:w,endDTS:w,type:$,hasAudio:M,hasVideo:U,nb:1,dropped:0,encrypted:H};f.audio=M&&!U?N:void 0,f.video=U?N:void 0;const q=v==null?void 0:v.sampleCount;if(q){const F=v.keyFrameIndex,Y=F!==-1;N.nb=q,N.dropped=F===0||this.isVideoContiguous?0:Y?F:q,N.independent=Y,N.firstKeyFrame=F,Y&&v.keyFrameStart&&(N.firstKeyFramePTS=(v.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(f.independent=Y),this.isVideoContiguous||(this.isVideoContiguous=Y),N.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${F}/${q} dropped: ${N.dropped} start: ${N.firstKeyFramePTS||"NA"}`)}return f.initSegment=g,f.id3=ic(i,r,l,l),s.samples.length&&(f.text=nc(s,r,l)),f}}function Li(n,e,t=!1){return(n==null?void 0:n.start)!==void 0?(n.start+(t?n.duration:0))/n.timescale:e}function PT(n,e,t,i){if(n===null)return!0;const s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function Oa(n,e,t){const i=n.codec;return i&&i.length>4?i:e===ue.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?en(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let ot;try{ot=self.performance.now.bind(self.performance)}catch{ot=Date.now}const Hi=[{demux:pT,remux:LT},{demux:ht,remux:Vi},{demux:cT,remux:Vi},{demux:fT,remux:Vi}];Hi.splice(2,0,{demux:dT,remux:Vi});class Ba{constructor(e,t,i,s,r,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=r,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=ot();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:u}=this;s&&(this.currentTransmuxState=s);const{contiguous:l,discontinuity:c,trackSwitch:f,accurateTimeOffset:p,timeOffset:g,initSegmentChange:m}=s||a,{audioCodec:E,videoCodec:y,defaultInitPts:v,duration:S,initSegmentData:A}=u,_=DT(o,t);if(_&&Kt(_.method)){const L=this.getDecrypter(),C=Ws(_.method);if(L.isSync()){let x=L.softwareDecrypt(o,_.key.buffer,_.iv.buffer,C);if(i.part>-1){const M=L.flush();x=M&&M.buffer}if(!x)return r.executeEnd=ot(),Fn(i);o=new Uint8Array(x)}else return this.asyncResult=!0,this.decryptionPromise=L.webCryptoDecrypt(o,_.key.buffer,_.iv.buffer,C).then(x=>{const w=this.push(x,null,i);return this.decryptionPromise=null,w}),this.decryptionPromise}const I=this.needsProbing(c,f);if(I){const L=this.configureTransmuxer(o);if(L)return this.logger.warn(`[transmuxer] ${L.message}`),this.observer.emit(T.ERROR,T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,fatal:!1,error:L,reason:L.message}),r.executeEnd=ot(),Fn(i)}(c||f||m||I)&&this.resetInitSegment(A,E,y,S,t),(c||m||I)&&this.resetInitialTimestamp(v),l||this.resetContiguity();const P=this.transmux(o,_,g,p,i);this.asyncResult=pi(P);const R=this.currentTransmuxState;return R.contiguous=!0,R.discontinuity=!1,R.trackSwitch=!1,r.executeEnd=ot(),P}flush(e){const t=e.transmuxing;t.executeStart=ot();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return this.asyncResult=!0,r.then(()=>this.flush(e));const o=[],{timeOffset:a}=s;if(i){const f=i.flush();f&&o.push(this.push(f.buffer,null,e))}const{demuxer:u,remuxer:l}=this;if(!u||!l){t.executeEnd=ot();const f=[Fn(e)];return this.asyncResult?Promise.resolve(f):f}const c=u.flush(a);return pi(c)?(this.asyncResult=!0,c.then(f=>(this.flushRemux(o,f,e),o))):(this.flushRemux(o,c,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:o,textTrack:a}=t,{accurateTimeOffset:u,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===K.MAIN?"level":"track"} ${i.level}`);const c=this.remuxer.remux(s,r,o,a,l,u,!0,this.id);e.push({remuxResult:c,chunkMeta:i}),i.transmuxing.executeEnd=ot()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,s),a.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,s,r):o=this.transmuxUnencrypted(e,i,s,r),o}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:o,id3Track:a,textTrack:u}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,o,a,u,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s}=this;let r;for(let f=0,p=Hi.length;f<p;f++){var o;if((o=Hi[f].demux)!=null&&o.probe(e,this.logger)){r=Hi[f];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,u=this.remuxer,l=r.remux,c=r.demux;(!u||!(u instanceof l))&&(this.remuxer=new l(i,t,s,this.logger)),(!a||!(a instanceof c))&&(this.demuxer=new c(i,t,s,this.logger),this.probe=c.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new qs(this.config)),e}}function DT(n,e){let t=null;return n.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Fn=n=>({remuxResult:{},chunkMeta:n});function pi(n){return"then"in n&&n.then instanceof Function}class bT{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class wT{constructor(e,t,i,s,r,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=o}}let $a=0;class sc{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=$a++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=u=>{const l=u.data,c=this.hls;if(!(!c||!(l!=null&&l.event)||l.instanceNo!==this.instanceNo))switch(l.event){case"init":{var f;const p=(f=this.workerContext)==null?void 0:f.objectURL;p&&self.URL.revokeObjectURL(p);break}case"transmuxComplete":{this.handleTransmuxComplete(l.data);break}case"flush":{this.onFlush(l.data);break}case"workerLog":{c.logger[l.data.logType]&&c.logger[l.data.logType](l.data.message);break}default:{l.data=l.data||{},l.data.frag=this.frag,l.data.part=this.part,l.data.id=this.id,c.trigger(l.event,l.data);break}}},this.onWorkerError=u=>{if(!this.hls)return;const l=new Error(`${u.message}  (${u.filename}:${u.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:l})};const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const o=(u,l)=>{l=l||{},l.frag=this.frag||void 0,u===T.ERROR&&(l=l,l.parent=this.id,l.part=this.part,this.error=l.error),this.hls.trigger(u,l)};this.observer=new Xs,this.observer.on(T.FRAG_DECRYPTED,o),this.observer.on(T.ERROR,o);const a=ta(r.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const u=this.hls.logger;if(r.workerPath||FE()){try{r.workerPath?(u.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=OE(r.workerPath)):(u.log(`injecting Web Worker for "${t}"`),this.workerContext=UE());const{worker:c}=this.workerContext;c.addEventListener("message",this.onWorkerMessage),c.addEventListener("error",this.onWorkerError),c.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:ce(r)})}catch(c){u.warn(`Error setting up "${t}" Web Worker, fallback to inline`,c),this.terminateWorker(),this.error=null,this.transmuxer=new Ba(this.observer,a,r,"",t,e.logger)}return}}this.transmuxer=new Ba(this.observer,a,r,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=$a++;const t=this.hls.config,i=ta(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:ce(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),BE(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,s,r,o,a,u,l,c){var f,p;l.transmuxing.start=self.performance.now();const{instanceNo:g,transmuxer:m}=this,E=o?o.start:r.start,y=r.decryptdata,v=this.frag,S=!(v&&r.cc===v.cc),A=!(v&&l.level===v.level),_=v?l.sn-v.sn:-1,I=this.part?l.part-this.part.index:-1,P=_===0&&l.id>1&&l.id===(v==null?void 0:v.stats.chunkCount),R=!A&&(_===1||_===0&&(I===1||P&&I<=0)),L=self.performance.now();(A||_||r.stats.parsing.start===0)&&(r.stats.parsing.start=L),o&&(I||!R)&&(o.stats.parsing.start=L);const C=!(v&&((f=r.initSegment)==null?void 0:f.url)===((p=v.initSegment)==null?void 0:p.url)),x=new wT(S,R,u,A,E,C);if(!R||S||C){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${r.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===K.MAIN?"level":"track"}: ${l.level} id: ${l.id}
        discontinuity: ${S}
        trackSwitch: ${A}
        contiguous: ${R}
        accurateTimeOffset: ${u}
        timeOffset: ${E}
        initSegmentChange: ${C}`);const w=new bT(i,s,t,a,c);this.configureTransmuxer(w)}if(this.frag=r,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:g,cmd:"demux",data:e,decryptdata:y,chunkMeta:l,state:x},e instanceof ArrayBuffer?[e]:[]);else if(m){const w=m.push(e,y,l,x);pi(w)?w.then(M=>{this.handleTransmuxComplete(M)}).catch(M=>{this.transmuxerError(M,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(w)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const s=i.flush(e);pi(s)?s.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")}):this.handleFlushResult(s,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const Ga=100;class kT extends zs{constructor(e,t,i){super(e,t,i,"audio-stream-controller",K.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(T.LEVEL_LOADED,this.onLevelLoaded,this),e.on(T.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(T.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(T.BUFFER_RESET,this.onBufferReset,this),e.on(T.BUFFER_CREATED,this.onBufferCreated,this),e.on(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(T.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(T.FRAG_LOADING,this.onFragLoading,this),e.on(T.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(T.LEVEL_LOADED,this.onLevelLoaded,this),e.off(T.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(T.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(T.BUFFER_RESET,this.onBufferReset,this),e.off(T.BUFFER_CREATED,this.onBufferCreated,this),e.off(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(T.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(T.FRAG_LOADING,this.onFragLoading,this),e.off(T.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r,trackId:o}){if(i===K.MAIN){const a=t.cc,u=this.fragCurrent;if(this.initPTS[a]={baseTime:s,timescale:r,trackId:o},this.log(`InitPTS for cc: ${a} found from main: ${s/r} (${s}/${r}) trackId: ${o}`),this.mainAnchor=t,this.state===k.WAITING_INIT_PTS){const l=this.waitingData;(!l&&!this.loadingParts||l&&l.frag.cc!==a)&&this.syncWithAnchor(t,l==null?void 0:l.frag)}else!this.hls.hasEnoughToStart&&u&&u.cc!==a?(u.abortRequests(),this.syncWithAnchor(t,u)):this.state===k.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const s=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&(s==null?void 0:s.cc)===t.cc)return;const r=(s||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),u=vu(o,r,a);u&&(this.log(`Syncing with main frag at ${u.start} cc ${u.cc}`),this.startFragRequested=!1,this.nextLoadPosition=u.start,this.resetLoadingState(),this.state===k.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=k.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(Ga),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=k.IDLE):this.state=k.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case k.IDLE:this.doTickIdle();break;case k.WAITING_TRACK:{const{levels:e,trackId:t}=this,i=e==null?void 0:e[t],s=i==null?void 0:i.details;if(s&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(s))break;this.state=k.WAITING_INIT_PTS}break}case k.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case k.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:s,complete:r}=e,o=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=k.FRAG_LOADING;const a=s.flush().buffer,u={frag:t,part:i,payload:a,networkDetails:null};this._handleFragmentLoadProgress(u),r&&super._handleFragmentLoadComplete(u)}else o&&o.cc!==e.frag.cc&&this.syncWithAnchor(o,e.frag)}else this.state=k.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:s,trackId:r}=this,o=t.config;if(!this.buffering||!s&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[r]))return;const a=i[r],u=a.details;if(!u||this.waitForLive(a)||this.waitForCdnTuneIn(u)){this.state=k.WAITING_TRACK,this.startFragRequested=!1;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,ue.AUDIO,K.AUDIO));const c=this.getFwdBufferInfo(l,K.AUDIO);if(c===null)return;if(!this.switchingTrack&&this._streamEnded(c,u)){t.trigger(T.BUFFER_EOS,{type:"audio"}),this.state=k.ENDED;return}const f=c.len,p=t.maxBufferLength,g=u.fragments,m=g[0].start,E=this.getLoadPosition(),y=this.flushing?E:c.end;if(this.switchingTrack&&s){const A=E;u.PTSKnown&&A<m&&(c.end>m||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),s.currentTime=m+.05)}if(f>=p&&!this.switchingTrack&&y<g[g.length-1].start)return;let v=this.getNextFragment(y,u);if(v&&this.isLoopLoading(v,y)&&(v=this.getNextFragmentLoopLoading(v,u,c,K.MAIN,p)),!v){this.bufferFlushed=!0;return}let S=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&S&&pe(v)&&!v.endList&&(!u.live||!this.loadingParts&&y<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(S)===me.OK&&(this.mainFragLoading=S=null),S&&pe(S))){if(v.start>S.end){const _=this.fragmentTracker.getFragAtPos(y,K.MAIN);_&&_.end>S.end&&(S=_,this.mainFragLoading={frag:_,targetBufferTime:null})}if(v.start>S.end)return}this.loadFragment(v,a,y)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new di(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==k.STOPPED&&(this.setInterval(Ga),this.state=k.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(T.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:s}=this,{details:r,id:o,groupId:a,track:u}=t;if(!s){this.warn(`Audio tracks reset while loading track ${o} "${u.name}" of "${a}"`);return}const l=this.mainDetails;if(!l||r.endCC>l.endCC||l.expired){this.cachedTrackLoadedData=t,this.state!==k.STOPPED&&(this.state=k.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${u.name}" of "${a}" loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const c=s[o];let f=0;if(r.live||(i=c.details)!=null&&i.live){if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;if(c.details){var p;f=this.alignPlaylists(r,c.details,(p=this.levelLastLoaded)==null?void 0:p.details)}r.alignedSliding||(Ou(r,l),r.alignedSliding||ln(r,l),f=r.fragmentStart)}c.details=r,this.levelLastLoaded=c,this.startFragRequested||this.setStartPosition(l,f),this.hls.trigger(T.AUDIO_TRACK_UPDATED,{details:r,id:o,groupId:t.groupId}),this.state===k.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=k.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:s,payload:r}=e,{config:o,trackId:a,levels:u}=this;if(!u){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const l=u[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}const c=l.details;if(!c){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const f=o.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let p=this.transmuxer;p||(p=this.transmuxer=new sc(this.hls,K.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const g=this.initPTS[i.cc],m=(t=i.initSegment)==null?void 0:t.data;if(g!==void 0){const y=s?s.index:-1,v=y!==-1,S=new Ys(i.level,i.sn,i.stats.chunkCount,r.byteLength,y,v);p.push(r,m,f,"",i,s,c.totalduration,!1,S,g)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);const{cache:E}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new Bu,complete:!1};E.push(new Uint8Array(r)),this.state!==k.STOPPED&&(this.state=k.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===K.MAIN&&pe(t.frag)&&(this.mainFragLoading=t,this.state===k.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==K.AUDIO){!this.audioOnly&&i.type===K.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(pe(i)){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(T.AUDIO_TRACK_SWITCHED,oe({},r)))}this.fragBufferedComplete(i,s),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=k.ERROR;return}switch(t.details){case b.FRAG_GAP:case b.FRAG_PARSING_ERROR:case b.FRAG_DECRYPT_ERROR:case b.FRAG_LOAD_ERROR:case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_ERROR:case b.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(K.AUDIO,t);break;case b.AUDIO_TRACK_LOAD_ERROR:case b.AUDIO_TRACK_LOAD_TIMEOUT:case b.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===k.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===te.AUDIO_TRACK&&(this.state=k.IDLE);break;case b.BUFFER_ADD_CODEC_ERROR:case b.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case b.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case b.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==ue.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==ue.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===k.ENDED&&(this.state=k.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,K.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:u,part:l,level:c}=a,{details:f}=c,{audio:p,text:g,id3:m,initSegment:E}=r;if(this.fragContextChanged(u)||!f){this.fragmentTracker.removeFragment(u);return}if(this.state=k.PARSING,this.switchingTrack&&p&&this.completeAudioSwitch(this.switchingTrack),E!=null&&E.tracks){const y=u.initSegment||u;if(this.unhandledEncryptionError(E,u))return;this._bufferInitSegment(c,E.tracks,y,o),s.trigger(T.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:i,tracks:E.tracks})}if(p){const{startPTS:y,endPTS:v,startDTS:S,endDTS:A}=p;l&&(l.elementaryStreams[ue.AUDIO]={startPTS:y,endPTS:v,startDTS:S,endDTS:A}),u.setElementaryStreamInfo(ue.AUDIO,y,v,S,A),this.bufferFragmentData(p,u,l,o)}if(m!=null&&(t=m.samples)!=null&&t.length){const y=le({id:i,frag:u,details:f},m);s.trigger(T.FRAG_PARSING_METADATA,y)}if(g){const y=le({id:i,frag:u,details:f},g);s.trigger(T.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(e,t,i,s){if(this.state!==k.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const r=t.audio;r.id=K.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${o}/${r.codec}]`),o&&o.split(",").length===1&&(r.levelCodec=o),this.hls.trigger(T.BUFFER_CODECS,t);const a=r.initSegment;if(a!=null&&a.byteLength){const u={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:a};this.hls.trigger(T.BUFFER_APPENDING,u)}this.tickImmediate()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.switchingTrack||s===me.NOT_LOADED||s===me.PARTIAL){var r;if(!pe(e))this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=k.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&ln(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a}=this.bufferedTrack;Ct({name:t,lang:i,assocLang:s,characteristics:r,audioCodec:o,channels:a},e,Rt)||(nn(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(T.AUDIO_TRACK_SWITCHED,oe({},e))}}class nr extends Ge{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const s=t==null?void 0:t.renditionReports;if(s){let r=-1;for(let o=0;o<s.length;o++){const a=s[o];let u;try{u=new self.URL(a.URI,t.url).href}catch(l){this.warn(`Could not construct new URL for Rendition Report: ${l}`),u=a.URI||""}if(u===e){r=o;break}else u===e.substring(0,u.length)&&(r=o)}if(r!==-1){const o=s[r],a=parseInt(o["LAST-MSN"])||t.lastPartSn;let u=parseInt(o["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const c=Math.min(t.age-t.partTarget,t.targetduration);u>=0&&c>t.partTarget&&(u+=1)}const l=i&&ia(i);return new na(a,u>=0?u:void 0,l)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:s,stats:r}=t,o=self.performance.now(),a=r.loading.first?Math.max(0,o-r.loading.first):0;s.advancedDateTime=Date.now()-a;const u=this.hls.config.timelineOffset;if(u!==s.appliedTimelineOffset){const c=Math.max(u||0,0);s.appliedTimelineOffset=c,s.fragments.forEach(f=>{f.setStart(f.playlistOffset+c)})}if(s.live||i!=null&&i.live){const c="levelInfo"in t?t.levelInfo:t.track;if(s.reloaded(i),i&&s.fragments.length>0){RE(i,s,this);const S=s.playlistParsingError;if(S){this.warn(S);const A=this.hls;if(!A.config.ignorePlaylistParsingErrors){var l;const{networkDetails:_}=t;A.trigger(T.ERROR,{type:W.NETWORK_ERROR,details:b.LEVEL_PARSING_ERROR,fatal:!1,url:s.url,error:S,reason:S.message,level:t.level||void 0,parent:(l=s.fragments[0])==null?void 0:l.type,networkDetails:_,stats:r});return}s.playlistParsingError=null}}s.requestScheduled===-1&&(s.requestScheduled=r.loading.start);const f=this.hls.mainForwardBufferInfo,p=f?f.end-f.len:0,g=(s.edge-p)*1e3,m=ku(s,g);if(s.requestScheduled+m<o?s.requestScheduled=o:s.requestScheduled+=m,this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),!this.canLoad||!s.live)return;let E,y,v;if(s.canBlockReload&&s.endSN&&s.advanced){const S=this.hls.config.lowLatencyMode,A=s.lastPartSn,_=s.endSN,I=s.lastPartIndex,P=I!==-1,R=A===_;P?R?(y=_+1,v=S?0:I):(y=A,v=S?I+1:s.maxPartIndex):y=_+1;const L=s.age,C=L+s.ageHeader;let x=Math.min(C-s.partTarget,s.targetduration*1.5);if(x>0){if(C>s.targetduration*3)this.log(`Playlist last advanced ${L.toFixed(2)}s ago. Omitting segment and part directives.`),y=void 0,v=void 0;else if(i!=null&&i.tuneInGoal&&C-s.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${x} with playlist age: ${s.age}`),x=0;else{const w=Math.floor(x/s.targetduration);if(y+=w,v!==void 0){const M=Math.round(x%s.targetduration/s.partTarget);v+=M}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${L.toFixed(2)}s goal: ${x} skip sn ${w} to part ${v}`)}s.tuneInGoal=x}if(E=this.getDeliveryDirectives(s,t.deliveryDirectives,y,v),S||!R){s.requestScheduled=o,this.loadingPlaylist(c,E);return}}else(s.canBlockReload||s.canSkipUntil)&&(E=this.getDeliveryDirectives(s,t.deliveryDirectives,y,v));E&&y!==void 0&&s.canBlockReload&&(s.requestScheduled=r.loading.first+Math.max(m-a*2,m/2)),this.scheduleLoading(c,E,s)}else this.clearTimer()}scheduleLoading(e,t,i){const s=i||e.details;if(!s){this.loadingPlaylist(e,t);return}const r=self.performance.now(),o=s.requestScheduled;if(r>=o){this.loadingPlaylist(e,t);return}const a=o-r;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,s){let r=ia(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=$i.No),new na(i,s,r)}checkRetry(e){const t=e.details,i=sn(e),s=e.errorAction,{action:r,retryCount:o=0,retryConfig:a}=s||{},u=!!s&&!!a&&(r===ve.RetryRequest||!s.resolved&&r===ve.SendAlternateToPenaltyBox);if(u){var l;if(o>=a.maxNumRetry)return!1;if(i&&(l=e.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const c=Ks(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),c),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${c}ms`)}e.levelRetry=!0,s.resolved=!0}return u}}function rc(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!gi(n[t].attrs,e[t].attrs))return!1;return!0}function gi(n,e,t){const i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function Ss(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}class MT extends nr{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.LEVEL_LOADING,this.onLevelLoading,this),e.on(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(T.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.LEVEL_LOADING,this.onLevelLoading,this),e.off(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(T.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(T.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(p=>!i||i.indexOf(p.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(p=>p.default)&&(this.selectDefaultTrack=!1),a.forEach((p,g)=>{p.id=g});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const u=this.hls.config.audioPreference;if(!r&&u){const p=je(u,a,Rt);if(p>-1)r=a[p];else{const g=je(u,this.tracks);r=this.tracks[g]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const c={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(T.AUDIO_TRACKS_UPDATED,c);const f=this.trackId;if(l!==-1&&f===-1)this.setAudioTrack(l);else if(a.length&&f===-1){var o;const p=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(p.message),this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:p})}}}onError(e,t){t.fatal||!t.context||t.context.type===te.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&Ct(e,s,Rt))return s;const r=je(e,this.tracksInGroup,Rt);if(r>-1){const o=this.tracksInGroup[r];return this.setAudioTrack(r),o}else if(s){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=Yy(e,t.levels,i,o,Rt);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=je(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(T.AUDIO_TRACK_SWITCHING,oe({},s)),r))return;const o=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||Ct(e,s,Rt)))return i}if(e){const{name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:u}=e;for(let l=0;l<t.length;l++){const c=t[l];if(Ct({name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:u},c,Rt))return l}for(let l=0;l<t.length;l++){const c=t[l];if(gi(e.attrs,c.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const c=t[l];if(gi(e.attrs,c.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&nn(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(T.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}}class NT{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const s=t[0];try{s.execute()}catch(r){var i;if(s.onError(r),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],s=i==null?void 0:i.buffer;return s?`SourceBuffer${s.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const Va=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,oc="HlsJsTrackRemovedError";class FT extends Error{constructor(e){super(e),this.name=oc}}class UT extends Ge{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var s;this.hls&&((s=this.mediaSource)==null?void 0:s.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:s,mediaSource:r}=this;i&&this.log("Media source opened"),!(!s||!r)&&(r.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(T.MEDIA_ATTACHED,{media:s,mediaSource:r}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&this.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=ry(mt(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.BUFFER_RESET,this.onBufferReset,this),e.on(T.BUFFER_APPENDING,this.onBufferAppending,this),e.on(T.BUFFER_CODECS,this.onBufferCodecs,this),e.on(T.BUFFER_EOS,this.onBufferEos,this),e.on(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(T.FRAG_PARSED,this.onFragParsed,this),e.on(T.FRAG_CHANGED,this.onFragChanged,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.BUFFER_RESET,this.onBufferReset,this),e.off(T.BUFFER_APPENDING,this.onBufferAppending,this),e.off(T.BUFFER_CODECS,this.onBufferCodecs,this),e.off(T.BUFFER_EOS,this.onBufferEos,this),e.off(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(T.FRAG_PARSED,this.onFragParsed,this),e.off(T.FRAG_CHANGED,this.onFragChanged,this),e.off(T.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const r=this.isUpdating();r||this.operationQueue.removeBlockers();const o=this.isQueued();(r||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${r?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const s=this.transferData;return!this.sourceBufferCount&&s&&s.mediaSource===t?le(i,s.tracks):this.sourceBuffers.forEach(r=>{const[o]=r;o&&(i[o]=le({},this.tracks[o]),this.removeBuffer(o)),r[0]=r[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let s=2;(t.audio&&!t.video||!t.altAudio)&&(s=1),this.bufferCodecEventsTotal=s,this.log(`${s} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&s&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media;this.transferData=this.overrides=void 0;const s=mt(this.appendSource);if(s){const r=!!t.mediaSource;(r||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new s;if(this.assignMediaSource(o),r)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const u=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||u&&o instanceof u,Ha(i),OT(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,s=t.tracks,r=s?Object.keys(s):null,o=r?r.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(s&&r&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${ce(i,(u,l)=>u==="initSegment"?void 0:l)};
transfer tracks: ${ce(s,(u,l)=>u==="initSegment"?void 0:l)}}`),!iu(s,i)){t.mediaSource=null,t.tracks=void 0;const u=e.currentTime,l=this.details,c=Math.max(u,(l==null?void 0:l.fragments[0].start)||0);if(c-u>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${u} -> ${c}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(s)}"->"${Object.keys(i)}") start time: ${c} currentTime: ${u}`),this.onMediaDetaching(T.MEDIA_DETACHING,{}),this.onMediaAttaching(T.MEDIA_ATTACHING,t),e.currentTime=c;return}this.transferData=void 0,r.forEach(u=>{const l=u,c=s[l];if(c){const f=c.buffer;if(f){const p=this.fragmentTracker,g=c.id;if(p.hasFragments(g)||p.hasParts(g)){const y=Q.getBuffered(f);p.detectEvictedFragments(l,y,g,null,!0)}const m=Un(l),E=[l,f];this.sourceBuffers[m]=E,f.updating&&this.operationQueue&&this.operationQueue.prependBlocker(l),this.trackSourceBuffer(l,c)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:s,mediaSource:r,_objectUrl:o}=this;if(r){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=r.readyState==="open";try{const u=r.sourceBuffers;for(let l=u.length;l--;)a&&u[l].abort(),r.removeSourceBuffer(u[l]);a&&r.endOfStream()}catch(u){this.warn(`onMediaDetaching: ${u.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(r.removeEventListener("startstreaming",this._onStartStreaming),r.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}s&&(s.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(s.removeAttribute("src"),this.appendSource&&Ha(s),s.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(T.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var s;(s=this.mediaSource)!=null&&s.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(r){this.warn(`onBufferReset ${e}`,r)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Un(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new NT(this.tracks)}onBufferCodecs(e,t){var i;const s=this.tracks,r=Object.keys(t);this.log(`BUFFER_CODECS: "${r}" (current SB count ${this.sourceBufferCount})`);const o="audiovideo"in t&&(s.audio||s.video)||s.audiovideo&&("audio"in t||"video"in t),a=!o&&this.sourceBufferCount&&this.media&&r.some(u=>!s[u]);if(o||a){this.warn(`Unsupported transition between "${Object.keys(s)}" and "${r}" SourceBuffers`);return}r.forEach(u=>{var l,c;const f=t[u],{id:p,codec:g,levelCodec:m,container:E,metadata:y,supplemental:v}=f;let S=s[u];const A=(l=this.transferData)==null||(l=l.tracks)==null?void 0:l[u],_=A!=null&&A.buffer?A:S,I=(_==null?void 0:_.pendingCodec)||(_==null?void 0:_.codec),P=_==null?void 0:_.levelCodec;S||(S=s[u]={buffer:void 0,listeners:[],codec:g,supplemental:v,container:E,levelCodec:m,metadata:y,id:p});const R=Bi(I,P),L=R==null?void 0:R.replace(Va,"$1");let C=Bi(g,m);const x=(c=C)==null?void 0:c.replace(Va,"$1");C&&R&&L!==x&&(u.slice(0,5)==="audio"&&(C=en(C,this.appendSource)),this.log(`switching codec ${I} to ${C}`),C!==(S.pendingCodec||S.codec)&&(S.pendingCodec=C),S.container=E,this.appendChangeType(u,E,C))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&((i=t.audio)==null?void 0:i.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const s=`${t};codecs=${i}`,r={label:`change-type=${s}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${s}`),a.changeType(s),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(r,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,s=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,K.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const u=this.tracks.video;(this.lastVideoAppendEnd>s||u!=null&&u.buffer&&Q.isBuffered(u.buffer,s)||((a=this.fragmentTracker.getAppendedFrag(s,K.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:s,type:r,parent:o,frag:a,part:u,chunkMeta:l,offset:c}=t,f=l.buffering[r],{sn:p,cc:g}=a,m=self.performance.now();f.start=m;const E=a.stats.buffering,y=u?u.stats.buffering:null;E.start===0&&(E.start=m),y&&y.start===0&&(y.start=m);const v=i.audio;let S=!1;r==="audio"&&(v==null?void 0:v.container)==="audio/mpeg"&&(S=!this.lastMpegAudioChunk||l.id===1||this.lastMpegAudioChunk.sn!==l.sn,this.lastMpegAudioChunk=l);const A=i.video,_=A==null?void 0:A.buffer;if(_&&p!=="initSegment"){const R=u||a,L=this.blockedAudioAppend;if(r==="audio"&&o!=="main"&&!this.blockedAudioAppend&&!(A.ending||A.ended)){const x=R.start+R.duration*.05,w=_.buffered,M=this.currentOp("video");!w.length&&!M?this.blockAudio(R):!M&&!Q.isBuffered(_,x)&&this.lastVideoAppendEnd<x&&this.blockAudio(R)}else if(r==="video"){const C=R.end;if(L){const x=L.frag.start;(C>x||C<this.lastVideoAppendEnd||Q.isBuffered(_,x))&&this.unblockAudio()}this.lastVideoAppendEnd=C}}const I=(u||a).start,P={label:`append-${r}`,execute:()=>{var R;f.executeStart=self.performance.now();const L=(R=this.tracks[r])==null?void 0:R.buffer;L&&(S?this.updateTimestampOffset(L,I,.1,r,p,g):c!==void 0&&V(c)&&this.updateTimestampOffset(L,c,1e-6,r,p,g)),this.appendExecutor(s,r)},onStart:()=>{},onComplete:()=>{const R=self.performance.now();f.executeEnd=f.end=R,E.first===0&&(E.first=R),y&&y.first===0&&(y.first=R);const L={};this.sourceBuffers.forEach(([C,x])=>{C&&(L[C]=Q.getBuffered(x))}),this.appendErrors[r]=0,r==="audio"||r==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(T.BUFFER_APPENDED,{type:r,frag:a,part:u,chunkMeta:l,parent:a.type,timeRanges:L})},onError:R=>{var L;const C={type:W.MEDIA_ERROR,parent:a.type,details:b.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:a,part:u,chunkMeta:l,error:R,err:R,fatal:!1},x=(L=this.media)==null?void 0:L.error;if(R.code===DOMException.QUOTA_EXCEEDED_ERR||R.name=="QuotaExceededError"||"quota"in R)C.details=b.BUFFER_FULL_ERROR;else if(R.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!x)C.errorAction=Ht(!0);else if(R.name===oc&&this.sourceBufferCount===0)C.errorAction=Ht(!0);else{const w=++this.appendErrors[r];this.warn(`Failed ${w}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${x||"no media error"})`),(w>=this.hls.config.appendErrorMaxRetry||x)&&(C.fatal=!0)}this.hls.trigger(T.ERROR,C)}};this.log(`queuing "${r}" append sn: ${p}${u?" p: "+u.index:""} of ${a.type===K.MAIN?"level":"track"} ${a.level} cc: ${g}`),this.append(P,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(T.BUFFER_FLUSHED,{type:e})},onError:s=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,s)}}}onBufferFlushing(e,t){const{type:i,startOffset:s,endOffset:r}=t;i?this.append(this.getFlushOp(i,s,r),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,s,r),o)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],o=s?s.elementaryStreams:i.elementaryStreams;o[ue.AUDIOVIDEO]?r.push("audiovideo"):(o[ue.AUDIO]&&r.push("audio"),o[ue.VIDEO]&&r.push("video"));const a=()=>{const u=self.performance.now();i.stats.buffering.end=u,s&&(s.stats.buffering.end=u);const l=s?s.stats:i.stats;this.hls.trigger(T.FRAG_BUFFERED,{frag:i,part:s,stats:l,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,r).catch(u=>{this.warn(`Fragment buffered callback ${u}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const s=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})?s?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(T.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(T.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===b.BUFFER_APPEND_ERROR&&t.frag){var i;const s=(i=t.errorAction)==null?void 0:i.nextAutoLevel;V(s)&&s!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const s=e.config,r=i.currentTime,o=t.levelTargetDuration,a=t.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(V(a)&&a>=0){const l=Math.max(a,o),c=Math.floor(r/o)*o-l;this.flushBackBuffer(r,o,c)}const u=s.frontBufferFlushThreshold;if(V(u)&&u>0){const l=Math.max(s.maxBufferLength,u),c=Math.max(l,o),f=Math.floor(r/o)*o+c;this.flushFrontBuffer(r,o,f)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){const a=Q.getBuffered(r);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(T.BACK_BUFFER_REACHED,{bufferEnd:i});const u=this.tracks[s];if((o=this.details)!=null&&o.live)this.hls.trigger(T.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(u!=null&&u.ended){this.log(`Cannot flush ${s} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(T.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:s})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([s,r])=>{if(r){const o=Q.getBuffered(r),a=o.length;if(a<2)return;const u=o.start(a-1),l=o.end(a-1);if(i>u||e>=u&&e<=l)return;this.hls.trigger(T.BUFFER_FLUSHING,{startOffset:u,endOffset:1/0,type:s})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;const s=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&i.setLiveSeekableRange){const l=Math.max(0,t.fragmentStart),c=Math.max(l,s);return{duration:1/0,start:l,end:c}}return{duration:1/0}}const r=(e=this.overrides)==null?void 0:e.duration;if(r)return V(r)?{duration:r}:null;const o=this.media.duration,a=V(i.duration)?i.duration:0;return s>a&&s>o||!V(o)?{duration:s}:null}updateMediaSource({duration:e,start:t,end:i}){const s=this.mediaSource;!this.media||!s||s.readyState!=="open"||(s.duration!==e&&(V(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),s.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${s.duration}. Setting seekable range to ${t}-${i}.`),s.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${ce(i)}`),this.tracksReady){var s;const r=(s=this.transferData)==null?void 0:s.tracks;r&&Object.keys(r).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const s=this.tracks[t];e[t]={buffer:i,container:s.container,codec:s.codec,supplemental:s.supplemental,levelCodec:s.levelCodec,id:s.id,metadata:s.metadata}}}),this.hls.trigger(T.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const r in e){const o=r,a=e[o];if(this.isPending(a)){const u=this.getTrackCodec(a,o),l=`${a.container};codecs=${u}`;a.codec=u,this.log(`creating sourceBuffer(${l})${this.currentOp(o)?" Queued":""} ${ce(a)}`);try{const c=i.addSourceBuffer(l),f=Un(o),p=[o,c];t[f]=p,a.buffer=c}catch(c){var s;this.error(`error while trying to add sourceBuffer: ${c.message}`),this.shiftAndExecuteNext(o),(s=this.operationQueue)==null||s.removeBlockers(),delete this.tracks[o],this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:c,sourceBufferName:o,mimeType:l,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let s=e.codec;i&&(t==="video"||t==="audiovideo")&&ui(i,"video")&&(s=Cy(s,i));const r=Bi(s,e.levelCodec);return r?t.slice(0,5)==="audio"?en(r,this.appendSource):r:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const s=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:s,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(r,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(T.BUFFER_FLUSHED,{type:r})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});const r=this.currentOp(e);r&&r.onError(s)}updateTimestampOffset(e,t,i,s,r,o){const a=t-e.timestampOffset;Math.abs(a)>=i&&(this.log(`Updating ${s} SourceBuffer timestampOffset to ${t} (sn: ${r} cc: ${o})`),e.timestampOffset=t)}removeExecutor(e,t,i){const{media:s,mediaSource:r}=this,o=this.tracks[e],a=o==null?void 0:o.buffer;if(!s||!r||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const u=V(s.duration)?s.duration:1/0,l=V(r.duration)?r.duration:1/0,c=Math.max(0,t),f=Math.min(i,u,l);f>c&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${c},${f}] from the ${e} SourceBuffer`),a.remove(c,f)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],s=i==null?void 0:i.buffer;if(!s)throw new FT(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,s.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,s=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(s).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const s=(i=this.tracks[t])==null?void 0:i.buffer;!s||s.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const s=this.tracks[e];if(!s)return;const r=s.buffer;if(!r)return;const o=i.bind(this,e);s.listeners.push({event:t,listener:o}),r.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(s=>{i.removeEventListener(s.event,s.listener)}),t.listeners.length=0)}}function Ha(n){const e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function OT(n,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}function Un(n){return n==="audio"?1:0}class sr{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(T.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(T.BUFFER_CODECS,this.onBufferCodecs,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(T.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(T.BUFFER_CODECS,this.onBufferCodecs,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&V(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,sr.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(a,u)=>u?a.width!==u.width||a.height!==u.height:!0;let r=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const u=e[a];if((u.width>=o||u.height>=o)&&s(u,e[a+1])){r=a;break}}return r}}const BT={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Pe=BT,$T={HLS:"h"},GT=$T;class tt{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof tt?i:new tt(i))),this.value=e,this.params=t}}const VT="Dict";function HT(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function KT(n,e,t,i){return new Error(`failed to ${n} "${HT(e)}" as ${t}`,{cause:i})}function it(n,e,t){return KT("serialize",n,e,t)}class ac{constructor(e){this.description=e}}const Ka="Bare Item",qT="Boolean";function YT(n){if(typeof n!="boolean")throw it(n,qT);return n?"?1":"?0"}function WT(n){return btoa(String.fromCharCode(...n))}const JT="Byte Sequence";function zT(n){if(ArrayBuffer.isView(n)===!1)throw it(n,JT);return`:${WT(n)}:`}const XT="Integer";function QT(n){return n<-999999999999999||999999999999999<n}function lc(n){if(QT(n))throw it(n,XT);return n.toString()}function ZT(n){return`@${lc(n.getTime()/1e3)}`}function uc(n,e){if(n<0)return-uc(-n,e);const t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){const s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}const jT="Decimal";function ev(n){const e=uc(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw it(n,jT);const t=e.toString();return t.includes(".")?t:`${t}.0`}const tv="String",iv=/[\x00-\x1f\x7f]+/;function nv(n){if(iv.test(n))throw it(n,tv);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function sv(n){return n.description||n.toString().slice(7,-1)}const rv="Token";function qa(n){const e=sv(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw it(e,rv);return e}function As(n){switch(typeof n){case"number":if(!V(n))throw it(n,Ka);return Number.isInteger(n)?lc(n):ev(n);case"string":return nv(n);case"symbol":return qa(n);case"boolean":return YT(n);case"object":if(n instanceof Date)return ZT(n);if(n instanceof Uint8Array)return zT(n);if(n instanceof ac)return qa(n);default:throw it(n,Ka)}}const ov="Key";function Is(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw it(n,ov);return n}function rr(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${Is(e)}`:`;${Is(e)}=${As(t)}`).join("")}function cc(n){return n instanceof tt?`${As(n.value)}${rr(n.params)}`:As(n)}function av(n){return`(${n.value.map(cc).join(" ")})${rr(n.params)}`}function lv(n,e={whitespace:!0}){if(typeof n!="object"||n==null)throw it(n,VT);const t=n instanceof Map?n.entries():Object.entries(n),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof tt||(r=new tt(r));let o=Is(s);return r.value===!0?o+=rr(r.params):(o+="=",Array.isArray(r.value)?o+=av(r):o+=cc(r)),o}).join(`,${i}`)}function dc(n,e){return lv(n,e)}const Xe="CMCD-Object",he="CMCD-Request",At="CMCD-Session",dt="CMCD-Status",uv={br:Xe,ab:Xe,d:Xe,ot:Xe,tb:Xe,tpb:Xe,lb:Xe,tab:Xe,lab:Xe,url:Xe,pb:he,bl:he,tbl:he,dl:he,ltc:he,mtp:he,nor:he,nrr:he,rc:he,sn:he,sta:he,su:he,ttfb:he,ttfbb:he,ttlb:he,cmsdd:he,cmsds:he,smrt:he,df:he,cs:he,ts:he,cid:At,pr:At,sf:At,sid:At,st:At,v:At,msd:At,bs:dt,bsd:dt,cdn:dt,rtp:dt,bg:dt,pt:dt,ec:dt,e:dt},cv={REQUEST:he};function dv(n){return Object.keys(n).reduce((e,t)=>{var i;return(i=n[t])===null||i===void 0||i.forEach(s=>e[s]=t),e},{})}function fv(n,e){const t={};if(!n)return t;const i=Object.keys(n),s=e?dv(e):{};return i.reduce((r,o)=>{var a;const u=uv[o]||s[o]||cv.REQUEST,l=(a=r[u])!==null&&a!==void 0?a:r[u]={};return l[o]=n[o],r},t)}function hv(n){return["ot","sf","st","e","sta"].includes(n)}function pv(n){return typeof n=="number"?V(n):n!=null&&n!==""&&n!==!1}const fc="event";function gv(n,e){const t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;const s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")+t.search+t.hash}const Ki=n=>Math.round(n),_s=(n,e)=>Array.isArray(n)?n.map(t=>_s(t,e)):n instanceof tt&&typeof n.value=="string"?new tt(_s(n.value,e),n.params):(e.baseUrl&&(n=gv(n,e.baseUrl)),e.version===1?encodeURIComponent(n):n),Pi=n=>Ki(n/100)*100,mv=(n,e)=>{let t=n;return e.version>=2&&(n instanceof tt&&typeof n.value=="string"?t=new tt([n]):typeof n=="string"&&(t=[n])),_s(t,e)},yv={br:Ki,d:Ki,bl:Pi,dl:Pi,mtp:Pi,nor:mv,rtp:Pi,tb:Ki},hc="request",pc="response",or=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],Ev=["e"],Tv=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function Tn(n){return Tv.test(n)}function vv(n){return or.includes(n)||Ev.includes(n)||Tn(n)}const gc=["d","dl","nor","ot","rtp","su"];function Sv(n){return or.includes(n)||gc.includes(n)||Tn(n)}const Av=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function Iv(n){return or.includes(n)||gc.includes(n)||Av.includes(n)||Tn(n)}const _v=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function Rv(n){return _v.includes(n)||Tn(n)}const xv={[pc]:Iv,[fc]:vv,[hc]:Sv};function mc(n,e={}){const t={};if(n==null||typeof n!="object")return t;const i=e.version||n.v||1,s=e.reportingMode||hc,r=i===1?Rv:xv[s];let o=Object.keys(n).filter(r);const a=e.filter;typeof a=="function"&&(o=o.filter(a));const u=s===pc||s===fc;u&&!o.includes("ts")&&o.push("ts"),i>1&&!o.includes("v")&&o.push("v");const l=le({},yv,e.formatters),c={version:i,reportingMode:s,baseUrl:e.baseUrl};return o.sort().forEach(f=>{let p=n[f];const g=l[f];if(typeof g=="function"&&(p=g(p,c)),f==="v"){if(i===1)return;p=i}f=="pr"&&p===1||(u&&f==="ts"&&!V(p)&&(p=Date.now()),pv(p)&&(hv(f)&&typeof p=="string"&&(p=new ac(p)),t[f]=p))}),t}function Cv(n,e={}){const t={};if(!n)return t;const i=mc(n,e),s=fv(i,e==null?void 0:e.customHeaderMap);return Object.entries(s).reduce((r,[o,a])=>{const u=dc(a,{whitespace:!1});return u&&(r[o]=u),r},t)}function Lv(n,e,t){return le(n,Cv(e,t))}const Pv="CMCD";function Dv(n,e={}){return n?dc(mc(n,e),{whitespace:!1}):""}function bv(n,e={}){if(!n)return"";const t=Dv(n,e);return encodeURIComponent(t)}function wv(n,e={}){if(!n)return"";const t=bv(n,e);return`${Pv}=${t}`}const Ya=/CMCD=[^&#]+/;function kv(n,e,t){const i=wv(e,t);if(!i)return n;if(Ya.test(n))return n.replace(Ya,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class Mv{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:Pe.MANIFEST,su:!this.initialized})}catch(r){this.hls.logger.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const{frag:r,part:o}=s,a=this.hls.levels[r.level],u=this.getObjectType(r),l={d:(o||r).duration*1e3,ot:u};(u===Pe.VIDEO||u===Pe.AUDIO||u==Pe.MUXED)&&(l.br=a.bitrate/1e3,l.tb=this.getTopBandwidth(u)/1e3,l.bl=this.getBufferLength(u));const c=o?this.getNextPart(o):this.getNextFrag(r);c!=null&&c.url&&c.url!==r.url&&(l.nor=c.url),this.apply(s,l)}catch(r){this.hls.logger.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHED,this.onMediaDetached,this),e.on(T.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHED,this.onMediaDetached,this),e.off(T.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:GT.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){le(t,this.createData());const i=t.ot===Pe.INIT||t.ot===Pe.VIDEO||t.ot===Pe.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((o,a)=>(s.includes(a)&&(o[a]=t[a]),o),{}));const r={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),Lv(e.headers,t,r)):e.url=kv(e.url,t,r)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const s=e.sn-i.startSN;return i.fragments[s+1]}}getNextPart(e){var t;const{index:i,fragment:s}=e,r=(t=this.hls.levels[s.level])==null||(t=t.details)==null?void 0:t.partList;if(r){const{sn:o}=s;for(let a=r.length-1;a>=0;a--){const u=r[a];if(u.index===i&&u.fragment.sn===o)return r[a+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Pe.TIMED_TEXT;if(e.sn==="initSegment")return Pe.INIT;if(t==="audio")return Pe.AUDIO;if(t==="main")return this.hls.audioTracks.length?Pe.VIDEO:Pe.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===Pe.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,o=r>-1?r+1:s.levels.length;i=s.levels.slice(0,o)}return i.forEach(r=>{r.bitrate>t&&(t=r.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===Pe.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:Q.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}}const Nv=3e5;class Fv extends Ge{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===ve.SendAlternateToPenaltyBox&&i.flags===we.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:u,type:l}=t.context;a&&s?o=this.getPathwayForGroupId(a,l,o):u&&(o=u)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!r&&s&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==o),t.details===b.BUFFER_APPEND_ERROR&&!t.fatal?i.resolved=!0:i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${s&&s.length} priorities: ${ce(r)} penalized: ${ce(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>Nv&&delete i[r]});for(let r=0;r<e.length;r++){const o=e[r];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,u=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,Fu(t),this.hls.trigger(T.LEVELS_UPDATED,{levels:t});const l=this.hls.levels[a];u&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==u.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==u.bitrate&&this.log(`Unstable Pathways change from bitrate ${u.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===te.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===te.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":u}=r;if(t.some(c=>c.pathwayId===o))return;const l=this.getLevelsForPathway(a).map(c=>{const f=new de(c.attrs);f["PATHWAY-ID"]=o;const p=f.AUDIO&&`${f.AUDIO}_clone_${o}`,g=f.SUBTITLES&&`${f.SUBTITLES}_clone_${o}`;p&&(i[f.AUDIO]=p,f.AUDIO=p),g&&(s[f.SUBTITLES]=g,f.SUBTITLES=g);const m=yc(c.uri,f["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",u),E=new di({attrs:f,audioCodec:c.audioCodec,bitrate:c.bitrate,height:c.height,name:c.name,url:m,videoCodec:c.videoCodec,width:c.width});if(c.audioGroups)for(let y=1;y<c.audioGroups.length;y++)E.addGroupId("audio",`${c.audioGroups[y]}_clone_${o}`);if(c.subtitleGroups)for(let y=1;y<c.subtitleGroups.length;y++)E.addGroupId("text",`${c.subtitleGroups[y]}_clone_${o}`);return E});t.push(...l),Wa(this.audioTracks,i,u,o),Wa(this.subtitleTracks,s,u,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const c=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+c)}const r={responseType:"json",url:s.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},u={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(c,f,p,g)=>{this.log(`Loaded steering manifest: "${s}"`);const m=c.data;if((m==null?void 0:m.VERSION)!==1){this.log(`Steering VERSION ${m.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=m.TTL;const{"RELOAD-URI":E,"PATHWAY-CLONES":y,"PATHWAY-PRIORITY":v}=m;if(E)try{this.uri=new self.URL(E,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${E}`);return}this.scheduleRefresh(this.uri||p.url),y&&this.clonePathways(y);const S={steeringManifest:m,url:s.toString()};this.hls.trigger(T.STEERING_MANIFEST_LOADED,S),v&&this.updatePathwayPriority(v)},onError:(c,f,p,g)=>{if(this.log(`Error loading steering manifest: ${c.code} ${c.text} (${f.url})`),this.stopLoad(),c.code===410){this.enabled=!1,this.log(`Steering manifest ${f.url} no longer available`);return}let m=this.timeToLoad*1e3;if(c.code===429){const E=this.loader;if(typeof(E==null?void 0:E.getResponseHeader)=="function"){const y=E.getResponseHeader("Retry-After");y&&(m=parseFloat(y)*1e3)}this.log(`Steering manifest ${f.url} rate limited`);return}this.scheduleRefresh(this.uri||f.url,m)},onTimeout:(c,f,p)=>{this.log(`Timeout loading steering manifest (${f.url})`),this.scheduleRefresh(this.uri||f.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,u,l)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function Wa(n,e,t,i){n&&Object.keys(e).forEach(s=>{const r=n.filter(o=>o.groupId===s).map(o=>{const a=le({},o);return a.details=void 0,a.attrs=new de(a.attrs),a.url=a.attrs.URI=yc(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[s],a.attrs["PATHWAY-ID"]=i,a});n.push(...r)})}function yc(n,e,t,i){const{HOST:s,PARAMS:r,[t]:o}=i;let a;e&&(a=o==null?void 0:o[e],a&&(n=a));const u=new self.URL(n);return s&&!a&&(u.host=s),r&&Object.keys(r).sort().forEach(l=>{l&&u.searchParams.set(l,r[l])}),u.href}class qt extends Ge{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=qt.CDMCleanupPromise?[qt.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=t=>{const{initDataType:i,initData:s}=t,r=`"${t.type}" event: init data type: "${i}"`;if(this.debug(r),s!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=si(this.config));const a=o.map(Pn).filter(u=>!!u);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=Gi(o);if(i!=="sinf"||a!==fe.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}let u;try{const g=ge(new Uint8Array(s)),m=Js(JSON.parse(g).sinf),E=du(m);if(!E)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");u=new Uint8Array(E.subarray(8,24))}catch(g){this.warn(`${r} Failed to parse sinf: ${g}`);return}const l=Se(u),{keyIdToKeySessionPromise:c,mediaKeySessions:f}=this;let p=c[l];for(let g=0;g<f.length;g++){const m=f[g],E=m.decryptdata;if(!E.keyId)continue;const y=Se(E.keyId);if(on(u,E.keyId)||E.uri.replace(/-/g,"").indexOf(l)!==-1){if(p=c[y],!p)continue;if(E.pssh)break;delete c[y],E.pssh=new Uint8Array(s),E.keyId=u,p=c[l]=p.then(()=>this.generateRequestWithPreferredKeySession(m,i,s,"encrypted-event-key-match")),p.catch(v=>this.handleError(v));break}}p||this.handleError(new Error(`Key ID ${l} not encountered in playlist. Key-system sessions ${f.length}.`))}).catch(o=>this.handleError(o))}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(T.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(T.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(T.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(T.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(T.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(T.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(T.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(T.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t==null?void 0:t[e];if(s)return s.licenseUrl;if(e===fe.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t==null?void 0:t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,u)=>!!o&&u.indexOf(o)===a,s=t.map(o=>o.audioCodec).filter(i),r=t.map(o=>o.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((o,a)=>{const u=l=>{const c=l.shift();this.getMediaKeysPromise(c,s,r).then(f=>o({keySystem:c,mediaKeys:f})).catch(f=>{l.length?u(l):f instanceof be?a(f):a(new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_NO_ACCESS,error:f,fatal:!0},f.message))})};u(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return Lu===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){var s;const r=mE(e,t,i,this.config.drmSystemOptions||{});let o=this.keySystemAccessPromises[e],a=(s=o)==null?void 0:s.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${ce(r)}`),a=this.requestMediaKeySystemAccess(e,r);const u=o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),a.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const c=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);const f=u.mediaKeys=l.createMediaKeys().then(p=>(this.log(`Media-keys created for "${e}"`),u.hasMediaKeys=!0,c.then(g=>g?this.setMediaKeysServerCertificate(p,e,g):p)));return f.catch(p=>{this.error(`Failed to create media-keys for "${e}"}: ${p}`)}),f})}return a.then(()=>o.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Se(e.keyId||[])} keyUri: ${e.uri}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=Di(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}updateKeySession(e,t){const i=e.mediaKeysSession;return this.log(`Updating key-session "${i.sessionId}" for keyId ${Se(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),i.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>Pn(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:s})=>{const r=Pn(s);r?t(r):i(new Error(`Unable to find format for key-system "${s}"`))}).catch(i)})}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=si(this.config),i=e.map(Gi).filter(s=>!!s&&t.indexOf(s)!==-1);return this.selectKeySystem(i)}getKeyStatus(e){const{mediaKeySessions:t}=this;for(let i=0;i<t.length;i++){const s=Uv(e,t[i]);if(s)return s}}loadKey(e){const t=e.keyInfo.decryptdata,i=Di(t),s=this.bannedKeyIds[i];if(s||this.getKeyStatus(t)==="internal-error"){const a=Ja(s||"internal-error",t);return this.handleError(a,e.frag),Promise.reject(a)}const r=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${r}`);const o=this.keyIdToKeySessionPromise[i];if(!o){const a=this.getKeySystemForKeyPromise(t).then(({keySystem:u,mediaKeys:l})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${r}`),this.attemptSetMediaKeys(u,l).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:u,mediaKeys:l,decryptdata:t}))))).then(u=>{const l="cenc",c=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(u,l,c,"playlist-key")});return a.catch(u=>this.handleError(u,e.frag)),this.keyIdToKeySessionPromise[i]=a,a}return o.catch(a=>{if(a instanceof be){const u=oe({},a.data);this.getKeyStatus(t)==="internal-error"&&(u.decryptdata=t);const l=new be(u,a.message);this.handleError(l,e.frag)}}),o}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e,t){if(this.hls)if(e instanceof be){t&&(e.data.frag=t);const i=e.data.decryptdata;this.error(`${e.message}${i?` (${Se(i.keyId||[])})`:""}`),this.hls.trigger(T.ERROR,e.data)}else this.error(e.message),this.hls.trigger(T.ERROR,{type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0})}getKeySystemForKeyPromise(e){const t=Di(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=Gi(e.keyFormat),r=s?[s]:si(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=si(this.config)),e.length===0)throw new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${ce({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>this.media?this.media.setMediaKeys(t):new Promise((r,o)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return o(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=t,this.media.setMediaKeys(t).then(r).catch(o)}}));return this.mediaKeys=t,this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r;const o=(r=this.config.drmSystems)==null||(r=r[e.keySystem])==null?void 0:r.generateRequest;if(o)try{const m=o.call(this.hls,t,i,e);if(!m)throw new Error("Invalid response from configured generateRequest filter");t=m.initDataType,i=m.initData?m.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(m){if(this.warn(m.message),this.hls&&this.hls.config.debug)throw m}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const a=Di(e.decryptdata),u=e.decryptdata.uri;this.log(`Generating key-session request for "${s}" keyId: ${a} URI: ${u} (init data type: ${t} length: ${i.byteLength})`);const l=new Xs,c=e._onmessage=m=>{const E=e.mediaKeysSession;if(!E){l.emit("error",new Error("invalid state"));return}const{messageType:y,message:v}=m;this.log(`"${y}" message event for session "${E.sessionId}" message size: ${v.byteLength}`),y==="license-request"||y==="license-renewal"?this.renewLicense(e,v).catch(S=>{l.eventNames().length?l.emit("error",S):this.handleError(S)}):y==="license-release"?e.keySystem===fe.FAIRPLAY&&this.updateKeySession(e,ms("acknowledged")).then(()=>this.removeSession(e)).catch(S=>this.handleError(S)):this.warn(`unhandled media key message type "${y}"`)},f=(m,E)=>{E.keyStatus=m;let y;m.startsWith("usable")?l.emit("resolved"):m==="internal-error"||m==="output-restricted"||m==="output-downscaled"?y=Ja(m,E.decryptdata):m==="expired"?y=new Error(`key expired (keyId: ${a})`):m==="released"?y=new Error("key released"):m==="status-pending"||this.warn(`unhandled key status change "${m}" (keyId: ${a})`),y&&(l.eventNames().length?l.emit("error",y):this.handleError(y))},p=e._onkeystatuseschange=m=>{if(!e.mediaKeysSession){l.emit("error",new Error("invalid state"));return}const y=this.getKeyStatuses(e);if(!Object.keys(y).some(_=>y[_]!=="status-pending"))return;if(y[a]==="expired"){this.log(`Expired key ${ce(y)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let S=y[a];if(S)f(S,e);else{var A;e.keyStatusTimeouts||(e.keyStatusTimeouts={}),(A=e.keyStatusTimeouts)[a]||(A[a]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;const I=this.getKeyStatus(e.decryptdata);if(I&&I!=="status-pending")return this.log(`No status for keyId ${a} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${I} from other session.`),f(I,e);this.log(`key status for ${a} in key-session "${e.mediaKeysSession.sessionId}" timed out after 1000ms`),S="internal-error",f(S,e)},1e3)),this.log(`No status for keyId ${a} (${ce(y)}).`)}};Ce(e.mediaKeysSession,"message",c),Ce(e.mediaKeysSession,"keystatuseschange",p);const g=new Promise((m,E)=>{l.on("error",E),l.on("resolved",m)});return e.mediaKeysSession.generateRequest(t,i).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${a} URI: ${u}`)}).catch(m=>{throw new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_NO_SESSION,error:m,decryptdata:e.decryptdata,fatal:!1},`Error generating key-session request: ${m}`)}).then(()=>g).catch(m=>(l.removeAllListeners(),this.removeSession(e).then(()=>{throw m}))).then(()=>(l.removeAllListeners(),e))}getKeyStatuses(e){const t={};return e.mediaKeysSession.keyStatuses.forEach((i,s)=>{if(typeof s=="string"&&typeof i=="object"){const a=s;s=i,i=a}const r="buffer"in s?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s);if(e.keySystem===fe.PLAYREADY&&r.length===16){const a=Se(r);t[a]=i,xu(r)}const o=Se(r);i==="internal-error"&&(this.bannedKeyIds[o]=i),this.log(`key status change "${i}" for keyStatuses keyId: ${o} key-session "${e.mediaKeysSession.sessionId}"`),t[o]=i}),t}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const u={responseType:"arraybuffer",url:r},l=t.certLoadPolicy.default,c={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},f={onSuccess:(p,g,m,E)=>{o(p.data)},onError:(p,g,m,E)=>{a(new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:oe({url:u.url,data:void 0},p)},`"${e}" certificate request failed (${r}). Status: ${p.code} (${p.text})`))},onTimeout:(p,g,m)=>{a(new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:u.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(p,g,m)=>{a(new Error("aborted"))}};s.load(u,c,f)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i.byteLength}) on "${t}"`),s(e)}).catch(o=>{r(new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:s,fatal:!1},s.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let c;for(let f=0,p=r.length;f<p;f++){var o,a;c=r[f];const g=(o=c.querySelector("name"))==null?void 0:o.textContent,m=(a=c.querySelector("value"))==null?void 0:a.textContent;g&&m&&e.setRequestHeader(g,m)}}const u=s.querySelector("Challenge"),l=u==null?void 0:u.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return ms(atob(l))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let u=a.response;this.log(`License received ${u instanceof ArrayBuffer?u.byteLength:u}`);const l=this.config.licenseResponseCallback;if(l)try{u=l.call(this.hls,a,o,e)}catch(c){this.error(c)}s(u)}else{const u=i.errorRetry,l=u?u.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)r(new be({type:W.KEY_SYSTEM_ERROR,details:b.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const c=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${c} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:u,licenseChallenge:l})=>{e.keySystem==fe.PLAYREADY&&(l=this.unpackPlayReadyKeyMessage(u,l)),u.send(l)}).catch(r)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,Ce(i,"encrypted",this.onMediaEncrypted),Ce(i,"waitingforkey",this.onWaitingForKey);const s=this.mediaResolved;s?s():this.mediaKeys=i.mediaKeys}onMediaDetached(){const e=this.media;e&&(De(e,"encrypted",this.onMediaEncrypted),De(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const t=this.mediaResolved;if(t&&t(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const i=this.media,s=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,gt.clearKeyUriToKeyIdMap();const r=s.length;qt.CDMCleanupPromise=Promise.all(s.map(o=>this.removeSession(o)).concat((i==null||(e=i.setMediaKeys(null))==null?void 0:e.catch(o=>{this.log(`Could not clear media keys: ${o}`),this.hls&&this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${o}`)})}))||Promise.resolve())).catch(o=>{this.log(`Could not close sessions and clear media keys: ${o}`),this.hls&&this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${o}`)})}).then(()=>{r&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this._clear()}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i,decryptdata:s}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${Se((s==null?void 0:s.keyId)||[])}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(e);r>-1&&this.mediaKeySessions.splice(r,1);const{keyStatusTimeouts:o}=e;o&&Object.keys(o).forEach(l=>self.clearTimeout(o[l]));const{drmSystemOptions:a}=this.config;return(EE(a)?new Promise((l,c)=>{self.setTimeout(()=>c(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(l).catch(c)}):Promise.resolve()).catch(l=>{this.log(`Could not remove session: ${l}`),this.hls&&this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${l}`)})}).then(()=>t.close()).catch(l=>{this.log(`Could not close session: ${l}`),this.hls&&this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${l}`)})})}return Promise.resolve()}}qt.CDMCleanupPromise=void 0;function Di(n){if(!n)throw new Error("Could not read keyId of undefined decryptdata");if(n.keyId===null)throw new Error("keyId is null");return Se(n.keyId)}function Uv(n,e){if(n.keyId&&e.mediaKeysSession.keyStatuses.has(n.keyId))return e.mediaKeysSession.keyStatuses.get(n.keyId);if(n.matches(e.decryptdata))return e.keyStatus}class be extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}function Ja(n,e){const t=n==="output-restricted",i=t?b.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:b.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new be({type:W.KEY_SYSTEM_ERROR,details:i,fatal:!1,decryptdata:e},t?"HDCP level output restricted":`key status changed to "${n}"`)}class Ov{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(T.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(T.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,u=1e3*o/r,l=this.hls;if(l.trigger(T.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),u>0&&o>l.config.fpsDroppedMonitoringThreshold*a){let c=l.currentLevel;l.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+c),c>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=c)&&(c=c-1,l.trigger(T.FPS_DROP_LEVEL_CAPPING,{level:c,droppedLevel:l.currentLevel}),l.autoLevelCapping=c,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function Ec(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function Tc(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){ae.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){ae.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function $t(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues)for(let i=n.cues.length;i--;)e&&n.cues[i].removeEventListener("enter",e),n.removeCue(n.cues[i]);t==="disabled"&&(n.mode=t)}function Rs(n,e,t,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=$v(n.cues,e,t);for(let o=0;o<r.length;o++)(!i||i(r[o]))&&n.removeCue(r[o])}s==="disabled"&&(n.mode=s)}function Bv(n,e){if(e<=n[0].startTime)return 0;const t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t,r;for(;i<=s;)if(r=Math.floor((s+i)/2),e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r;return n[i].startTime-e<e-n[s].startTime?i:s}function $v(n,e,t){const i=[],s=Bv(n,e);if(s>-1)for(let r=s,o=n.length;r<o;r++){const a=n[r];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function qi(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}class Gv extends nr{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=qi(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.LEVEL_LOADING,this.onLevelLoading,this),e.on(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(T.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(T.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.LEVEL_LOADING,this.onLevelLoading,this),e.off(T.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(T.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(T.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const s=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,s)return;qi(i.textTracks).forEach(o=>{$t(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(c=>!i||i.indexOf(c.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(c=>c.default)&&(this.selectDefaultTrack=!1),o.forEach((c,f)=>{c.id=f});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!r&&a){this.selectDefaultTrack=!1;const c=je(a,o);if(c>-1)r=o[c];else{const f=je(a,this.tracks);r=this.tracks[f]}}let u=this.findTrackId(r);u===-1&&r&&(u=this.findTrackId(null));const l={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(T.SUBTITLE_TRACKS_UPDATED,l),u!==-1&&this.trackId===-1&&this.setSubtitleTrack(u)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){const r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||Ct(r,e)))return s}if(e){for(let s=0;s<t.length;s++){const r=t[s];if(gi(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const r=t[s];if(gi(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(Ss(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===te.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Ct(e,i))return i;const s=je(e,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=je(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,s=e.groupId,r=this.getUrlWithDirectives(e.url,t),o=e.details,a=o==null?void 0:o.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${r}`),this.hls.trigger(T.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=qi(e.textTracks),i=this.currentTrack;let s;if(i&&(s=t.filter(r=>Ss(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!V(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(T.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:o,groupId:a="",name:u,type:l,url:c}=s;this.hls.trigger(T.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:u,type:l,url:c});const f=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(f)}}function Vv(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}function ai(n){let e=5381,t=n.length;for(;t;)e=e*33^n.charCodeAt(--t);return(e>>>0).toString()}const Yt=.025;let cn=(function(n){return n[n.Point=0]="Point",n[n.Range=1]="Range",n})({});function Hv(n,e,t){return`${n.identifier}-${t+1}-${ai(e)}`}class Kv{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return On(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=On(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=V(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return On(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<Yt))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?cn.Range:cn.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return qv(this)}}function On(n,e){return n-e.start<e.duration/2&&!(Math.abs(n-(e.start+e.duration))<Yt)?e.start:e.start+e.duration}function vc(n,e,t){const i=new self.URL(n,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function Bn(n,e){for(;(t=n.assetList[++e])!=null&&t.error;)var t;return e}function qv(n){return`["${n.identifier}" ${n.cue.pre?"<pre>":n.cue.post?"<post>":""}${n.timelineStart.toFixed(2)}-${n.resumeTime.toFixed(2)}]`}function Ut(n){const e=n.timelineStart,t=n.duration||0;return`["${n.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class Yv{constructor(e,t,i,s){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(T.PLAYOUT_LIMIT_REACHED,{})};const r=this.hls=new e(t);this.interstitial=i,this.assetItem=s;const o=()=>{this.hasDetails=!0};r.once(T.LEVEL_LOADED,o),r.once(T.AUDIO_TRACK_LOADED,o),r.once(T.SUBTITLE_TRACK_LOADED,o),r.on(T.MEDIA_ATTACHING,(a,{media:u})=>{this.removeMediaListeners(),this.mediaAttached=u,this.interstitial.playoutLimit&&(u.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&r.on(T.BUFFER_APPENDED,()=>{const c=this.bufferedEnd;this.reachedPlayout(c)&&(this._bufferedEosTime=c,r.trigger(T.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=vc(t,e.config.primarySessionId||"").href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;const i=Math.min(this._bufferedEosTime||1/0,this.duration),s=this.timelineOffset,r=Q.bufferInfo(e,s,0);return this.getAssetTime(r.end)>=i-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=Q.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const i=t-this.startOffset;if(i>0&&i<e)return i}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){var s;(s=this.hls)==null||s.on(e,t)}once(e,t,i){var s;(s=this.hls)==null||s.once(e,t)}off(e,t,i){var s;(s=this.hls)==null||s.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${Ut(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const za=.033;class Wv extends Ge{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,s)=>e<=s.startOffset&&t>s.startOffset?(delete s.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const s=this.items;if(s)for(s[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(r=s[i])!=null&&r.event;){var r;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let s=0;s<i.length;s++){let r=i[s];if(t&&t!=="primary"&&(r=r[t]),e===r.start||e>r.start&&e<r.end)return s}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let s=e;s<=t&&i[s];s++){const r=i[s].event;if(r!=null&&r.restrictions.jump&&!r.appendInPlace)return s}return-1}findEventIndex(e){const t=this.items;if(t)for(let s=t.length;s--;){var i;if(((i=t[s].event)==null?void 0:i.identifier)===e)return s}return-1}findAssetIndex(e,t){const i=e.assetList,s=i.length;if(s>1)for(let r=0;r<s;r++){const o=i[r];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&(t<a+(o.duration||0)||r===s-1))return r}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const i=t.assetList,s=i[i.length-1];if(s)return s.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:s}=i,r=this.events,o=this.parseDateRanges(s,{url:i.url},t),a=Object.keys(s),u=r?r.filter(l=>!a.includes(l.identifier)):[];o.length&&o.sort((l,c)=>{const f=l.cue.pre,p=l.cue.post,g=c.cue.pre,m=c.cue.post;if(f&&!g)return-1;if(g&&!f||p&&!m)return 1;if(m&&!p)return-1;if(!f&&!g&&!p&&!m){const E=l.startTime,y=c.startTime;if(E!==y)return E-y}return l.dateRange.tagOrder-c.dateRange.tagOrder}),this.events=o,u.forEach(l=>{this.removeEvent(l)}),this.updateSchedule(e,u)}updateSchedule(e,t=[],i=!1){const s=this.events||[];if(s.length||t.length||this.length<2){const r=this.items,o=this.parseSchedule(s,e);(i||t.length||(r==null?void 0:r.length)!==o.length||o.some((u,l)=>Math.abs(u.playout.start-r[l].playout.start)>.005||Math.abs(u.playout.end-r[l].playout.end)>.005))&&(this.items=o,this.onScheduleUpdate(t,r))}}parseDateRanges(e,t,i){const s=[],r=Object.keys(e);for(let o=0;o<r.length;o++){const a=r[o],u=e[a];if(u.isInterstitial){let l=this.eventMap[a];l?l.setDateRange(u):(l=new Kv(u,t),this.eventMap[a]=l,i===!1&&(l.appendInPlace=i)),s.push(l)}}return s}parseSchedule(e,t){const i=[],s=t.main.details,r=s.live?1/0:s.edge;let o=0;if(e=e.filter(u=>!u.error&&!(u.cue.once&&u.hasPlayed)),e.length){this.resolveOffsets(e,t);let u=0,l=0;if(e.forEach((c,f)=>{const p=c.cue.pre,g=c.cue.post,m=e[f-1]||null,E=c.appendInPlace,y=g?r:c.startOffset,v=c.duration,S=c.timelineOccupancy===cn.Range?v:0,A=c.resumptionOffset,_=(m==null?void 0:m.startTime)===y,I=y+c.cumulativeDuration;let P=E?I+v:y+A;if(p||!g&&y<=0){const L=l;l+=S,c.timelineStart=I;const C=o;o+=v,i.push({event:c,start:I,end:P,playout:{start:C,end:o},integrated:{start:L,end:l}})}else if(y<=r){if(!_){const x=y-u;if(x>za){const w=u,M=l;l+=x;const U=o;o+=x;const $={previousEvent:e[f-1]||null,nextEvent:c,start:w,end:w+x,playout:{start:U,end:o},integrated:{start:M,end:l}};i.push($)}else x>0&&m&&(m.cumulativeDuration+=x,i[i.length-1].end=y)}g&&(P=I),c.timelineStart=I;const L=l;l+=S;const C=o;o+=v,i.push({event:c,start:I,end:P,playout:{start:C,end:o},integrated:{start:L,end:l}})}else return;const R=c.resumeTime;g||R>r?u=r:u=R}),u<r){var a;const c=u,f=l,p=r-u;l+=p;const g=o;o+=p,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:u,end:c+p,playout:{start:g,end:o},integrated:{start:f,end:l}})}this.setDurations(r,o,l)}else i.push({previousEvent:null,nextEvent:null,start:0,end:r,playout:{start:0,end:r},integrated:{start:0,end:r}}),this.setDurations(r,r,r);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,s=i.live?1/0:i.edge;let r=0,o=-1;e.forEach((a,u)=>{const l=a.cue.pre,c=a.cue.post,f=l?0:c?s:a.startTime;this.updateAssetDurations(a),o===f?a.cumulativeDuration=r:(r=0,o=f),!c&&a.snapOptions.in&&(a.resumeAnchor=Lt(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&u+1<e.length&&e[u+1].startTime-e[u].resumeTime<za&&(e[u+1].appendInPlace=!1,e[u+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const g=V(a.resumeOffset)?a.resumeOffset:a.duration;r+=g})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,s=e.startTime+e.resumptionOffset;return Math.abs(i-s)>Yt?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${s}`),!1):!Object.keys(t).some(o=>{const a=t[o].details,u=a.edge;if(i>=u)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${u}`),!1;const l=Lt(null,a.fragments,i);if(!l)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const c=o==="audio"?.175:0;return Math.abs(l.start-i)<Yt+c||Math.abs(l.end-i)<Yt+c?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${l.start}-${l.end} sn: ${l.sn} cc: ${l.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,s=!1,r=!1;for(let o=0;o<e.assetList.length;o++){const a=e.assetList[o],u=t+i;a.startOffset=i,a.timelineStart=u,s||(s=a.duration===null),r||(r=!!a.error);const l=a.error?0:a.duration||0;i+=l}s&&!r?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function He(n){return`[${n.event?'"'+n.event.identifier+'"':"primary"}: ${n.start.toFixed(2)}-${n.end.toFixed(2)}]`}class Jv{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let s;try{s=vc(i,this.hls.sessionId,e.baseUrl)}catch(p){const g=this.assignAssetListError(e,b.ASSET_LIST_LOAD_ERROR,p,i);this.hls.trigger(T.ERROR,g);return}t&&s.protocol!=="data:"&&s.searchParams.set("_HLS_start_offset",""+t);const r=this.hls.config,o=r.loader,a=new o(r),u={responseType:"json",url:s.href},l=r.interstitialAssetListLoadPolicy.default,c={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},f={onSuccess:(p,g,m,E)=>{const y=p.data,v=y==null?void 0:y.ASSETS;if(!Array.isArray(v)){const S=this.assignAssetListError(e,b.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),m.url,g,E);this.hls.trigger(T.ERROR,S);return}e.assetListResponse=y,this.hls.trigger(T.ASSET_LIST_LOADED,{event:e,assetListResponse:y,networkDetails:E})},onError:(p,g,m,E)=>{const y=this.assignAssetListError(e,b.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${p.code} ${p.text} (${g.url})`),g.url,E,m);this.hls.trigger(T.ERROR,y)},onTimeout:(p,g,m)=>{const E=this.assignAssetListError(e,b.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${g.url})`),g.url,p,m);this.hls.trigger(T.ERROR,E)}};return a.load(u,c,f),this.hls.trigger(T.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,s,r,o){return e.error=i,{type:W.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:s,error:i,networkDetails:o,stats:r}}}function Xa(n){var e;n==null||(e=n.play())==null||e.catch(()=>{})}function bi(n,e){return`[${n}] Advancing timeline position to ${e}`}class zv extends Ge{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled||!this.schedule)return;const s=i-this.timelinePos;if(Math.abs(s)<1/7056e5)return;const o=s<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-s)&&this.updateSchedule(!0),this.checkBuffer(),o&&i<a.start||i>=a.end){var u;const g=this.findItemIndex(a);let m=this.schedule.findItemIndexAtTime(i);if(m===-1&&(m=g+(o?-1:1),this.log(`seeked ${o?"back ":""}to position not covered by schedule ${i} (resolving from ${g} to ${m})`)),!this.isInterstitial(a)&&(u=this.media)!=null&&u.paused&&(this.shouldPlay=!1),!o&&m>g){const E=this.schedule.findJumpRestrictedIndex(g+1,m);if(E>g){this.setSchedulePosition(E);return}}this.setSchedulePosition(m);return}const l=this.playingAsset;if(!l){if(this.playingLastItem&&this.isInterstitial(a)){const g=a.event.assetList[0];g&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,g))}return}const c=l.timelineStart,f=l.duration||0;if(o&&i<c||i>=c+f){var p;(p=a.event)!=null&&p.appendInPlace&&(this.clearAssetPlayers(a.event,a),this.flushFrontBuffer(i)),this.setScheduleToAssetAtTime(i,l)}},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const s=this.playingItem;if(!s||this.playingLastItem)return;if(i>=s.end){this.timelinePos=s.end;const a=this.findItemIndex(s);this.setSchedulePosition(a+1)}const r=this.playingAsset;if(!r)return;const o=r.timelineStart+(r.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,r)},this.onScheduleUpdate=(i,s)=>{const r=this.schedule;if(!r)return;const o=this.playingItem,a=r.events||[],u=r.items||[],l=r.durations,c=i.map(E=>E.identifier),f=!!(a.length||c.length);(f||s)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${u.map(E=>He(E))} pos: ${this.timelinePos}`),c.length&&this.log(`Removed events ${c}`);let p=null,g=null;o&&(p=this.updateItem(o,this.timelinePos),this.itemsMatch(o,p)?this.playingItem=p:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const m=this.bufferingItem;if(m&&(g=this.updateItem(m,this.bufferedPos),this.itemsMatch(m,g)?this.bufferingItem=g:m.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(m.event,null))),i.forEach(E=>{E.assetList.forEach(y=>{this.clearAssetPlayer(y.identifier,null)})}),this.playerQueue.forEach(E=>{if(E.interstitial.appendInPlace){const y=E.assetItem.timelineStart,v=E.timelineOffset-y;if(v)try{E.timelineOffset=y}catch(S){Math.abs(v)>Yt&&this.warn(`${S} ("${E.assetId}" ${E.timelineOffset}->${y})`)}}}),f||s){if(this.hls.trigger(T.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:u.slice(0),durations:l,removedIds:c}),this.isInterstitial(o)&&c.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}o&&this.trimInPlace(p,o),m&&g!==p&&this.trimInPlace(g,m),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new Jv(e),this.schedule=new Wv(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e&&(e.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(T.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(T.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(T.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(T.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(T.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(T.BUFFER_APPENDED,this.onBufferAppended,this),e.on(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(T.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(T.MEDIA_ENDED,this.onMediaEnded,this),e.on(T.ERROR,this.onError,this),e.on(T.DESTROYING,this.onDestroying,this))}unregisterListeners(){const e=this.hls;e&&(e.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(T.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(T.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(T.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(T.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(T.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(T.BUFFER_CODECS,this.onBufferCodecs,this),e.off(T.BUFFER_APPENDED,this.onBufferAppended,this),e.off(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(T.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(T.MEDIA_ENDED,this.onMediaEnded,this),e.off(T.ERROR,this.onError,this),e.off(T.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){De(e,"play",this.onPlay),De(e,"pause",this.onPause),De(e,"seeking",this.onSeeking),De(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;Ce(i,"seeking",this.onSeeking),Ce(i,"timeupdate",this.onTimeupdate),Ce(i,"play",this.onPlay),Ce(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,s=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!s){this.clearScheduleState();const r=this.findItemIndex(i);this.setSchedulePosition(r)}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,s=this.media;if(this.media=null,!i&&(s&&this.removeMediaListeners(s),this.detachedData)){const r=this.getBufferingPlayer();r&&(this.log(`Removing schedule state for detachedData and ${r}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,r.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=f=>f&&e.getAssetPlayer(f.identifier),s=(f,p,g,m,E)=>{if(f){let y=f[p].start;const v=f.event;if(v){if(p==="playout"||v.timelineOccupancy!==cn.Point){const S=i(g);(S==null?void 0:S.interstitial)===v&&(y+=S.assetItem.startOffset+S[E])}}else{const S=m==="bufferedPos"?o():e[m];y+=S-f.start}return y}return 0},r=(f,p)=>{var g;if(f!==0&&p!=="primary"&&(g=e.schedule)!=null&&g.length){var m;const E=e.schedule.findItemIndexAtTime(f),y=(m=e.schedule.items)==null?void 0:m[E];if(y){const v=y[p].start-y.start;return f+v}}return f},o=()=>{const f=e.bufferedPos;return f===Number.MAX_VALUE?a("primary"):Math.max(f,0)},a=f=>{var p,g;return(p=e.primaryDetails)!=null&&p.live?e.primaryDetails.edge:((g=e.schedule)==null?void 0:g.durations[f])||0},u=(f,p)=>{var g,m;const E=e.effectivePlayingItem;if(E!=null&&(g=E.event)!=null&&g.restrictions.skip||!e.schedule)return;e.log(`seek to ${f} "${p}"`);const y=e.effectivePlayingItem,v=e.schedule.findItemIndexAtTime(f,p),S=(m=e.schedule.items)==null?void 0:m[v],A=e.getBufferingPlayer(),_=A==null?void 0:A.interstitial,I=_==null?void 0:_.appendInPlace,P=y&&e.itemsMatch(y,S);if(y&&(I||P)){const R=i(e.playingAsset),L=(R==null?void 0:R.media)||e.primaryMedia;if(L){const C=p==="primary"?L.currentTime:s(y,p,e.playingAsset,"timelinePos","currentTime"),x=f-C,w=(I?C:L.currentTime)+x;if(w>=0&&(!R||I||w<=R.duration)){L.currentTime=w;return}}}if(S){let R=f;if(p!=="primary"){const C=S[p].start,x=f-C;R=S.start+x}const L=!e.isInterstitial(S);if((!e.isInterstitial(y)||y.event.appendInPlace)&&(L||S.event.appendInPlace)){const C=e.media||(I?A==null?void 0:A.media:null);C&&(C.currentTime=R)}else if(y){const C=e.findItemIndex(y);if(v>C){const w=e.schedule.findJumpRestrictedIndex(C+1,v);if(w>C){e.setSchedulePosition(w);return}}let x=0;if(L)e.timelinePos=R,e.checkBuffer();else{const w=S.event.assetList,M=f-(S[p]||S).start;for(let U=w.length;U--;){const $=w[U];if($.duration&&M>=$.startOffset&&M<$.startOffset+$.duration){x=U;break}}}e.setSchedulePosition(v,x)}}},l=()=>{const f=e.effectivePlayingItem;if(e.isInterstitial(f))return f;const p=t();return e.isInterstitial(p)?p:null},c={get bufferedEnd(){const f=t(),p=e.bufferingItem;if(p&&p===f){var g;return s(p,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-p.playout.start||((g=e.bufferingAsset)==null?void 0:g.startOffset)||0}return 0},get currentTime(){const f=l(),p=e.effectivePlayingItem;return p&&p===f?s(p,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-p.playout.start:0},set currentTime(f){const p=l(),g=e.effectivePlayingItem;g&&g===p&&u(f+g.playout.start,"playout")},get duration(){const f=l();return f?f.playout.end-f.playout.start:0},get assetPlayers(){var f;const p=(f=l())==null?void 0:f.event.assetList;return p?p.map(g=>e.getAssetPlayer(g.identifier)):[]},get playingIndex(){var f;const p=(f=l())==null?void 0:f.event;return p&&e.effectivePlayingAsset?p.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};return this.manager={get events(){var f;return((f=e.schedule)==null||(f=f.events)==null?void 0:f.slice(0))||[]},get schedule(){var f;return((f=e.schedule)==null||(f=f.items)==null?void 0:f.slice(0))||[]},get interstitialPlayer(){return l()?c:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const f=t();return e.findItemIndex(f)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const f=e.effectivePlayingItem;return e.findItemIndex(f)},primary:{get bufferedEnd(){return o()},get currentTime(){const f=e.timelinePos;return f>0?f:0},set currentTime(f){u(f,"primary")},get duration(){return a("primary")},get seekableStart(){var f;return((f=e.primaryDetails)==null?void 0:f.fragmentStart)||0}},integrated:{get bufferedEnd(){return s(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return s(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(f){u(f,"integrated")},get duration(){return a("integrated")},get seekableStart(){var f;return r(((f=e.primaryDetails)==null?void 0:f.fragmentStart)||0,"integrated")}},skip:()=>{const f=e.effectivePlayingItem,p=f==null?void 0:f.event;if(p&&!p.restrictions.skip){const g=e.findItemIndex(f);if(p.appendInPlace){const m=f.playout.start+f.event.duration;u(m+.001,"playout")}else e.advanceAfterAssetEnded(p,g,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const i=this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&!i.event.appendInPlace)return;let s=this.media;!s&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(s=this.primaryMedia);const r=(t=s)==null?void 0:t.currentTime;if(!(r===void 0||!V(r)))return r}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,s=e.media;if(i&&s===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&s){this.detachedData={media:s};return}const r=e.transferMedia();this.log(`transfer MediaSource from ${e} ${ce(r)}`),this.detachedData=r}else t&&s&&(this.shouldPlay||(this.shouldPlay=!s.paused))}transferMediaTo(e,t){var i,s;if(e.media===t)return;let r=null;const o=this.hls,a=e!==o,u=a&&e.interstitial.appendInPlace,l=(i=this.detachedData)==null?void 0:i.mediaSource;let c;if(o.media)u&&(r=o.transferMedia(),this.detachedData=r),c="Primary";else if(l){const m=this.getBufferingPlayer();m?(r=m.transferMedia(),c=`${m}`):c="detached MediaSource"}else c="detached media";if(!r){if(l)r=this.detachedData,this.log(`using detachedData: MediaSource ${ce(r)}`);else if(!this.detachedData||o.media===t){const m=this.playerQueue;m.length>1&&m.forEach(E=>{if(a&&E.interstitial.appendInPlace!==u){const y=E.interstitial;this.clearInterstitial(E.interstitial,null),y.appendInPlace=!1,y.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${y}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const f=r&&"mediaSource"in r&&((s=r.mediaSource)==null?void 0:s.readyState)!=="closed",p=f&&r?r:t;this.log(`${f?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${c} (media.currentTime: ${t.currentTime})`);const g=this.schedule;if(p===r&&g){const m=a&&e.assetId===g.assetIdAtEnd;p.overrides={duration:g.duration,endOfStream:!a||m,cueRemoval:!a}}e.attachMedia(p)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e==null?void 0:e.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,s=this.effectivePlayingItem;if(i===-1){const r=this.hls.startPosition;if(this.log(bi("checkStart",r)),this.timelinePos=r,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(r>=0||!this.primaryLive){const o=this.timelinePos=r>0?r:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(s&&!this.playingItem){const r=e.findItemIndex(s);this.setSchedulePosition(r)}}advanceAssetBuffering(e,t){const i=e.event,s=i.findAssetIndex(t),r=Bn(i,s);if(!i.isAssetPastPlayoutLimit(r))this.bufferedToEvent(e,r);else if(this.schedule){var o;const a=(o=this.schedule.items)==null?void 0:o[this.findItemIndex(e)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(e,t,i){const s=Bn(e,i);if(e.isAssetPastPlayoutLimit(s)){if(this.schedule){const r=this.schedule.items;if(r){const o=t+1,a=r.length;if(o>=a){this.setSchedulePosition(-1);return}const u=e.resumeTime;this.timelinePos<u&&(this.log(bi("advanceAfterAssetEnded",u)),this.timelinePos=u,e.appendInPlace&&this.advanceInPlace(u),this.checkBuffer(this.bufferedPos<u)),this.setSchedulePosition(o)}}}else{if(e.appendInPlace){const r=e.assetList[s];r&&this.advanceInPlace(r.timelineStart)}this.setSchedulePosition(t,s)}}setScheduleToAssetAtTime(e,t){const i=this.schedule;if(!i)return;const s=t.parentIdentifier,r=i.getEvent(s);if(r){const o=i.findEventIndex(s),a=i.findAssetIndex(r,e);this.advanceAfterAssetEnded(r,o,a-1)}}setSchedulePosition(e,t){var i;const s=(i=this.schedule)==null?void 0:i.items;if(!s||this.playbackDisabled)return;const r=e>=0?s[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${r&&He(r)}) pos: ${this.timelinePos}`);const o=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(o)){const c=o.event,f=this.playingAsset,p=f==null?void 0:f.identifier,g=p?this.getAssetPlayer(p):null;if(g&&p&&(!this.eventItemsMatch(o,r)||t!==void 0&&p!==c.assetList[t].identifier)){var u;const m=c.findAssetIndex(f);if(this.log(`INTERSTITIAL_ASSET_ENDED ${m+1}/${c.assetList.length} ${Ut(f)}`),this.endedAsset=f,this.playingAsset=null,this.hls.trigger(T.INTERSTITIAL_ASSET_ENDED,{asset:f,assetListIndex:m,event:c,schedule:s.slice(0),scheduleIndex:e,player:g}),o!==this.playingItem){this.itemsMatch(o,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(c,this.findItemIndex(this.playingItem),m);return}this.retreiveMediaSource(p,r),g.media&&!((u=this.detachedData)!=null&&u.mediaSource)&&g.detachMedia()}if(!this.eventItemsMatch(o,r)&&(this.endedItem=o,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${c} ${He(o)}`),c.hasPlayed=!0,this.hls.trigger(T.INTERSTITIAL_ENDED,{event:c,schedule:s.slice(0),scheduleIndex:e}),c.cue.once)){var l;this.updateSchedule();const m=(l=this.schedule)==null?void 0:l.items;if(r&&m){const E=this.findItemIndex(r);this.advanceSchedule(E,m,t,o,a)}return}}this.advanceSchedule(e,s,t,o,a)}advanceSchedule(e,t,i,s,r){const o=this.schedule;if(!o)return;const a=t[e]||null,u=this.primaryMedia,l=this.playerQueue;if(l.length&&l.forEach(c=>{const f=c.interstitial,p=o.findEventIndex(f.identifier);(p<e||p>e+1)&&this.clearInterstitial(f,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const c=a.event;if(i===void 0){i=o.findAssetIndex(c,this.timelinePos);const m=Bn(c,i-1);if(c.isAssetPastPlayoutLimit(m)||c.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(c,e,i);return}i=m}const f=this.waitingItem;this.assetsBuffered(a,u)||this.setBufferingItem(a);let p=this.preloadAssets(c,i);if(this.eventItemsMatch(a,f||s)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${He(a)} ${c.appendInPlace?"append in place":""}`),this.hls.trigger(T.INTERSTITIAL_STARTED,{event:c,schedule:t.slice(0),scheduleIndex:e})),!c.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${c}`);return}if(c.assetListLoader&&(c.assetListLoader.destroy(),c.assetListLoader=void 0),!u){this.log(`Waiting for attachMedia to start Interstitial ${c}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const g=c.assetList[i];if(!g){this.advanceAfterAssetEnded(c,e,i||0);return}if(p||(p=this.getAssetPlayer(g.identifier)),p===null||p.destroyed){const m=c.assetList.length;this.warn(`asset ${i+1}/${m} player destroyed ${c}`),p=this.createAssetPlayer(c,g,i),p.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&c.appendInPlace&&this.isAssetBuffered(g))return;this.startAssetPlayer(p,i,t,e,u),this.shouldPlay&&Xa(p.media)}else a?(this.resumePrimary(a,e,s),this.shouldPlay&&Xa(this.hls.media)):r&&this.isInterstitial(s)&&(this.endedItem=null,this.playingItem=s,s.event.appendInPlace||this.attachPrimary(o.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e;return(e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var s,r;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${He(e)}`),!((s=this.detachedData)!=null&&s.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.log(bi("resumePrimary",a)),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const o=(r=this.schedule)==null?void 0:r.items;o&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${He(e)}`),this.hls.trigger(T.INTERSTITIALS_PRIMARY_RESUMED,{schedule:o.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const s=this.primaryDetails;if(t===0)return this.hls.startPosition;if(s&&(i<s.fragmentStart||i>s.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:Q.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const s=this.primaryMedia;if(!s)return;const r=this.hls;r.media?this.checkBuffer():(this.transferMediaTo(r,s),i&&this.startLoadingPrimaryAt(e,i)),i||(this.log(bi("attachPrimary",e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const s=this.hls;!s.loadingEnabled||!s.media||Math.abs((((i=s.mainForwardBufferInfo)==null?void 0:i.start)||s.media.currentTime)-e)>.5?s.startLoad(e,t):s.bufferingEnabled||s.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(T.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(T.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const i=this.hls.levels[t.level];if(!i.details)return;const s=oe(oe({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=s,this.schedule.parseInterstitialDateRanges(s,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=oe(oe({},this.altSelection),{},{audio:i});return}const r=oe(oe({},s),{},{audio:i});this.mediaSelection=r}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=oe(oe({},this.altSelection),{},{subtitles:i});return}const r=oe(oe({},s),{},{subtitles:i});this.mediaSelection=r}onAudioTrackSwitching(e,t){const i=ra(t);this.playerQueue.forEach(({hls:s})=>s&&(s.setAudioOption(t)||s.setAudioOption(i)))}onSubtitleTrackSwitch(e,t){const i=ra(t);this.playerQueue.forEach(({hls:s})=>s&&(s.setSubtitleOption(t)||t.id!==-1&&s.setSubtitleOption(i)))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const s=this.timelinePos;this.bufferedPos=s,this.checkBuffer()}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let s=0;s<t.length;s++){const r=t[s];if(r.cue.post){var i;const o=this.schedule.findEventIndex(r.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){var i;const s=(i=this.schedule)==null?void 0:i.items;if(e&&s){const r=this.findItemIndex(e,t);return s[r]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((r,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(r.identifier,null)});const i=e.end+.25,s=Q.bufferInfo(this.primaryMedia,i,0);(s.end>i||(s.nextStart||0)>i)&&(this.log(`trim buffered interstitial ${He(e)} (was ${He(t)})`),this.attachPrimary(i,null,!0),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;const i=this.mediaSelection;i&&((t=this.schedule)==null||t.updateSchedule(i,[],e))}checkBuffer(e){var t;const i=(t=this.schedule)==null?void 0:t.items;if(!i)return;const s=Q.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=s.len<1),this.updateBufferedPos(s.end,i,e)}updateBufferedPos(e,t,i){const s=this.schedule,r=this.bufferingItem;if(this.bufferedPos>e||!s)return;if(t.length===1&&this.itemsMatch(t[0],r)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let u=s.findItemIndexAtTime(e);if(this.bufferedPos<e){var l;const c=this.findItemIndex(r),f=Math.min(c+1,t.length-1),p=t[f];if((u===-1&&r&&e>=r.end||(l=p.event)!=null&&l.appendInPlace&&e+.01>=p.start)&&(u=f),this.isInterstitial(r)){const g=r.event;if(f-a>1&&g.appendInPlace===!1||g.assetList.length===0&&g.assetListLoader)return}if(this.bufferedPos=e,u>c&&u>a)this.bufferedToItem(p);else{const g=this.primaryDetails;this.primaryLive&&g&&e>g.edge-g.targetduration&&p.start<g.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(p)&&this.preloadAssets(p.event,0)}}else i&&o&&!this.itemsMatch(o,r)&&(u===a?this.bufferedToItem(o):u===a+1&&this.bufferedToItem(t[u]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(s=>{const r=this.getAssetPlayer(s.identifier);return!(r!=null&&r.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(!this.itemsMatch(e,t)&&i){const{items:s,events:r}=i;if(!s||!r)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const u=a?a.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${He(e)}`+(t?` (${u.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(o){const l=i.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((c,f)=>{const p=this.getAssetPlayer(c.identifier);p&&(f===l&&p.loadSource(),p.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(l=>l.pauseBuffering());this.hls.trigger(T.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:r.slice(0),schedule:s.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const s=this.detachedData;s?s.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,s=i.assetList.length===0&&!i.assetListLoader,r=i.cue.once;if(s||!r){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(o,a)}}}preloadAssets(e,t){const i=e.assetUrl,s=e.assetList.length,r=s===0&&!e.assetListLoader,o=e.cue.once;if(r){const u=e.timelineStart;if(e.appendInPlace){var a;const p=this.playingItem;!this.isInterstitial(p)&&(p==null||(a=p.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(u+.25)}let l,c=0;if(!this.playingItem&&this.primaryLive&&(c=this.hls.startPosition,c===-1&&(c=this.hls.liveSyncPosition||0)),c&&!(e.cue.pre||e.cue.post)){const p=c-u;p>0&&(l=Math.round(p*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:s} ${e}${l?` live-start: ${c} start-offset: ${l}`:""}`),i)return this.createAsset(e,0,0,u,e.duration,i);const f=this.assetListLoader.loadAssetList(e,l);f&&(e.assetListLoader=f)}else if(!o&&s){for(let l=t;l<s;l++){const c=e.assetList[l],f=this.getAssetPlayerQueueIndex(c.identifier);(f===-1||this.playerQueue[f].destroyed)&&!c.error&&this.createAssetPlayer(e,c,l)}const u=e.assetList[t];if(u){const l=this.getAssetPlayer(u.identifier);return l&&l.loadSource(),l}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(s=>{this.hls.trigger(T.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:s})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,s,r,o){const a={parentIdentifier:e.identifier,identifier:Hv(e,o,t),duration:r,startOffset:i,timelineStart:s,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const s=this.hls,r=s.userConfig;let o=r.videoPreference;const a=s.loadLevelObj||s.levels[s.currentLevel];(o||a)&&(o=le({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const u=s.audioTracks[s.audioTrack],l=s.subtitleTracks[s.subtitleTrack];let c=0;if(this.primaryLive||e.appendInPlace){const _=this.timelinePos-t.timelineStart;if(_>1){const I=t.duration;I&&_<I&&(c=_)}}const f=t.identifier,p=oe(oe({},r),{},{maxMaxBufferLength:Math.min(180,s.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:s.sessionId,assetPlayerId:f,abrEwmaDefaultEstimate:s.bandwidthEstimate,interstitialsController:void 0,startPosition:c,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:u||r.audioPreference,subtitlePreference:l||r.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(p.timelineOffset=t.timelineStart));const g=p.cmcd;g!=null&&g.sessionId&&g.contentId&&(p.cmcd=le({},g,{contentId:ai(t.uri)})),this.getAssetPlayer(f)&&this.warn(`Duplicate date range identifier ${e} and asset ${f}`);const m=new Yv(this.HlsPlayerClass,p,e,t);this.playerQueue.push(m),e.assetList[i]=t;let E=!0;const y=_=>{if(_.live){var I;const L=new Error(`Interstitials MUST be VOD assets ${e}`),C={fatal:!0,type:W.OTHER_ERROR,details:b.INTERSTITIAL_ASSET_ITEM_ERROR,error:L},x=((I=this.schedule)==null?void 0:I.findEventIndex(e.identifier))||-1;this.handleAssetItemError(C,e,x,i,L.message);return}const P=_.edge-_.fragmentStart,R=t.duration;(E||R===null||P>R)&&(E=!1,this.log(`Interstitial asset "${f}" duration change ${R} > ${P}`),t.duration=P,this.updateSchedule())};m.on(T.LEVEL_UPDATED,(_,{details:I})=>y(I)),m.on(T.LEVEL_PTS_UPDATED,(_,{details:I})=>y(I)),m.on(T.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const v=(_,I)=>{const P=this.getAssetPlayer(f);if(P&&I.tracks){P.off(T.BUFFER_CODECS,v),P.tracks=I.tracks;const R=this.primaryMedia;this.bufferingAsset===P.assetItem&&R&&!P.media&&this.bufferAssetPlayer(P,R)}};m.on(T.BUFFER_CODECS,v);const S=()=>{var _;const I=this.getAssetPlayer(f);if(this.log(`buffered to end of asset ${I}`),!I||!this.schedule)return;const P=this.schedule.findEventIndex(e.identifier),R=(_=this.schedule.items)==null?void 0:_[P];this.isInterstitial(R)&&this.advanceAssetBuffering(R,t)};m.on(T.BUFFERED_TO_END,S);const A=_=>()=>{if(!this.getAssetPlayer(f)||!this.schedule)return;this.shouldPlay=!0;const P=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,P,_)};return m.once(T.MEDIA_ENDED,A(i)),m.once(T.PLAYOUT_LIMIT_REACHED,A(1/0)),m.on(T.ERROR,(_,I)=>{if(!this.schedule)return;const P=this.getAssetPlayer(f);if(I.details===b.BUFFER_STALLED_ERROR){if(P!=null&&P.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${I.error} ${e}`)}),m.on(T.DESTROYING,()=>{if(!this.getAssetPlayer(f)||!this.schedule)return;const I=new Error(`Asset player destroyed unexpectedly ${f}`),P={fatal:!0,type:W.OTHER_ERROR,details:b.INTERSTITIAL_ASSET_ITEM_ERROR,error:I};this.handleAssetItemError(P,e,this.schedule.findEventIndex(e.identifier),i,I.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${Ut(t)}`),this.hls.trigger(T.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:m}),m}clearInterstitial(e,t){this.clearAssetPlayers(e,t),e.reset()}clearAssetPlayers(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)})}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){const s=this.playerQueue[i];this.log(`clear ${s} toSegment: ${t&&He(t)}`),this.transferMediaFromPlayer(s,t),this.playerQueue.splice(i,1),s.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,s,r){const{interstitial:o,assetItem:a,assetId:u}=e,l=o.assetList.length,c=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!c||c.identifier!==u)&&(c&&(this.clearAssetPlayer(c.identifier,i[s]),delete c.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${l} ${Ut(a)}`),this.hls.trigger(T.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:s,player:e})),this.bufferAssetPlayer(e,r)}bufferAssetPlayer(e,t){var i,s;if(!this.schedule)return;const{interstitial:r,assetItem:o}=e,a=this.schedule.findEventIndex(r.identifier),u=(i=this.schedule.items)==null?void 0:i[a];if(!u)return;e.loadSource(),this.setBufferingItem(u),this.bufferingAsset=o;const l=this.getBufferingPlayer();if(l===e)return;const c=r.appendInPlace;if(c&&(l==null?void 0:l.interstitial.appendInPlace)===!1)return;const f=(l==null?void 0:l.tracks)||((s=this.detachedData)==null?void 0:s.tracks)||this.requiredTracks;if(c&&o!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(f&&!iu(f,e.tracks)){const p=new Error(`Asset ${Ut(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(f)}')`),g={fatal:!0,type:W.OTHER_ERROR,details:b.INTERSTITIAL_ASSET_ITEM_ERROR,error:p},m=r.findAssetIndex(o);this.handleAssetItemError(g,r,a,m,p.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){const t=this.schedule,i=this.primaryMedia;if(!t||!i)return;const s=i.currentTime,r=t.findAssetIndex(e,s),o=e.assetList[r];if(o){const a=this.getAssetPlayer(o.identifier);if(a){const u=a.currentTime||s-o.timelineStart,l=a.duration-u;if(this.warn(`Stalled at ${u} of ${u+l} in ${a} ${e} (media.currentTime: ${s})`),u&&(l/i.playbackRate<.5||a.bufferedInPlaceToEnd(i))&&a.hls){const c=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,c,r)}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,i,s,r){if(e.details===b.BUFFER_STALLED_ERROR)return;const o=t.assetList[s]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&Ut(o)} ${e.error}`),!this.schedule)return;const a=(o==null?void 0:o.identifier)||"",u=this.getAssetPlayerQueueIndex(a),l=this.playerQueue[u]||null,c=this.schedule.items,f=le({},e,{fatal:!1,errorAction:Ht(!0),asset:o,assetListIndex:s,event:t,schedule:c,scheduleIndex:i,player:l});if(this.hls.trigger(T.INTERSTITIAL_ASSET_ERROR,f),!e.fatal)return;const p=this.playingAsset,g=this.bufferingAsset,m=new Error(r);if(o&&(this.clearAssetPlayer(a,null),o.error=m),!t.assetList.some(E=>!E.error))t.error=m;else for(let E=s;E<t.assetList.length;E++)this.resetAssetPlayer(t.assetList[E].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):p&&p.identifier===a?this.advanceAfterAssetEnded(t,i,s):g&&g.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,g)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;let s=this.timelinePos;if(i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${s} playing: ${He(i)} error: ${e.error}`),s===-1&&(s=this.hls.startPosition);const o=this.updateItem(i,s);this.itemsMatch(i,o)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}else if(s===-1){this.checkStart();return}if(!this.schedule)return;const r=this.schedule.findItemIndexAtTime(s);this.setSchedulePosition(r)}onAssetListLoaded(e,t){var i,s;const r=t.event,o=r.identifier,a=t.assetListResponse.ASSETS;if(!((i=this.schedule)!=null&&i.hasEvent(o)))return;const u=r.timelineStart,l=r.duration;let c=0;a.forEach((E,y)=>{const v=parseFloat(E.DURATION);this.createAsset(r,y,c,u+c,v,E.URI),c+=v}),r.duration=c,this.log(`Loaded asset-list with duration: ${c} (was: ${l}) ${r}`);const f=this.waitingItem,p=(f==null?void 0:f.event.identifier)===o;this.updateSchedule();const g=(s=this.bufferingItem)==null?void 0:s.event;if(p){var m;const E=this.schedule.findEventIndex(o),y=(m=this.schedule.items)==null?void 0:m[E];if(y){if(!this.playingItem&&this.timelinePos>y.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==E){r.error=new Error(`Interstitial ${a.length?"no longer within playback range":"asset-list is empty"} ${this.timelinePos} ${r}`),this.log(r.error.message),this.updateSchedule(!0),this.primaryFallback(r);return}this.setBufferingItem(y)}this.setSchedulePosition(E)}else if((g==null?void 0:g.identifier)===o){const E=r.assetList[0];if(E){const y=this.getAssetPlayer(E.identifier);if(g.appendInPlace){const v=this.primaryMedia;y&&v&&this.bufferAssetPlayer(y,v)}else y&&y.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case b.ASSET_LIST_PARSING_ERROR:case b.ASSET_LIST_LOAD_ERROR:case b.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&(this.updateSchedule(!0),this.primaryFallback(i));break}case b.BUFFER_STALLED_ERROR:{const i=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&i.event.appendInPlace){this.handleInPlaceStall(i.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const Qa=500;class Xv extends zs{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",K.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(T.LEVEL_LOADED,this.onLevelLoaded,this),e.on(T.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(T.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(T.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(T.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(T.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(T.LEVEL_LOADED,this.onLevelLoaded,this),e.off(T.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(T.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(T.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(T.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(T.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=k.IDLE,this.setInterval(Qa),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(this.fragContextChanged(i)||(pe(i)&&(this.fragPrevious=i),this.state=k.IDLE),!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let o;const a=i.start;for(let l=0;l<r.length;l++)if(a>=r[l].start&&a<=r[l].end){o=r[l];break}const u=i.start+i.duration;o?o.end=u:(o={start:a,end:u},r.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=r){o.shift();continue}else if(o[a].start<r)o[a].start=r;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,r,K.SUBTITLE)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===K.SUBTITLE&&(t.details===b.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==k.STOPPED&&(this.state=k.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&rc(this.levels,t)){this.levels=t.map(i=>new di(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new di(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,K.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.state!==k.STOPPED&&this.setInterval(Qa)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:s,levels:r}=this,{details:o,id:a}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const u=r[a];if(a>=r.length||!u)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(o.live||(i=u.details)!=null&&i.live){if(o.deltaUpdateFailed)return;const f=this.mainDetails;if(!f){this.startFragRequested=!1;return}const p=f.fragments[0];if(!u.details)o.hasProgramDateTime&&f.hasProgramDateTime?(ln(o,f),l=o.fragmentStart):p&&(l=p.start,Es(o,l));else{var c;l=this.alignPlaylists(o,u.details,(c=this.levelLastLoaded)==null?void 0:c.details),l===0&&p&&(l=p.start,Es(o,l))}f&&!this.startFragRequested&&this.setStartPosition(f,l)}u.details=o,this.levelLastLoaded=u,a===s&&(this.hls.trigger(T.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===k.IDLE&&(Lt(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),u.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&Kt(s.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer,Ws(s.method)).catch(a=>{throw r.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const u=performance.now();r.trigger(T.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:u}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=k.IDLE})}}doTick(){if(!this.media){this.state=k.IDLE;return}if(this.state===k.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:s}=this,r=this.getLoadPosition(),o=Q.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:a,len:u}=o,l=i.details,c=this.hls.maxBufferLength+l.levelTargetDuration;if(u>c)return;const f=l.fragments,p=f.length,g=l.edge;let m=null;const E=this.fragPrevious;if(a<g){const S=s.maxFragLookUpTolerance,A=a>g-S?0:S;m=Lt(E,f,Math.max(f[0].start,a),A),!m&&E&&E.start<f[0].start&&(m=f[0])}else m=f[p-1];if(m=this.filterReplacedPrimary(m,i.details),!m)return;const y=m.sn-l.startSN,v=f[y-1];if(v&&v.cc===m.cc&&this.fragmentTracker.getState(v)===me.NOT_LOADED&&(m=v),this.fragmentTracker.getState(m)===me.NOT_LOADED){const S=this.mapToInitFragWhenRequired(m);S&&this.loadFragment(S,i,a)}}}loadFragment(e,t,i){pe(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Qv(this.tracksBuffered[this.currentTrackId]||[])}}class Qv{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const Zv={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Sc=n=>String.fromCharCode(Zv[n]||n),Ke=15,st=100,jv={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},eS={17:2,18:4,21:6,22:8,23:10,19:13,20:15},tS={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},iS={25:2,26:4,29:6,30:8,31:10,27:13,28:15},nS=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class sS{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;ae.log(`${this.time} [${e}] ${i}`)}}}const It=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Ac{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class rS{constructor(){this.uchar=" ",this.penState=new Ac}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class oS{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Ac,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<st;t++)this.chars.push(new rS);this.logger=e}equals(e){for(let t=0;t<st;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<st;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<st;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>st&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=st)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Sc(e);if(this.pos>=st){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<st;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<st;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class $n{constructor(e){this.rows=[],this.currRow=Ke-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Ke;t++)this.rows.push(new oS(e));this.logger=e}reset(){for(let e=0;e<Ke;e++)this.rows[e].clear();this.currRow=Ke-1}equals(e){let t=!0;for(let i=0;i<Ke;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Ke;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Ke;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+ce(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<Ke;a++)this.rows[a].clear();const r=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[r].cueStartTime,u=this.logger.time;if(a!==null&&u!==null&&a<u)for(let l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(o.rows[r+l])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,o=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+ce(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<Ke;r++){const o=this.rows[r].getTextString();o&&(s=r+1,e?t.push("Row "+s+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Za{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new $n(i),this.nonDisplayedMemory=new $n(i),this.lastOutputScreen=new $n(i),this.currRollUpRow=this.displayedMemory.rows[Ke-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Ke-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+ce(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class ja{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=lS(),this.logger=void 0;const s=this.logger=new sS;this.channels=[null,new Za(e,t,s),new Za(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const s=t[i]&127,r=t[i+1]&127;let o=!1,a=null;if(s===0&&r===0)continue;this.logger.log(3,()=>"["+It([t[i],t[i+1]])+"] -> ("+It([s,r])+")");const u=this.cmdHistory;if(s>=16&&s<=31){if(aS(s,r,u)){wi(null,null,u),this.logger.log(3,()=>"Repeated command ("+It([s,r])+") is dropped");continue}wi(s,r,this.cmdHistory),o=this.parseCmd(s,r),o||(o=this.parseMidrow(s,r)),o||(o=this.parsePAC(s,r)),o||(o=this.parseBackgroundAttributes(s,r))}else wi(null,null,u);if(!o&&(a=this.parseChars(s,r),a)){const c=this.currentChannel;c&&c>0?this.channels[c].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+It([s,r])+" orig: "+It([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=33&&t<=35;if(!(i||s))return!1;const r=e===20||e===21||e===23?1:2,o=this.channels[r];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+It([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(s||r))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?jv[e]:tS[e]:i=o===1?eS[e]:iS[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let o;r===17?o=t+80:r===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+Sc(o)+"' in channel "+i),s=[o]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);return s&&this.logger.log(3,()=>"Char codes =  "+It(s).join(",")),s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const o={};e===16||e===24?(r=Math.floor((t-32)/2),o.background=nS[r],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}wi(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function wi(n,e,t){t.a=n,t.b=e}function aS(n,e,t){return t.a===n&&t.b===e}function lS(){return{a:null,b:null}}var ar=(function(){if(an!=null&&an.VTTCue)return self.VTTCue;const n=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,u){if(typeof u!="string"||!Array.isArray(a))return!1;const l=u.toLowerCase();return~a.indexOf(l)?l:!1}function i(a){return t(n,a)}function s(a){return t(e,a)}function r(a,...u){let l=1;for(;l<arguments.length;l++){const c=arguments[l];for(const f in c)a[f]=c[f]}return a}function o(a,u,l){const c=this,f={enumerable:!0};c.hasBeenReset=!1;let p="",g=!1,m=a,E=u,y=l,v=null,S="",A=!0,_="auto",I="start",P=50,R="middle",L=50,C="middle";Object.defineProperty(c,"id",r({},f,{get:function(){return p},set:function(x){p=""+x}})),Object.defineProperty(c,"pauseOnExit",r({},f,{get:function(){return g},set:function(x){g=!!x}})),Object.defineProperty(c,"startTime",r({},f,{get:function(){return m},set:function(x){if(typeof x!="number")throw new TypeError("Start time must be set to a number.");m=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"endTime",r({},f,{get:function(){return E},set:function(x){if(typeof x!="number")throw new TypeError("End time must be set to a number.");E=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"text",r({},f,{get:function(){return y},set:function(x){y=""+x,this.hasBeenReset=!0}})),Object.defineProperty(c,"region",r({},f,{get:function(){return v},set:function(x){v=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"vertical",r({},f,{get:function(){return S},set:function(x){const w=i(x);if(w===!1)throw new SyntaxError("An invalid or illegal string was specified.");S=w,this.hasBeenReset=!0}})),Object.defineProperty(c,"snapToLines",r({},f,{get:function(){return A},set:function(x){A=!!x,this.hasBeenReset=!0}})),Object.defineProperty(c,"line",r({},f,{get:function(){return _},set:function(x){if(typeof x!="number"&&x!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");_=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"lineAlign",r({},f,{get:function(){return I},set:function(x){const w=s(x);if(!w)throw new SyntaxError("An invalid or illegal string was specified.");I=w,this.hasBeenReset=!0}})),Object.defineProperty(c,"position",r({},f,{get:function(){return P},set:function(x){if(x<0||x>100)throw new Error("Position must be between 0 and 100.");P=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"positionAlign",r({},f,{get:function(){return R},set:function(x){const w=s(x);if(!w)throw new SyntaxError("An invalid or illegal string was specified.");R=w,this.hasBeenReset=!0}})),Object.defineProperty(c,"size",r({},f,{get:function(){return L},set:function(x){if(x<0||x>100)throw new Error("Size must be between 0 and 100.");L=x,this.hasBeenReset=!0}})),Object.defineProperty(c,"align",r({},f,{get:function(){return C},set:function(x){const w=s(x);if(!w)throw new SyntaxError("An invalid or illegal string was specified.");C=w,this.hasBeenReset=!0}})),c.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o})();class uS{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function Ic(n){function e(i,s,r,o){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(o||0)}const t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class cS{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function _c(n,e,t,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const o=s[r].split(t);if(o.length!==2)continue;const a=o[0],u=o[1];e(a,u)}}const xs=new ar(0,0,""),ki=xs.align==="middle"?"middle":"center";function dS(n,e,t){const i=n;function s(){const a=Ic(n);if(a===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),a}function r(a,u){const l=new cS;_c(a,function(p,g){let m;switch(p){case"region":for(let E=t.length-1;E>=0;E--)if(t[E].id===g){l.set(p,t[E].region);break}break;case"vertical":l.alt(p,g,["rl","lr"]);break;case"line":m=g.split(","),l.integer(p,m[0]),l.percent(p,m[0])&&l.set("snapToLines",!1),l.alt(p,m[0],["auto"]),m.length===2&&l.alt("lineAlign",m[1],["start",ki,"end"]);break;case"position":m=g.split(","),l.percent(p,m[0]),m.length===2&&l.alt("positionAlign",m[1],["start",ki,"end","line-left","line-right","auto"]);break;case"size":l.percent(p,g);break;case"align":l.alt(p,g,["start",ki,"end","left","right"]);break}},/:/,/\s/),u.region=l.get("region",null),u.vertical=l.get("vertical","");let c=l.get("line","auto");c==="auto"&&xs.line===-1&&(c=-1),u.line=c,u.lineAlign=l.get("lineAlign","start"),u.snapToLines=l.get("snapToLines",!0),u.size=l.get("size",100),u.align=l.get("align",ki);let f=l.get("position","auto");f==="auto"&&xs.position===50&&(f=u.align==="start"||u.align==="left"?0:u.align==="end"||u.align==="right"?100:50),u.position=f}function o(){n=n.replace(/^\s+/,"")}if(o(),e.startTime=s(),o(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),o(),e.endTime=s(),o(),r(n,e)}function Rc(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class fS{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new uS,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,o=0;for(r=Rc(r);o<r.length&&r[o]!=="\r"&&r[o]!==`
`;)++o;const a=r.slice(0,o);return r[o]==="\r"&&++o,r[o]===`
`&&++o,t.buffer=r.slice(o),a}function s(r){_c(r,function(o,a){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const a=r.match(/^()?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new ar(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{dS(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=r.indexOf("-->")!==-1;if(!r||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const hS=/\r\n|\n\r|\n|\r/g,Gn=function(e,t,i=0){return e.slice(i,i+t.length)===t},pS=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!V(t)||!V(i)||!V(s)||!V(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=3600*1e3*r,t};function lr(n,e,t){return ai(n.toString())+ai(e.toString())+ai(t)}const gS=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(o=r)!=null&&o.new;){var o;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function mS(n,e,t,i,s,r,o){const a=new fS,u=Ne(new Uint8Array(n)).trim().replace(hS,`
`).split(`
`),l=[],c=e?AT(e.baseTime,e.timescale):0;let f="00:00.000",p=0,g=0,m,E=!0;a.oncue=function(y){const v=t[i];let S=t.ccOffset;const A=(p-c)/9e4;if(v!=null&&v.new&&(g!==void 0?S=t.ccOffset=v.start:gS(t,i,A)),A){if(!e){m=new Error("Missing initPTS for VTT MPEGTS");return}S=A-t.presentationOffset}const _=y.endTime-y.startTime,I=ke((y.startTime+S-g)*9e4,s*9e4)/9e4;y.startTime=Math.max(I,0),y.endTime=Math.max(I+_,0);const P=y.text.trim();y.text=decodeURIComponent(encodeURIComponent(P)),y.id||(y.id=lr(y.startTime,y.endTime,P)),y.endTime>0&&l.push(y)},a.onparsingerror=function(y){m=y},a.onflush=function(){if(m){o(m);return}r(l)},u.forEach(y=>{if(E)if(Gn(y,"X-TIMESTAMP-MAP=")){E=!1,y.slice(16).split(",").forEach(v=>{Gn(v,"LOCAL:")?f=v.slice(6):Gn(v,"MPEGTS:")&&(p=parseInt(v.slice(7)))});try{g=pS(f)/1e3}catch(v){m=v}return}else y===""&&(E=!1);a.parse(y+`
`)}),a.flush()}const Vn="stpp.ttml.im1t",xc=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Cc=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,yS={left:"start",center:"center",right:"end",start:"start",end:"end"};function el(n,e,t,i){const s=ee(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(a=>Ne(a)),o=ST(e.baseTime,1,e.timescale);try{r.forEach(a=>t(ES(a,o)))}catch(a){i(a)}}function ES(n,e){const s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(r).reduce((f,p)=>(f[p]=s.getAttribute(`ttp:${p}`)||r[p],f),{}),a=s.getAttribute("xml:space")!=="preserve",u=tl(Hn(s,"styling","style")),l=tl(Hn(s,"layout","region")),c=Hn(s,"body","[begin]");return[].map.call(c,f=>{const p=Lc(f,a);if(!p||!f.hasAttribute("begin"))return null;const g=qn(f.getAttribute("begin"),o),m=qn(f.getAttribute("dur"),o);let E=qn(f.getAttribute("end"),o);if(g===null)throw il(f);if(E===null){if(m===null)throw il(f);E=g+m}const y=new ar(g-e,E-e,p);y.id=lr(y.startTime,y.endTime,y.text);const v=l[f.getAttribute("region")],S=u[f.getAttribute("style")],A=TS(v,S,u),{textAlign:_}=A;if(_){const I=yS[_];I&&(y.lineAlign=I),y.align=_}return le(y,A),y}).filter(f=>f!==null)}function Hn(n,e,t){const i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function tl(n){return n.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Lc(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?Lc(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function TS(n,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(s=t[o]),r.reduce((a,u)=>{const l=Kn(e,i,u)||Kn(n,i,u)||Kn(s,i,u);return l&&(a[u]=l),a},{})}function Kn(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function il(n){return new Error(`Could not parse ttml timestamp ${n}`)}function qn(n,e){if(!n)return null;let t=Ic(n);return t===null&&(xc.test(n)?t=vS(n,e):Cc.test(n)&&(t=SS(n,e))),t}function vS(n,e){const t=xc.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function SS(n,e){const t=Cc.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class Mi{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class AS{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=sl(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(T.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(T.FRAG_LOADING,this.onFragLoading,this),e.on(T.FRAG_LOADED,this.onFragLoaded,this),e.on(T.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(T.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(T.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(T.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(T.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(T.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(T.FRAG_LOADING,this.onFragLoading,this),e.off(T.FRAG_LOADED,this.onFragLoaded,this),e.off(T.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(T.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(T.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(T.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(T.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Mi(this,"textTrack1"),t=new Mi(this,"textTrack2"),i=new Mi(this,"textTrack3"),s=new Mi(this,"textTrack4");this.cea608Parser1=new ja(1,e,t),this.cea608Parser2=new ja(3,i,s)}addCues(e,t,i,s,r){let o=!1;for(let a=r.length;a--;){const u=r[a],l=IS(u[0],u[1],t,i);if(l>=0&&(u[0]=Math.min(u[0],t),u[1]=Math.max(u[1],i),o=!0,l/(i-t)>.5))return}if(o||r.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,s)}else{const a=this.Cues.newCue(null,t,i,s);this.hls.trigger(T.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r,trackId:o}){const{unparsedVttFrags:a}=this;i===K.MAIN&&(this.initPTS[t.cc]={baseTime:s,timescale:r,trackId:o}),a.length&&(this.unparsedVttFrags=[],a.forEach(u=>{this.initPTS[u.frag.cc]?this.onFragLoaded(T.FRAG_LOADED,u):this.hls.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:u.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(nl(r,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:o}=t[e],a=this.getExistingTrack(r,o);if(a)i[e]=a,$t(i[e]),Ec(i[e],s);else{const u=this.createTextTrack("captions",r,o);u&&(u[e]=!0,i[e]=u)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(T.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:s}=this;Object.keys(s).forEach(r=>{$t(s[r]),delete s[r]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=sl(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)$t(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===Vn);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(rc(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?qi(o.textTracks):null;if(this.tracks.forEach((u,l)=>{let c;if(a){let f=null;for(let p=0;p<a.length;p++)if(a[p]&&nl(a[p],u)){f=a[p],a[p]=null;break}f&&(c=f)}if(c)$t(c);else{const f=Pc(u);c=this.createTextTrack(f,u.name,u.lang),c&&(c.mode="disabled")}c&&this.textTracks.push(c)}),a!=null&&a.length){const u=a.filter(l=>l!==null).map(l=>l.label);u.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${u.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(T.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,o=this.captionsProperties[r];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===K.MAIN){var i,s;const{cea608Parser1:r,cea608Parser2:o,lastSn:a}=this,{cc:u,sn:l}=t.frag,c=(i=(s=t.part)==null?void 0:s.index)!=null?i:-1;r&&o&&(l!==a+1||l===a&&c!==this.lastPartIndex+1||u!==this.lastCc)&&(r.reset(),o.reset()),this.lastCc=u,this.lastSn=l,this.lastPartIndex=c}}onFragLoaded(e,t){const{frag:i,payload:s}=t;if(i.type===K.SUBTITLE)if(s.byteLength){const r=i.decryptdata,o="stats"in t;if(r==null||!r.encrypted||o){const a=this.tracks[i.level],u=this.vttCCs;u[i.cc]||(u[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Vn?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;el(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{i.logger.log(`Failed to parse IMSC1: ${s}`),i.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;const{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:o}=this,a=r.length-1;if(!r[i.cc]&&a===-1){o.push(e);return}const u=this.hls,l=(t=i.initSegment)!=null&&t.data?$e(i.initSegment.data,new Uint8Array(s)).buffer:s;mS(l,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,c=>{this._appendCues(c,i.level),u.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},c=>{const f=c.message==="Missing initPTS for VTT MPEGTS";f?o.push(e):this._fallbackToIMSC1(i,s),u.logger.log(`Failed to parse VTT cue: ${c}`),!(f&&a>i.cc)&&u.trigger(T.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:c})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||el(t,this.initPTS[e.cc],()=>{i.textCodec=Vn,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>Tc(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(T.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===K.SUBTITLE&&this.onFragLoaded(T.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:s}=t;if(!(i.type===K.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let r=0;r<s.length;r++){const o=s[r].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(s[r].pts,a[0]),this.cea608Parser2.addData(s[r].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!r||r==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(u=>Rs(a[u],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(u=>Rs(a[u],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const o=e[s++],a=127&e[s++],u=127&e[s++];if(a===0&&u===0)continue;if((4&o)!==0){const c=3&o;(c===0||c===1)&&(t[c].push(a),t[c].push(u))}}return t}}function Pc(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function nl(n,e){return!!n&&n.kind===Pc(e)&&Ss(e,n)}function IS(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function sl(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const _S=/\s/,RS={newCue(n,e,t,i){const s=[];let r,o,a,u,l;const c=self.VTTCue||self.TextTrackCue;for(let p=0;p<i.rows.length;p++)if(r=i.rows[p],a=!0,u=0,l="",!r.isEmpty()){var f;for(let E=0;E<r.chars.length;E++)_S.test(r.chars[E].uchar)&&a?u++:(l+=r.chars[E].uchar,a=!1);r.cueStartTime=e,e===t&&(t+=1e-4),u>=16?u--:u++;const g=Rc(l.trim()),m=lr(e,t,g);n!=null&&(f=n.cues)!=null&&f.getCueById(m)||(o=new c(e,t,g),o.id=m,o.line=p+1,o.align="left",o.position=10+Math.min(80,Math.floor(u*8/32)*10),s.push(o))}return n&&s.length&&(s.sort((p,g)=>p.line==="auto"||g.line==="auto"?0:p.line>8&&g.line>8?g.line-p.line:p.line-g.line),s.forEach(p=>Tc(n,p))),s}};function xS(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const CS=/(\d+)-(\d+)\/(\d+)/;class rl{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||bS,this.controller=new self.AbortController,this.stats=new $s}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=LS(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:u,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=u&&V(u)?u:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},t.timeout),(pi(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(f=>{var p;this.response=this.loader=f;const g=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(s,e,this.response))},l-(g-s.loading.start)),!f.ok){const{status:E,statusText:y}=f;throw new wS(y||"fetch, bad network response",E,f)}s.loading.first=g,s.total=DS(f.headers)||s.total;const m=(p=this.callbacks)==null?void 0:p.onProgress;return m&&V(t.highWaterMark)?this.loadProgressively(f,s,e,t.highWaterMark,m):o?f.arrayBuffer():e.responseType==="json"?f.json():f.text()}).then(f=>{var p,g;const m=this.response;if(!m)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const E=f[a];E&&(s.loaded=s.total=E);const y={url:m.url,data:f,code:m.status},v=(p=this.callbacks)==null?void 0:p.onProgress;v&&!V(t.highWaterMark)&&v(s,e,f,m),(g=this.callbacks)==null||g.onSuccess(y,s,e,m)}).catch(f=>{var p;if(self.clearTimeout(this.requestTimeout),s.aborted)return;const g=f&&f.code||0,m=f?f.message:null;(p=this.callbacks)==null||p.onError({code:g,text:m},e,f?f.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const o=new Bu,a=e.body.getReader(),u=()=>a.read().then(l=>{if(l.done)return o.dataLength&&r(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const c=l.value,f=c.length;return t.loaded+=f,f<s||o.dataLength?(o.push(c),o.dataLength>=s&&r(t,i,o.flush().buffer,e)):r(t,i,c.buffer,e),u()}).catch(()=>Promise.reject());return u()}}function LS(n,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(le({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function PS(n){const e=CS.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function DS(n){const e=n.get("Content-Range");if(e){const i=PS(e);if(V(i))return i}const t=n.get("Content-Length");if(t)return parseInt(t)}function bS(n,e){return new self.Request(n.url,e)}class wS extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const kS=/^age:\s*[\d.]+\s*$/im;class Dc{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new $s,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:o}=i.loadPolicy;if(s)for(const a in s)e.setRequestHeader(a,s[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&V(r)?r:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const l=t.status,c=t.responseType==="text"?t.responseText:null;if(l>=200&&l<300){const m=c??t.response;if(m!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const E=t.responseType==="arraybuffer"?m.byteLength:m.length;i.loaded=i.total=E,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const y=(o=this.callbacks)==null?void 0:o.onProgress;y&&y(i,e,m,t);const v={url:t.responseURL,data:m,code:l};(a=this.callbacks)==null||a.onSuccess(v,i,e,t);return}}const f=r.loadPolicy.errorRetry,p=i.retry,g={url:e.url,data:void 0,code:l};if(rn(f,p,!1,g))this.retry(f);else{var u;ae.error(`${l} while loading ${e.url}`),(u=this.callbacks)==null||u.onError({code:l,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(rn(e,t,!0))this.retry(e);else{var i;ae.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Ks(e,i.retry),i.retry++,ae.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&kS.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const MS={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},NS=oe(oe({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Dc,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Wy,bufferController:UT,capLevelController:sr,errorController:Zy,fpsController:Ov,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Lu,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:MS},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},FS()),{},{subtitleStreamController:Xv,subtitleTrackController:Gv,timelineController:AS,audioStreamController:kT,audioTrackController:MT,emeController:qt,cmcdController:Mv,contentSteeringController:Fv,interstitialsController:zv});function FS(){return{cueHandler:RS,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function US(n,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Cs(n),s=["manifest","level","frag"],r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return s.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,u=e[a]===void 0,l=[];r.forEach(c=>{const f=`${o}Loading${c}`,p=e[f];if(p!==void 0&&u){l.push(f);const g=i[a].default;switch(e[a]={default:g},c){case"TimeOut":g.maxLoadTimeMs=p,g.maxTimeToFirstByteMs=p;break;case"MaxRetry":g.errorRetry.maxNumRetry=p,g.timeoutRetry.maxNumRetry=p;break;case"RetryDelay":g.errorRetry.retryDelayMs=p,g.timeoutRetry.retryDelayMs=p;break;case"MaxRetryTimeout":g.errorRetry.maxRetryDelayMs=p,g.timeoutRetry.maxRetryDelayMs=p;break}}}),l.length&&t.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${a}": ${ce(e[a])}`)}),oe(oe({},i),e)}function Cs(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(Cs):Object.keys(n).reduce((e,t)=>(e[t]=Cs(n[t]),e),{}):n}function OS(n,e){const t=n.loader;t!==rl&&t!==Dc?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):xS()&&(n.loader=rl,n.progressive=!0,n.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const Yi=2,BS=.1,$S=.05,GS=100;class VS extends Iu{constructor(e,t){super("gap-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(T.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(GS),this.mediaSource=t.mediaSource;const i=this.media=t.media;Ce(i,"playing",this.onMediaPlaying),Ce(i,"waiting",this.onMediaWaiting),Ce(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(De(i,"playing",this.onMediaPlaying),De(i,"waiting",this.onMediaWaiting),De(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,s;const r=(i=this.hls)==null?void 0:i.config;if(!r)return;const o=this.media;if(!o)return;const{seeking:a}=o,u=this.seeking&&!a,l=!this.seeking&&a,c=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,r.nudgeOnVideoHole&&!c&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(l||u){u&&this.stallResolved(e);return}if(c){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(T.MEDIA_ENDED,{stalled:!1}));return}if(!Q.getBuffered(o).length){this.nudgeRetry=0;return}const f=Q.bufferInfo(o,e,0),p=f.nextStart||0,g=this.fragmentTracker;if(a&&g&&this.hls){const P=ol(this.hls.inFlightFragments,e),R=f.len>Yi,L=!p||P||p-e>Yi&&!g.getPartialFragment(e);if(R||L)return;this.moved=!1}const m=(s=this.hls)==null?void 0:s.latestLevelDetails;if(!this.moved&&this.stalled!==null&&g){if(!(f.len>0)&&!p)return;const R=Math.max(p,f.start||0)-e,C=!!(m!=null&&m.live)?m.targetduration*2:Yi,x=Ni(e,g);if(R>0&&(R<=C||x)){o.paused||this._trySkipBufferHole(x);return}}const E=r.detectStallWithCurrentTimeMs,y=self.performance.now(),v=this.waiting;let S=this.stalled;if(S===null)if(v>0&&y-v<E)S=this.stalled=v;else{this.stalled=y;return}const A=y-S;if(!a&&(A>=E||v)&&this.hls){var _;if(((_=this.mediaSource)==null?void 0:_.readyState)==="ended"&&!(m!=null&&m.live)&&Math.abs(e-((m==null?void 0:m.edge)||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(T.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(f),!this.media||!this.hls)return}const I=Q.bufferInfo(o,e,r.maxBufferHole);this._tryFixBufferStall(I,A,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(T.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const s=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&s&&s.length>1&&e>s.end(0)){const r=Q.bufferedInfo(Q.timeRangesToArray(this.buffered.audio),e,0);if(r.len>1&&t>=r.start){const o=Q.timeRangesToArray(s),a=Q.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const u=Q.bufferedInfo(o,e,0).bufferedIndex,l=o[a].end,c=o[a+1].start;if((u===-1||u>a)&&c-l<1&&e-l<2){const f=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${l} -> ${c} buffered index: ${u}`);this.warn(f.message),this.media.currentTime+=1e-6;let p=Ni(e,this.fragmentTracker);p&&"fragment"in p?p=p.fragment:p||(p=void 0);const g=Q.bufferInfo(this.media,e,0);this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:f,reason:f.message,frag:p,buffer:g.len,bufferInfo:g})}}}}}_tryFixBufferStall(e,t,i){var s,r;const{fragmentTracker:o,media:a}=this,u=(s=this.hls)==null?void 0:s.config;if(!a||!o||!u)return;const l=(r=this.hls)==null?void 0:r.latestLevelDetails,c=Ni(i,o);if((c||l!=null&&l.live&&i<l.fragmentStart)&&(this._trySkipBufferHole(c)||!this.media))return;const f=e.buffered,p=this.adjacentTraversal(e,i);(f&&f.length>1&&e.len>u.maxBufferHole||e.nextStart&&(e.nextStart-i<u.maxBufferHole||p))&&(t>u.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,s=e.nextStart;if(i&&s){const r=i.getFragAtPos(t,K.MAIN),o=i.getFragAtPos(s,K.MAIN);if(r&&o)return o.sn-r.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:s,stalled:r}=this;if(!s&&r!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${ce(e)})`);this.warn(o.message),t.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:r}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:s}=this,r=(t=this.hls)==null?void 0:t.config;if(!s||!i||!r)return 0;const o=s.currentTime,a=Q.bufferInfo(s,o,0),u=o<a.start?a.start:a.nextStart;if(u&&this.hls){const c=a.len<=r.maxBufferHole,f=a.len>0&&a.len<1&&s.readyState<3,p=u-o;if(p>0&&(c||f)){if(p>r.maxBufferHole){let m=!1;if(o===0){const E=i.getAppendedFrag(0,K.MAIN);E&&u<E.end&&(m=!0)}if(!m&&e){var l;if(!((l=this.hls.loadLevelObj)!=null&&l.details)||ol(this.hls.inFlightFragments,u))return 0;let y=!1,v=e.end;for(;v<u;){const S=Ni(v,i);if(S)v+=S.duration;else{y=!0;break}}if(y)return 0}}const g=Math.max(u+$S,o+BS);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${g}`),this.moved=!0,s.currentTime=g,!(e!=null&&e.gap)){const m=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${g}`),E={type:W.MEDIA_ERROR,details:b.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:m,reason:m.message,buffer:a.len,bufferInfo:a};e&&("fragment"in e?E.part=e:E.frag=e),this.hls.trigger(T.ERROR,E)}return g}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:s}=this,r=t==null?void 0:t.config;if(!i||!r)return 0;const o=i.currentTime;if(this.nudgeRetry++,s<r.nudgeMaxRetry){const a=o+(s+1)*r.nudgeOffset,u=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(u.message),i.currentTime=a,t.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_NUDGE_ON_STALL,error:u,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${r.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function ol(n,e){const t=al(n.main);if(t&&t.start<=e)return t;const i=al(n.audio);return i&&i.start<=e?i:null}function al(n){if(!n)return null;switch(n.state){case k.IDLE:case k.STOPPED:case k.ENDED:case k.ERROR:return null}return n.frag}function Ni(n,e){return e.getAppendedFrag(n,K.MAIN)||e.getPartialFragment(n)}const HS=.25;function Ls(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function Yn(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,ce(s?oe({type:s},i):i))}return r}const Fi=(()=>{const n=Ls();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class KS{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(T.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e&&(e.on(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(T.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(T.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(T.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(T.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var e;const t=(e=this.hls)==null?void 0:e.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&$t(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return Ec(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:i,enableID3MetadataCues:s}=this.hls.config;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=Ls();if(o)for(let a=0;a<r.length;a++){const u=r[a].type;if(u===Me.emsg&&!i||!s)continue;const l=Yu(r[a].data),c=r[a].pts;let f=c+r[a].duration;f>Fi&&(f=Fi),f-c<=0&&(f=c+HS);for(let g=0;g<l.length;g++){const m=l[g];if(!Wu(m)){this.updateId3CueEnds(c,u);const E=Yn(o,c,f,m,u);E&&this.id3Track.addCue(E)}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const o=s[r];o.type===t&&o.startTime<e&&o.endTime===Fi&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:u}}=o;if(r&&(a||u)){let l;s==="audio"?l=c=>c.type===Me.audioId3&&u:s==="video"?l=c=>c.type===Me.emsg&&a:l=c=>c.type===Me.audioId3&&u||c.type===Me.emsg&&a,Rs(r,t,i,l)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;const{assetPlayerId:i,timelineOffset:s,enableDateRangeMetadataCues:r,interstitialsController:o}=this.hls.config;if(!r)return;const a=Ls();if(i&&s&&!o){const{fragmentStart:E,fragmentEnd:y}=e;let v=this.assetCue;v?(v.startTime=E,v.endTime=y):a&&(v=this.assetCue=Yn(a,E,y,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),v&&(v.id=i,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(v),v.addEventListener("enter",this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;const{id3Track:u}=this,{dateRanges:l}=e,c=Object.keys(l);let f=this.dateRangeCuesAppended;if(u&&t){var p;if((p=u.cues)!=null&&p.length){const E=Object.keys(f).filter(y=>!c.includes(y));for(let y=E.length;y--;){var g;const v=E[y],S=(g=f[v])==null?void 0:g.cues;delete f[v],S&&Object.keys(S).forEach(A=>{const _=S[A];if(_){_.removeEventListener("enter",this.onEventCueEnter);try{u.removeCue(_)}catch{}}})}}else f=this.dateRangeCuesAppended={}}const m=e.fragments[e.fragments.length-1];if(!(c.length===0||!V(m==null?void 0:m.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let E=0;E<c.length;E++){const y=c[E],v=l[y],S=v.startTime,A=f[y],_=(A==null?void 0:A.cues)||{};let I=(A==null?void 0:A.durationKnown)||!1,P=Fi;const{duration:R,endDate:L}=v;if(L&&R!==null)P=S+R,I=!0;else if(v.endOnNext&&!I){const x=c.reduce((w,M)=>{if(M!==v.id){const U=l[M];if(U.class===v.class&&U.startDate>v.startDate&&(!w||v.startDate<w.startDate))return U}return w},null);x&&(P=x.startTime,I=!0)}const C=Object.keys(v.attr);for(let x=0;x<C.length;x++){const w=C[x];if(!dE(w))continue;const M=_[w];if(M)I&&!(A!=null&&A.durationKnown)?M.endTime=P:Math.abs(M.startTime-S)>.01&&(M.startTime=S,M.endTime=P);else if(a){let U=v.attr[w];fE(w)&&(U=nu(U));const H=Yn(a,S,P,{key:w,data:U},Me.dateRange);H&&(H.id=y,this.id3Track.addCue(H),_[w]=H,o&&(w==="X-ASSET-LIST"||w==="X-ASSET-URL")&&H.addEventListener("enter",this.onEventCueEnter))}}f[y]={cues:_,dateRange:v,durationKnown:I}}}}}class qS{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const s=this.computeLatency();if(s===null)return;this._latency=s;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:o}=this.config;if(!r||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const u=s-a,l=Math.min(this.maxLatency,a+i.targetduration);if(u<l&&u>.05&&this.forwardBufferLength>1){const f=Math.min(2,Math.max(1,o)),p=Math.round(2/(1+Math.exp(-.75*u-this.edgeStalled))*20)/20,g=Math.min(f,Math.max(1,p));this.changeMediaPlaybackRate(t,g)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,u=this.hls.userConfig;let l=a&&i||t;(this._targetLatencyUpdated||u.liveSyncDuration||u.liveSyncDurationCount||l===0)&&(l=r!==void 0?r:o*s);const c=s;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,c)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,o=s-i.totalduration,a=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,r),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(T.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(T.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(T.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(T.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===b.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,s;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(s=this.targetLatency)==null?void 0:s.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class YS extends nr{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(T.LEVEL_LOADED,this.onLevelLoaded,this),e.on(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(T.FRAG_BUFFERED,this.onFragBuffered,this),e.on(T.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(T.LEVEL_LOADED,this.onLevelLoaded,this),e.off(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(T.FRAG_BUFFERED,this.onFragBuffered,this),e.off(T.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,s=[],r={},o={};let a=!1,u=!1,l=!1;t.levels.forEach(c=>{const f=c.attrs;let{audioCodec:p,videoCodec:g}=c;p&&(c.audioCodec=p=en(p,i)||void 0),g&&(g=c.videoCodec=Ly(g));const{width:m,height:E,unknownCodecs:y}=c,v=(y==null?void 0:y.length)||0;if(a||(a=!!(m&&E)),u||(u=!!g),l||(l=!!p),v||p&&!this.isAudioSupported(p)||g&&!this.isVideoSupported(g)){this.log(`Some or all CODECS not supported "${f.CODECS}"`);return}const{CODECS:S,"FRAME-RATE":A,"HDCP-LEVEL":_,"PATHWAY-ID":I,RESOLUTION:P,"VIDEO-RANGE":R}=f,C=`${`${I||"."}-`}${c.bitrate}-${P}-${A}-${S}-${R}-${_}`;if(r[C])if(r[C].uri!==c.url&&!c.attrs["PATHWAY-ID"]){const x=o[C]+=1;c.attrs["PATHWAY-ID"]=new Array(x+1).join(".");const w=this.createLevel(c);r[C]=w,s.push(w)}else r[C].addGroupId("audio",f.AUDIO),r[C].addGroupId("text",f.SUBTITLES);else{const x=this.createLevel(c);r[C]=x,o[C]=1,s.push(x)}}),this.filterAndSortMediaOptions(s,t,a,u,l)}createLevel(e){const t=new di(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const s=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(s.message),t.supportedResult=gu(s,[])}return t}isAudioSupported(e){return ui(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return ui(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,s,r){var o;let a=[],u=[],l=e;const c=((o=t.stats)==null?void 0:o.parsing)||{};if((i||s)&&r&&(l=l.filter(({videoCodec:S,videoRange:A,width:_,height:I})=>(!!S||!!(_&&I))&&Oy(A))),l.length===0){Promise.resolve().then(()=>{if(this.hls){let S="no level with compatible codecs found in manifest",A=S;t.levels.length&&(A=`one or more CODECS in variant not supported: ${ce(t.levels.map(I=>I.attrs.CODECS).filter((I,P,R)=>R.indexOf(I)===P))}`,this.warn(A),S+=` (${A})`);const _=new Error(S);this.hls.trigger(T.ERROR,{type:W.MEDIA_ERROR,details:b.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:_,reason:A})}}),c.end=performance.now();return}t.audioTracks&&(a=t.audioTracks.filter(S=>!S.audioCodec||this.isAudioSupported(S.audioCodec)),ll(a)),t.subtitles&&(u=t.subtitles,ll(u));const f=l.slice(0);l.sort((S,A)=>{if(S.attrs["HDCP-LEVEL"]!==A.attrs["HDCP-LEVEL"])return(S.attrs["HDCP-LEVEL"]||"")>(A.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&S.height!==A.height)return S.height-A.height;if(S.frameRate!==A.frameRate)return S.frameRate-A.frameRate;if(S.videoRange!==A.videoRange)return tn.indexOf(S.videoRange)-tn.indexOf(A.videoRange);if(S.videoCodec!==A.videoCodec){const _=jo(S.videoCodec),I=jo(A.videoCodec);if(_!==I)return I-_}if(S.uri===A.uri&&S.codecSet!==A.codecSet){const _=ji(S.codecSet),I=ji(A.codecSet);if(_!==I)return I-_}return S.averageBitrate!==A.averageBitrate?S.averageBitrate-A.averageBitrate:0});let p=f[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==f.length)){for(let S=0;S<f.length;S++)if(f[S].pathwayId===l[0].pathwayId){p=f[S];break}}this._levels=l;for(let S=0;S<l.length;S++)if(l[S]===p){var g;this._firstLevel=S;const A=p.bitrate,_=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${A}`),((g=this.hls.userConfig)==null?void 0:g.abrEwmaDefaultEstimate)===void 0){const I=Math.min(A,this.hls.config.abrEwmaDefaultEstimateMax);I>_&&_===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=I)}break}const m=r&&!s,E=this.hls.config,y=!!(E.audioStreamController&&E.audioTrackController),v={levels:l,audioTracks:a,subtitleTracks:u,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:y&&!m&&a.some(S=>!!S.url)};c.end=performance.now(),this.hls.trigger(T.MANIFEST_PARSED,v)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const c=new Error("invalid level idx"),f=e<0;if(this.hls.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.LEVEL_SWITCH_ERROR,level:e,fatal:f,error:c,reason:c.message}),f)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&s&&r===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${r?" with Pathway "+r:""}`);const u={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(T.LEVEL_SWITCHING,u);const l=o.details;if(!l||l.live){const c=this.switchParams(o.uri,s==null?void 0:s.details,l);this.loadPlaylist(c)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(s=>t.indexOf(s)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===te.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===K.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${s}`),(a=t.deliveryDirectives)!=null&&a.skip&&(r.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let u=o.details;u===t.details&&u.advanced&&(u=void 0),this.playlistLoaded(s,t,u)}else(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),s=this.currentLevelIndex,r=e.attrs["PATHWAY-ID"],o=e.details,a=o==null?void 0:o.age;this.log(`Loading level index ${s}${(t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""}${r?" Pathway "+r:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(T.LEVEL_LOADING,{url:i,level:s,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((r,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(r),r===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,r.details&&r.details.fragments.forEach(a=>a.level=-1)),!1));Fu(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const s=i.length-1;this._firstLevel=Math.min(this._firstLevel,s),this._startLevel&&(this._startLevel=Math.min(this._startLevel,s)),this.hls.trigger(T.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(T.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function ll(n){const e={};n.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function bc(){return self.SourceBuffer||self.WebKitSourceBuffer}function wc(){if(!mt())return!1;const e=bc();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function WS(){if(!wc())return!1;const n=mt();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(ci(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(ci(e,"audio"))))}function JS(){var n;const e=bc();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}const zS=100;class XS extends zs{constructor(e,t,i){super(e,t,i,"stream-controller",K.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const s=this.media,r=s?s.currentTime:null;if(r===null||!V(r)||(this.log(`Media seeked to ${r.toFixed(3)}`),!this.getBufferedFrag(r)))return;const o=this.getFwdBufferInfoAtPos(s,r,K.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${r} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(T.MANIFEST_PARSED,this.onManifestParsed,this),e.on(T.LEVEL_LOADING,this.onLevelLoading,this),e.on(T.LEVEL_LOADED,this.onLevelLoaded,this),e.on(T.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(T.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(T.BUFFER_CREATED,this.onBufferCreated,this),e.on(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(T.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(T.MANIFEST_PARSED,this.onManifestParsed,this),e.off(T.LEVEL_LOADED,this.onLevelLoaded,this),e.off(T.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(T.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(T.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(T.BUFFER_CREATED,this.onBufferCreated,this),e.off(T.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(T.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(T.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:s}=this;if(this.stopLoad(),this.setInterval(zS),this.level=-1,!this.startFragRequested){let r=s.startLevel;r===-1&&(s.config.testBandwidth&&this.levels.length>1?(r=0,this.bitrateTest=!0):r=s.firstAutoLevel),s.nextLoadLevel=r,this.level=s.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=k.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=k.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case k.WAITING_LEVEL:{const{levels:e,level:t}=this,i=e==null?void 0:e[t],s=i==null?void 0:i.details;if(s&&(!s.live||this.levelLastLoaded===i&&!this.waitForLive(i))){if(this.waitForCdnTuneIn(s))break;this.state=k.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=k.IDLE;break}break}case k.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===k.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this;if(t===null||!s&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const r=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[r]))return;const o=i[r],a=this.getMainFwdBufferInfo();if(a===null)return;const u=this.getLevelDetails();if(u&&this._streamEnded(a,u)){const E={};this.altAudio===2&&(E.type="video"),this.hls.trigger(T.BUFFER_EOS,E),this.state=k.ENDED;return}if(!this.buffering)return;e.loadLevel!==r&&e.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;const l=o.details;if(!l||this.state===k.WAITING_LEVEL||this.waitForLive(o)){this.level=r,this.state=k.WAITING_LEVEL,this.startFragRequested=!1;return}const c=a.len,f=this.getMaxBufferLength(o.maxBitrate);if(c>=f)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const p=this.backtrackFragment?this.backtrackFragment.start:a.end;let g=this.getNextFragment(p,l);if(this.couldBacktrack&&!this.fragPrevious&&g&&pe(g)&&this.fragmentTracker.getState(g)!==me.OK){var m;const y=((m=this.backtrackFragment)!=null?m:g).sn-l.startSN,v=l.fragments[y-1];v&&g.cc===v.cc&&(g=v,this.fragmentTracker.removeFragment(v))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(g&&this.isLoopLoading(g,p)){if(!g.gap){const y=this.audioOnly&&!this.altAudio?ue.AUDIO:ue.VIDEO,v=(y===ue.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;v&&this.afterBufferFlushed(v,y,K.MAIN)}g=this.getNextFragmentLoopLoading(g,l,a,K.MAIN,f)}g&&(g.initSegment&&!g.initSegment.data&&!this.bitrateTest&&(g=g.initSegment),this.loadFragment(g,o,p))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);s===me.NOT_LOADED||s===me.PARTIAL?pe(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,K.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<r.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,u=e[a],l=this.fragLastKbps;l&&this.fragCurrent?i=this.fragCurrent.duration*u.maxBitrate/(1e3*l)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const u=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,c=Math.max(o.end,u+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(c,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case k.KEY_LOADING:case k.FRAG_LOADING:case k.FRAG_LOADING_WAITING_RETRY:case k.PARSING:case k.PARSED:this.state=k.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;Ce(i,"playing",this.onMediaPlaying),Ce(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(De(i,"playing",this.onMediaPlaying),De(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(T.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,s=!1;for(let r=0;r<t.levels.length;r++){const o=t.levels[r].audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,s=s||o.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=i&&s&&!JS(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==k.IDLE)return;const s=t.levelInfo;(!s.details||s.details.live&&(this.levelLastLoaded!==s||s.details.expired)||this.waitForCdnTuneIn(s.details))&&(this.state=k.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s,startFragRequested:r}=this,o=t.level,a=t.details,u=a.totalduration;if(!s){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${u}`);const l=t.levelInfo,c=this.fragCurrent;c&&(this.state===k.FRAG_LOADING||this.state===k.FRAG_LOADING_WAITING_RETRY)&&c.level!==t.level&&c.loader&&this.abortCurrentFrag();let f=0;if(a.live||(i=l.details)!=null&&i.live){var p;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;f=this.alignPlaylists(a,l.details,(p=this.levelLastLoaded)==null?void 0:p.details)}if(l.details=a,this.levelLastLoaded=l,r||this.setStartPosition(a,f),this.hls.trigger(T.LEVEL_UPDATED,{details:a,level:o}),this.state===k.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=k.IDLE}r&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,u=r>=o-t.maxFragLookUpTolerance&&r<=a;if(s!==null&&i.duration>s&&(r<s||!u)){const c=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!u&&i.readyState<4||r<a-c)&&(this._hasEnoughToStart||(this.nextLoadPosition=s),i.readyState))if(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${s.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var l;const f=Q.bufferInfo(i,s,0);if(!((l=f.buffered)!=null&&l.length)){i.currentTime=s;return}if(f.start<=r){i.currentTime=s;return}const{nextStart:g}=Q.bufferedInfo(f.buffered,r,0);g&&(i.currentTime=g)}else i.currentTime=s}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:s,payload:r}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const u=a.details;if(!u){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const l=a.videoCodec,c=u.PTSKnown||!u.live,f=(t=i.initSegment)==null?void 0:t.data,p=this._getAudioCodec(a),g=this.transmuxer=this.transmuxer||new sc(this.hls,K.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=s?s.index:-1,E=m!==-1,y=new Ys(i.level,i.sn,i.stats.chunkCount,r.byteLength,m,E),v=this.initPTS[i.cc];g.push(r,f,p,l,i,s,u.totalduration,c,y,v)}onAudioTrackSwitching(e,t){const i=this.hls,s=this.altAudio!==0;if(nn(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(s){this.altAudio=0,this.fragmentTracker.removeAllFragments(),i.once(T.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(T.AUDIO_TRACK_SWITCHED,t)}),i.trigger(T.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(T.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=nn(t.url,this.hls);if(i){const s=this.videoBuffer;s&&this.mediaBuffer!==s&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=s)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,o=!1;for(const a in i){const u=i[a];if(u.id==="main"){if(r=a,s=u,a==="video"){const l=i[a];l&&(this.videoBuffer=l.buffer)}}else o=!0}o&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t,r=i.type===K.MAIN;if(r){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===k.PARSED&&(this.state=k.IDLE);return}const a=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),pe(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}const o=this.media;o&&(!this._hasEnoughToStart&&Q.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),r&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=k.ERROR;return}switch(t.details){case b.FRAG_GAP:case b.FRAG_PARSING_ERROR:case b.FRAG_DECRYPT_ERROR:case b.FRAG_LOAD_ERROR:case b.FRAG_LOAD_TIMEOUT:case b.KEY_LOAD_ERROR:case b.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(K.MAIN,t);break;case b.LEVEL_LOAD_ERROR:case b.LEVEL_LOAD_TIMEOUT:case b.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===k.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===te.LEVEL&&(this.state=k.IDLE);break;case b.BUFFER_ADD_CODEC_ERROR:case b.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case b.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case b.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=k.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==ue.AUDIO||!this.altAudio){const i=(t===ue.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,K.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=this.timelineOffset;s&&i&&(i+=s);const r=this.getLevelDetails(),o=Q.getBuffered(e),a=o.length?o.start(0):0,u=a-i,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||u>0&&(u<l||this.loadingParts&&u<2*((r==null?void 0:r.partTarget)||0)))&&(this.log(`adjusting start position by ${u} to match buffer start`),i+=u,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this,r=i==null?void 0:i.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=k.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=r.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),s.trigger(T.FRAG_LOADED,i),r.bitrateTest=!1}).catch(i=>{this.state===k.STOPPED||this.state===k.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}_handleTransmuxComplete(e){const t=this.playlistType,{hls:i}=this,{remuxResult:s,chunkMeta:r}=e,o=this.getCurrentContext(r);if(!o){this.resetWhenMissingContext(r);return}const{frag:a,part:u,level:l}=o,{video:c,text:f,id3:p,initSegment:g}=s,{details:m}=l,E=this.altAudio?void 0:s.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=k.PARSING,g){const y=g.tracks;if(y){const _=a.initSegment||a;if(this.unhandledEncryptionError(g,a))return;this._bufferInitSegment(l,y,_,r),i.trigger(T.FRAG_PARSING_INIT_SEGMENT,{frag:_,id:t,tracks:y})}const v=g.initPTS,S=g.timescale,A=this.initPTS[a.cc];if(V(v)&&(!A||A.baseTime!==v||A.timescale!==S)){const _=g.trackId;this.initPTS[a.cc]={baseTime:v,timescale:S,trackId:_},i.trigger(T.INIT_PTS_FOUND,{frag:a,id:t,initPTS:v,timescale:S,trackId:_})}}if(c&&m){E&&c.type==="audiovideo"&&this.logMuxedErr(a);const y=m.fragments[a.sn-1-m.startSN],v=a.sn===m.startSN,S=!y||a.cc>y.cc;if(s.independent!==!1){const{startPTS:A,endPTS:_,startDTS:I,endDTS:P}=c;if(u)u.elementaryStreams[c.type]={startPTS:A,endPTS:_,startDTS:I,endDTS:P};else if(c.firstKeyFrame&&c.independent&&r.id===1&&!S&&(this.couldBacktrack=!0),c.dropped&&c.independent){const R=this.getMainFwdBufferInfo(),L=(R?R.end:this.getLoadPosition())+this.config.maxBufferHole,C=c.firstKeyFramePTS?c.firstKeyFramePTS:A;if(!v&&L<C-this.config.maxBufferHole&&!S){this.backtrack(a);return}else S&&(a.gap=!0);a.setElementaryStreamInfo(c.type,a.start,_,a.start,P,!0)}else v&&A-(m.appliedTimelineOffset||0)>Yi&&(a.gap=!0);a.setElementaryStreamInfo(c.type,A,_,I,P),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(c,a,u,r,v||S)}else if(v||S)a.gap=!0;else{this.backtrack(a);return}}if(E){const{startPTS:y,endPTS:v,startDTS:S,endDTS:A}=E;u&&(u.elementaryStreams[ue.AUDIO]={startPTS:y,endPTS:v,startDTS:S,endDTS:A}),a.setElementaryStreamInfo(ue.AUDIO,y,v,S,A),this.bufferFragmentData(E,a,u,r)}if(m&&p!=null&&p.samples.length){const y={id:t,frag:a,details:m,samples:p.samples};i.trigger(T.FRAG_PARSING_METADATA,y)}if(m&&f){const y={id:t,frag:a,details:m,samples:f.samples};i.trigger(T.FRAG_PARSING_USERDATA,y)}}logMuxedErr(e){this.warn(`${pe(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,s){if(this.state!==k.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:r,video:o,audiovideo:a}=t;if(r){const l=e.audioCodec;let c=Bi(r.codec,l);c==="mp4a"&&(c="mp4a.40.5");const f=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){c&&(c.indexOf("mp4a.40.5")!==-1?c="mp4a.40.2":c="mp4a.40.5");const p=r.metadata;p&&"channelCount"in p&&(p.channelCount||1)!==1&&f.indexOf("firefox")===-1&&(c="mp4a.40.5")}c&&c.indexOf("mp4a.40.5")!==-1&&f.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(c="mp4a.40.2",this.log(`Android: force audio codec to ${c}`)),l&&l!==c&&this.log(`Swapping manifest audio codec "${l}" for "${c}"`),r.levelCodec=c,r.id=K.MAIN,this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${c||""}/${l||""}/${r.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=K.MAIN;const l=o.codec;if((l==null?void 0:l.length)===4)switch(l){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${l}]${o.codec!==l?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const u=Object.keys(t);if(u.length){if(this.hls.trigger(T.BUFFER_CODECS,t),!this.hls)return;u.forEach(l=>{const f=t[l].initSegment;f!=null&&f.byteLength&&this.hls.trigger(T.BUFFER_APPENDING,{type:l,data:f,frag:i,part:null,chunkMeta:s,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,K.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e==null?void 0:e[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=k.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(Q.isBuffered(e,i)?t=this.getAppendedFrag(i):Q.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(T.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(T.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return V(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(V(t)){const i=this.getLevelDetails(),s=this.currentFrag||(i?Lt(null,i.fragments,t):null);if(s){const r=s.programDateTime;if(r!==null){const o=r+(t-s.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class QS extends Ge{constructor(e,t){super("key-loader",t),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyIdToKeyInfo){const s=this.keyIdToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e].loader;t&&t.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(e,t=b.KEY_LOAD_ERROR,i,s,r){return new rt({type:W.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t,i){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let s=0,r=t.length;s<r;s++){const o=t[s];if(e.cc<=o.cc&&(!pe(e)||!pe(o)||e.sn<o.sn)||!i&&s==r-1)return this.emeController.selectKeySystemFormat(o).then(a=>{if(!this.emeController)return;o.setKeyFormat(a);const u=Gi(a);if(u)return this.emeController.getKeySystemAccess([u])})}if(this.config.requireKeySystemAccessOnStart){const s=si(this.config);if(s.length)return this.emeController.getKeySystemAccess(s)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const l=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(e,b.KEY_LOAD_ERROR,l))}const o=r.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,b.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));const a=Wn(r);let u=this.keyIdToKeyInfo[a];if((i=u)!=null&&i.decryptdata.key)return r.key=u.decryptdata.key,Promise.resolve({frag:e,keyInfo:u});if(this.emeController&&(s=u)!=null&&s.keyLoadPromise)switch(this.emeController.getKeyStatus(u.decryptdata)){case"usable":case"usable-in-future":return u.keyLoadPromise.then(c=>{const{keyInfo:f}=c;return r.key=f.decryptdata.key,{frag:e,keyInfo:f}})}switch(this.log(`${this.keyIdToKeyInfo[a]?"Rel":"L"}oading${r.keyId?" keyId: "+Se(r.keyId):""} URI: ${r.uri} from ${e.type} ${e.level}`),u=this.keyIdToKeyInfo[a]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(u,e):this.loadKeyEME(u,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(u,e);default:return Promise.reject(this.createKeyLoadError(e,b.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var s;if(!e.decryptdata.keyId&&(s=t.initSegment)!=null&&s.data){const o=my(t.initSegment.data);if(o.length){let a=o[0];a.some(u=>u!==0)?(this.log(`Using keyId found in init segment ${Se(a)}`),gt.setKeyIdForUri(e.decryptdata.uri,a)):(a=gt.addKeyIdForUri(e.decryptdata.uri),this.log(`Generating keyId to patch media ${Se(a)}`)),e.decryptdata.keyId=a}}if(!e.decryptdata.keyId&&!pe(t))return Promise.resolve(i);const r=this.emeController.loadKey(i);return(e.keyLoadPromise=r.then(o=>(e.mediaKeySessionContext=o,i))).catch(o=>{throw e.keyLoadPromise=null,"data"in o&&(o.data.frag=t),o})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((o,a)=>{const u={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=i.keyLoadPolicy.default,c={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},f={onSuccess:(p,g,m,E)=>{const{frag:y,keyInfo:v}=m,S=Wn(v.decryptdata);if(!y.decryptdata||v!==this.keyIdToKeyInfo[S])return a(this.createKeyLoadError(y,b.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),E));v.decryptdata.key=y.decryptdata.key=new Uint8Array(p.data),y.keyLoader=null,v.loader=null,o({frag:y,keyInfo:v})},onError:(p,g,m,E)=>{this.resetLoader(g),a(this.createKeyLoadError(t,b.KEY_LOAD_ERROR,new Error(`HTTP Error ${p.code} loading key ${p.text}`),m,oe({url:u.url,data:void 0},p)))},onTimeout:(p,g,m)=>{this.resetLoader(g),a(this.createKeyLoadError(t,b.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),m))},onAbort:(p,g,m)=>{this.resetLoader(g),a(this.createKeyLoadError(t,b.INTERNAL_ABORTED,new Error("key loading aborted"),m))}};r.load(u,c,f)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null);const o=Wn(i.decryptdata)||s;delete this.keyIdToKeyInfo[o],r&&r.destroy()}}function Wn(n){if(n.keyFormat!==Ae.FAIRPLAY){const e=n.keyId;if(e)return Se(e)}return n.uri}function ul(n){const{type:e}=n;switch(e){case te.AUDIO_TRACK:return K.AUDIO;case te.SUBTITLE_TRACK:return K.SUBTITLE;default:return K.MAIN}}function Jn(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class ZS{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(T.MANIFEST_LOADING,this.onManifestLoading,this),e.on(T.LEVEL_LOADING,this.onLevelLoading,this),e.on(T.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(T.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(T.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(T.MANIFEST_LOADING,this.onManifestLoading,this),e.off(T.LEVEL_LOADING,this.onLevelLoading,this),e.off(T.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(T.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(T.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,o=new r(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:te.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:s,pathwayId:r,url:o,deliveryDirectives:a,levelInfo:u}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:te.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:u})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:te.AUDIO_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:te.SUBTITLE_TRACK,url:r,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[te.LEVEL];if(i){const s=i.context;s&&!t.levels.some(r=>r===s.levelOrTrack)&&(i.abort(),delete this.loaders[te.LEVEL])}}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const l=this.hls.logger,c=s.context;if(c&&c.levelOrTrack===e.levelOrTrack&&(c.url===e.url||c.deliveryDirectives&&!e.deliveryDirectives)){c.url===e.url?l.log(`[playlist-loader]: ignore ${e.url} ongoing request`):l.log(`[playlist-loader]: ignore ${e.url} in favor of ${c.url}`);return}l.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===te.MANIFEST?r=i.manifestLoadPolicy.default:r=le({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),V((t=e.deliveryDirectives)==null?void 0:t.part)){let l;if(e.type===te.LEVEL&&e.level!==null?l=this.hls.levels[e.level].details:e.type===te.AUDIO_TRACK&&e.id!==null?l=this.hls.audioTracks[e.id].details:e.type===te.SUBTITLE_TRACK&&e.id!==null&&(l=this.hls.subtitleTracks[e.id].details),l){const c=l.partTarget,f=l.targetduration;if(c&&f){const p=Math.max(c*3,f*.8)*1e3;r=le({},r,{maxTimeToFirstByteMs:Math.min(p,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(p,r.maxTimeToFirstByteMs)})}}}const o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},u={onSuccess:(l,c,f,p)=>{const g=this.getInternalLoader(f);this.resetInternalLoader(f.type);const m=l.data;c.parsing.start=performance.now(),et.isMediaPlaylist(m)||f.type!==te.MANIFEST?this.handleTrackOrLevelPlaylist(l,c,f,p||null,g):this.handleMasterPlaylist(l,c,f,p)},onError:(l,c,f,p)=>{this.handleNetworkError(c,f,!1,l,p)},onTimeout:(l,c,f)=>{this.handleNetworkError(c,f,!0,void 0,l)}};s.load(e,a,u)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,s){const r=this.hls,o=e.data,a=Jn(e,i),u=et.parseMasterPlaylist(o,a);if(u.playlistParsingError){t.parsing.end=performance.now(),this.handleManifestParsingError(e,i,u.playlistParsingError,s,t);return}const{contentSteering:l,levels:c,sessionData:f,sessionKeys:p,startTimeOffset:g,variableList:m}=u;this.variableList=m,c.forEach(S=>{const{unknownCodecs:A}=S;if(A){const{preferManagedMediaSource:_}=this.hls.config;let{audioCodec:I,videoCodec:P}=S;for(let R=A.length;R--;){const L=A[R];ui(L,"audio",_)?(S.audioCodec=I=I?`${I},${L}`:L,Wt.audio[I.substring(0,4)]=2,A.splice(R,1)):ui(L,"video",_)&&(S.videoCodec=P=P?`${P},${L}`:L,Wt.video[P.substring(0,4)]=2,A.splice(R,1))}}});const{AUDIO:E=[],SUBTITLES:y,"CLOSED-CAPTIONS":v}=et.parseMasterPlaylistMedia(o,a,u);E.length&&!E.some(A=>!A.url)&&c[0].audioCodec&&!c[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),E.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new de({}),bitrate:0,url:""})),r.trigger(T.MANIFEST_LOADED,{levels:c,audioTracks:E,subtitles:y,captions:v,contentSteering:l,url:a,stats:t,networkDetails:s,sessionData:f,sessionKeys:p,startTimeOffset:g,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,s,r){const o=this.hls,{id:a,level:u,type:l}=i,c=Jn(e,i),f=V(u)?u:V(a)?a:0,p=ul(i),g=et.parseLevelPlaylist(e.data,c,f,p,0,this.variableList);if(l===te.MANIFEST){const m={attrs:new de({}),bitrate:0,details:g,name:"",url:c};g.requestScheduled=t.loading.start+ku(g,0),o.trigger(T.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:c,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=g,this.handlePlaylistLoaded(g,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(T.ERROR,{type:W.NETWORK_ERROR,details:b.MANIFEST_PARSING_ERROR,fatal:t.type===te.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let o=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===te.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===te.AUDIO_TRACK||e.type===te.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let u=b.UNKNOWN,l=!1;const c=this.getInternalLoader(e);switch(e.type){case te.MANIFEST:u=i?b.MANIFEST_LOAD_TIMEOUT:b.MANIFEST_LOAD_ERROR,l=!0;break;case te.LEVEL:u=i?b.LEVEL_LOAD_TIMEOUT:b.LEVEL_LOAD_ERROR,l=!1;break;case te.AUDIO_TRACK:u=i?b.AUDIO_TRACK_LOAD_TIMEOUT:b.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case te.SUBTITLE_TRACK:u=i?b.SUBTITLE_TRACK_LOAD_TIMEOUT:b.SUBTITLE_LOAD_ERROR,l=!1;break}c&&this.resetInternalLoader(e.type);const f={type:W.NETWORK_ERROR,details:u,fatal:l,url:e.url,loader:c,context:e,error:a,networkDetails:t,stats:r};if(s){const p=(t==null?void 0:t.url)||e.url;f.response=oe({url:p,data:void 0},s)}this.hls.trigger(T.ERROR,f)}handlePlaylistLoaded(e,t,i,s,r,o){const a=this.hls,{type:u,level:l,levelOrTrack:c,id:f,groupId:p,deliveryDirectives:g}=s,m=Jn(t,s),E=ul(s);let y=typeof s.level=="number"&&E===K.MAIN?l:void 0;const v=e.playlistParsingError;if(v){if(this.hls.logger.warn(`${v} ${e.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(T.ERROR,{type:W.NETWORK_ERROR,details:b.LEVEL_PARSING_ERROR,fatal:!1,url:m,error:v,reason:v.message,response:t,context:s,level:y,parent:E,networkDetails:r,stats:i});return}e.playlistParsingError=null}if(!e.fragments.length){const S=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(T.ERROR,{type:W.NETWORK_ERROR,details:b.LEVEL_EMPTY_ERROR,fatal:!1,url:m,error:S,reason:S.message,response:t,context:s,level:y,parent:E,networkDetails:r,stats:i});return}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),u){case te.MANIFEST:case te.LEVEL:if(y){if(!c)y=0;else if(c!==a.levels[y]){const S=a.levels.indexOf(c);S>-1&&(y=S)}}a.trigger(T.LEVEL_LOADED,{details:e,levelInfo:c||a.levels[0],level:y||0,id:f||0,stats:i,networkDetails:r,deliveryDirectives:g,withoutMultiVariant:u===te.MANIFEST});break;case te.AUDIO_TRACK:a.trigger(T.AUDIO_TRACK_LOADED,{details:e,track:c,id:f||0,groupId:p||"",stats:i,networkDetails:r,deliveryDirectives:g});break;case te.SUBTITLE_TRACK:a.trigger(T.SUBTITLE_TRACK_LOADED,{details:e,track:c,id:f||0,groupId:p||"",stats:i,networkDetails:r,deliveryDirectives:g});break}}}class xt{static get version(){return fi}static isMSESupported(){return wc()}static isSupported(){return WS()}static getMediaSource(){return mt()}static get Events(){return T}static get MetadataSchema(){return Me}static get ErrorTypes(){return W}static get ErrorDetails(){return b}static get DefaultConfig(){return xt.defaultConfig?xt.defaultConfig:NS}static set DefaultConfig(e){xt.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Xs,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=sy(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=US(xt.DefaultConfig,e,t);this.userConfig=e,i.progressive&&OS(i,t);const{abrController:s,bufferController:r,capLevelController:o,errorController:a,fpsController:u}=i,l=new a(this),c=this.abrController=new s(this),f=new jy(this),p=i.interstitialsController,g=p?this.interstitialsController=new p(this,xt):null,m=this.bufferController=new r(this,f),E=this.capLevelController=new o(this),y=new u(this),v=new ZS(this),S=i.contentSteeringController,A=S?new S(this):null,_=this.levelController=new YS(this,A),I=new KS(this),P=new QS(this.config,this.logger),R=this.streamController=new XS(this,f,P),L=this.gapController=new VS(this,f);E.setStreamController(R),y.setStreamController(R);const C=[v,_,R];g&&C.splice(1,0,g),A&&C.splice(1,0,A),this.networkControllers=C;const x=[c,m,L,E,y,I,f];this.audioTrackController=this.createController(i.audioTrackController,C);const w=i.audioStreamController;w&&C.push(this.audioStreamController=new w(this,f,P)),this.subtitleTrackController=this.createController(i.subtitleTrackController,C);const M=i.subtitleStreamController;M&&C.push(this.subtititleStreamController=new M(this,f,P)),this.createController(i.timelineController,x),P.emeController=this.emeController=this.createController(i.emeController,x),this.cmcdController=this.createController(i.cmcdController,x),this.latencyController=this.createController(qS,x),this.coreComponents=x,C.push(l);const U=l.onErrorOut;typeof U=="function"&&this.on(T.ERROR,U,l),this.on(T.MANIFEST_LOADED,v.onManifestLoaded,v)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=e===T.ERROR;this.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.INTERNAL_EXCEPTION,fatal:s,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(T.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const r=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(T.ERROR,{type:W.OTHER_ERROR,details:b.ATTACH_MEDIA_ERROR,fatal:!0,error:r});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,s=t?e:{media:i};this._media=i,this.trigger(T.MEDIA_ATTACHING,s)}detachMedia(){this.logger.log("detachMedia"),this.trigger(T.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(T.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,s=this._url=Bs.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(T.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[K.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[K.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[K.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e==null?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=Vv()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){Uy(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e!=null&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const o=e[r].attrs["HDCP-LEVEL"];if(o&&o<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=Eu(t);return mu(e,i,navigator.mediaCapabilities)}}xt.defaultConfig=void 0;export{eA as G,xt as H};
